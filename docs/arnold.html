<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.10.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>PresenZ SDK: Implementation in Arnold</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">PresenZ SDK<span id="projectnumber">&#160;4.1.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('arnold.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Implementation in Arnold</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md__c_1_2jk_2workspace_2_presen_z___s_d_k__master_0d2_2resources_2_s_d_k_2manual_210-implementation-arnold"></a> Here is the implementation code for <a class="el" href="namespace_presen_z.html">PresenZ</a> inside SolidAngle Arnold.</p>
<h1><a class="anchor" id="autotoc_md53"></a>
10.1 Camera</h1>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;ai.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;map&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;thread&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="_pz_camera_api_8h.html">API/PzCameraApi.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="_pz_assert_8h.html">API/PzAssert.h</a>&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &quot;arnoldWrapper.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;presenz_global_parameters.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">struct </span>FromRev {</div>
<div class="line">    FromRev() :rev(0) {}</div>
<div class="line">    FromRev(<span class="keyword">const</span> AtVector2&amp; s) {</div>
<div class="line">        rev = 1;</div>
<div class="line">        sx=s.x;</div>
<div class="line">        sy=s.y;</div>
<div class="line">    }</div>
<div class="line">    int8_t rev;</div>
<div class="line">    <span class="keywordtype">float</span> sx;</div>
<div class="line">    <span class="keywordtype">float</span> sy;</div>
<div class="line">};</div>
<div class="line"><span class="keyword">static</span> std::map&lt;std::thread::id, FromRev&gt; fromRevMap;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">AI_CAMERA_NODE_EXPORT_METHODS(PresenZCameraMethods)</div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> AtCameraInput&amp; getCamInput(<span class="keyword">const</span> AtCameraInput &amp;input) { <span class="keywordflow">return</span> input; }</div>
<div class="line">AtCameraOutput&amp; getCamOutput(AtCameraOutput &amp;output) { <span class="keywordflow">return</span> output; }</div>
<div class="line"> </div>
<div class="line"><span class="keyword">enum</span> <a class="code hl_enumeration" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#a3104904c134a52357b85f763f6dfd48f">Eye</a></div>
<div class="line">{</div>
<div class="line">    <a class="code hl_enumvalue" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#a3104904c134a52357b85f763f6dfd48fa4280d82f18d6dbafdeb68c811112455e">RC_Left</a> = 0,</div>
<div class="line">    <a class="code hl_enumvalue" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#a3104904c134a52357b85f763f6dfd48fac2b22af1f16cebd2cc909767c763a713">RC_Right</a> = 1</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span>* rendering_eye_enum[] =</div>
<div class="line">{</div>
<div class="line">    <span class="stringliteral">&quot;left&quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;right&quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;leftThenRight&quot;</span>, <span class="comment">// usefull to comunicate with the python code which then trigger a left and a right if the user specify &quot;leftTheRight&quot;</span></div>
<div class="line">    NULL</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</div>
<div class="line"><span class="keyword">inline</span> T clamp(<span class="keyword">const</span> T&amp; u, <span class="keyword">const</span> T&amp; umin, <span class="keyword">const</span> T&amp; umax) { <span class="keywordflow">return</span>  (u &lt; umin ? umin : (u &gt; umax ? umax : u)); }</div>
<div class="line"> </div>
<div class="line"><span class="keyword">struct </span>multiCamData_t</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">size_t</span> renderSizeX;</div>
<div class="line">    <span class="keywordtype">size_t</span> renderSizeY;</div>
<div class="line">    <span class="keywordtype">double</span> render_aspect;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">inline</span> multiCamData_t * GetLocalData(<span class="keyword">const</span> AtNode* node)</div>
<div class="line">{</div>
<div class="line">    multiCamData_t *data = (multiCamData_t*)AiNodeGetLocalData(node);</div>
<div class="line">    <span class="keywordflow">return</span> data;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> camInitialize(AtNode* node, <span class="keywordtype">void</span> *data) {</div>
<div class="line"> </div>
<div class="line">    AiCameraInitialize(node);</div>
<div class="line">    AiNodeSetLocalData(node, data);</div>
<div class="line"> </div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">node_parameters</div>
<div class="line">{</div>
<div class="line">    AiParameterInt(<span class="stringliteral">&quot;multibox_offset_right&quot;</span>, 0);</div>
<div class="line">    AiParameterInt(<span class="stringliteral">&quot;multibox_offset_top&quot;</span>, 0);</div>
<div class="line">    AiParameterInt(<span class="stringliteral">&quot;multibox_offset_back&quot;</span>, 0);</div>
<div class="line">    AiParameterFlt(<span class="stringliteral">&quot;distance_to_ground&quot;</span>, 1.6f);</div>
<div class="line">    AiParameterFlt(<span class="stringliteral">&quot;ipd&quot;</span>, 63.65f);               <span class="comment">// male mean  64.7(mm) ; female mean 62.6(mm)</span></div>
<div class="line">    AiParameterBool(<span class="stringliteral">&quot;draft_mode&quot;</span>, <span class="keyword">false</span>);</div>
<div class="line">    AiParameterFlt(<span class="stringliteral">&quot;presenz_scene_scale&quot;</span>, 1.0f);</div>
<div class="line"> </div>
<div class="line">    AiParameterVec(<span class="stringliteral">&quot;view_scale&quot;</span>, 1.0f, 0.5f, 1.0f);</div>
<div class="line">    AiParameterVec(<span class="stringliteral">&quot;specular_point_offset&quot;</span>, 0.0f, 0.0f, 0.0f);</div>
<div class="line">    AiParameterEnum(<span class="stringliteral">&quot;rendering_eye&quot;</span>, Eye::RC_Left, rendering_eye_enum);</div>
<div class="line">    AiParameterInt(<span class="stringliteral">&quot;render_inside_zov&quot;</span>, 0);</div>
<div class="line">    AiParameterBool(<span class="stringliteral">&quot;clipping_enable&quot;</span>, <span class="keyword">false</span>);</div>
<div class="line">    AiParameterVec(<span class="stringliteral">&quot;clipping_position&quot;</span>, 0.0f, 0.0f, 0.0f);</div>
<div class="line">    AiParameterFlt(<span class="stringliteral">&quot;clipping_radius&quot;</span>, 100.0f);</div>
<div class="line">    AiParameterBool(<span class="stringliteral">&quot;clipping_outside&quot;</span>, <span class="keyword">false</span>);</div>
<div class="line"> </div>
<div class="line">    AiParameterFlt(<span class="stringliteral">&quot;ideal_point_size&quot;</span>, 0.1f);</div>
<div class="line"> </div>
<div class="line">    AiParameterBool(<span class="stringliteral">&quot;enable_froxtrum&quot;</span>, <span class="keyword">true</span>);</div>
<div class="line">    AiParameterInt(<span class="stringliteral">&quot;froxtrum_depth&quot;</span>, 7);</div>
<div class="line">    AiParameterInt(<span class="stringliteral">&quot;volume_depth&quot;</span>, 9);</div>
<div class="line">    </div>
<div class="line"> </div>
<div class="line">    AiParameterBool(<span class="stringliteral">&quot;block_range&quot;</span>, <span class="keyword">false</span>);</div>
<div class="line">    AiParameterInt(<span class="stringliteral">&quot;block_range_in&quot;</span>, 0);</div>
<div class="line">    AiParameterInt(<span class="stringliteral">&quot;block_range_out&quot;</span>, 0);</div>
<div class="line"> </div>
<div class="line">    AiParameterBool(<span class="stringliteral">&quot;render_isolated&quot;</span>, <span class="keyword">false</span>);</div>
<div class="line">    AiParameterInt(<span class="stringliteral">&quot;stereo_right_eye&quot;</span>, 0);</div>
<div class="line"> </div>
<div class="line">    AiParameterStr(<span class="stringliteral">&quot;window_shapes_file&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);</div>
<div class="line">    AiParameterInt(<span class="stringliteral">&quot;window_shape_index&quot;</span>, 0 );</div>
<div class="line">    AiParameterFlt(<span class="stringliteral">&quot;min_dist_to_screen&quot;</span>,100.0f);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    AiMetaDataSetStr(nentry, NULL, <span class="stringliteral">&quot;maya.translator&quot;</span>, <span class="stringliteral">&quot;przCamera&quot;</span>);</div>
<div class="line">    AiMetaDataSetStr(nentry, NULL, <span class="stringliteral">&quot;_synonym&quot;</span>, <span class="stringliteral">&quot;PresenZCamera&quot;</span>);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">node_initialize</div>
<div class="line">{</div>
<div class="line">    multiCamData_t* data = <span class="keyword">new</span> multiCamData_t();</div>
<div class="line">    camInitialize(node, data);</div>
<div class="line"><span class="preprocessor">#if AI_VERSION_ARCH_NUM &gt;= 7 &amp;&amp; AI_VERSION_MAJOR_NUM &gt;= 4</span></div>
<div class="line">    <span class="keyword">const</span> AtNode* render_options = AiRenderSessionGetOptions(render_session);</div>
<div class="line">    AiNodeAddDependency(node, render_options, xresStr);</div>
<div class="line">    AiNodeAddDependency(node, render_options, yresStr);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">node_update</div>
<div class="line">{</div>
<div class="line"> </div>
<div class="line">    AiCameraUpdate(node, <span class="keyword">false</span>);</div>
<div class="line">    AiNodeSetFlt(node, shutterStartStr, 0.0f);</div>
<div class="line">    AiNodeSetFlt(node, shutterEndStr, 0.0f);</div>
<div class="line"> </div>
<div class="line">    multiCamData_t *data = GetLocalData(node);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> AtNode* render_options = AiRenderSessionGetOptions(render_session);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">int</span> xres = AiNodeGetInt(render_options, xresStr); </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">int</span> yres = AiNodeGetInt(render_options, yresStr);</div>
<div class="line">    data-&gt;renderSizeX = xres;</div>
<div class="line">    data-&gt;renderSizeY = yres;</div>
<div class="line">    data-&gt;render_aspect = (double(xres) / double(yres));</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">node_finish</div>
<div class="line">{</div>
<div class="line">    multiCamData_t *data = GetLocalData(node);</div>
<div class="line">    <span class="keyword">delete</span> data;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">camera_reverse_ray</div>
<div class="line">{</div>
<div class="line">    multiCamData_t *data = GetLocalData(node);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// normalized direction</span></div>
<div class="line">    AtVector dir = AiV3Normalize(Po);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">double</span> u, v;</div>
<div class="line">    <a class="code hl_function" href="group___pz_camera_api.html#gaa6fa25f6eba2c3d8f1cbfe59724601f1">PresenZ::Camera::PzGetUVFromRay</a>(<a class="code hl_typedef" href="group___n_o_z__vector.html#ga347d85f3e636cf273a47949aa0613a8f">NozVector</a>(dir.x,dir.y,dir.z), u, v);</div>
<div class="line">    <span class="comment">// Calculate screen coordinates</span></div>
<div class="line">    Ps.x = ((float)u*2.0f)-1.0f;</div>
<div class="line">    Ps.y = ((2.0f*(-(float)v+1))-1.0f)/ (float)data-&gt;render_aspect;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">     </div>
<div class="line">    <span class="comment">// This fonction is called by the to perform the arnold adaptativeSubdivision</span></div>
<div class="line">    <span class="comment">// while this is working, the others thread are still going on, casting rays.</span></div>
<div class="line"> </div>
<div class="line">    <span class="comment">// &quot;camera_create_ray&quot; is directly caller imedialty after every call of &quot;camera_reverse_ray&quot;,     </span></div>
<div class="line">    <span class="comment">// so if fromrevers == 1 in the &quot;camera_create_ray&quot; scope we know fromrevers went through &quot;camera_reverse_ray&quot;</span></div>
<div class="line">    <span class="comment">// and this is going to be a subdiv ray so we wont consider this ray as a presenz ray. and we&#39;ll just do a standard cubeMap projection.</span></div>
<div class="line">    <span class="comment">// warning : in a case, dir(0.5,0.5,0.5) gives Ps=(-0.3333,0.0), The camera_create_ray(-0.3333,0.0) is never called after.</span></div>
<div class="line"> </div>
<div class="line">    fromRevMap[std::this_thread::get_id()] = FromRev(Ps);</div>
<div class="line">    <span class="comment">//PZ_INFO(&quot;---&gt; %f %f %d rev \n&quot;,Ps.x,Ps.y, std::this_thread::get_id());</span></div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Get the camera origin/direction for each pixel on the image. This will query the information to PresenZ in turn.</span></div>
<div class="line">camera_create_ray</div>
<div class="line">{</div>
<div class="line"> </div>
<div class="line">    multiCamData_t *data = GetLocalData(node);</div>
<div class="line">    <span class="keyword">const</span> AtCameraInput&amp; camInput = getCamInput(input);</div>
<div class="line">    AtCameraOutput&amp; camOutput = getCamOutput(output);</div>
<div class="line">    </div>
<div class="line">    camOutput.dOdx = AI_V3_ZERO;</div>
<div class="line">    camOutput.dOdy = AI_V3_ZERO;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">double</span> sy = (((double)data-&gt;renderSizeY - (<span class="keywordtype">double</span>)camInput.sy)); <span class="comment">//sy in in range [0, resy], but upside down.</span></div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> pixelX = AiClamp((<span class="keywordtype">double</span>)camInput.sx, 0.0, (<span class="keywordtype">double</span>)data-&gt;renderSizeX);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> pixelY = AiClamp(sy, 0.0, (<span class="keywordtype">double</span>)data-&gt;renderSizeY);</div>
<div class="line">    </div>
<div class="line">    </div>
<div class="line">    <span class="keyword">const</span> std::thread::id this_id = std::this_thread::get_id();</div>
<div class="line">    <span class="comment">// see &quot;camera_reverse_ray&quot; </span></div>
<div class="line">    <span class="keywordflow">if</span> (fromRevMap[this_id].rev == 1 &amp;&amp; camInput.sx == fromRevMap[this_id].sx &amp;&amp; camInput.sy == fromRevMap[this_id].sy) {</div>
<div class="line">        <span class="comment">//PZ_INFO(&quot;---&gt; %f %f %d rray  *\n&quot;, camInput.sx, camInput.sy, this_id);</span></div>
<div class="line">        <a class="code hl_struct" href="struct_presen_z_1_1_camera_1_1v4__1_1_1_pz_camera_ray.html">PresenZ::Camera::PzCameraRay</a> rayCtx = <a class="code hl_function" href="group___pz_camera_api.html#ga99f96383ca61a19c957ee512104d613e">PresenZ::Camera::PzGetSpecularRay</a>(pixelX, pixelY);</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">float</span> dsx = 2.0f / (data-&gt;renderSizeX * 3.f);  <span class="comment">// or (2/Rx)/3   </span></div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">float</span> dsy = 1.0f / data-&gt;renderSizeY;         <span class="comment">// or (2/Ry)/2</span></div>
<div class="line"> </div>
<div class="line">        camOutput.dDdx = AtVectorFromNozPoint(rayCtx.<a class="code hl_variable" href="struct_presen_z_1_1_camera_1_1v4__1_1_1_pz_camera_ray.html#a736153c8076e6040f9703e238e5b987c">dDdx</a> * dsx);</div>
<div class="line">        camOutput.dDdy = AtVectorFromNozPoint(rayCtx.<a class="code hl_variable" href="struct_presen_z_1_1_camera_1_1v4__1_1_1_pz_camera_ray.html#aeb84bfd699fd4a7c535d38f19449e6b4">dDdy</a> * dsy);</div>
<div class="line">        camOutput.weight = AI_RGB_WHITE ;</div>
<div class="line">        camOutput.dir = AtVectorFromNozPoint(rayCtx.<a class="code hl_variable" href="struct_presen_z_1_1_camera_1_1v4__1_1_1_pz_camera_ray.html#a7d4ae5b50b35b0b0e860ffe3192b05da">dir</a>);</div>
<div class="line">        camOutput.origin = AI_V3_ZERO;</div>
<div class="line">        camOutput.dOdx = AI_V3_ZERO;</div>
<div class="line">        camOutput.dOdy = AI_V3_ZERO;</div>
<div class="line"> </div>
<div class="line">        fromRevMap[this_id].rev = 0;</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    fromRevMap[this_id].rev = 0;</div>
<div class="line"> </div>
<div class="line">    <a class="code hl_struct" href="struct_presen_z_1_1_camera_1_1v4__1_1_1_pz_camera_ray.html">PresenZ::Camera::PzCameraRay</a> rayCtx;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">int</span> x = <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(pixelX), y = <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(pixelY);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    rayCtx = <a class="code hl_function" href="group___pz_camera_api.html#ga2efdc9059c503a12228edc4acea39bb7">PresenZ::Camera::PzGetCameraRay</a>(x, y);</div>
<div class="line">    <span class="keywordflow">if</span> (rayCtx.<a class="code hl_function" href="struct_presen_z_1_1_camera_1_1v4__1_1_1_pz_camera_ray.html#a5bc2a781be2586924afce4e4a4ea6697">isValid</a>()) {</div>
<div class="line">        <span class="comment">// Theses 1.5 dsx dsy factors has been empiricaly found </span></div>
<div class="line">        <span class="comment">// and match the ones from the Arnold cube3x2map camera in 720x480</span></div>
<div class="line">        <span class="comment">// const float mydsx = 2.0 / ( double(data-&gt;renderSizeX) * 1.5 );      // should be equal Ai_dsx in input // but I dnt know where these 1.5 factors are comming from !!!</span></div>
<div class="line">        <span class="comment">// const float mydsy = (2.0 / ( double(data-&gt;renderSizeY) * 1.5 * 1.5)); // should be equal Ai_dsy in input // same</span></div>
<div class="line">        <span class="comment">// in order to get the same derivativ (or mipmap level) than the arnold cube map camera, we had to :</span></div>
<div class="line">        <span class="comment">// dsx = mydsx</span></div>
<div class="line">        <span class="comment">// dsy = mydsy * 1.5</span></div>
<div class="line">        <span class="comment">// then finaly dsy,dsy was equal to :</span></div>
<div class="line">        <span class="comment">// const float dsx = 4.0 / ( data-&gt;renderSizeX * 3.);</span></div>
<div class="line">        <span class="comment">// const float dsy = 4.0 / ( data-&gt;renderSizeY * 3 );</span></div>
<div class="line"> </div>
<div class="line">        <span class="comment">// then we choose to take a 90deg perspectiva camera to set the derivative of our faces</span></div>
<div class="line">        <span class="comment">// this gives us</span></div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">float</span> dsx = 2.0f / (data-&gt;renderSizeX * 3.f);  <span class="comment">// or (2/Rx)/3   </span></div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">float</span> dsy = 1.0f / data-&gt;renderSizeY;         <span class="comment">// or (2/Ry)/2</span></div>
<div class="line"> </div>
<div class="line">        camOutput.dDdx = AtVectorFromNozPoint(rayCtx.<a class="code hl_variable" href="struct_presen_z_1_1_camera_1_1v4__1_1_1_pz_camera_ray.html#a736153c8076e6040f9703e238e5b987c">dDdx</a>*dsx);</div>
<div class="line">        camOutput.dDdy = AtVectorFromNozPoint(rayCtx.<a class="code hl_variable" href="struct_presen_z_1_1_camera_1_1v4__1_1_1_pz_camera_ray.html#aeb84bfd699fd4a7c535d38f19449e6b4">dDdy</a>*dsy);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> {</div>
<div class="line">        camOutput.dDdx = AI_V3_ONE; </div>
<div class="line">        camOutput.dDdy = AI_V3_ONE;</div>
<div class="line"> </div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    camOutput.weight = rayCtx.<a class="code hl_function" href="struct_presen_z_1_1_camera_1_1v4__1_1_1_pz_camera_ray.html#a5bc2a781be2586924afce4e4a4ea6697">isValid</a>() ? AI_RGB_WHITE : AI_RGB_BLACK;</div>
<div class="line">    camOutput.dir = rayCtx.<a class="code hl_function" href="struct_presen_z_1_1_camera_1_1v4__1_1_1_pz_camera_ray.html#a5bc2a781be2586924afce4e4a4ea6697">isValid</a>() ? AtVectorFromNozPoint(rayCtx.<a class="code hl_variable" href="struct_presen_z_1_1_camera_1_1v4__1_1_1_pz_camera_ray.html#a7d4ae5b50b35b0b0e860ffe3192b05da">dir</a>) : AI_V3_ZERO;</div>
<div class="line">    camOutput.origin = AtVectorFromNozPoint(rayCtx.<a class="code hl_variable" href="struct_presen_z_1_1_camera_1_1v4__1_1_1_pz_camera_ray.html#a3e1a826396726caf4930542970259fef">origin</a>);</div>
<div class="line">}</div>
<div class="ttc" id="a_pz_assert_8h_html"><div class="ttname"><a href="_pz_assert_8h.html">PzAssert.h</a></div><div class="ttdoc">Several helper macros for validating and debugging using PresenZ logging system.</div></div>
<div class="ttc" id="a_pz_camera_api_8h_html"><div class="ttname"><a href="_pz_camera_api_8h.html">PzCameraApi.h</a></div></div>
<div class="ttc" id="agroup___n_o_z__vector_html_ga347d85f3e636cf273a47949aa0613a8f"><div class="ttname"><a href="group___n_o_z__vector.html#ga347d85f3e636cf273a47949aa0613a8f">NozVector</a></div><div class="ttdeci">NozPoint NozVector</div><div class="ttdoc">3D vector (single precision)</div><div class="ttdef"><b>Definition</b> vector.h:451</div></div>
<div class="ttc" id="agroup___pz_camera_api_html_ga2efdc9059c503a12228edc4acea39bb7"><div class="ttname"><a href="group___pz_camera_api.html#ga2efdc9059c503a12228edc4acea39bb7">PresenZ::Camera::v4_1::PzGetCameraRay</a></div><div class="ttdeci">PzCameraRay PzGetCameraRay(const double &amp;x, const double &amp;y)</div><div class="ttdoc">Return a ray for a given pixel X/Y coordinate for the current PresenZ phase.</div></div>
<div class="ttc" id="agroup___pz_camera_api_html_ga99f96383ca61a19c957ee512104d613e"><div class="ttname"><a href="group___pz_camera_api.html#ga99f96383ca61a19c957ee512104d613e">PresenZ::Camera::v4_1::PzGetSpecularRay</a></div><div class="ttdeci">PzCameraRay PzGetSpecularRay(const double &amp;x, const double &amp;y)</div><div class="ttdoc">Return a ray as if it was cast from the specularPoint of the camera.</div></div>
<div class="ttc" id="agroup___pz_camera_api_html_gaa6fa25f6eba2c3d8f1cbfe59724601f1"><div class="ttname"><a href="group___pz_camera_api.html#gaa6fa25f6eba2c3d8f1cbfe59724601f1">PresenZ::Camera::v4_1::PzGetUVFromRay</a></div><div class="ttdeci">void PzGetUVFromRay(const NozVector &amp;dir, double &amp;uval, double &amp;vval)</div><div class="ttdoc">Given a direction (X,Y,Z), this will return the u,v screen coordinates of the cubeMap projection.</div></div>
<div class="ttc" id="anamespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s_html_a3104904c134a52357b85f763f6dfd48f"><div class="ttname"><a href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#a3104904c134a52357b85f763f6dfd48f">PresenZ::Phase::PRESENZ_VERSION_NS::Eye</a></div><div class="ttdeci">Eye</div><div class="ttdoc">Eye describes for which eye we are rendering, this is used in PresenZ to bend rays correctly.</div><div class="ttdef"><b>Definition</b> PzConstants.h:69</div></div>
<div class="ttc" id="anamespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s_html_a3104904c134a52357b85f763f6dfd48fa4280d82f18d6dbafdeb68c811112455e"><div class="ttname"><a href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#a3104904c134a52357b85f763f6dfd48fa4280d82f18d6dbafdeb68c811112455e">PresenZ::Phase::PRESENZ_VERSION_NS::RC_Left</a></div><div class="ttdeci">@ RC_Left</div><div class="ttdoc">render left eye</div><div class="ttdef"><b>Definition</b> PzConstants.h:73</div></div>
<div class="ttc" id="anamespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s_html_a3104904c134a52357b85f763f6dfd48fac2b22af1f16cebd2cc909767c763a713"><div class="ttname"><a href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#a3104904c134a52357b85f763f6dfd48fac2b22af1f16cebd2cc909767c763a713">PresenZ::Phase::PRESENZ_VERSION_NS::RC_Right</a></div><div class="ttdeci">@ RC_Right</div><div class="ttdoc">render right eye</div><div class="ttdef"><b>Definition</b> PzConstants.h:75</div></div>
<div class="ttc" id="astruct_presen_z_1_1_camera_1_1v4__1_1_1_pz_camera_ray_html"><div class="ttname"><a href="struct_presen_z_1_1_camera_1_1v4__1_1_1_pz_camera_ray.html">PresenZ::Camera::v4_1::PzCameraRay</a></div><div class="ttdoc">PzCameraRay defines the return value from PzGetRayDetectPhase() / PzGetRayRenderPhase() containing da...</div><div class="ttdef"><b>Definition</b> PzCameraApi.h:47</div></div>
<div class="ttc" id="astruct_presen_z_1_1_camera_1_1v4__1_1_1_pz_camera_ray_html_a3e1a826396726caf4930542970259fef"><div class="ttname"><a href="struct_presen_z_1_1_camera_1_1v4__1_1_1_pz_camera_ray.html#a3e1a826396726caf4930542970259fef">PresenZ::Camera::v4_1::PzCameraRay::origin</a></div><div class="ttdeci">NozPoint origin</div><div class="ttdoc">ray origin</div><div class="ttdef"><b>Definition</b> PzCameraApi.h:52</div></div>
<div class="ttc" id="astruct_presen_z_1_1_camera_1_1v4__1_1_1_pz_camera_ray_html_a5bc2a781be2586924afce4e4a4ea6697"><div class="ttname"><a href="struct_presen_z_1_1_camera_1_1v4__1_1_1_pz_camera_ray.html#a5bc2a781be2586924afce4e4a4ea6697">PresenZ::Camera::v4_1::PzCameraRay::isValid</a></div><div class="ttdeci">bool isValid() const</div><div class="ttdoc">Return if the structure is valid or not.</div><div class="ttdef"><b>Definition</b> PzCameraApi.h:62</div></div>
<div class="ttc" id="astruct_presen_z_1_1_camera_1_1v4__1_1_1_pz_camera_ray_html_a736153c8076e6040f9703e238e5b987c"><div class="ttname"><a href="struct_presen_z_1_1_camera_1_1v4__1_1_1_pz_camera_ray.html#a736153c8076e6040f9703e238e5b987c">PresenZ::Camera::v4_1::PzCameraRay::dDdx</a></div><div class="ttdeci">NozVector dDdx</div><div class="ttdoc">ray direction derivatives with respect to the x of target image</div><div class="ttdef"><b>Definition</b> PzCameraApi.h:56</div></div>
<div class="ttc" id="astruct_presen_z_1_1_camera_1_1v4__1_1_1_pz_camera_ray_html_a7d4ae5b50b35b0b0e860ffe3192b05da"><div class="ttname"><a href="struct_presen_z_1_1_camera_1_1v4__1_1_1_pz_camera_ray.html#a7d4ae5b50b35b0b0e860ffe3192b05da">PresenZ::Camera::v4_1::PzCameraRay::dir</a></div><div class="ttdeci">NozVector dir</div><div class="ttdoc">ray direction</div><div class="ttdef"><b>Definition</b> PzCameraApi.h:54</div></div>
<div class="ttc" id="astruct_presen_z_1_1_camera_1_1v4__1_1_1_pz_camera_ray_html_aeb84bfd699fd4a7c535d38f19449e6b4"><div class="ttname"><a href="struct_presen_z_1_1_camera_1_1v4__1_1_1_pz_camera_ray.html#aeb84bfd699fd4a7c535d38f19449e6b4">PresenZ::Camera::v4_1::PzCameraRay::dDdy</a></div><div class="ttdeci">NozVector dDdy</div><div class="ttdoc">ray direction derivatives with respect to the y of target image</div><div class="ttdef"><b>Definition</b> PzCameraApi.h:58</div></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md54"></a>
10.2 AOV shader</h1>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;arnoldWrapper.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="_pz_detect_sample_api_8h.html">API/PzDetectSampleApi.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="_pz_app_logger_8h.html">API/PzAppLogger.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="_pz_shading_api_8h.html">API/PzShadingApi.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="_pz_cryptomatte_api_8h.html">API/PzCryptomatteApi.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;presenz_global_parameters.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">namespace</span></div>
<div class="line">{</div>
<div class="line">    <span class="keyword">enum</span> PresenZAOVsParams</div>
<div class="line">    {</div>
<div class="line">        p_beauty,</div>
<div class="line">    };</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line">AI_SHADER_NODE_EXPORT_METHODS(PresenZPostAOVShaderMethods);</div>
<div class="line"> </div>
<div class="line">node_parameters</div>
<div class="line">{</div>
<div class="line">    AiMetaDataSetStr(nentry, NULL, <span class="stringliteral">&quot;_synonym&quot;</span>, <span class="stringliteral">&quot;PresenZPostAOVShader&quot;</span>);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span></div>
<div class="line">{</div>
<div class="line">    AtNode* renderCamera;</div>
<div class="line">    <span class="keywordtype">bool</span> renderIsolated;</div>
<div class="line">    <span class="keywordtype">float</span> maxDistance;</div>
<div class="line">    <span class="keywordtype">bool</span> hasEnv;</div>
<div class="line"> </div>
<div class="line">} postShaderData;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">struct </span>CryptoUserData</div>
<div class="line">{</div>
<div class="line">    CryptoUserData(AtShaderGlobals* input) : sg(input) {}</div>
<div class="line">    ~CryptoUserData(){}</div>
<div class="line">    AtShaderGlobals* sg;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">struct </span>ArnoldUserData : <span class="keyword">public</span> ArnoldUserDataBase</div>
<div class="line">{</div>
<div class="line">    ArnoldUserData(AtShaderGlobals* input) : ArnoldUserDataBase(input), sgout(0), hasEnv(false), maxDist(0) {</div>
<div class="line">        sgout = AiShaderGlobals();</div>
<div class="line">    }</div>
<div class="line">    ~ArnoldUserData()</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">if</span> (sgout)</div>
<div class="line">        {</div>
<div class="line">            AiShaderGlobalsDestroy(sgout);</div>
<div class="line">            sgout = 0;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    AtShaderGlobals *sgout;</div>
<div class="line">    <span class="keywordtype">bool</span> hasEnv;</div>
<div class="line">    <span class="keywordtype">float</span> maxDist;</div>
<div class="line"> </div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">inline</span> <span class="keywordtype">void</span> setOut(AtShaderGlobals* sg, <span class="keyword">const</span> AtNode* node, PresenZAOVsParams p_beauty) { sg-&gt;out.CLOSURE() = AiShaderEvalParamClosure(p_beauty); }</div>
<div class="line"><span class="keyword">inline</span> <span class="keywordtype">void</span> setOutBlack(AtShaderGlobals* sg) { sg-&gt;out.RGBA() = AI_RGBA_ZERO; }</div>
<div class="line"><span class="keyword">inline</span> <span class="keywordtype">void</span> setOutWhite(AtShaderGlobals* sg) { sg-&gt;out.RGBA() = AI_RGBA_WHITE; }</div>
<div class="line"><span class="keyword">inline</span> uint8_t getRecursionLevel(AtShaderGlobals* sg) { <span class="keywordflow">return</span> sg-&gt;bounces; }</div>
<div class="line"><span class="keyword">inline</span> uint8_t getReflectionLevel(AtShaderGlobals* sg) { <span class="keywordflow">return</span> sg-&gt;bounces_reflect; }</div>
<div class="line"><span class="keyword">inline</span> uint8_t getRefractionLevel(AtShaderGlobals* sg) { <span class="keywordflow">return</span> sg-&gt;bounces_transmit; }</div>
<div class="line"><span class="keyword">inline</span> uint8_t getDiffractionLevel(AtShaderGlobals* sg) { <span class="keywordflow">return</span> sg-&gt;bounces_diffuse; }</div>
<div class="line"><span class="keyword">inline</span> uint8_t getGlossyLevel(AtShaderGlobals* sg) { <span class="keywordflow">return</span> sg-&gt;bounces_specular; }</div>
<div class="line"><span class="keyword">inline</span> <span class="keywordtype">void</span> setVelocityVec(AtShaderGlobals* sg) { AtVector P1; AiShaderGlobalsGetPositionAtTime(sg, 1.0f, P1, NULL, NULL, NULL); AiAOVSetVec(sg, velocityAtStr, AtVector(P1.x - sg-&gt;P.x, P1.y - sg-&gt;P.y, P1.z - sg-&gt;P.z)); }</div>
<div class="line"><span class="keyword">inline</span> <span class="keywordtype">void</span> setShaderGlobals(AtShaderGlobals* sg, uint8_t Rr, uint8_t Rr_refl, uint8_t Rr_refr, uint8_t Rr_diff, uint8_t Rr_gloss) { sg-&gt;bounces = Rr; sg-&gt;bounces_reflect = Rr_refl; sg-&gt;bounces_transmit = Rr_refr; sg-&gt;bounces_diffuse = Rr_diff; sg-&gt;bounces_specular = Rr_gloss; }</div>
<div class="line"><span class="keyword">inline</span> <span class="keywordtype">void</span> setGlassMaterialAOV(AtShaderGlobals* sg) { AiAOVSetBool(sg, przGlassAtStr, <span class="keyword">true</span>); }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span>* GetNodeName(<span class="keywordtype">void</span>* ptr, <span class="keywordtype">void</span>* userData) {</div>
<div class="line">    <span class="keywordflow">return</span> AiNodeGetName((AtNode*)ptr);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span>* GetMaterialName(<span class="keywordtype">void</span>* ptr, <span class="keywordtype">void</span>* userData) {</div>
<div class="line">    CryptoUserData&amp; context = *<span class="keyword">reinterpret_cast&lt;</span>CryptoUserData*<span class="keyword">&gt;</span>(userData);</div>
<div class="line">    AtNode* shader = AiShaderGlobalsGetShader(context.sg);</div>
<div class="line">    <span class="keywordflow">return</span> AiNodeGetName(shader);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">bool</span> IsMaterialCacheable(<span class="keywordtype">void</span>* ptr, <span class="keywordtype">void</span>* userData) {</div>
<div class="line">    AtArray* shaders = AiNodeGetArray((AtNode*)ptr, shaderStr);</div>
<div class="line">    <span class="keywordflow">return</span> shaders ? AiArrayGetNumElements(shaders) == 1 : <span class="keyword">false</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">bool</span> ArnoldGetPreviousHitData(<a class="code hl_struct" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_pz_previous_detect_glass_sample.html">PresenZ::DetectSample::PzPreviousDetectGlassSample</a>&amp; prevSample, <span class="keywordtype">bool</span> save, <span class="keywordtype">void</span>* userData) {</div>
<div class="line">    ArnoldUserData&amp; context = *<span class="keyword">reinterpret_cast&lt;</span>ArnoldUserData*<span class="keyword">&gt;</span>(userData);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (save) {</div>
<div class="line">        <span class="comment">// We tag the ray so we can get the previous value at the next intersection</span></div>
<div class="line">        AiMessageSetVecFunc(context.sg, msgPreviousPStr, context.sg-&gt;P);</div>
<div class="line">        AiMessageSetVecFunc(context.sg, msgPreviousNStr, context.sg-&gt;Ng);</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> {</div>
<div class="line">        <span class="comment">//If we are coming from another glass, we get the value</span></div>
<div class="line">        <span class="keywordflow">if</span> (context.sg-&gt;transp_index &gt; 0) {</div>
<div class="line">            AtVector previousP, previousN;</div>
<div class="line">            AiMessageGetVecFunc(context.sg, msgPreviousPStr, &amp;previousP);</div>
<div class="line">            AiMessageGetVecFunc(context.sg, msgPreviousNStr, &amp;previousN);</div>
<div class="line">            prevSample.<a class="code hl_variable" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_pz_previous_detect_glass_sample.html#a39246df9bccc12078d74da138ecfbfa4">hitPoint</a> = NozPointFromAiPoint(previousP);</div>
<div class="line">            prevSample.<a class="code hl_variable" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_pz_previous_detect_glass_sample.html#a89abeba874f4701e91ff5ad7601dd164">hitNormal</a> = NozVectorFromAiVector(previousN);</div>
<div class="line">            <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">false</span>;   </div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">bool</span> ArnoldHitTest(<span class="keyword">const</span> <a class="code hl_struct" href="struct_noz_point.html">NozVector</a>&amp; origin, <span class="keyword">const</span> <a class="code hl_struct" href="struct_noz_point.html">NozVector</a>&amp; dir, <span class="keyword">const</span> <span class="keywordtype">double</span> dist, <a class="code hl_struct" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_ray_test_result.html">PresenZ::DetectSample::RayTestResult</a>&amp; out, <span class="keywordtype">void</span>* userData) {</div>
<div class="line">    ArnoldUserData&amp; context = *<span class="keyword">reinterpret_cast&lt;</span>ArnoldUserData*<span class="keyword">&gt;</span>(userData);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">bool</span> hitOk = <span class="keyword">false</span>;</div>
<div class="line"> </div>
<div class="line">    AtVector atOrigin = AtVectorFromNozVector(origin);</div>
<div class="line">    AtVector atDir = AtVectorFromNozVector(dir);</div>
<div class="line"> </div>
<div class="line">    AiShaderGlobalsSetTraceSet(context.sg, przGlassAtStr, <span class="keyword">false</span>);</div>
<div class="line">    AtRay probe = AiMakeRay(AI_RAY_CAMERA, atOrigin, &amp;atDir, (<span class="keywordtype">float</span>)dist, context.sg);</div>
<div class="line">    hitOk = AiTraceProbe(probe, context.sgout);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (hitOk)</div>
<div class="line">    {</div>
<div class="line"> </div>
<div class="line">        out.<a class="code hl_variable" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_ray_test_result.html#a9d3ba7a09d203fbcadc59723666e37fe">hit</a> = NozVectorFromAiVector(context.sgout-&gt;P);</div>
<div class="line">        out.<a class="code hl_variable" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_ray_test_result.html#a58649588b953a60c4ab3fb9b2143a87b">normal</a> = NozVectorFromAiVector(context.sgout-&gt;Ng);</div>
<div class="line">        out.<a class="code hl_variable" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_ray_test_result.html#a873684cefeb665f3d5e6b495de57fc0d">d</a> = context.sgout-&gt;Rl;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (context.hasEnv)</div>
<div class="line">    {</div>
<div class="line">        hitOk = <span class="keyword">true</span>;</div>
<div class="line">        <a class="code hl_struct" href="struct_noz_point.html">NozPoint</a> camPos = <a class="code hl_function" href="group___pz_phase_api.html#gaf907558c917636b2f0cad787e5b1dda3">PresenZ::Phase::PzGetZOVWorldPosition</a>();</div>
<div class="line"> </div>
<div class="line">        std::vector&lt;float&gt; distances = hit_sphere(camPos, context.maxDist, dir, origin);</div>
<div class="line">        out.<a class="code hl_variable" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_ray_test_result.html#a9d3ba7a09d203fbcadc59723666e37fe">hit</a> = origin + (dir * distances[0]);</div>
<div class="line">        out.<a class="code hl_variable" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_ray_test_result.html#a58649588b953a60c4ab3fb9b2143a87b">normal</a> = <a class="code hl_function" href="group___n_o_z__vector.html#ga19bf5d776ee066f688d5432fe9ce257f">NozVecNormalize</a>(-dir);</div>
<div class="line">        out.<a class="code hl_variable" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_ray_test_result.html#a873684cefeb665f3d5e6b495de57fc0d">d</a> = <a class="code hl_function" href="group___n_o_z__vector.html#gaec436ed5ffc599d804a9fd8fb464b70d">NozVecDist</a>(origin, out.<a class="code hl_variable" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_ray_test_result.html#a9d3ba7a09d203fbcadc59723666e37fe">hit</a>);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> hitOk;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">uint64_t ArnoldQueryFlags(uint64_t flags, <span class="keywordtype">void</span>* userData)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">const</span> ArnoldUserData&amp; context = *<span class="keyword">reinterpret_cast&lt;</span><span class="keyword">const </span>ArnoldUserData*<span class="keyword">&gt;</span>(userData);</div>
<div class="line">    <span class="keywordtype">int</span> retval = 0;</div>
<div class="line">    <span class="keywordflow">if</span> (flags)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">if</span>(AiNodeIs(context.sg-&gt;Op, curveAtStr) || IsTaggedAsHair(context.sg))</div>
<div class="line">            retval += 1;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> retval;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">shader_evaluate</div>
<div class="line">{</div>
<div class="line">    </div>
<div class="line">    postShaderData* data = (postShaderData*)AiNodeGetLocalData(node);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (PresenZ_data_struct::pass == PresenZ::Phase::Detect)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// Early out if it&#39;s not a camera ray.</span></div>
<div class="line">        <span class="keywordflow">if</span> (!(sg-&gt;Rt &amp; AI_RAY_CAMERA))</div>
<div class="line">            <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">bool</span> isCurve = AiNodeIs(sg-&gt;Op, curveAtStr);</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">const</span> uint32_t faceIndex = sg-&gt;fi;</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">bool</span> hemi = sg-&gt;fhemi;</div>
<div class="line">        <span class="comment">//sg-&gt;fhemi = false;</span></div>
<div class="line">        </div>
<div class="line">        <span class="keywordflow">if</span>(!isCurve)</div>
<div class="line">            sg-&gt;fi = UINT32_MAX;</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">if</span> (sg-&gt;fi == 0)</div>
<div class="line">                sg-&gt;fi = sg-&gt;fi+1;</div>
<div class="line">            <span class="keywordflow">else</span></div>
<div class="line">                sg-&gt;fi = 0;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        ArnoldUserData userData(sg);</div>
<div class="line">        </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">        <a class="code hl_struct" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_pz_detect_sample.html">PresenZ::DetectSample::PzDetectSample</a> sample;</div>
<div class="line">        <a class="code hl_struct" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_pz_previous_detect_glass_sample.html">PresenZ::DetectSample::PzPreviousDetectGlassSample</a> previousSample;</div>
<div class="line">        sample.<a class="code hl_variable" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_pz_detect_sample.html#a75f8ddf992db0cfc3cd1aa024086b6f3">pixelX</a> = sg-&gt;x;</div>
<div class="line">        sample.<a class="code hl_variable" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_pz_detect_sample.html#aaa0423628e784003c3f5754ca1e56e70">pixelY</a> = sg-&gt;y;</div>
<div class="line">        sample.<a class="code hl_variable" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_pz_detect_sample.html#a4c9257ffdd839b215aabfba5f05fa02e">hitNormal</a> = NozPointFromAiPoint(sg-&gt;Ng);</div>
<div class="line">        sample.<a class="code hl_variable" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_pz_detect_sample.html#a39246df9bccc12078d74da138ecfbfa4">hitPoint</a> = NozPointFromAiPoint(sg-&gt;P);      </div>
<div class="line">        <a class="code hl_function" href="group___pz_detect_sample_api.html#gaac4c7d95f316fc322a4cc36dd5b09e58">PresenZ::DetectSample::PzMatchSampleIndex</a>(sample, NozPointFromAiPoint(sg-&gt;Ro));</div>
<div class="line">        <span class="comment">// so yup, this bad boy right above is there to recompute the sample index from the ray direction.</span></div>
<div class="line">        <span class="comment">// because apparently some indices trown from the camera doesn&#39;t come with the same number in the shader</span></div>
<div class="line">        <span class="comment">//</span></div>
<div class="line">        <span class="comment">// This might be due to the fact that before... some camera ray was not really trown to the scene but was just evaluated for the adaptiveSubdivision/displacement calculation </span></div>
<div class="line">        <span class="comment">// now these subdiv/disp ray are taken in account by PresenZ, so we&#39;are not wasting PresenZ ray and indices anymore. </span></div>
<div class="line">        </div>
<div class="line">        <span class="keywordflow">if</span> (IsTaggedAsHair(sg))</div>
<div class="line">        {</div>
<div class="line">            sample.<a class="code hl_variable" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_pz_detect_sample.html#ad50b77be6452fcd203fa25771dd4f69e">isHair</a> = <span class="keyword">true</span>;</div>
<div class="line">            sample.<a class="code hl_variable" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_pz_detect_sample.html#a4c9257ffdd839b215aabfba5f05fa02e">hitNormal</a> = <a class="code hl_struct" href="struct_noz_point.html">NozPoint</a>(0.0f);</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (IsTaggedAsGlass(sg) == <span class="keyword">true</span>) {</div>
<div class="line">            sample.<a class="code hl_variable" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_pz_detect_sample.html#ae89f8742850b3f5fb55f23ccf9a55d86">transpType</a> = PresenZ::DetectSample::DST_glass;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (IsTaggedAsChaotic(sg) == <span class="keyword">true</span>)</div>
<div class="line">            sample.<a class="code hl_variable" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_pz_detect_sample.html#a8a33ba6ff4f3da7799e33a2827f9d297">isChaotic</a> = <span class="keyword">true</span>;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">bool</span> notisolated = (data-&gt;renderIsolated ) &amp;&amp; (!IsTaggedAsRenderIsolated(sg));</div>
<div class="line">        <span class="keywordflow">if</span> (notisolated) { <span class="comment">// not isolated And render isolated on... </span></div>
<div class="line">            <span class="keywordflow">return</span>;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">        <span class="comment">//const AtNodeEntry* entry = AiNodeGetNodeEntry(sg-&gt;Op);</span></div>
<div class="line">        <span class="keywordflow">if</span>(sg-&gt;Rl &gt;= data-&gt;maxDistance)</div>
<div class="line">        {</div>
<div class="line">            <a class="code hl_struct" href="struct_noz_point.html">NozPoint</a> camPos = <a class="code hl_function" href="group___pz_phase_api.html#gaf907558c917636b2f0cad787e5b1dda3">PresenZ::Phase::PzGetZOVWorldPosition</a>();</div>
<div class="line">            <a class="code hl_struct" href="struct_noz_point.html">NozVector</a> rayDir(sg-&gt;Rd.x, sg-&gt;Rd.y, sg-&gt;Rd.z);</div>
<div class="line">            <a class="code hl_struct" href="struct_noz_point.html">NozVector</a> rayOrigin = NozPointFromAiPoint(sg-&gt;Ro);</div>
<div class="line">            std::vector&lt;float&gt; distances = hit_sphere(camPos, data-&gt;maxDistance, rayDir, rayOrigin);</div>
<div class="line">            sample.<a class="code hl_variable" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_pz_detect_sample.html#a39246df9bccc12078d74da138ecfbfa4">hitPoint</a> = rayOrigin + (rayDir * distances[0]);</div>
<div class="line">            sample.<a class="code hl_variable" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_pz_detect_sample.html#a4c9257ffdd839b215aabfba5f05fa02e">hitNormal</a> = -rayDir;</div>
<div class="line">            userData.hasEnv = <span class="keyword">true</span>;</div>
<div class="line">            userData.maxDist = data-&gt;maxDistance;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <a class="code hl_struct" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_ray_test_interface.html">PresenZ::DetectSample::RayTestInterface</a> probe(&amp;userData, ArnoldHitTest, ArnoldQueryFlags, ArnoldSaveDetect, ArnoldGetPreviousHitData);</div>
<div class="line">        <a class="code hl_function" href="group___pz_detect_sample_api.html#ga50a309149dfd3120e636960a329bba53">PresenZ::DetectSample::PzProcessDetectSample</a>(&amp;probe, sample, sg-&gt;tid);</div>
<div class="line"> </div>
<div class="line">        sg-&gt;fhemi = hemi;</div>
<div class="line">        sg-&gt;fi = faceIndex;</div>
<div class="line">      </div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (PresenZ_data_struct::pass == PresenZ::Phase::Detect_Reflection)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// Early out if it&#39;s not a camera ray.</span></div>
<div class="line">        <span class="keywordflow">if</span> (!(sg-&gt;Rt &amp; AI_RAY_CAMERA))</div>
<div class="line">            <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">        <a class="code hl_struct" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_pz_detect_sample.html">PresenZ::DetectSample::PzDetectSample</a> sample;</div>
<div class="line">        sample.<a class="code hl_variable" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_pz_detect_sample.html#a75f8ddf992db0cfc3cd1aa024086b6f3">pixelX</a> = sg-&gt;x;</div>
<div class="line">        sample.<a class="code hl_variable" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_pz_detect_sample.html#aaa0423628e784003c3f5754ca1e56e70">pixelY</a> = sg-&gt;y;</div>
<div class="line">        sample.<a class="code hl_variable" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_pz_detect_sample.html#a4c9257ffdd839b215aabfba5f05fa02e">hitNormal</a> = NozPointFromAiPoint(sg-&gt;Ng);</div>
<div class="line">        sample.<a class="code hl_variable" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_pz_detect_sample.html#a39246df9bccc12078d74da138ecfbfa4">hitPoint</a> = NozPointFromAiPoint(sg-&gt;P);</div>
<div class="line">        <span class="comment">//sample.sampleIndex = sg-&gt;si;</span></div>
<div class="line">        <a class="code hl_function" href="group___pz_detect_sample_api.html#gaac4c7d95f316fc322a4cc36dd5b09e58">PresenZ::DetectSample::PzMatchSampleIndex</a>(sample, NozPointFromAiPoint(sg-&gt;Ro));</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (AiNodeIs(sg-&gt;Op, curveAtStr) || IsTaggedAsHair(sg))</div>
<div class="line">        {</div>
<div class="line">            sample.<a class="code hl_variable" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_pz_detect_sample.html#ad50b77be6452fcd203fa25771dd4f69e">isHair</a> = <span class="keyword">true</span>;</div>
<div class="line">            sample.<a class="code hl_variable" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_pz_detect_sample.html#a4c9257ffdd839b215aabfba5f05fa02e">hitNormal</a> = <a class="code hl_struct" href="struct_noz_point.html">NozPoint</a>(0.0f);</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (IsTaggedAsGlass(sg) == <span class="keyword">true</span>) {</div>
<div class="line">            sample.<a class="code hl_variable" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_pz_detect_sample.html#ae89f8742850b3f5fb55f23ccf9a55d86">transpType</a> = PresenZ::DetectSample::DST_glass;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (IsTaggedAsChaotic(sg) == <span class="keyword">true</span>)</div>
<div class="line">            sample.<a class="code hl_variable" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_pz_detect_sample.html#a8a33ba6ff4f3da7799e33a2827f9d297">isChaotic</a> = <span class="keyword">true</span>;</div>
<div class="line"> </div>
<div class="line">        </div>
<div class="line">        ArnoldUserData userData(sg);</div>
<div class="line">        <a class="code hl_struct" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_ray_test_interface.html">PresenZ::DetectSample::RayTestInterface</a> probe(&amp;userData, ArnoldHitTest, ArnoldQueryFlags, <span class="keyword">nullptr</span>, <span class="keyword">nullptr</span>);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">        <a class="code hl_function" href="group___pz_detect_sample_api.html#ga50a309149dfd3120e636960a329bba53">PresenZ::DetectSample::PzProcessDetectSample</a>(&amp;probe, sample, sg-&gt;tid);</div>
<div class="line"> </div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">if</span> (!(sg-&gt;Rt &amp; AI_RAY_CAMERA))</div>
<div class="line">            <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (PresenZ_data_struct::pass == PresenZ::Phase::Render_Reflection)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">if</span>(sg-&gt;bounces == 1)</div>
<div class="line">            {</div>
<div class="line">                AiAOVSetVec(sg, rayDirAOVStr, sg-&gt;Rd);</div>
<div class="line">                AiAOVSetVec(sg, rayOrigAOVStr, sg-&gt;Ro);</div>
<div class="line">                AiAOVSetVec(sg, NCameraAtStr, sg-&gt;Ng);</div>
<div class="line">            }</div>
<div class="line"> </div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">        {</div>
<div class="line"> </div>
<div class="line">            AiAOVSetVec(sg, rayDirAOVStr, sg-&gt;Rd);</div>
<div class="line">            AiAOVSetVec(sg, rayOrigAOVStr, sg-&gt;Ro);</div>
<div class="line">            <span class="keywordflow">if</span> (sg-&gt;Rl &gt;= data-&gt;maxDistance)</div>
<div class="line">                AiAOVSetVec(sg, NCameraAtStr, AiV3Normalize(-sg-&gt;Rd));</div>
<div class="line">            <span class="keywordflow">else</span></div>
<div class="line">                AiAOVSetVec(sg, NCameraAtStr, sg-&gt;Ng);</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (sg-&gt;sc == AI_CONTEXT_SURFACE) {</div>
<div class="line">            <span class="keywordflow">if</span> (PresenZ_data_struct::do_crypto) {</div>
<div class="line"> </div>
<div class="line">                <span class="keywordtype">float</span> nsp_hash, obj_hash, mat_hash;</div>
<div class="line"> </div>
<div class="line">                CryptoUserData userData(sg);</div>
<div class="line"> </div>
<div class="line">                <a class="code hl_struct" href="struct_presen_z_1_1_cryptomatte_1_1v4__1_1_1_crypto_mattet_interface.html">PresenZ::Cryptomatte::CryptoMattetInterface</a> getCryptoInfo((<span class="keywordtype">void</span>*)sg-&gt;Op, &amp;userData, GetNodeName, GetMaterialName, IsMaterialCacheable);</div>
<div class="line">                <a class="code hl_function" href="namespace_presen_z_1_1_cryptomatte_1_1v4__1.html#ad219ee7803206d54bc0d96297c647c69">PresenZ::Cryptomatte::PzProcessNode</a>(&amp;getCryptoInfo, sg-&gt;tid, nsp_hash, obj_hash, mat_hash);</div>
<div class="line">                AiAOVSetFlt(sg, crypto_objectAOVStr, obj_hash);</div>
<div class="line">                AiAOVSetFlt(sg, crypto_materialAOVStr, mat_hash);</div>
<div class="line">                AiAOVSetFlt(sg, crypto_assetAOVStr, nsp_hash);</div>
<div class="line"> </div>
<div class="line">                AtVector P1, P2;</div>
<div class="line">                AiShaderGlobalsGetPositionAtTime(sg, 0.0f, P1, NULL, NULL, NULL);</div>
<div class="line">                AiShaderGlobalsGetPositionAtTime(sg, 1.0f, P2, NULL, NULL, NULL);</div>
<div class="line">                AiAOVSetVec(sg, velocityAtStr, AtVector(P2.x - P1.x, P2.y - P1.y, P2.z - P1.z));</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">node_initialize</div>
<div class="line">{</div>
<div class="line">    postShaderData *data = (postShaderData*)AiMalloc(<span class="keyword">sizeof</span>(postShaderData));</div>
<div class="line">    AiNodeSetLocalData(node, data);</div>
<div class="line">    <span class="keyword">const</span> AtUniverse* universe = AiNodeGetUniverse(node);</div>
<div class="line">    AtNode* camera = AiUniverseGetCamera(universe);</div>
<div class="line">    data-&gt;renderCamera = camera;</div>
<div class="line"><span class="preprocessor">#if AI_VERSION_ARCH_NUM &gt;= 7 &amp;&amp; AI_VERSION_MAJOR_NUM &gt;= 4</span></div>
<div class="line">    AiNodeAddDependency(node, camera, farClipStr);</div>
<div class="line">    AiNodeAddDependency(node, camera, renderIsolatedStr);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">node_update</div>
<div class="line">{</div>
<div class="line"> </div>
<div class="line">    postShaderData *data = (postShaderData*)AiNodeGetLocalData(node);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> AtUniverse* universe = AiNodeGetUniverse(node);</div>
<div class="line">    AtNode* pzCamera = AiUniverseGetCamera(universe);</div>
<div class="line"><span class="preprocessor">#if AI_VERSION_ARCH_NUM &gt;= 7 &amp;&amp; AI_VERSION_MAJOR_NUM &gt;= 4</span></div>
<div class="line">    AiNodeClearDependency(node, data-&gt;renderCamera);</div>
<div class="line">    AiNodeAddDependency(node, pzCamera, farClipStr);</div>
<div class="line">    AiNodeAddDependency(node, pzCamera, renderIsolatedStr);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">    data-&gt;renderCamera = pzCamera;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (AiNodeIs(pzCamera, PresenzCameraName))</div>
<div class="line">    {</div>
<div class="line">        data-&gt;renderIsolated = AiNodeGetBool(pzCamera, renderIsolatedStr);</div>
<div class="line">        data-&gt;maxDistance = AiNodeGetFlt(pzCamera, farClipStr);;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">        <a class="code hl_define" href="group___pz_app_logger.html#gafd8b815a0f76d6b121f44f62d5730ee4">PZ_ERROR</a>(<span class="stringliteral">&quot;[PresenZ] Could not find the PresenZ camera.&quot;</span>);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">node_finish</div>
<div class="line">{</div>
<div class="line">}</div>
<div class="ttc" id="a_pz_app_logger_8h_html"><div class="ttname"><a href="_pz_app_logger_8h.html">PzAppLogger.h</a></div></div>
<div class="ttc" id="a_pz_cryptomatte_api_8h_html"><div class="ttname"><a href="_pz_cryptomatte_api_8h.html">PzCryptomatteApi.h</a></div></div>
<div class="ttc" id="a_pz_detect_sample_api_8h_html"><div class="ttname"><a href="_pz_detect_sample_api_8h.html">PzDetectSampleApi.h</a></div></div>
<div class="ttc" id="a_pz_shading_api_8h_html"><div class="ttname"><a href="_pz_shading_api_8h.html">PzShadingApi.h</a></div></div>
<div class="ttc" id="agroup___n_o_z__vector_html_ga19bf5d776ee066f688d5432fe9ce257f"><div class="ttname"><a href="group___n_o_z__vector.html#ga19bf5d776ee066f688d5432fe9ce257f">NozVecNormalize</a></div><div class="ttdeci">NozVector NozVecNormalize(const NozVector &amp;a)</div><div class="ttdoc">Normalize a vector: a / ||a||.</div><div class="ttdef"><b>Definition</b> vector.h:638</div></div>
<div class="ttc" id="agroup___n_o_z__vector_html_gaec436ed5ffc599d804a9fd8fb464b70d"><div class="ttname"><a href="group___n_o_z__vector.html#gaec436ed5ffc599d804a9fd8fb464b70d">NozVecDist</a></div><div class="ttdeci">float NozVecDist(const NozPoint2 &amp;p1, const NozPoint2 &amp;p2)</div><div class="ttdoc">Distance between two points: ||p1-p2||.</div><div class="ttdef"><b>Definition</b> vector.h:496</div></div>
<div class="ttc" id="agroup___pz_app_logger_html_gafd8b815a0f76d6b121f44f62d5730ee4"><div class="ttname"><a href="group___pz_app_logger.html#gafd8b815a0f76d6b121f44f62d5730ee4">PZ_ERROR</a></div><div class="ttdeci">#define PZ_ERROR(a,...)</div><div class="ttdoc">Printf analog define that forwards an ERROR message to PresenZ logging system.</div><div class="ttdef"><b>Definition</b> PzAppLogger.h:214</div></div>
<div class="ttc" id="agroup___pz_detect_sample_api_html_ga50a309149dfd3120e636960a329bba53"><div class="ttname"><a href="group___pz_detect_sample_api.html#ga50a309149dfd3120e636960a329bba53">PresenZ::DetectSample::v4_1::PzProcessDetectSample</a></div><div class="ttdeci">NozRGBA PzProcessDetectSample(RayTestInterface *intfPtr, const PzDetectSample &amp;sample, const size_t &amp;threadIndex)</div><div class="ttdoc">During the detection phase, ray intersections need to be notified to PresenZ through PzProcessDetectS...</div></div>
<div class="ttc" id="agroup___pz_detect_sample_api_html_gaac4c7d95f316fc322a4cc36dd5b09e58"><div class="ttname"><a href="group___pz_detect_sample_api.html#gaac4c7d95f316fc322a4cc36dd5b09e58">PresenZ::DetectSample::v4_1::PzMatchSampleIndex</a></div><div class="ttdeci">void PzMatchSampleIndex(PzDetectSample &amp;sample, const NozPoint &amp;rayOriginWorldPos)</div><div class="ttdoc">PzDetectSample needs to know what is the sampleIndex.</div></div>
<div class="ttc" id="agroup___pz_phase_api_html_gaf907558c917636b2f0cad787e5b1dda3"><div class="ttname"><a href="group___pz_phase_api.html#gaf907558c917636b2f0cad787e5b1dda3">PresenZ::Phase::v4_1::PzGetZOVWorldPosition</a></div><div class="ttdeci">NozPoint PzGetZOVWorldPosition()</div><div class="ttdoc">Get ZOV world position.</div></div>
<div class="ttc" id="anamespace_presen_z_1_1_cryptomatte_1_1v4__1_html_ad219ee7803206d54bc0d96297c647c69"><div class="ttname"><a href="namespace_presen_z_1_1_cryptomatte_1_1v4__1.html#ad219ee7803206d54bc0d96297c647c69">PresenZ::Cryptomatte::v4_1::PzProcessNode</a></div><div class="ttdeci">void PzProcessNode(CryptoMattetInterface *intf, const size_t &amp;threadIndex, float &amp;nsp_hash_clr, float &amp;obj_hash_clr, float &amp;mat_hash_clr)</div></div>
<div class="ttc" id="astruct_noz_point_html"><div class="ttname"><a href="struct_noz_point.html">NozPoint</a></div><div class="ttdoc">3D point (single precision)</div><div class="ttdef"><b>Definition</b> vector.h:27</div></div>
<div class="ttc" id="astruct_presen_z_1_1_cryptomatte_1_1v4__1_1_1_crypto_mattet_interface_html"><div class="ttname"><a href="struct_presen_z_1_1_cryptomatte_1_1v4__1_1_1_crypto_mattet_interface.html">PresenZ::Cryptomatte::v4_1::CryptoMattetInterface</a></div><div class="ttdef"><b>Definition</b> PzCryptomatteApi.h:28</div></div>
<div class="ttc" id="astruct_presen_z_1_1_detect_sample_1_1v4__1_1_1_pz_detect_sample_html"><div class="ttname"><a href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_pz_detect_sample.html">PresenZ::DetectSample::v4_1::PzDetectSample</a></div><div class="ttdoc">PzDetectSample defines the structure of a detection sample.</div><div class="ttdef"><b>Definition</b> PzDetectSampleApi.h:117</div></div>
<div class="ttc" id="astruct_presen_z_1_1_detect_sample_1_1v4__1_1_1_pz_detect_sample_html_a39246df9bccc12078d74da138ecfbfa4"><div class="ttname"><a href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_pz_detect_sample.html#a39246df9bccc12078d74da138ecfbfa4">PresenZ::DetectSample::v4_1::PzDetectSample::hitPoint</a></div><div class="ttdeci">NozPoint hitPoint</div><div class="ttdoc">Hitpoint in the sample coordinates (see PzSetSampleSpace(Space renderSpace)).</div><div class="ttdef"><b>Definition</b> PzDetectSampleApi.h:136</div></div>
<div class="ttc" id="astruct_presen_z_1_1_detect_sample_1_1v4__1_1_1_pz_detect_sample_html_a4c9257ffdd839b215aabfba5f05fa02e"><div class="ttname"><a href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_pz_detect_sample.html#a4c9257ffdd839b215aabfba5f05fa02e">PresenZ::DetectSample::v4_1::PzDetectSample::hitNormal</a></div><div class="ttdeci">NozPoint hitNormal</div><div class="ttdoc">Normal of the hit point in the sample coordinates (see PzSetSampleSpace(Space renderSpace)).</div><div class="ttdef"><b>Definition</b> PzDetectSampleApi.h:134</div></div>
<div class="ttc" id="astruct_presen_z_1_1_detect_sample_1_1v4__1_1_1_pz_detect_sample_html_a75f8ddf992db0cfc3cd1aa024086b6f3"><div class="ttname"><a href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_pz_detect_sample.html#a75f8ddf992db0cfc3cd1aa024086b6f3">PresenZ::DetectSample::v4_1::PzDetectSample::pixelX</a></div><div class="ttdeci">int pixelX</div><div class="ttdoc">Render image x coordinate.</div><div class="ttdef"><b>Definition</b> PzDetectSampleApi.h:126</div></div>
<div class="ttc" id="astruct_presen_z_1_1_detect_sample_1_1v4__1_1_1_pz_detect_sample_html_a8a33ba6ff4f3da7799e33a2827f9d297"><div class="ttname"><a href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_pz_detect_sample.html#a8a33ba6ff4f3da7799e33a2827f9d297">PresenZ::DetectSample::v4_1::PzDetectSample::isChaotic</a></div><div class="ttdeci">bool isChaotic</div><div class="ttdoc">Is the hit object a chaotic geometry.</div><div class="ttdef"><b>Definition</b> PzDetectSampleApi.h:122</div></div>
<div class="ttc" id="astruct_presen_z_1_1_detect_sample_1_1v4__1_1_1_pz_detect_sample_html_aaa0423628e784003c3f5754ca1e56e70"><div class="ttname"><a href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_pz_detect_sample.html#aaa0423628e784003c3f5754ca1e56e70">PresenZ::DetectSample::v4_1::PzDetectSample::pixelY</a></div><div class="ttdeci">int pixelY</div><div class="ttdoc">Render image y coordinate.</div><div class="ttdef"><b>Definition</b> PzDetectSampleApi.h:128</div></div>
<div class="ttc" id="astruct_presen_z_1_1_detect_sample_1_1v4__1_1_1_pz_detect_sample_html_ad50b77be6452fcd203fa25771dd4f69e"><div class="ttname"><a href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_pz_detect_sample.html#ad50b77be6452fcd203fa25771dd4f69e">PresenZ::DetectSample::v4_1::PzDetectSample::isHair</a></div><div class="ttdeci">bool isHair</div><div class="ttdoc">Is the hit object tagged as hair.</div><div class="ttdef"><b>Definition</b> PzDetectSampleApi.h:120</div></div>
<div class="ttc" id="astruct_presen_z_1_1_detect_sample_1_1v4__1_1_1_pz_detect_sample_html_ae89f8742850b3f5fb55f23ccf9a55d86"><div class="ttname"><a href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_pz_detect_sample.html#ae89f8742850b3f5fb55f23ccf9a55d86">PresenZ::DetectSample::v4_1::PzDetectSample::transpType</a></div><div class="ttdeci">DetectSample_transp transpType</div><div class="ttdoc">Is the hit object opque/glass/semi-Transp.</div><div class="ttdef"><b>Definition</b> PzDetectSampleApi.h:132</div></div>
<div class="ttc" id="astruct_presen_z_1_1_detect_sample_1_1v4__1_1_1_pz_previous_detect_glass_sample_html"><div class="ttname"><a href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_pz_previous_detect_glass_sample.html">PresenZ::DetectSample::v4_1::PzPreviousDetectGlassSample</a></div><div class="ttdoc">Store the previous intersection along a camera ray.</div><div class="ttdef"><b>Definition</b> PzDetectSampleApi.h:82</div></div>
<div class="ttc" id="astruct_presen_z_1_1_detect_sample_1_1v4__1_1_1_pz_previous_detect_glass_sample_html_a39246df9bccc12078d74da138ecfbfa4"><div class="ttname"><a href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_pz_previous_detect_glass_sample.html#a39246df9bccc12078d74da138ecfbfa4">PresenZ::DetectSample::v4_1::PzPreviousDetectGlassSample::hitPoint</a></div><div class="ttdeci">NozPoint hitPoint</div><div class="ttdef"><b>Definition</b> PzDetectSampleApi.h:84</div></div>
<div class="ttc" id="astruct_presen_z_1_1_detect_sample_1_1v4__1_1_1_pz_previous_detect_glass_sample_html_a89abeba874f4701e91ff5ad7601dd164"><div class="ttname"><a href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_pz_previous_detect_glass_sample.html#a89abeba874f4701e91ff5ad7601dd164">PresenZ::DetectSample::v4_1::PzPreviousDetectGlassSample::hitNormal</a></div><div class="ttdeci">NozVector hitNormal</div><div class="ttdef"><b>Definition</b> PzDetectSampleApi.h:85</div></div>
<div class="ttc" id="astruct_presen_z_1_1_detect_sample_1_1v4__1_1_1_ray_test_interface_html"><div class="ttname"><a href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_ray_test_interface.html">PresenZ::DetectSample::v4_1::RayTestInterface</a></div><div class="ttdoc">This interface is forwarded to PzProcessDetectSample() so that PresenZ can perform an additional visi...</div><div class="ttdef"><b>Definition</b> PzDetectSampleApi.h:99</div></div>
<div class="ttc" id="astruct_presen_z_1_1_detect_sample_1_1v4__1_1_1_ray_test_result_html"><div class="ttname"><a href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_ray_test_result.html">PresenZ::DetectSample::v4_1::RayTestResult</a></div><div class="ttdoc">RayTestResult is a simplistic structure that holds the 3D hitpoint of the ray, the normal at that poi...</div><div class="ttdef"><b>Definition</b> PzDetectSampleApi.h:46</div></div>
<div class="ttc" id="astruct_presen_z_1_1_detect_sample_1_1v4__1_1_1_ray_test_result_html_a58649588b953a60c4ab3fb9b2143a87b"><div class="ttname"><a href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_ray_test_result.html#a58649588b953a60c4ab3fb9b2143a87b">PresenZ::DetectSample::v4_1::RayTestResult::normal</a></div><div class="ttdeci">NozVector normal</div><div class="ttdoc">normal at the hitpoint.</div><div class="ttdef"><b>Definition</b> PzDetectSampleApi.h:50</div></div>
<div class="ttc" id="astruct_presen_z_1_1_detect_sample_1_1v4__1_1_1_ray_test_result_html_a873684cefeb665f3d5e6b495de57fc0d"><div class="ttname"><a href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_ray_test_result.html#a873684cefeb665f3d5e6b495de57fc0d">PresenZ::DetectSample::v4_1::RayTestResult::d</a></div><div class="ttdeci">double d</div><div class="ttdoc">distance of ray.</div><div class="ttdef"><b>Definition</b> PzDetectSampleApi.h:52</div></div>
<div class="ttc" id="astruct_presen_z_1_1_detect_sample_1_1v4__1_1_1_ray_test_result_html_a9d3ba7a09d203fbcadc59723666e37fe"><div class="ttname"><a href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_ray_test_result.html#a9d3ba7a09d203fbcadc59723666e37fe">PresenZ::DetectSample::v4_1::RayTestResult::hit</a></div><div class="ttdeci">NozPoint hit</div><div class="ttdoc">3D hitpoint.</div><div class="ttdef"><b>Definition</b> PzDetectSampleApi.h:48</div></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md55"></a>
10.3 Intersection shader</h1>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;arnoldWrapper.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="_pz_detect_sample_api_8h.html">API/PzDetectSampleApi.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="_pz_app_logger_8h.html">API/PzAppLogger.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="_pz_shading_api_8h.html">API/PzShadingApi.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;presenz_global_parameters.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">namespace</span></div>
<div class="line">{</div>
<div class="line">    <span class="keyword">enum</span> PresenZAOVsParams</div>
<div class="line">    {</div>
<div class="line">        p_beauty,</div>
<div class="line">        p_opacity</div>
<div class="line">    };</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line">AI_SHADER_NODE_EXPORT_METHODS(PresenZShaderMtd);</div>
<div class="line"> </div>
<div class="line">node_parameters</div>
<div class="line">{</div>
<div class="line">    AiParameterClosure(<span class="stringliteral">&quot;beauty&quot;</span>);</div>
<div class="line">    AiParameterRGB(<span class="stringliteral">&quot;opacity&quot;</span>, 1.0, 1.0, 1.0);</div>
<div class="line">    AiMetaDataSetInt(nentry, <span class="stringliteral">&quot;opacity&quot;</span>, <span class="stringliteral">&quot;opacity_term&quot;</span>, 1);</div>
<div class="line">    AiMetaDataSetInt(nentry, <span class="stringliteral">&quot;beauty&quot;</span>, <span class="stringliteral">&quot;opacity_term&quot;</span>, 0);</div>
<div class="line">    AiMetaDataSetStr(nentry, NULL, <span class="stringliteral">&quot;_synonym&quot;</span>, <span class="stringliteral">&quot;PresenZShader&quot;</span>);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span></div>
<div class="line">{</div>
<div class="line">    AtNode* renderCamera;</div>
<div class="line">    PresenZ::Phase::Eye eye;</div>
<div class="line">    <span class="keywordtype">bool</span> renderIsolated;</div>
<div class="line">    uint8_t stereoRightEye;</div>
<div class="line"> </div>
<div class="line">} ShaderData;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">inline</span> <span class="keywordtype">void</span> setOut(AtShaderGlobals* sg, <span class="keyword">const</span> AtNode* node, PresenZAOVsParams p_beauty) { sg-&gt;out.CLOSURE() = AiShaderEvalParamClosure(p_beauty); }</div>
<div class="line"><span class="keyword">inline</span> <span class="keywordtype">void</span> setOutBlack(AtShaderGlobals* sg) { sg-&gt;out.RGBA() = AI_RGBA_ZERO; }</div>
<div class="line"><span class="keyword">inline</span> <span class="keywordtype">void</span> setOutWhite(AtShaderGlobals* sg) { sg-&gt;out.RGBA() = AI_RGBA_WHITE; }</div>
<div class="line"><span class="keyword">inline</span> uint8_t getRecursionLevel(AtShaderGlobals* sg) { <span class="keywordflow">return</span> sg-&gt;bounces; }</div>
<div class="line"><span class="keyword">inline</span> uint8_t getReflectionLevel(AtShaderGlobals* sg) { <span class="keywordflow">return</span> sg-&gt;bounces_reflect; }</div>
<div class="line"><span class="keyword">inline</span> uint8_t getRefractionLevel(AtShaderGlobals* sg) { <span class="keywordflow">return</span> sg-&gt;bounces_transmit; }</div>
<div class="line"><span class="keyword">inline</span> uint8_t getDiffractionLevel(AtShaderGlobals* sg) { <span class="keywordflow">return</span> sg-&gt;bounces_diffuse; }</div>
<div class="line"><span class="keyword">inline</span> uint8_t getGlossyLevel(AtShaderGlobals* sg) { <span class="keywordflow">return</span> sg-&gt;bounces_specular; }</div>
<div class="line"><span class="keyword">inline</span> <span class="keywordtype">void</span> setVelocityVec(AtShaderGlobals* sg) { AtVector P1; AiShaderGlobalsGetPositionAtTime(sg, 1.0f, P1, NULL, NULL, NULL); AiAOVSetVec(sg, velocityAtStr, AtVector(P1.x - sg-&gt;P.x, P1.y - sg-&gt;P.y, P1.z - sg-&gt;P.z)); }</div>
<div class="line"><span class="keyword">inline</span> <span class="keywordtype">void</span> setShaderGlobals(AtShaderGlobals* sg, uint8_t Rr, uint8_t Rr_refl, uint8_t Rr_refr, uint8_t Rr_diff, uint8_t Rr_gloss) { sg-&gt;bounces = Rr; sg-&gt;bounces_reflect = Rr_refl; sg-&gt;bounces_transmit = Rr_refr; sg-&gt;bounces_diffuse = Rr_diff; sg-&gt;bounces_specular = Rr_gloss; }</div>
<div class="line"><span class="keyword">inline</span> <span class="keywordtype">void</span> setGlassMaterialAOV(AtShaderGlobals* sg) { AiAOVSetBool(sg, przGlassAtStr, <span class="keyword">true</span>); }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">bool</span> SolveLinearSystem2x2(<span class="keyword">const</span> <span class="keywordtype">float</span> A[2][2], <span class="keyword">const</span> <span class="keywordtype">float</span> B[2], <span class="keywordtype">float</span> *x0, <span class="keywordtype">float</span> *x1)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">float</span> det = A[0][0] * A[1][1] - A[0][1] * A[1][0];</div>
<div class="line">    <span class="keywordflow">if</span> (fabsf(det) &lt; 1e-10f)</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">    *x0 = (A[1][1] * B[0] - A[0][1] * B[1]) / det;</div>
<div class="line">    *x1 = (A[0][0] * B[1] - A[1][0] * B[0]) / det;</div>
<div class="line">    <span class="keywordflow">if</span> (isnan(*x0) || isnan(*x1))</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> computeUVDifferentials(<span class="keyword">const</span> AtVector&amp; nn,  <span class="keyword">const</span> AtVector &amp;dPdx, <span class="keyword">const</span> AtVector &amp;dPdy, <span class="keyword">const</span> AtVector &amp;dPdu, <span class="keyword">const</span> AtVector &amp;dPdv,</div>
<div class="line">    <span class="keywordtype">float</span> &amp;dudx,<span class="keywordtype">float</span> &amp;dudy, <span class="keywordtype">float</span> &amp;dvdx, <span class="keywordtype">float</span> &amp;dvdy  ) {</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">float</span> A[2][2], Bx[2], By[2];</div>
<div class="line">    <span class="keywordtype">int</span> axes[2];</div>
<div class="line">    <span class="keywordflow">if</span> (fabsf(nn.x) &gt; fabsf(nn.y) &amp;&amp; fabsf(nn.x) &gt; fabsf(nn.z)) {</div>
<div class="line">        axes[0] = 1; axes[1] = 2;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fabsf(nn.y) &gt; fabsf(nn.z)) {</div>
<div class="line">        axes[0] = 0; axes[1] = 2;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> {</div>
<div class="line">        axes[0] = 0; axes[1] = 1;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    A[0][0] = dPdu[axes[0]];</div>
<div class="line">    A[0][1] = dPdv[axes[0]];</div>
<div class="line">    A[1][0] = dPdu[axes[1]];</div>
<div class="line">    A[1][1] = dPdv[axes[1]];</div>
<div class="line">    Bx[0] = dPdx[axes[0]];</div>
<div class="line">    Bx[1] = dPdx[axes[1]];</div>
<div class="line">    By[0] = dPdy[axes[0]];</div>
<div class="line">    By[1] = dPdy[axes[1]];</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (!SolveLinearSystem2x2(A, Bx, &amp;dudx, &amp;dvdx)) {</div>
<div class="line">        dudx = 0.; dvdx = 0.;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (!SolveLinearSystem2x2(A, By, &amp;dudy, &amp;dvdy)) {</div>
<div class="line">        dudy = 0.; dvdy = 0.;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">AtVector GetPlaneIntersect(<span class="keyword">const</span> AtVector&amp; planePoint, <span class="keyword">const</span> AtVector&amp; planeNormal, <span class="keyword">const</span> AtVector&amp; linePoint, <span class="keyword">const</span> AtVector&amp; lineDir)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> denom = AiV3Dot(planeNormal, lineDir);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (fabs(denom) &gt; FLT_EPSILON) {</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> p0l0x = <span class="keyword">static_cast&lt;</span><span class="keywordtype">double</span><span class="keyword">&gt;</span>(planePoint.x) - <span class="keyword">static_cast&lt;</span><span class="keywordtype">double</span><span class="keyword">&gt;</span>(linePoint.x);</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> p0l0y = <span class="keyword">static_cast&lt;</span><span class="keywordtype">double</span><span class="keyword">&gt;</span>(planePoint.y) - <span class="keyword">static_cast&lt;</span><span class="keywordtype">double</span><span class="keyword">&gt;</span>(linePoint.y);</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> p0l0z = <span class="keyword">static_cast&lt;</span><span class="keywordtype">double</span><span class="keyword">&gt;</span>(planePoint.z) - <span class="keyword">static_cast&lt;</span><span class="keywordtype">double</span><span class="keyword">&gt;</span>(linePoint.z);</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> num = p0l0x * planeNormal.x + p0l0y * planeNormal.y + p0l0z * planeNormal.z;</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> t = num / denom;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">return</span> linePoint + (float)t * lineDir;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> planePoint;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">bool</span> isStereoRightEye(uint8_t stereoRightEye, <span class="keywordtype">bool</span> stereoTag) {</div>
<div class="line">    <span class="keywordflow">if</span> (stereoRightEye == 0) <span class="keywordflow">return</span> <span class="keyword">true</span>; <span class="comment">// render all surfaces, ignore stereo tag</span></div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (stereoRightEye == 1 &amp;&amp; stereoTag ) <span class="keywordflow">return</span> <span class="keyword">true</span>; <span class="comment">// render tagged surface in stereo</span></div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (stereoRightEye == 2 &amp;&amp; !stereoTag) <span class="keywordflow">return</span> <span class="keyword">true</span>; <span class="comment">// render tagged surface in stereo</span></div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">shader_evaluate</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (PresenZ_data_struct::pass == PresenZ::Phase::Render || PresenZ_data_struct::pass == PresenZ::Phase::Render_Reflection)</div>
<div class="line">    {</div>
<div class="line">        ShaderData *data = (ShaderData*)AiNodeGetLocalData(node);</div>
<div class="line"> </div>
<div class="line">        AiAOVSetVec(sg, NCameraAtStr, sg-&gt;Ng);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">        </div>
<div class="line"> </div>
<div class="line">        <span class="comment">// for left eye you should always evaluate shader, for right eye we need to check that hitpoint is not too far</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">        <span class="comment">// If it&#39;s not a camera ray, we are just evaluating the shader</span></div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (!(sg-&gt;Rt &amp; AI_RAY_CAMERA))</div>
<div class="line">        {</div>
<div class="line">            <span class="comment">// Transmission case.</span></div>
<div class="line">            <span class="comment">/*if (sg-&gt;Rt &amp; AI_RAY_ALL_TRANSMIT)</span></div>
<div class="line"><span class="comment">            {</span></div>
<div class="line"><span class="comment">                bool fromGlass = false;</span></div>
<div class="line"><span class="comment">                bool found = AiStateGetMsgBool(przGlassAtStr, &amp;fromGlass);</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">                if (found)</span></div>
<div class="line"><span class="comment">                {</span></div>
<div class="line"><span class="comment">                // If  we are coming from a glass, and we are not, we don&#39;t want the refraction, so we return nothing.</span></div>
<div class="line"><span class="comment">                if (IsTaggedAsGlass(sg-&gt;Op) == false)</span></div>
<div class="line"><span class="comment">                    return;</span></div>
<div class="line"><span class="comment">                else</span></div>
<div class="line"><span class="comment">                    sg-&gt;out.CLOSURE() = closureList;</span></div>
<div class="line"><span class="comment">                }</span></div>
<div class="line"><span class="comment">                else</span></div>
<div class="line"><span class="comment">                    sg-&gt;out.CLOSURE() = closureList;</span></div>
<div class="line"><span class="comment">                    return;</span></div>
<div class="line"><span class="comment">            }</span></div>
<div class="line"><span class="comment">            else*/</span></div>
<div class="line">                sg-&gt;out.CLOSURE() = AiShaderEvalParamClosure(p_beauty);</div>
<div class="line"> </div>
<div class="line">        }</div>
<div class="line">        <span class="comment">// Camera ray...</span></div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">        {</div>
<div class="line"> </div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">int</span> originalx = sg-&gt;x;</div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">int</span> originaly = sg-&gt;y;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">bool</span> notisolated = (data-&gt;renderIsolated) &amp;&amp; (!IsTaggedAsRenderIsolated(sg));</div>
<div class="line">            <span class="keywordflow">if</span> (notisolated) {</div>
<div class="line">                sg-&gt;out.CLOSURE() = AiClosureMatte(sg);</div>
<div class="line">                <span class="keywordflow">return</span>;</div>
<div class="line">            }</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">if</span> (<a class="code hl_function" href="group___pz_shading_api.html#gaaf3dc36dbde17e31135afc1c646c919b">PresenZ::Shading::PzIsValidEvaluation</a>(originalx, originaly, sg-&gt;Rl, IsTaggedAsChaotic(sg)) == <span class="keyword">false</span>)</div>
<div class="line">            {</div>
<div class="line">                sg-&gt;out.CLOSURE() = AiClosureMatte(sg);</div>
<div class="line">                <span class="keywordflow">return</span>;</div>
<div class="line">            }</div>
<div class="line"> </div>
<div class="line">            <span class="keyword">const</span> AtVector originalRd = sg-&gt;Rd;</div>
<div class="line">            <a class="code hl_struct" href="struct_noz_point.html">NozPoint</a> bestCamWS = <a class="code hl_function" href="group___pz_shading_api.html#ga68ddb9e076ae6fec33b50e3ae245142e">PresenZ::Shading::PzGetBestCameraWSPosition</a>(originalx, originaly);</div>
<div class="line">            <a class="code hl_struct" href="struct_noz_point.html">NozVector</a> bestCamWsDir = <a class="code hl_function" href="group___n_o_z__vector.html#ga19bf5d776ee066f688d5432fe9ce257f">NozVecNormalize</a>( NozPointFromAiPoint(sg-&gt;P) - bestCamWS );</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">            <a class="code hl_struct" href="struct_presen_z_1_1_shading_1_1v4__1_1_1_pz_bend_ray.html">PresenZ::Shading::PzBendRay</a> bendRay = <a class="code hl_function" href="group___pz_shading_api.html#ga912fcf8b7c785ab9694088699ea26fe8">PresenZ::Shading::PzGetBendRayRenderPhase</a>(</div>
<div class="line">                data-&gt;eye, </div>
<div class="line">                NozPointFromAiPoint(sg-&gt;Ng),</div>
<div class="line">                NozPointFromAiPoint(sg-&gt;Ns), </div>
<div class="line">                NozPointFromAiPoint(originalRd),</div>
<div class="line">                NozPointFromAiPoint(sg-&gt;P), </div>
<div class="line">                sg-&gt;Rl,</div>
<div class="line">                bestCamWS); <span class="comment">// eye, normal, worldcameradir, worldpoint, hitdistance</span></div>
<div class="line"> </div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">bool</span> stereoRightEye = isStereoRightEye(data-&gt;stereoRightEye, IsTaggedAsStereoRightEye(sg) );</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">if</span> (data-&gt;eye == PresenZ::Phase::Eye::RC_Left || (data-&gt;eye == PresenZ::Phase::Eye::RC_Right &amp;&amp; stereoRightEye &amp;&amp; bendRay.<a class="code hl_variable" href="struct_presen_z_1_1_shading_1_1v4__1_1_1_pz_bend_ray.html#a25d24f3fc254ac9d7f43b9be22fadd34">isStereoScopic</a>))</div>
<div class="line">            {</div>
<div class="line">                <span class="keywordtype">int</span> realX = 0;</div>
<div class="line">                <span class="keywordtype">int</span> realY = 0;</div>
<div class="line">                <span class="keywordflow">if</span> (<a class="code hl_function" href="group___pz_shading_api.html#ga32e916e803525c250e7f4121b5f42af7">PresenZ::Shading::PzGetPixelCoordinates</a>(originalx, originaly, realX, realY)) {</div>
<div class="line">                    sg-&gt;x = realX;</div>
<div class="line">                    sg-&gt;y = realY;</div>
<div class="line">                }</div>
<div class="line"> </div>
<div class="line">                <a class="code hl_struct" href="struct_noz_point2.html">NozVector2</a> inPixelPos = <a class="code hl_function" href="group___pz_shading_api.html#ga5414e03628523cb82f83ea25de2a4797">PresenZ::Shading::PzGetXYInPixelPosition</a>(originalx, originaly, sg-&gt;si);</div>
<div class="line">                sg-&gt;px = inPixelPos.<a class="code hl_variable" href="group___n_o_z__vector.html#gad0da36b2558901e21e7a30f6c227a45e">x</a>;</div>
<div class="line">                sg-&gt;py = inPixelPos.<a class="code hl_variable" href="group___n_o_z__vector.html#gaa4f0d3eebc3c443f9be81bf48561a217">y</a>;</div>
<div class="line">                </div>
<div class="line">                sg-&gt;Rd = AtVectorFromNozPoint(bendRay.<a class="code hl_variable" href="struct_presen_z_1_1_shading_1_1v4__1_1_1_pz_bend_ray.html#a7d4ae5b50b35b0b0e860ffe3192b05da">dir</a>);</div>
<div class="line">                sg-&gt;Rl = (float)bendRay.<a class="code hl_variable" href="struct_presen_z_1_1_shading_1_1v4__1_1_1_pz_bend_ray.html#ab44f0a3b38724b93889067c8dc6e9469">wHitDistance</a>;</div>
<div class="line">                sg-&gt;Ro = sg-&gt;P - AtVectorFromNozPoint(bendRay.<a class="code hl_variable" href="struct_presen_z_1_1_shading_1_1v4__1_1_1_pz_bend_ray.html#a7d4ae5b50b35b0b0e860ffe3192b05da">dir</a>) * (float)bendRay.<a class="code hl_variable" href="struct_presen_z_1_1_shading_1_1v4__1_1_1_pz_bend_ray.html#ab44f0a3b38724b93889067c8dc6e9469">wHitDistance</a>;</div>
<div class="line">                <span class="keywordtype">double</span> resX = 0.;</div>
<div class="line">                <span class="keywordtype">double</span> resY = 0.;</div>
<div class="line">                <a class="code hl_function" href="group___pz_shading_api.html#ga812673fa2416a14c90f2d32818b00af0">PresenZ::Shading::PzGetRenderingResolution</a>(resX, resY);</div>
<div class="line"> </div>
<div class="line">                <span class="comment">// Previously we took the arnold cube map camera derivative into reference </span></div>
<div class="line">                <span class="comment">// but we found out they were a bit too long, this was making arnold using too high mipmap level</span></div>
<div class="line">                </div>
<div class="line">                <span class="comment">// const float dsx = 2.0 / (resX * 1.5);    // matching camera screenspace derivatives </span></div>
<div class="line">                <span class="comment">// const float dsy = ( 2.0 / (resY * 1.5 * 1.5) ) * 1.5 ;</span></div>
<div class="line">                <span class="comment">// equaling this</span></div>
<div class="line">                <span class="comment">// const float dsx = 4.0 / (resX * 3.);</span></div>
<div class="line">                <span class="comment">// const float dsy = 4.0 / (resY * 3 );</span></div>
<div class="line">                </div>
<div class="line">                <span class="comment">// now we are using a 90deg perspective camera derivative as a refenrece </span></div>
<div class="line">                <span class="comment">// to set the derivative for each face of our cube map projection. </span></div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">float</span> dsx = 2.0f / ((float)resX * 3.f) ;  <span class="comment">// or (2/Ry)/3   </span></div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">float</span> dsy = 1.0f / (float)resY;         <span class="comment">// or (2/Ry)/2</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">                sg-&gt;dDdx = AtVectorFromNozVector( bendRay.<a class="code hl_variable" href="struct_presen_z_1_1_shading_1_1v4__1_1_1_pz_bend_ray.html#a736153c8076e6040f9703e238e5b987c">dDdx</a> ) *  dsx;</div>
<div class="line">                sg-&gt;dDdy = AtVectorFromNozVector( bendRay.<a class="code hl_variable" href="struct_presen_z_1_1_shading_1_1v4__1_1_1_pz_bend_ray.html#aeb84bfd699fd4a7c535d38f19449e6b4">dDdy</a> ) *  dsy;</div>
<div class="line">                </div>
<div class="line">                AtVector sgrd = AtVectorFromNozPoint(bestCamWsDir);</div>
<div class="line">                AtVector sgro = AtVectorFromNozPoint(bestCamWS);</div>
<div class="line"> </div>
<div class="line">                sg-&gt;dPdx = GetPlaneIntersect(sg-&gt;P, sg-&gt;Ng, sgro, sgrd + sg-&gt;dDdx) - sg-&gt;P;</div>
<div class="line">                sg-&gt;dPdy = GetPlaneIntersect(sg-&gt;P, sg-&gt;Ng, sgro, sgrd + sg-&gt;dDdy) - sg-&gt;P;</div>
<div class="line">                </div>
<div class="line"> </div>
<div class="line">                computeUVDifferentials(sg-&gt;Ng, sg-&gt;dPdx, sg-&gt;dPdy, sg-&gt;dPdu, sg-&gt;dPdv, sg-&gt;dudx, sg-&gt;dudy, sg-&gt;dvdx, sg-&gt;dvdy);</div>
<div class="line"> </div>
<div class="line">                AtClosureList closureList = AiShaderEvalParamClosure(p_beauty);</div>
<div class="line">                AtRGB opacity = AiShaderEvalParamOpacity(p_opacity);</div>
<div class="line">                closureList.add(AiClosureTransparent(sg, AI_RGB_WHITE - opacity));</div>
<div class="line">                closureList *= opacity;</div>
<div class="line"> </div>
<div class="line">                <span class="keywordflow">if</span> (IsTaggedAsGlass(sg) == <span class="keyword">true</span>)</div>
<div class="line">                {</div>
<div class="line">                    <span class="keywordflow">if</span> (PresenZ_data_struct::pass == PresenZ::Phase::Render_Reflection)</div>
<div class="line">                    {</div>
<div class="line">                        AtScrSample sample;</div>
<div class="line">                        AtVector reflectionRay = AiReflect(originalRd, sg-&gt;Nf);</div>
<div class="line">                        AtRay ray = AiMakeRay(AI_RAY_CAMERA, sg-&gt;P, &amp;reflectionRay, AI_INFINITE, sg);</div>
<div class="line">                        AiTrace(ray, AI_RGB_WHITE, sample);</div>
<div class="line"> </div>
<div class="line">                        AiAOVSetFlt(sg, Z_Refl_AtStr, sample.z);</div>
<div class="line">                        AtRGBA rgba = sample.color;</div>
<div class="line">                        rgba.a = sample.alpha;</div>
<div class="line">                        AiAOVSetRGBA(sg, RGBA_Refl_AtStr, rgba);</div>
<div class="line">                        AiAOVSetVec(sg, NHitPoint_Refl_AtStr, sample.point);</div>
<div class="line">                        sg-&gt;out.CLOSURE() = AiClosureMatte(sg);</div>
<div class="line">                        <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">                    }</div>
<div class="line">                    <span class="comment">// If we are tagged as glass, we are making the object transparent so our ray continue.</span></div>
<div class="line">                    <span class="comment">// We also tag the ray for further depth != camera.</span></div>
<div class="line">                    setGlassMaterialAOV(sg);</div>
<div class="line">                    AiStateSetMsgBool(przGlassAtStr, <span class="keyword">true</span>);</div>
<div class="line"> </div>
<div class="line">                    <span class="keywordtype">bool</span> goThrough = <span class="keyword">false</span>;</div>
<div class="line">                    <span class="keyword">const</span> <span class="keywordtype">bool</span> shadeCurrentPoint = <a class="code hl_function" href="group___pz_shading_api.html#ga8be962a3456154722009774be47f9834">PresenZ::Shading::PzShouldShade</a>(NozPointFromAiPoint(sg-&gt;P), NozPointFromAiPoint(sg-&gt;Ns), originalx, originaly, goThrough);</div>
<div class="line">                    <span class="keywordflow">if</span> (!shadeCurrentPoint) {</div>
<div class="line">                        <span class="keywordflow">if</span> (goThrough)</div>
<div class="line">                            sg-&gt;out.CLOSURE() = AiClosureTransparent(sg);</div>
<div class="line">                        <span class="keywordflow">else</span></div>
<div class="line">                            sg-&gt;out.CLOSURE() = AiClosureMatte(sg);</div>
<div class="line">                        <span class="keywordflow">return</span>;</div>
<div class="line">                    }                   </div>
<div class="line">                    </div>
<div class="line">                    <span class="keywordflow">if</span> (goThrough){</div>
<div class="line">                        closureList.add(AiClosureTransparent(sg));</div>
<div class="line">                    }</div>
<div class="line">                    sg-&gt;out.CLOSURE() = closureList;</div>
<div class="line">                    <span class="keywordflow">return</span>;</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">else</span></div>
<div class="line">                {</div>
<div class="line">                    <span class="comment">// Normal evaluation</span></div>
<div class="line">                    sg-&gt;out.CLOSURE()= closureList;</div>
<div class="line">                    <span class="keywordflow">return</span>;</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (IsTaggedAsGlass(sg) == <span class="keyword">true</span>)</div>
<div class="line">            {</div>
<div class="line">                sg-&gt;out.CLOSURE() = AiClosureTransparent(sg);</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span></div>
<div class="line">                sg-&gt;out.CLOSURE() = AiClosureMatte(sg);</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// Early out if it&#39;s not a camera ray.</span></div>
<div class="line">        <span class="keywordflow">if</span> (!(sg-&gt;Rt &amp; AI_RAY_CAMERA))</div>
<div class="line">            <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">        AiAOVSetInt(sg, pixelYStr, -1);</div>
<div class="line">        AiAOVSetInt(sg, pixelXStr, -1);</div>
<div class="line">        AiAOVSetInt(sg, detectTBestCamStr, -1);</div>
<div class="line">        <span class="keywordflow">if</span> (IsTaggedAsGlass(sg) == <span class="keyword">true</span>)</div>
<div class="line">        {</div>
<div class="line">            sg-&gt;out.CLOSURE() = AiClosureTransparent(sg, AI_RGB_50GREY);</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">            sg-&gt;out.CLOSURE();</div>
<div class="line">    }</div>
<div class="line"><span class="keywordflow">return</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">node_initialize</div>
<div class="line">{</div>
<div class="line">    ShaderData *data = (ShaderData*)AiMalloc(<span class="keyword">sizeof</span>(ShaderData));</div>
<div class="line">    AiNodeSetLocalData(node, data);</div>
<div class="line"> </div>
<div class="line">    AtNode* camera = AiUniverseGetCamera(AiNodeGetUniverse(node));</div>
<div class="line">    data-&gt;renderCamera = camera;</div>
<div class="line"><span class="preprocessor">#if AI_VERSION_ARCH_NUM &gt;= 7 &amp;&amp; AI_VERSION_MAJOR_NUM &gt;= 4</span></div>
<div class="line">    AiNodeAddDependency(node, camera, renderingEyeStr);</div>
<div class="line">    AiNodeAddDependency(node, camera, stereoRightEyeStr);</div>
<div class="line">    AiNodeAddDependency(node, camera, renderIsolatedStr);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> </div>
<div class="line">    <a class="code hl_define" href="group___pz_app_logger.html#gad79dc53c351eeff13f901542c29f6e57">PZ_DEBUG</a>(<span class="stringliteral">&quot;node initialized&quot;</span>);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">node_update</div>
<div class="line">{</div>
<div class="line">    ShaderData *data = (ShaderData*)AiNodeGetLocalData(node);</div>
<div class="line">    AtNode* pzCamera = AiUniverseGetCamera(AiNodeGetUniverse(node));</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#if AI_VERSION_ARCH_NUM &gt;= 7 &amp;&amp; AI_VERSION_MAJOR_NUM &gt;= 4</span></div>
<div class="line">    AiNodeClearDependency(node, data-&gt;renderCamera);</div>
<div class="line">    AiNodeAddDependency(node, pzCamera, renderingEyeStr);</div>
<div class="line">    AiNodeAddDependency(node, pzCamera, stereoRightEyeStr);</div>
<div class="line">    AiNodeAddDependency(node, pzCamera, renderIsolatedStr);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">    data-&gt;renderCamera = pzCamera;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (AiNodeIs(pzCamera, PresenzCameraName))</div>
<div class="line">    {</div>
<div class="line">        data-&gt;eye = AiNodeGetInt(pzCamera, renderingEyeStr) ? PresenZ::Phase::Eye::RC_Right : PresenZ::Phase::Eye::RC_Left;</div>
<div class="line">        data-&gt;renderIsolated = AiNodeGetBool(pzCamera, renderIsolatedStr);</div>
<div class="line">        data-&gt;stereoRightEye = AiNodeGetInt(pzCamera, stereoRightEyeStr);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">        <a class="code hl_define" href="group___pz_app_logger.html#gafd8b815a0f76d6b121f44f62d5730ee4">PZ_ERROR</a>(<span class="stringliteral">&quot;[PresenZ] Could not find the PresenZ camera.&quot;</span>);</div>
<div class="line">    </div>
<div class="line">    <a class="code hl_define" href="group___pz_app_logger.html#gad79dc53c351eeff13f901542c29f6e57">PZ_DEBUG</a>(<span class="stringliteral">&quot;node updated&quot;</span>);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">node_finish</div>
<div class="line">{</div>
<div class="line">    ShaderData *data = (ShaderData*)AiNodeGetLocalData(node);</div>
<div class="line">    AiFree(data);</div>
<div class="line">}</div>
<div class="ttc" id="agroup___n_o_z__vector_html_gaa4f0d3eebc3c443f9be81bf48561a217"><div class="ttname"><a href="group___n_o_z__vector.html#gaa4f0d3eebc3c443f9be81bf48561a217">NozPoint2::y</a></div><div class="ttdeci">float y</div><div class="ttdoc">y</div><div class="ttdef"><b>Definition</b> vector.h:255</div></div>
<div class="ttc" id="agroup___n_o_z__vector_html_gad0da36b2558901e21e7a30f6c227a45e"><div class="ttname"><a href="group___n_o_z__vector.html#gad0da36b2558901e21e7a30f6c227a45e">NozPoint2::x</a></div><div class="ttdeci">float x</div><div class="ttdoc">x</div><div class="ttdef"><b>Definition</b> vector.h:253</div></div>
<div class="ttc" id="agroup___pz_app_logger_html_gad79dc53c351eeff13f901542c29f6e57"><div class="ttname"><a href="group___pz_app_logger.html#gad79dc53c351eeff13f901542c29f6e57">PZ_DEBUG</a></div><div class="ttdeci">#define PZ_DEBUG(a,...)</div><div class="ttdoc">Printf analog define that forwards a DEBUG message to PresenZ logging system.</div><div class="ttdef"><b>Definition</b> PzAppLogger.h:217</div></div>
<div class="ttc" id="agroup___pz_shading_api_html_ga32e916e803525c250e7f4121b5f42af7"><div class="ttname"><a href="group___pz_shading_api.html#ga32e916e803525c250e7f4121b5f42af7">PresenZ::Shading::v4_1::PzGetPixelCoordinates</a></div><div class="ttdeci">bool PzGetPixelCoordinates(const int &amp;pixelX, const int &amp;pixelY, int &amp;outPixelX, int &amp;outPixelY)</div><div class="ttdoc">Get the position in the cubemap of the current rendered pixel.</div></div>
<div class="ttc" id="agroup___pz_shading_api_html_ga5414e03628523cb82f83ea25de2a4797"><div class="ttname"><a href="group___pz_shading_api.html#ga5414e03628523cb82f83ea25de2a4797">PresenZ::Shading::v4_1::PzGetXYInPixelPosition</a></div><div class="ttdeci">NozVector2 PzGetXYInPixelPosition(const int &amp;pixelX, const int &amp;pixelY, const size_t &amp;pixelSampleIndex)</div><div class="ttdoc">Get the X/Y position in [0,1[ inside the rendered pixel.</div></div>
<div class="ttc" id="agroup___pz_shading_api_html_ga68ddb9e076ae6fec33b50e3ae245142e"><div class="ttname"><a href="group___pz_shading_api.html#ga68ddb9e076ae6fec33b50e3ae245142e">PresenZ::Shading::v4_1::PzGetBestCameraWSPosition</a></div><div class="ttdeci">NozPoint PzGetBestCameraWSPosition(const int &amp;pixelX, const int &amp;pixelY)</div><div class="ttdoc">Get the world position of the current scanning camera (the best camera selected for scanning this poi...</div></div>
<div class="ttc" id="agroup___pz_shading_api_html_ga812673fa2416a14c90f2d32818b00af0"><div class="ttname"><a href="group___pz_shading_api.html#ga812673fa2416a14c90f2d32818b00af0">PresenZ::Shading::v4_1::PzGetRenderingResolution</a></div><div class="ttdeci">void PzGetRenderingResolution(double &amp;resX, double &amp;resY)</div><div class="ttdoc">Query PresenZ about the current rendering resolution.</div></div>
<div class="ttc" id="agroup___pz_shading_api_html_ga8be962a3456154722009774be47f9834"><div class="ttname"><a href="group___pz_shading_api.html#ga8be962a3456154722009774be47f9834">PresenZ::Shading::v4_1::PzShouldShade</a></div><div class="ttdeci">bool PzShouldShade(const NozPoint &amp;hitPointWorld, const NozVector &amp;hitPointNormal, const double &amp;x, const double &amp;y, bool &amp;goThrough)</div><div class="ttdoc">Query PresenZ to know if the current location should be shaded as Transparent or not.</div></div>
<div class="ttc" id="agroup___pz_shading_api_html_ga912fcf8b7c785ab9694088699ea26fe8"><div class="ttname"><a href="group___pz_shading_api.html#ga912fcf8b7c785ab9694088699ea26fe8">PresenZ::Shading::v4_1::PzGetBendRayRenderPhase</a></div><div class="ttdeci">PzBendRay PzGetBendRayRenderPhase(const PresenZ::Phase::Eye &amp;eye, const NozVector &amp;GNormal, const NozVector &amp;normal, const NozVector &amp;CameraDir, const NozPoint &amp;hitPoint, const double &amp;hitDistance, const NozVector &amp;bestCamWsPos)</div><div class="ttdoc">Get a ray bent from the specular point to override the shading context.</div></div>
<div class="ttc" id="agroup___pz_shading_api_html_gaaf3dc36dbde17e31135afc1c646c919b"><div class="ttname"><a href="group___pz_shading_api.html#gaaf3dc36dbde17e31135afc1c646c919b">PresenZ::Shading::v4_1::PzIsValidEvaluation</a></div><div class="ttdeci">bool PzIsValidEvaluation(const int &amp;pixelX, const int &amp;pixelY, const double &amp;hitDistance, bool isChaotic=false, bool isVolumetric=false)</div><div class="ttdoc">Query PresenZ to know if the current location should be shaded.</div></div>
<div class="ttc" id="astruct_noz_point2_html"><div class="ttname"><a href="struct_noz_point2.html">NozPoint2</a></div><div class="ttdoc">2D point</div><div class="ttdef"><b>Definition</b> vector.h:251</div></div>
<div class="ttc" id="astruct_presen_z_1_1_shading_1_1v4__1_1_1_pz_bend_ray_html"><div class="ttname"><a href="struct_presen_z_1_1_shading_1_1v4__1_1_1_pz_bend_ray.html">PresenZ::Shading::v4_1::PzBendRay</a></div><div class="ttdoc">PzBendRay is a structure representing a bend ray.</div><div class="ttdef"><b>Definition</b> PzShadingApi.h:27</div></div>
<div class="ttc" id="astruct_presen_z_1_1_shading_1_1v4__1_1_1_pz_bend_ray_html_a25d24f3fc254ac9d7f43b9be22fadd34"><div class="ttname"><a href="struct_presen_z_1_1_shading_1_1v4__1_1_1_pz_bend_ray.html#a25d24f3fc254ac9d7f43b9be22fadd34">PresenZ::Shading::v4_1::PzBendRay::isStereoScopic</a></div><div class="ttdeci">bool isStereoScopic</div><div class="ttdoc">can be computed for the other eye.</div><div class="ttdef"><b>Definition</b> PzShadingApi.h:39</div></div>
<div class="ttc" id="astruct_presen_z_1_1_shading_1_1v4__1_1_1_pz_bend_ray_html_a736153c8076e6040f9703e238e5b987c"><div class="ttname"><a href="struct_presen_z_1_1_shading_1_1v4__1_1_1_pz_bend_ray.html#a736153c8076e6040f9703e238e5b987c">PresenZ::Shading::v4_1::PzBendRay::dDdx</a></div><div class="ttdeci">NozVector dDdx</div><div class="ttdoc">world space ray direction derivatives with respect to x</div><div class="ttdef"><b>Definition</b> PzShadingApi.h:33</div></div>
<div class="ttc" id="astruct_presen_z_1_1_shading_1_1v4__1_1_1_pz_bend_ray_html_a7d4ae5b50b35b0b0e860ffe3192b05da"><div class="ttname"><a href="struct_presen_z_1_1_shading_1_1v4__1_1_1_pz_bend_ray.html#a7d4ae5b50b35b0b0e860ffe3192b05da">PresenZ::Shading::v4_1::PzBendRay::dir</a></div><div class="ttdeci">NozVector dir</div><div class="ttdoc">world space ray direction</div><div class="ttdef"><b>Definition</b> PzShadingApi.h:31</div></div>
<div class="ttc" id="astruct_presen_z_1_1_shading_1_1v4__1_1_1_pz_bend_ray_html_ab44f0a3b38724b93889067c8dc6e9469"><div class="ttname"><a href="struct_presen_z_1_1_shading_1_1v4__1_1_1_pz_bend_ray.html#ab44f0a3b38724b93889067c8dc6e9469">PresenZ::Shading::v4_1::PzBendRay::wHitDistance</a></div><div class="ttdeci">double wHitDistance</div><div class="ttdoc">world space distance from the specularPoint to the hitPoint</div><div class="ttdef"><b>Definition</b> PzShadingApi.h:37</div></div>
<div class="ttc" id="astruct_presen_z_1_1_shading_1_1v4__1_1_1_pz_bend_ray_html_aeb84bfd699fd4a7c535d38f19449e6b4"><div class="ttname"><a href="struct_presen_z_1_1_shading_1_1v4__1_1_1_pz_bend_ray.html#aeb84bfd699fd4a7c535d38f19449e6b4">PresenZ::Shading::v4_1::PzBendRay::dDdy</a></div><div class="ttdeci">NozVector dDdy</div><div class="ttdoc">world space ray direction derivatives with respect to y</div><div class="ttdef"><b>Definition</b> PzShadingApi.h:35</div></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md56"></a>
10.4 Filter</h1>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;ai.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &quot;arnoldWrapper.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;presenz_global_parameters.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="_pz_bucket_api_8h.html">API/PzBucketApi.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="_pz_render_sample_api_8h.html">API/PzRenderSampleApi.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="_pz_detect_sample_api_8h.html">API/PzDetectSampleApi.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="_pz_phase_api_8h.html">API/PzPhaseApi.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="_pz_cryptomatte_api_8h.html">API/PzCryptomatteApi.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="_pz_assert_8h.html">API/PzAssert.h</a>&quot;</span></div>
<div class="line"> </div>
<div class="line">AI_FILTER_NODE_EXPORT_METHODS(PresenZFilterMethods);</div>
<div class="line"> </div>
<div class="line"><span class="keyword">using namespace </span><a class="code hl_namespace" href="namespace_presen_z_1_1_phase.html">PresenZ::Phase</a>;</div>
<div class="line"><span class="keyword">using namespace </span><a class="code hl_namespace" href="namespace_presen_z_1_1_bin_i_o.html">PresenZ::BinIO</a>;</div>
<div class="line"><span class="keyword">using namespace </span><a class="code hl_namespace" href="namespace_presen_z_1_1_render_sample.html">PresenZ::RenderSample</a>;</div>
<div class="line"><span class="keyword">using namespace </span><a class="code hl_namespace" href="namespace_presen_z_1_1_cryptomatte.html">PresenZ::Cryptomatte</a>;</div>
<div class="line"> </div>
<div class="line">node_parameters</div>
<div class="line">{</div>
<div class="line">    AiParameterFlt(<span class="stringliteral">&quot;width&quot;</span>, 1.0);</div>
<div class="line">    AiMetaDataSetStr(nentry, NULL, <span class="stringliteral">&quot;_synonym&quot;</span>, <span class="stringliteral">&quot;PresenZFilter&quot;</span>);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">node_initialize</div>
<div class="line">{</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span>* necessary_aovs[] = { <span class="stringliteral">&quot;FLOAT Z&quot;</span>, <span class="keyword">nullptr</span>};</div>
<div class="line">    AiFilterInitialize(node, <span class="keyword">true</span>, necessary_aovs);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">node_finish</div>
<div class="line">{</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">node_update</div>
<div class="line">{</div>
<div class="line">    <span class="comment">//AiFilterUpdate(node, AiNodeGetFlt(node, &quot;width&quot;));</span></div>
<div class="line">    AiFilterUpdate(node, 1.0);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">filter_output_type</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span> AI_TYPE_POINTER;</div>
<div class="line"> </div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> filter_detect(AtNode* node, AtAOVSampleIterator* iterator, <span class="keywordtype">void</span>* data_out, uint8_t data_type)</div>
<div class="line">{</div>
<div class="line">    AtString AOVFiltered = AiAOVSampleIteratorGetAOVName(iterator);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (AOVFiltered == detectPzStr) {</div>
<div class="line">        </div>
<div class="line">        FilterDataDetect* out_data = <span class="keyword">new</span> FilterDataDetect();</div>
<div class="line">        </div>
<div class="line">        <span class="keywordflow">while</span> (AiAOVSampleIteratorGetNext(iterator)) {</div>
<div class="line">            <span class="keywordflow">while</span> (AiAOVSampleIteratorGetNextDepth(iterator)) {</div>
<div class="line">                </div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">int</span> curDepth = AiAOVSampleIteratorGetDepth(iterator);</div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">bool</span> pzSample = AiAOVSampleIteratorGetAOVBool(iterator, detectPzStr);</div>
<div class="line">                <span class="keywordflow">if</span> (!pzSample)</div>
<div class="line">                    <span class="keywordflow">continue</span>;</div>
<div class="line"> </div>
<div class="line">                <a class="code hl_struct" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_save_data_structure.html">PresenZ::DetectSample::SaveDataStructure</a> info;</div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">int</span> bestCam = AiAOVSampleIteratorGetAOVInt(iterator, detectTBestCamStr);</div>
<div class="line">                <span class="comment">// We don&#39;t actually have a real value in that case.</span></div>
<div class="line">                <span class="keywordflow">if</span> (bestCam == -1)</div>
<div class="line">                    <span class="keywordflow">continue</span>;</div>
<div class="line">                info.<a class="code hl_variable" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_save_data_structure.html#a1cdedf2e87044c140c64183314f9d522">bestCam</a> = bestCam;</div>
<div class="line">                info.<a class="code hl_variable" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_save_data_structure.html#a9267c6b3eae71d461769e6ea6a8fe2c0">camera</a> = AiAOVSampleIteratorGetAOVInt(iterator, detectCameraStr);</div>
<div class="line">                info.<a class="code hl_variable" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_save_data_structure.html#a2228d652eb39da15933e2b9345893951">expSize</a> = AiAOVSampleIteratorGetAOVInt(iterator, detectexpSizeStr);</div>
<div class="line">                info.<a class="code hl_variable" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_save_data_structure.html#a8a33ba6ff4f3da7799e33a2827f9d297">isChaotic</a> = AiAOVSampleIteratorGetAOVBool(iterator, detectChaoticStr);</div>
<div class="line">                info.<a class="code hl_variable" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_save_data_structure.html#ac66c2e837c24a5cd822b7b42ed61558d">isDraft</a> = AiAOVSampleIteratorGetAOVBool(iterator, detectDraftStr);</div>
<div class="line">                info.<a class="code hl_variable" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_save_data_structure.html#a97876727134fadec3c9fc1dd3e6fbaff">isEstimated</a> = AiAOVSampleIteratorGetAOVBool(iterator, detectEstimatedStr);</div>
<div class="line">                info.<a class="code hl_variable" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_save_data_structure.html#a6ada42ea3d29a108ebf63a249a02d0fb">isVolumetric</a> = AiAOVSampleIteratorGetAOVBool(iterator, detectVolumetricStr);</div>
<div class="line">                info.<a class="code hl_variable" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_save_data_structure.html#ad50b77be6452fcd203fa25771dd4f69e">isHair</a> = AiAOVSampleIteratorGetAOVBool(iterator, detectHairStr);</div>
<div class="line">                info.<a class="code hl_variable" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_save_data_structure.html#a1a4f15d1f73a8a725318a64a4303630c">maxZ</a> = AiAOVSampleIteratorGetAOVFlt(iterator, detectTmaxZStr);</div>
<div class="line">                info.<a class="code hl_variable" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_save_data_structure.html#a10783e24924a7160fed76c3a48530298">minZ</a> = AiAOVSampleIteratorGetAOVFlt(iterator, detectTminZStr);</div>
<div class="line">                info.<a class="code hl_variable" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_save_data_structure.html#afdddd54644ca7c73b3d22f7b2d206ca8">normal</a> = NozVectorFromAiVector(AiAOVSampleIteratorGetAOVVec(iterator, detectTNormalStr));</div>
<div class="line">                info.<a class="code hl_variable" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_save_data_structure.html#ac132759c29737e9daf6c071e2d49db6b">transpType</a> = AiAOVSampleIteratorGetAOVInt(iterator, detectTranspTypeStr);</div>
<div class="line">                info.<a class="code hl_variable" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_save_data_structure.html#af73583b1e980b0aa03f9884812e9fd4d">z</a> = AiAOVSampleIteratorGetAOVFlt(iterator, detectZStr);</div>
<div class="line">                info.<a class="code hl_variable" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_save_data_structure.html#a75f8ddf992db0cfc3cd1aa024086b6f3">pixelX</a> = AiAOVSampleIteratorGetAOVInt(iterator, pixelXStr);</div>
<div class="line">                info.<a class="code hl_variable" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_save_data_structure.html#aaa0423628e784003c3f5754ca1e56e70">pixelY</a> = AiAOVSampleIteratorGetAOVInt(iterator, pixelYStr);</div>
<div class="line">                out_data-&gt;data.push_back(info);</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">        *((<span class="keywordtype">void</span>**)data_out) = (<span class="keywordtype">void</span>*)out_data;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> filter_render(AtNode* node, AtAOVSampleIterator* iterator, <span class="keywordtype">void</span>* data_out, uint8_t data_type)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">const</span> AtUniverse* universe = AiNodeGetUniverse(node);</div>
<div class="line">    <span class="keyword">const</span> AtNode* pzCamera = AiUniverseGetCamera(universe);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">float</span> far_clip = AiNodeGetFlt(pzCamera, farClipStr);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">float</span> scene_scale = AiNodeGetFlt(pzCamera, presenzSceneScaleStr);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">float</span> max_distance = far_clip - (0.1f * scene_scale);</div>
<div class="line"> </div>
<div class="line">    </div>
<div class="line">    AtString AOVFiltered = AiAOVSampleIteratorGetAOVName(iterator);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (AOVFiltered == RGBAAtStr) {</div>
<div class="line"> </div>
<div class="line">        FilterData* out_data = <span class="keyword">new</span> FilterData();</div>
<div class="line"> </div>
<div class="line">        <span class="keywordtype">float</span> lastTransmission = 1.0f;</div>
<div class="line">        <span class="keywordtype">int</span> lastDepth = -1;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordtype">int</span> x, y;</div>
<div class="line">        AiAOVSampleIteratorGetPixel(iterator, x, y);</div>
<div class="line"> </div>
<div class="line">        std::vector&lt;PzRenderSample&gt; renderSamples;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">while</span> (AiAOVSampleIteratorGetNext(iterator)) {</div>
<div class="line">            <span class="keyword">const</span> AtVector2 offset = AiAOVSampleIteratorGetOffset(iterator);</div>
<div class="line">            <span class="keywordflow">while</span> (AiAOVSampleIteratorGetNextDepth(iterator)) {</div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">int</span> curDepth = AiAOVSampleIteratorGetDepth(iterator);</div>
<div class="line">                <span class="comment">// Depth 0, we reset the transmission.</span></div>
<div class="line">                <span class="keywordflow">if</span> (curDepth == 0) {</div>
<div class="line">                    lastTransmission = 1.0f;</div>
<div class="line">                    lastDepth = -1;</div>
<div class="line">                }</div>
<div class="line"> </div>
<div class="line">                AtRGBA <a class="code hl_enumvalue" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#add16db84a471b163119fa85bfa9df0fdae75845ff0980839032f4a78a0d42753c">RGBA</a> = AiAOVSampleIteratorGetRGBA(iterator);</div>
<div class="line">                <span class="comment">// Getting all our other data</span></div>
<div class="line">                <span class="keyword">const</span> AtVector P = AiAOVSampleIteratorGetAOVVec(iterator, NHitPointAtStr);</div>
<div class="line">                <span class="keyword">const</span> AtVector N = AiAOVSampleIteratorGetAOVVec(iterator, NCameraAtStr);</div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">float</span> distance = AiAOVSampleIteratorGetAOVFlt(iterator, ZAtStr);</div>
<div class="line"> </div>
<div class="line">                <a class="code hl_struct" href="struct_presen_z_1_1_render_sample_1_1v4__1_1_1_pz_render_sample.html">PzRenderSample</a> winSample;</div>
<div class="line"> </div>
<div class="line">                <a class="code hl_function" href="group___render_sample.html#gae1426a7ec51607b5dc5d9c2b73ed4347">PzSetSamplePosition</a>(winSample, NozVectorFromAiVector(P));</div>
<div class="line">                <a class="code hl_function" href="group___render_sample.html#ga6b536a25d0cd571d05f62ba75c305f05">PzSetSampleNormal</a>(winSample, NozVectorFromAiVector(N));</div>
<div class="line">                <a class="code hl_function" href="group___render_sample.html#ga8935efb907edc5afd9ce511b72182819">PzSetSampleZ</a>(winSample, distance);</div>
<div class="line">                <a class="code hl_function" href="group___render_sample.html#ga4e2a3666a24149f5027023528ce21a5a">PzSetSamplePosXY</a>(winSample, offset.x + 0.5f, offset.y + 0.5f);</div>
<div class="line">                <a class="code hl_function" href="group___render_sample.html#gaf899335a8718a1a4b6fdce008d227071">PzSetSampleDepth</a>(winSample, curDepth);</div>
<div class="line"> </div>
<div class="line">                <span class="keywordflow">if</span> (PresenZ_data_struct::do_crypto) {</div>
<div class="line">                    <span class="keywordtype">bool</span> do_object, do_material, do_asset = <span class="keyword">false</span>;</div>
<div class="line">                    <a class="code hl_function" href="namespace_presen_z_1_1_cryptomatte_1_1v4__1.html#a3404d8b67629d5291a6656c413729eaa">PzGetActiveCryptomatte</a>(do_object, do_material, do_asset);</div>
<div class="line">                    <span class="keywordflow">if</span> (do_object)</div>
<div class="line">                        <a class="code hl_function" href="namespace_presen_z_1_1_cryptomatte_1_1v4__1.html#a8affba5e09de3d0672d96739f57e0961">PzSetSampleCrypto</a>(winSample, cryptoType::object, AiAOVSampleIteratorGetAOVFlt(iterator, crypto_objectAOVStr));</div>
<div class="line">                    <span class="keywordflow">if</span> (do_material)</div>
<div class="line">                        <a class="code hl_function" href="namespace_presen_z_1_1_cryptomatte_1_1v4__1.html#a8affba5e09de3d0672d96739f57e0961">PzSetSampleCrypto</a>(winSample, cryptoType::material, AiAOVSampleIteratorGetAOVFlt(iterator, crypto_materialAOVStr));</div>
<div class="line">                    <span class="keywordflow">if</span> (do_asset)</div>
<div class="line">                        <a class="code hl_function" href="namespace_presen_z_1_1_cryptomatte_1_1v4__1.html#a8affba5e09de3d0672d96739f57e0961">PzSetSampleCrypto</a>(winSample, cryptoType::asset, AiAOVSampleIteratorGetAOVFlt(iterator, crypto_assetAOVStr));</div>
<div class="line">                }</div>
<div class="line"> </div>
<div class="line">                <span class="keywordtype">bool</span> isGlass = AiAOVSampleIteratorGetAOVBool(iterator, przGlassAtStr);</div>
<div class="line">                <span class="keywordflow">if</span> (isGlass) {</div>
<div class="line">                    <span class="keyword">const</span> AtRGB transmission = AiAOVSampleIteratorGetAOVRGB(iterator, transmissionAOV);</div>
<div class="line">                    <span class="keyword">const</span> <span class="keywordtype">float</span> transmissionAlbedo = (transmission.r + transmission.g + transmission.b) / 3.0f;</div>
<div class="line"> </div>
<div class="line">                    <span class="keywordflow">if</span> (transmissionAlbedo != 0.0f) {</div>
<div class="line">                        <a class="code hl_enumvalue" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#add16db84a471b163119fa85bfa9df0fdae75845ff0980839032f4a78a0d42753c">RGBA</a> = AiAOVSampleIteratorGetAOVRGBA(iterator, glassRGBOVStr);</div>
<div class="line">                        <span class="keywordtype">float</span> curTransmission = 1.0f - transmissionAlbedo;</div>
<div class="line">                        <span class="keywordflow">if</span> (curDepth &gt; lastDepth) {</div>
<div class="line">                            curTransmission *= lastTransmission;</div>
<div class="line">                            lastDepth = curDepth;</div>
<div class="line">                            lastTransmission = curTransmission;</div>
<div class="line">                        }</div>
<div class="line">                        <a class="code hl_enumvalue" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#add16db84a471b163119fa85bfa9df0fdae75845ff0980839032f4a78a0d42753c">RGBA</a>.a = curTransmission;</div>
<div class="line">                        <a class="code hl_function" href="group___render_sample.html#gab1f9d16753fb9da84735c3138032ef97">PzAddGlassSampleAov</a>(winSample, 1);</div>
<div class="line">                    }</div>
<div class="line">                    <span class="keywordflow">else</span></div>
<div class="line">                        <a class="code hl_function" href="group___render_sample.html#gab1f9d16753fb9da84735c3138032ef97">PzAddGlassSampleAov</a>(winSample, 0);</div>
<div class="line"> </div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">else</span></div>
<div class="line">                    <a class="code hl_function" href="group___render_sample.html#gab1f9d16753fb9da84735c3138032ef97">PzAddGlassSampleAov</a>(winSample, 0);</div>
<div class="line"> </div>
<div class="line">                <a class="code hl_function" href="group___render_sample.html#ga1363397bd1f19ac5231055543875c744">PzSetSampleColor</a>(winSample, NozRGBAFromAiRGBA(RGBA));</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">                <span class="keywordflow">if</span> (AiAOVSampleIteratorHasAOVValue(iterator, velocityAtStr, AI_TYPE_VECTOR))</div>
<div class="line">                    <a class="code hl_function" href="group___render_sample.html#ga80538f930119a325ca534c896e490597">PzAddVelocitySampleAov</a>(winSample, NozVectorFromAiVector(AiAOVSampleIteratorGetAOVVec(iterator, velocityAtStr)));</div>
<div class="line"> </div>
<div class="line">                <span class="comment">// Matte objects</span></div>
<div class="line">                <span class="keywordflow">if</span>(distance == 0.0f)</div>
<div class="line">                    <a class="code hl_function" href="group___render_sample.html#ga8935efb907edc5afd9ce511b72182819">PzSetSampleZ</a>(winSample, <a class="code hl_define" href="constant_8h.html#a22dd49f4a5b95f2951748a7bef17d100">NOZ_INFINITE</a>);</div>
<div class="line">                <span class="comment">// Fixing dome/max clip plane samples</span></div>
<div class="line">                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (distance &gt;= max_distance) { <span class="comment">//Hit the skydome sphere, need to recompute hitpoint and normal with virtual sphere around ZOV</span></div>
<div class="line">                    <span class="keywordflow">if</span>(<a class="code hl_enumvalue" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#add16db84a471b163119fa85bfa9df0fdae75845ff0980839032f4a78a0d42753c">RGBA</a>.a == 0.0) {</div>
<div class="line">                        <span class="comment">// Alpha at 0 = We hit nothing. We set the sample as a background one.</span></div>
<div class="line">                        <a class="code hl_function" href="group___render_sample.html#ga8935efb907edc5afd9ce511b72182819">PzSetSampleZ</a>(winSample, <a class="code hl_define" href="constant_8h.html#a22dd49f4a5b95f2951748a7bef17d100">NOZ_INFINITE</a>);</div>
<div class="line">                    } <span class="keywordflow">else</span> {</div>
<div class="line">                        <a class="code hl_struct" href="struct_noz_point.html">NozPoint</a> camPos = <a class="code hl_function" href="group___pz_phase_api.html#gaf907558c917636b2f0cad787e5b1dda3">PresenZ::Phase::PzGetZOVWorldPosition</a>();</div>
<div class="line">                        <a class="code hl_struct" href="struct_noz_point.html">NozVector</a> rayDir(NozVectorFromAiVector(AiAOVSampleIteratorGetAOVVec(iterator, rayDirAOVStr)));</div>
<div class="line">                        <span class="keywordflow">if</span>(<a class="code hl_function" href="group___n_o_z__vector.html#ga145b6f75c1c66f24c8c4ab97f9564a55">NozVecLength</a>(rayDir) != 0) {</div>
<div class="line">                            <a class="code hl_struct" href="struct_noz_point.html">NozVector</a> rayOrigin(NozVectorFromAiVector(AiAOVSampleIteratorGetAOVVec(iterator, rayOrigAOVStr)));</div>
<div class="line">                            std::vector&lt;float&gt; distances = hit_sphere(camPos, max_distance, rayDir, rayOrigin);</div>
<div class="line">                            <a class="code hl_function" href="group___render_sample.html#gae1426a7ec51607b5dc5d9c2b73ed4347">PzSetSamplePosition</a>(winSample, rayOrigin + (rayDir * distances[0]));</div>
<div class="line">                            <a class="code hl_function" href="group___render_sample.html#ga6b536a25d0cd571d05f62ba75c305f05">PzSetSampleNormal</a>(winSample, -rayDir);</div>
<div class="line">                            <a class="code hl_function" href="group___render_sample.html#ga8935efb907edc5afd9ce511b72182819">PzSetSampleZ</a>(winSample, distances[0]);</div>
<div class="line">                        }</div>
<div class="line">                    }</div>
<div class="line">                }</div>
<div class="line"> </div>
<div class="line">                <span class="keywordtype">size_t</span> numAovs = <a class="code hl_function" href="group___pz_phase_api.html#ga800b20ae7724b268fd3d82134ea96a46">PzRenderPhaseGetNumAov</a>();</div>
<div class="line">                <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; numAovs; ++i) {</div>
<div class="line">                    std::string name;</div>
<div class="line">                    PresenZ::Phase::AOVType type;</div>
<div class="line">                    <a class="code hl_function" href="group___pz_phase_api.html#ga6063c2c114e7a465b965556590be3164">PzGetAOVInfo</a>(i, name, type);</div>
<div class="line"> </div>
<div class="line">                    AtString AOVname(name.c_str());</div>
<div class="line">                    <span class="keywordflow">if</span> (AOVname != przvelocityAtStr &amp;&amp; AOVname != presenzStr) {</div>
<div class="line">                        <span class="keywordflow">switch</span> (type) {</div>
<div class="line">                            <span class="keywordflow">case</span> PresenZ::Phase::AOVType::INT: {</div>
<div class="line">                                <span class="keyword">auto</span> value = AiAOVSampleIteratorGetAOVInt(iterator, AOVname);</div>
<div class="line">                                <a class="code hl_function" href="group___render_sample.html#ga9a7159997ae0ca7d7656d7fe180fd190">PzAddSampleAov</a>(winSample, (<span class="keywordtype">void</span>*)&amp;value, name); <span class="keywordflow">break</span>;</div>
<div class="line">                            }</div>
<div class="line">                            <span class="keywordflow">case</span> PresenZ::Phase::AOVType::BOOL: {</div>
<div class="line">                                <span class="keyword">auto</span> value = AiAOVSampleIteratorGetAOVBool(iterator, AOVname);</div>
<div class="line">                                <a class="code hl_function" href="group___render_sample.html#ga9a7159997ae0ca7d7656d7fe180fd190">PzAddSampleAov</a>(winSample, (<span class="keywordtype">void</span>*)&amp;value, name); <span class="keywordflow">break</span>;</div>
<div class="line">                            }</div>
<div class="line">                            <span class="keywordflow">case</span> PresenZ::Phase::AOVType::FLOAT: {</div>
<div class="line">                                <span class="keyword">auto</span> value = AiAOVSampleIteratorGetAOVFlt(iterator, AOVname);</div>
<div class="line">                                <a class="code hl_function" href="group___render_sample.html#ga9a7159997ae0ca7d7656d7fe180fd190">PzAddSampleAov</a>(winSample, (<span class="keywordtype">void</span>*)&amp;value, name); <span class="keywordflow">break</span>;</div>
<div class="line">                            }</div>
<div class="line">                            <span class="keywordflow">case</span> PresenZ::Phase::AOVType::RGB: {</div>
<div class="line">                                <span class="keyword">auto</span> value = AiAOVSampleIteratorGetAOVRGB(iterator, AOVname);</div>
<div class="line">                                <a class="code hl_function" href="group___render_sample.html#ga9a7159997ae0ca7d7656d7fe180fd190">PzAddSampleAov</a>(winSample, (<span class="keywordtype">void</span>*)&amp;value, name); <span class="keywordflow">break</span>;</div>
<div class="line">                            }</div>
<div class="line">                            <span class="keywordflow">case</span> PresenZ::Phase::AOVType::RGBA: {</div>
<div class="line">                                <span class="keyword">auto</span> value = AiAOVSampleIteratorGetAOVRGBA(iterator, AOVname);</div>
<div class="line">                                <a class="code hl_function" href="group___render_sample.html#ga9a7159997ae0ca7d7656d7fe180fd190">PzAddSampleAov</a>(winSample, (<span class="keywordtype">void</span>*)&amp;value, name); <span class="keywordflow">break</span>;</div>
<div class="line">                            }</div>
<div class="line">                            <span class="keywordflow">case</span> PresenZ::Phase::AOVType::VEC: {</div>
<div class="line">                                <span class="keyword">auto</span> value = AiAOVSampleIteratorGetAOVVec(iterator, AOVname);</div>
<div class="line">                                <a class="code hl_function" href="group___render_sample.html#ga9a7159997ae0ca7d7656d7fe180fd190">PzAddSampleAov</a>(winSample, (<span class="keywordtype">void</span>*)&amp;value, name); <span class="keywordflow">break</span>;</div>
<div class="line">                            }</div>
<div class="line">                            <span class="keywordflow">case</span> PresenZ::Phase::AOVType::VEC2: {</div>
<div class="line">                                <span class="keyword">auto</span> value = AiAOVSampleIteratorGetAOVVec2(iterator, AOVname);</div>
<div class="line">                                <a class="code hl_function" href="group___render_sample.html#ga9a7159997ae0ca7d7656d7fe180fd190">PzAddSampleAov</a>(winSample, (<span class="keywordtype">void</span>*)&amp;value, name); <span class="keywordflow">break</span>;</div>
<div class="line">                            }</div>
<div class="line">                        }</div>
<div class="line">                    }</div>
<div class="line">                }</div>
<div class="line">                renderSamples.push_back(winSample);</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">if</span> (renderSamples.empty() == <span class="keyword">false</span>)</div>
<div class="line">        {</div>
<div class="line">            <a class="code hl_function" href="group___render_sample.html#ga4c8496dbbcbc7811f2ba58fd44f6661e">PzSetSamplesCount</a>(x, y, (<span class="keywordtype">int</span>)renderSamples.size());</div>
<div class="line">            <a class="code hl_function" href="group___render_sample.html#gae715ceee4ccb12e2ac960c8de76b40a8">PzFilterRenderSample</a>(x, y, renderSamples, out_data-&gt;data);</div>
<div class="line">        }</div>
<div class="line">    </div>
<div class="line">        *((<span class="keywordtype">void</span>**)data_out) = (<span class="keywordtype">void</span>*)out_data;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">filter_pixel</div>
<div class="line">{</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (PresenZ_data_struct::pass == PresenZ::Phase::Detect || PresenZ_data_struct::pass == PresenZ::Phase::Detect_Reflection)</div>
<div class="line">        filter_detect(node, iterator, data_out, data_type);</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (PresenZ_data_struct::pass == PresenZ::Phase::Render || PresenZ_data_struct::pass == PresenZ::Phase::Render_Reflection)</div>
<div class="line">        filter_render(node, iterator, data_out, data_type);</div>
<div class="line"> </div>
<div class="line">}</div>
<div class="ttc" id="a_pz_bucket_api_8h_html"><div class="ttname"><a href="_pz_bucket_api_8h.html">PzBucketApi.h</a></div></div>
<div class="ttc" id="a_pz_phase_api_8h_html"><div class="ttname"><a href="_pz_phase_api_8h.html">PzPhaseApi.h</a></div></div>
<div class="ttc" id="a_pz_render_sample_api_8h_html"><div class="ttname"><a href="_pz_render_sample_api_8h.html">PzRenderSampleApi.h</a></div></div>
<div class="ttc" id="aconstant_8h_html_a22dd49f4a5b95f2951748a7bef17d100"><div class="ttname"><a href="constant_8h.html#a22dd49f4a5b95f2951748a7bef17d100">NOZ_INFINITE</a></div><div class="ttdeci">#define NOZ_INFINITE</div><div class="ttdef"><b>Definition</b> constant.h:17</div></div>
<div class="ttc" id="agroup___n_o_z__vector_html_ga145b6f75c1c66f24c8c4ab97f9564a55"><div class="ttname"><a href="group___n_o_z__vector.html#ga145b6f75c1c66f24c8c4ab97f9564a55">NozVecLength</a></div><div class="ttdeci">float NozVecLength(const NozVector2 &amp;v1)</div><div class="ttdoc">Vector Length: ||v1||.</div><div class="ttdef"><b>Definition</b> vector.h:488</div></div>
<div class="ttc" id="agroup___pz_phase_api_html_ga6063c2c114e7a465b965556590be3164"><div class="ttname"><a href="group___pz_phase_api.html#ga6063c2c114e7a465b965556590be3164">PresenZ::Phase::v4_1::PzGetAOVInfo</a></div><div class="ttdeci">void PzGetAOVInfo(const int32_t &amp;index, std::string &amp;name, AOVType &amp;type)</div></div>
<div class="ttc" id="agroup___pz_phase_api_html_ga800b20ae7724b268fd3d82134ea96a46"><div class="ttname"><a href="group___pz_phase_api.html#ga800b20ae7724b268fd3d82134ea96a46">PresenZ::Phase::v4_1::PzRenderPhaseGetNumAov</a></div><div class="ttdeci">size_t PzRenderPhaseGetNumAov()</div><div class="ttdoc">Function to get the number of AOV registered to presenZ.</div></div>
<div class="ttc" id="agroup___render_sample_html_ga1363397bd1f19ac5231055543875c744"><div class="ttname"><a href="group___render_sample.html#ga1363397bd1f19ac5231055543875c744">PresenZ::RenderSample::v4_1::PzSetSampleColor</a></div><div class="ttdeci">void PzSetSampleColor(PzRenderSample &amp;sample, const NozRGBA &amp;rgba)</div><div class="ttdoc">Set the default (left eye) color for this sample.</div></div>
<div class="ttc" id="agroup___render_sample_html_ga4c8496dbbcbc7811f2ba58fd44f6661e"><div class="ttname"><a href="group___render_sample.html#ga4c8496dbbcbc7811f2ba58fd44f6661e">PresenZ::RenderSample::v4_1::PzSetSamplesCount</a></div><div class="ttdeci">void PzSetSamplesCount(const int &amp;pixelX, const int &amp;pixelY, const int &amp;count)</div><div class="ttdoc">Set the number of samples launched for a pixel.</div></div>
<div class="ttc" id="agroup___render_sample_html_ga4e2a3666a24149f5027023528ce21a5a"><div class="ttname"><a href="group___render_sample.html#ga4e2a3666a24149f5027023528ce21a5a">PresenZ::RenderSample::v4_1::PzSetSamplePosXY</a></div><div class="ttdeci">void PzSetSamplePosXY(PzRenderSample &amp;sample, const double &amp;xScreen, const double &amp;yScreen)</div><div class="ttdoc">Set the X/Y inside the pixel, this will set the inPixelPosXY by keeping only the decimals.</div></div>
<div class="ttc" id="agroup___render_sample_html_ga6b536a25d0cd571d05f62ba75c305f05"><div class="ttname"><a href="group___render_sample.html#ga6b536a25d0cd571d05f62ba75c305f05">PresenZ::RenderSample::v4_1::PzSetSampleNormal</a></div><div class="ttdeci">void PzSetSampleNormal(PzRenderSample &amp;sample, const NozVector &amp;normal)</div><div class="ttdoc">Set the sample normal.</div></div>
<div class="ttc" id="agroup___render_sample_html_ga80538f930119a325ca534c896e490597"><div class="ttname"><a href="group___render_sample.html#ga80538f930119a325ca534c896e490597">PresenZ::RenderSample::v4_1::PzAddVelocitySampleAov</a></div><div class="ttdeci">void PzAddVelocitySampleAov(PzRenderSample &amp;sample, const NozVector &amp;velocity)</div><div class="ttdoc">Will tag the current sample with a specific velocity so between-frame interpolation is more accurate.</div></div>
<div class="ttc" id="agroup___render_sample_html_ga8935efb907edc5afd9ce511b72182819"><div class="ttname"><a href="group___render_sample.html#ga8935efb907edc5afd9ce511b72182819">PresenZ::RenderSample::v4_1::PzSetSampleZ</a></div><div class="ttdeci">void PzSetSampleZ(PzRenderSample &amp;sample, const double z)</div><div class="ttdoc">Set how far from the ray origin you are.</div></div>
<div class="ttc" id="agroup___render_sample_html_ga9a7159997ae0ca7d7656d7fe180fd190"><div class="ttname"><a href="group___render_sample.html#ga9a7159997ae0ca7d7656d7fe180fd190">PresenZ::RenderSample::v4_1::PzAddSampleAov</a></div><div class="ttdeci">void PzAddSampleAov(PzRenderSample &amp;sample, const void *data, const int &amp;iAlias)</div><div class="ttdoc">Add your own custom type of data.</div></div>
<div class="ttc" id="agroup___render_sample_html_gab1f9d16753fb9da84735c3138032ef97"><div class="ttname"><a href="group___render_sample.html#gab1f9d16753fb9da84735c3138032ef97">PresenZ::RenderSample::v4_1::PzAddGlassSampleAov</a></div><div class="ttdeci">void PzAddGlassSampleAov(PzRenderSample &amp;sample, const int &amp;glass)</div><div class="ttdoc">Will tag the current sample as a glass that need to be transparent.</div></div>
<div class="ttc" id="agroup___render_sample_html_gae1426a7ec51607b5dc5d9c2b73ed4347"><div class="ttname"><a href="group___render_sample.html#gae1426a7ec51607b5dc5d9c2b73ed4347">PresenZ::RenderSample::v4_1::PzSetSamplePosition</a></div><div class="ttdeci">void PzSetSamplePosition(PzRenderSample &amp;sample, const NozPoint &amp;position)</div><div class="ttdoc">Set the sample position.</div></div>
<div class="ttc" id="agroup___render_sample_html_gae715ceee4ccb12e2ac960c8de76b40a8"><div class="ttname"><a href="group___render_sample.html#gae715ceee4ccb12e2ac960c8de76b40a8">PresenZ::RenderSample::v4_1::PzFilterRenderSample</a></div><div class="ttdeci">void PzFilterRenderSample(const size_t &amp;x, const size_t &amp;y, std::vector&lt; PzRenderSample &gt; &amp;renderSamples, std::vector&lt; PzFilteredSample &gt; &amp;pixelXY_Results)</div><div class="ttdoc">Filter the current RenderSample data.</div></div>
<div class="ttc" id="agroup___render_sample_html_gaf899335a8718a1a4b6fdce008d227071"><div class="ttname"><a href="group___render_sample.html#gaf899335a8718a1a4b6fdce008d227071">PresenZ::RenderSample::v4_1::PzSetSampleDepth</a></div><div class="ttdeci">void PzSetSampleDepth(PzRenderSample &amp;sample, const int &amp;depth)</div><div class="ttdoc">Will reference the depth of the current sample (transparency level) for filtering.</div></div>
<div class="ttc" id="anamespace_presen_z_1_1_bin_i_o_html"><div class="ttname"><a href="namespace_presen_z_1_1_bin_i_o.html">PresenZ::BinIO</a></div><div class="ttdef"><b>Definition</b> PzBucketApi.h:15</div></div>
<div class="ttc" id="anamespace_presen_z_1_1_cryptomatte_1_1v4__1_html_a3404d8b67629d5291a6656c413729eaa"><div class="ttname"><a href="namespace_presen_z_1_1_cryptomatte_1_1v4__1.html#a3404d8b67629d5291a6656c413729eaa">PresenZ::Cryptomatte::v4_1::PzGetActiveCryptomatte</a></div><div class="ttdeci">void PzGetActiveCryptomatte(bool &amp;objects, bool &amp;materials, bool &amp;assets)</div><div class="ttdoc">Function to get the active Cryptomattes AOV in presenZ.</div></div>
<div class="ttc" id="anamespace_presen_z_1_1_cryptomatte_1_1v4__1_html_a8affba5e09de3d0672d96739f57e0961"><div class="ttname"><a href="namespace_presen_z_1_1_cryptomatte_1_1v4__1.html#a8affba5e09de3d0672d96739f57e0961">PresenZ::Cryptomatte::v4_1::PzSetSampleCrypto</a></div><div class="ttdeci">void PzSetSampleCrypto(PresenZ::RenderSample::PzRenderSample &amp;sample, const cryptoType &amp;type, const float &amp;value)</div></div>
<div class="ttc" id="anamespace_presen_z_1_1_cryptomatte_html"><div class="ttname"><a href="namespace_presen_z_1_1_cryptomatte.html">PresenZ::Cryptomatte</a></div><div class="ttdef"><b>Definition</b> PzCryptomatteApi.h:8</div></div>
<div class="ttc" id="anamespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s_html_add16db84a471b163119fa85bfa9df0fdae75845ff0980839032f4a78a0d42753c"><div class="ttname"><a href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#add16db84a471b163119fa85bfa9df0fdae75845ff0980839032f4a78a0d42753c">PresenZ::Phase::PRESENZ_VERSION_NS::RGBA</a></div><div class="ttdeci">@ RGBA</div><div class="ttdoc">RGBA.</div><div class="ttdef"><b>Definition</b> PzConstants.h:147</div></div>
<div class="ttc" id="anamespace_presen_z_1_1_phase_html"><div class="ttname"><a href="namespace_presen_z_1_1_phase.html">PresenZ::Phase</a></div><div class="ttdef"><b>Definition</b> PzConstants.h:53</div></div>
<div class="ttc" id="anamespace_presen_z_1_1_render_sample_html"><div class="ttname"><a href="namespace_presen_z_1_1_render_sample.html">PresenZ::RenderSample</a></div><div class="ttdef"><b>Definition</b> PzRenderSampleApi.h:18</div></div>
<div class="ttc" id="astruct_presen_z_1_1_detect_sample_1_1v4__1_1_1_save_data_structure_html"><div class="ttname"><a href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_save_data_structure.html">PresenZ::DetectSample::v4_1::SaveDataStructure</a></div><div class="ttdef"><b>Definition</b> PzDetectSampleApi.h:58</div></div>
<div class="ttc" id="astruct_presen_z_1_1_detect_sample_1_1v4__1_1_1_save_data_structure_html_a10783e24924a7160fed76c3a48530298"><div class="ttname"><a href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_save_data_structure.html#a10783e24924a7160fed76c3a48530298">PresenZ::DetectSample::v4_1::SaveDataStructure::minZ</a></div><div class="ttdeci">float minZ</div><div class="ttdef"><b>Definition</b> PzDetectSampleApi.h:70</div></div>
<div class="ttc" id="astruct_presen_z_1_1_detect_sample_1_1v4__1_1_1_save_data_structure_html_a1a4f15d1f73a8a725318a64a4303630c"><div class="ttname"><a href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_save_data_structure.html#a1a4f15d1f73a8a725318a64a4303630c">PresenZ::DetectSample::v4_1::SaveDataStructure::maxZ</a></div><div class="ttdeci">float maxZ</div><div class="ttdef"><b>Definition</b> PzDetectSampleApi.h:71</div></div>
<div class="ttc" id="astruct_presen_z_1_1_detect_sample_1_1v4__1_1_1_save_data_structure_html_a1cdedf2e87044c140c64183314f9d522"><div class="ttname"><a href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_save_data_structure.html#a1cdedf2e87044c140c64183314f9d522">PresenZ::DetectSample::v4_1::SaveDataStructure::bestCam</a></div><div class="ttdeci">uint8_t bestCam</div><div class="ttdef"><b>Definition</b> PzDetectSampleApi.h:73</div></div>
<div class="ttc" id="astruct_presen_z_1_1_detect_sample_1_1v4__1_1_1_save_data_structure_html_a2228d652eb39da15933e2b9345893951"><div class="ttname"><a href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_save_data_structure.html#a2228d652eb39da15933e2b9345893951">PresenZ::DetectSample::v4_1::SaveDataStructure::expSize</a></div><div class="ttdeci">uint8_t expSize</div><div class="ttdef"><b>Definition</b> PzDetectSampleApi.h:67</div></div>
<div class="ttc" id="astruct_presen_z_1_1_detect_sample_1_1v4__1_1_1_save_data_structure_html_a6ada42ea3d29a108ebf63a249a02d0fb"><div class="ttname"><a href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_save_data_structure.html#a6ada42ea3d29a108ebf63a249a02d0fb">PresenZ::DetectSample::v4_1::SaveDataStructure::isVolumetric</a></div><div class="ttdeci">bool isVolumetric</div><div class="ttdef"><b>Definition</b> PzDetectSampleApi.h:66</div></div>
<div class="ttc" id="astruct_presen_z_1_1_detect_sample_1_1v4__1_1_1_save_data_structure_html_a75f8ddf992db0cfc3cd1aa024086b6f3"><div class="ttname"><a href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_save_data_structure.html#a75f8ddf992db0cfc3cd1aa024086b6f3">PresenZ::DetectSample::v4_1::SaveDataStructure::pixelX</a></div><div class="ttdeci">int pixelX</div><div class="ttdef"><b>Definition</b> PzDetectSampleApi.h:74</div></div>
<div class="ttc" id="astruct_presen_z_1_1_detect_sample_1_1v4__1_1_1_save_data_structure_html_a8a33ba6ff4f3da7799e33a2827f9d297"><div class="ttname"><a href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_save_data_structure.html#a8a33ba6ff4f3da7799e33a2827f9d297">PresenZ::DetectSample::v4_1::SaveDataStructure::isChaotic</a></div><div class="ttdeci">bool isChaotic</div><div class="ttdef"><b>Definition</b> PzDetectSampleApi.h:65</div></div>
<div class="ttc" id="astruct_presen_z_1_1_detect_sample_1_1v4__1_1_1_save_data_structure_html_a9267c6b3eae71d461769e6ea6a8fe2c0"><div class="ttname"><a href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_save_data_structure.html#a9267c6b3eae71d461769e6ea6a8fe2c0">PresenZ::DetectSample::v4_1::SaveDataStructure::camera</a></div><div class="ttdeci">uint8_t camera</div><div class="ttdef"><b>Definition</b> PzDetectSampleApi.h:61</div></div>
<div class="ttc" id="astruct_presen_z_1_1_detect_sample_1_1v4__1_1_1_save_data_structure_html_a97876727134fadec3c9fc1dd3e6fbaff"><div class="ttname"><a href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_save_data_structure.html#a97876727134fadec3c9fc1dd3e6fbaff">PresenZ::DetectSample::v4_1::SaveDataStructure::isEstimated</a></div><div class="ttdeci">bool isEstimated</div><div class="ttdef"><b>Definition</b> PzDetectSampleApi.h:62</div></div>
<div class="ttc" id="astruct_presen_z_1_1_detect_sample_1_1v4__1_1_1_save_data_structure_html_aaa0423628e784003c3f5754ca1e56e70"><div class="ttname"><a href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_save_data_structure.html#aaa0423628e784003c3f5754ca1e56e70">PresenZ::DetectSample::v4_1::SaveDataStructure::pixelY</a></div><div class="ttdeci">int pixelY</div><div class="ttdef"><b>Definition</b> PzDetectSampleApi.h:75</div></div>
<div class="ttc" id="astruct_presen_z_1_1_detect_sample_1_1v4__1_1_1_save_data_structure_html_ac132759c29737e9daf6c071e2d49db6b"><div class="ttname"><a href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_save_data_structure.html#ac132759c29737e9daf6c071e2d49db6b">PresenZ::DetectSample::v4_1::SaveDataStructure::transpType</a></div><div class="ttdeci">uint8_t transpType</div><div class="ttdef"><b>Definition</b> PzDetectSampleApi.h:68</div></div>
<div class="ttc" id="astruct_presen_z_1_1_detect_sample_1_1v4__1_1_1_save_data_structure_html_ac66c2e837c24a5cd822b7b42ed61558d"><div class="ttname"><a href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_save_data_structure.html#ac66c2e837c24a5cd822b7b42ed61558d">PresenZ::DetectSample::v4_1::SaveDataStructure::isDraft</a></div><div class="ttdeci">bool isDraft</div><div class="ttdef"><b>Definition</b> PzDetectSampleApi.h:64</div></div>
<div class="ttc" id="astruct_presen_z_1_1_detect_sample_1_1v4__1_1_1_save_data_structure_html_ad50b77be6452fcd203fa25771dd4f69e"><div class="ttname"><a href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_save_data_structure.html#ad50b77be6452fcd203fa25771dd4f69e">PresenZ::DetectSample::v4_1::SaveDataStructure::isHair</a></div><div class="ttdeci">bool isHair</div><div class="ttdef"><b>Definition</b> PzDetectSampleApi.h:63</div></div>
<div class="ttc" id="astruct_presen_z_1_1_detect_sample_1_1v4__1_1_1_save_data_structure_html_af73583b1e980b0aa03f9884812e9fd4d"><div class="ttname"><a href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_save_data_structure.html#af73583b1e980b0aa03f9884812e9fd4d">PresenZ::DetectSample::v4_1::SaveDataStructure::z</a></div><div class="ttdeci">float z</div><div class="ttdef"><b>Definition</b> PzDetectSampleApi.h:69</div></div>
<div class="ttc" id="astruct_presen_z_1_1_detect_sample_1_1v4__1_1_1_save_data_structure_html_afdddd54644ca7c73b3d22f7b2d206ca8"><div class="ttname"><a href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_save_data_structure.html#afdddd54644ca7c73b3d22f7b2d206ca8">PresenZ::DetectSample::v4_1::SaveDataStructure::normal</a></div><div class="ttdeci">NozPoint normal</div><div class="ttdef"><b>Definition</b> PzDetectSampleApi.h:72</div></div>
<div class="ttc" id="astruct_presen_z_1_1_render_sample_1_1v4__1_1_1_pz_render_sample_html"><div class="ttname"><a href="struct_presen_z_1_1_render_sample_1_1v4__1_1_1_pz_render_sample.html">PresenZ::RenderSample::v4_1::PzRenderSample</a></div><div class="ttdoc">Data containing all relevant information regarding a shading phase sample.</div><div class="ttdef"><b>Definition</b> PzRenderSampleApi.h:135</div></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md57"></a>
10.5 Driver</h1>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;ai.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &quot;arnoldWrapper.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;presenz_global_parameters.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="_pz_bucket_api_8h.html">API/PzBucketApi.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="_pz_render_sample_api_8h.html">API/PzRenderSampleApi.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="_pz_detect_sample_api_8h.html">API/PzDetectSampleApi.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="_pz_phase_api_8h.html">API/PzPhaseApi.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="_pz_camera_api_8h.html">API/PzCameraApi.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="_pz_cryptomatte_api_8h.html">API/PzCryptomatteApi.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="_pz_assert_8h.html">API/PzAssert.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &lt;map&gt;</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">using namespace </span><a class="code hl_namespace" href="namespace_presen_z_1_1_phase.html">PresenZ::Phase</a>;</div>
<div class="line"><span class="keyword">using namespace </span><a class="code hl_namespace" href="namespace_presen_z_1_1_bin_i_o.html">PresenZ::BinIO</a>;</div>
<div class="line"><span class="keyword">using namespace </span><a class="code hl_namespace" href="namespace_presen_z_1_1_render_sample.html">PresenZ::RenderSample</a>;</div>
<div class="line"><span class="keyword">using namespace </span><a class="code hl_namespace" href="namespace_presen_z_1_1_camera.html">PresenZ::Camera</a>;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Invoke all the PresenZ parameters that are related to the Camera</span></div>
<div class="line"><span class="keywordtype">void</span> initPresenZCameraParameters(<span class="keyword">const</span> AtNode* pzCamera, <span class="keyword">const</span> <span class="keywordtype">int</span> renderTargetResX, <span class="keyword">const</span> <span class="keywordtype">int</span> renderTargetResY, <span class="keyword">const</span> <span class="keywordtype">float</span> ipd)</div>
<div class="line">{</div>
<div class="line">    PzSetOutputResolution(renderTargetResX, renderTargetResY);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">int</span> renderEye = AiNodeGetInt(pzCamera, renderingEyeStr);</div>
<div class="line">    PresenZ::Phase::Eye eye = PresenZ::Phase::Eye::RC_LeftAndRight;</div>
<div class="line">    <span class="keywordflow">if</span> (renderEye == 0) { eye = PresenZ::Phase::Eye::RC_Left; }</div>
<div class="line">    <span class="keywordflow">if</span> (renderEye == 1) { eye = PresenZ::Phase::Eye::RC_Right; }</div>
<div class="line"> </div>
<div class="line">    <a class="code hl_function" href="group___pz_phase_api.html#ga949129ceea6602d8e188e8edde8c9596">PzSetDeepReflection</a>(eye, ipd);</div>
<div class="line"> </div>
<div class="line">    <a class="code hl_function" href="group___pz_phase_api.html#gabfdb2cfc6e11bc80cc3d8f27bff0768e">PzSetDistanceToGround</a>(AiNodeGetFlt(pzCamera, distanceToGroundStr));</div>
<div class="line">    <a class="code hl_function" href="group___pz_phase_api.html#ga1aca5cb52d6cc925c72a658a8cae0161">PzSetSpecularPointOffset</a>(NozPointFromAiPoint(AiNodeGetVec(pzCamera, specularPointOffsetStr)));</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> AtVector viewscale = AiNodeGetVec(pzCamera, viewScaleStr);</div>
<div class="line">    <a class="code hl_function" href="group___pz_phase_api.html#ga9e5a704692330cca20bc7cc81219228e">PzSetZovScaling</a>(viewscale.x, viewscale.y, viewscale.z);</div>
<div class="line"> </div>
<div class="line">    <a class="code hl_function" href="group___pz_phase_api.html#gaae62eec6ec456bd4c638f1c0b4bf470f">PzSetZovOffset</a>(AiNodeGetInt(pzCamera, multiboxOffsetRightStr), AiNodeGetInt(pzCamera, multiboxOffsetTopStr), AiNodeGetInt(pzCamera, multiboxOffsetBackStr));</div>
<div class="line"> </div>
<div class="line">    AtMatrix AtCamToWorldMat4;</div>
<div class="line">    AiCameraToWorldMatrix(pzCamera, 0.5, AtCamToWorldMat4);</div>
<div class="line"> </div>
<div class="line">    <a class="code hl_typedef" href="matrix_8h.html#a15eb5c4da255c65c60623dc95ca45bc1">NozMatrix</a> worldToCam;</div>
<div class="line">    AtMatrixToNozMatrix(AtCamToWorldMat4, worldToCam);</div>
<div class="line">    <a class="code hl_function" href="group___pz_phase_api.html#gab7d28db69c251d7d1761412440d41068">PzSetCameraToWorldMatrix</a>(worldToCam);</div>
<div class="line"> </div>
<div class="line">    <a class="code hl_function" href="group___pz_phase_api.html#ga536fd47146cb18c507f803356f5df1d9">PzSetClippingSphere</a>(AiNodeGetBool(pzCamera, clippingEnableStr),</div>
<div class="line">        <a class="code hl_typedef" href="group___n_o_z__vector.html#ga347d85f3e636cf273a47949aa0613a8f">NozVector</a>(AiNodeGetVec(pzCamera, clippingPositionStr).x, AiNodeGetVec(pzCamera, clippingPositionStr).y, AiNodeGetVec(pzCamera, clippingPositionStr).z),</div>
<div class="line">        AiNodeGetFlt(pzCamera, clippingRadiusStr), !AiNodeGetBool(pzCamera, clippingOutsideStr));</div>
<div class="line"> </div>
<div class="line">    <a class="code hl_function" href="group___pz_phase_api.html#ga770112d6d9328a4cc973dec788ec4c65">PzSetRenderInsideBox</a>(AiNodeGetInt(pzCamera, renderInsideZOVStr));</div>
<div class="line"> </div>
<div class="line">    <a class="code hl_function" href="group___pz_phase_api.html#ga0e256374d02c493cea64e1413a0da7f1">PzSetFroxtrum</a>(AiNodeGetBool(pzCamera, enableFroxtrumStr));</div>
<div class="line">    <a class="code hl_function" href="group___pz_phase_api.html#gab3f9a2ad1e2b489787fb177116e3e248">PzSetFroxtrumDepth</a>(AiNodeGetInt(pzCamera, froxtrumDepthStr));</div>
<div class="line">    <a class="code hl_function" href="group___pz_phase_api.html#gadb463d0048e422dc0b613361de76d887">PzSetVolumeDepth</a>(AiNodeGetInt(pzCamera, volumeDepthStr));</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> AtString windowShapesFile = AiNodeGetStr(pzCamera, windowShapesFileStr);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">int</span> windowShapeIndex = AiNodeGetInt(pzCamera, windowShapeIndexStr);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">float</span> minDistToScreen = AiNodeGetFlt(pzCamera, minDistToScreenStr);</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">if</span> (windowShapesFile.length() != 0 ){</div>
<div class="line">        <a class="code hl_function" href="group___pz_phase_api.html#ga79970a419cce7b5c709765413c5d8fb2">PzSetWindowShapesFile</a>(windowShapesFile.c_str(), windowShapeIndex);</div>
<div class="line">        <a class="code hl_function" href="group___pz_phase_api.html#gae379dd62e45b425b22c82f70455acfb8">PzSetDetectionMinimumDistance</a>(minDistToScreen);</div>
<div class="line">        <a class="code hl_define" href="group___pz_app_logger.html#gaf8ab3f1606906a93b3081de7f0cb7be1">PZ_INFO</a>(<span class="stringliteral">&quot;[PresenZ] Set the minimum distance of detection to %f cm for window shape rendering\n&quot;</span>, minDistToScreen);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Forward all the parameters from Arnold to PresenZ.</span></div>
<div class="line"><span class="keywordtype">bool</span> initPresenZ(AtNode *node)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">const</span> AtUniverse* universe = AiNodeGetUniverse(node);</div>
<div class="line">    <span class="keyword">const</span> AtNode* pzCamera = AiUniverseGetCamera(universe);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (AiNodeIs(pzCamera, PresenzCameraName) == <span class="keyword">false</span>)</div>
<div class="line">    {</div>
<div class="line">        <a class="code hl_define" href="group___pz_app_logger.html#ga57e4c432a80f1ffc8de1a41a42ac07d0">PZ_WARNING</a>(<span class="stringliteral">&quot;[PresenZ] Could not find the PresenZ camera.&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">    }</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">int</span> pass = AiNodeGetInt(node, passStr);</div>
<div class="line">    PresenZ_data_struct::pass = pass;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">int</span> renderEye = AiNodeGetInt(pzCamera, renderingEyeStr);</div>
<div class="line">    <span class="keyword">const</span> AtNode *universeOptions = AiRenderSessionGetOptions(AiUniverseGetRenderSession(universe));</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (pass == Detect || pass == Detect_Reflection)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">if</span> (AiNodeGetInt(universeOptions, AASamplesStr) != 16)</div>
<div class="line">            <a class="code hl_define" href="group___pz_app_logger.html#gafd8b815a0f76d6b121f44f62d5730ee4">PZ_ERROR</a>(<span class="stringliteral">&quot;Detection phase requires 16 AA_Samples&quot;</span>);</div>
<div class="line">        <span class="keywordflow">if</span> (AiNodeGetBool(universeOptions, enableAdaptiveSamplingStr) == <span class="keyword">true</span>)</div>
<div class="line">            <a class="code hl_define" href="group___pz_app_logger.html#gafd8b815a0f76d6b121f44f62d5730ee4">PZ_ERROR</a>(<span class="stringliteral">&quot;Detection phase requires adaptative sampling disabled.&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (AiNodeGetFlt(universeOptions, pixelAspectRatioStr) != 1.0f)</div>
<div class="line">        <a class="code hl_define" href="group___pz_app_logger.html#gafd8b815a0f76d6b121f44f62d5730ee4">PZ_ERROR</a>(<span class="stringliteral">&quot;Device aspect ratio is not 1.0&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    <a class="code hl_function" href="group___pz_phase_api.html#gacfccac9e817766726140bc8ee2ce0ae5">PzInitPhase</a>((Phase)pass, PresenZ::Util::RenderingEngineId::ARNOLD);</div>
<div class="line"> </div>
<div class="line">    <a class="code hl_function" href="group___pz_phase_api.html#ga6263ef2247a2089acee99bf2dc4891cd">PzSetRenderTransparencyMode</a>(PresenZ::Phase::TransparencyRenderingType(PresenZ::Phase::TransparencyRenderingType::PRZ_BOTH));</div>
<div class="line">    PresenZ_data_struct::glass_pass_mode = PresenZ::Phase::TransparencyRenderingType::PRZ_BOTH;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (pass == Render || pass == Render_Reflection)</div>
<div class="line">    {</div>
<div class="line">        <a class="code hl_function" href="group___pz_phase_api.html#gab23e6ab698846a91a469c5a3c91fb5d0">PzSetExternalCounter</a>(<span class="keyword">true</span>);</div>
<div class="line">        registerAdditionalAOVs(node);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <a class="code hl_function" href="group___pz_phase_api.html#ga1a8e8cc90a1fa139011213a3115d80b7">PzSetDetectionSaveguard</a>(8.0, DSG_disabled);</div>
<div class="line">    <span class="comment">// Arnold is thread safe when writing files.</span></div>
<div class="line">    <a class="code hl_function" href="group___pz_phase_api.html#ga16b450c73fbfd9298b91d051b87fa3dd">PzSetOutputThreadSafety</a>(<span class="keyword">false</span>);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (pass == Detect || pass == Detect_Reflection) {</div>
<div class="line">        <a class="code hl_function" href="group___pz_phase_api.html#ga8492ca6f6962498177d3a8a7f0e33b80">PzSetPresenZBucket</a>(<span class="keyword">true</span>);</div>
<div class="line">        <a class="code hl_function" href="group___pz_phase_api.html#gaf893250a30d9bea6182a59fbe66dbe9c">PzSetThreadNumber</a>(AiNodeGetInt(universeOptions, threadsStr));</div>
<div class="line"> </div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> {</div>
<div class="line">        <a class="code hl_function" href="group___pz_phase_api.html#ga8492ca6f6962498177d3a8a7f0e33b80">PzSetPresenZBucket</a>(<span class="keyword">false</span>);</div>
<div class="line">        <a class="code hl_function" href="group___pz_phase_api.html#gaf893250a30d9bea6182a59fbe66dbe9c">PzSetThreadNumber</a>(0);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <a class="code hl_function" href="group___pz_phase_api.html#ga341b31b72158a06791d4d0e0606c427a">PzSetCameraUpVector</a>(<a class="code hl_typedef" href="group___n_o_z__vector.html#ga347d85f3e636cf273a47949aa0613a8f">NozVector</a>(0.0, 1.0, 0.0));</div>
<div class="line">    <a class="code hl_function" href="group___pz_phase_api.html#gaaf7df9d321491e87bd3fa52ad5c648a0">PzSetDetectFilePath</a>(GetOutputDirectoryDetectFilePath(node).c_str());</div>
<div class="line">    <a class="code hl_function" href="group___pz_phase_api.html#ga7759b42bda5736f78e2fecd80601d16e">PzSetOutFilePath</a>(GetOutputDirectoryFilePath(node).c_str());</div>
<div class="line">    <a class="code hl_function" href="group___pz_phase_api.html#ga9d205f548fd171cda282661a9c849b3d">PzSetCurrentFrame</a>((<span class="keywordtype">int</span>)AiNodeGetFlt(universeOptions, frameStr));</div>
<div class="line">    <a class="code hl_function" href="group___pz_phase_api.html#gabeff0a36ad7a222a509922e10096c20f">PzSetDraft</a>(AiNodeGetBool(pzCamera, draftModeStr));</div>
<div class="line">    <a class="code hl_function" href="group___pz_phase_api.html#ga949129ceea6602d8e188e8edde8c9596">PzSetDeepReflection</a>(Eye::RC_LeftAndRight, AiNodeGetFlt(pzCamera, ipdStr));</div>
<div class="line">    </div>
<div class="line">    <a class="code hl_function" href="group___pz_phase_api.html#gaa99ece6cbf6d1f8a07966bb2e17cbcb5">PzSetIdealPointSizeTarget</a>(AiNodeGetFlt(pzCamera, idealPointSizeStr));</div>
<div class="line">    <a class="code hl_function" href="group___pz_phase_api.html#ga6864add2dc016bfc5a1e1e980f8ce2cc">PzSetRenderScale</a>(AiNodeGetFlt(pzCamera, presenzSceneScaleStr));</div>
<div class="line">    </div>
<div class="line">    </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">int</span> renderTargetResX = AiNodeGetInt(universeOptions, xresStr);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">int</span> renderTargetResY = AiNodeGetInt(universeOptions, yresStr);</div>
<div class="line"> </div>
<div class="line">    initPresenZCameraParameters(pzCamera, renderTargetResX, renderTargetResY, AiNodeGetFlt(pzCamera, ipdStr));</div>
<div class="line"> </div>
<div class="line">    <a class="code hl_function" href="group___pz_phase_api.html#gab97cf9e993c581aca0a1eb7401faf784">PzSetMotionVector</a>(<span class="keyword">true</span>);</div>
<div class="line"> </div>
<div class="line">    <a class="code hl_function" href="group___pz_phase_api.html#ga8fb61701ff43f121a84599ecd7443656">PzSetRenderingResolutionParameters</a>(<a class="code hl_function" href="group___pz_phase_api.html#ga61484e9b774b113f22f6148d811ed715">PzComputeRenderingResolutionParameters</a>(renderTargetResX, renderTargetResY));</div>
<div class="line">    <span class="comment">//PzSetRenderingResolutionParameters(PzGetRenderingResolutionParameters());</span></div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (pass == Render || pass == Render_Reflection) {</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">bool</span> do_crypto_object = AiNodeGetBool(node, cryptomatteObjectStr);</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">bool</span> do_crypto_material = AiNodeGetBool(node, cryptomatteMaterialStr);</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">bool</span> do_crypto_asset = AiNodeGetBool(node, cryptomatteAssetStr);</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">int</span> depth_object = AiNodeGetInt(node, cryptomatteObjectDepthStr);</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">int</span> depth_material = AiNodeGetInt(node, cryptomatteMaterialDepthStr);</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">int</span> depth_asset = AiNodeGetInt(node, cryptomatteAssetDepthStr);</div>
<div class="line"> </div>
<div class="line">        PresenZ_data_struct::do_crypto = do_crypto_object || do_crypto_material || do_crypto_asset;</div>
<div class="line">        <a class="code hl_function" href="group___pz_phase_api.html#ga7aca27da0e5e0e838ec13de88a551a6d">PzSetCryptomatte</a>(do_crypto_object, do_crypto_material, do_crypto_asset, depth_object, depth_material, depth_asset);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">AI_DRIVER_NODE_EXPORT_METHODS(nozPresenZDriverMethods);</div>
<div class="line"> </div>
<div class="line">node_parameters</div>
<div class="line">{</div>
<div class="line">    AiParameterStr(<span class="stringliteral">&quot;filename&quot;</span>, <span class="stringliteral">&quot;presenz.prz&quot;</span>);</div>
<div class="line">    AiParameterStr(<span class="stringliteral">&quot;detect_file&quot;</span>, <span class="stringliteral">&quot;presenz.przDetect&quot;</span>);</div>
<div class="line">    AiMetaDataSetBool(nentry, <span class="stringliteral">&quot;detect_file&quot;</span>, <span class="stringliteral">&quot;maya.hide&quot;</span>, <span class="keyword">true</span>);</div>
<div class="line">    AiParameterStr(<span class="stringliteral">&quot;color_space&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);          <span class="comment">// No idea what to do with that, but otherwise MtoA barf about it.</span></div>
<div class="line">    AiParameterInt(<span class="stringliteral">&quot;pass&quot;</span>, 0);</div>
<div class="line">    AiMetaDataSetBool(nentry, <span class="stringliteral">&quot;pass&quot;</span>, <span class="stringliteral">&quot;maya.hide&quot;</span>, <span class="keyword">true</span>);</div>
<div class="line"> </div>
<div class="line">    AiParameterBool(<span class="stringliteral">&quot;cryptomatte_object&quot;</span>, <span class="keyword">true</span>);</div>
<div class="line">    AiParameterInt(<span class="stringliteral">&quot;cryptomatte_object_depth&quot;</span>, 2);</div>
<div class="line">    AiParameterBool(<span class="stringliteral">&quot;cryptomatte_material&quot;</span>, <span class="keyword">false</span>);</div>
<div class="line">    AiParameterInt(<span class="stringliteral">&quot;cryptomatte_material_depth&quot;</span>, 2);</div>
<div class="line">    AiParameterBool(<span class="stringliteral">&quot;cryptomatte_asset&quot;</span>, <span class="keyword">false</span>);</div>
<div class="line">    AiParameterInt(<span class="stringliteral">&quot;cryptomatte_asset_depth&quot;</span>, 2);</div>
<div class="line"> </div>
<div class="line">    AiParameterInt(<span class="stringliteral">&quot;current_block&quot;</span>, 0);         <span class="comment">// &quot;Current block to render&quot;</span></div>
<div class="line">    AiMetaDataSetBool(nentry, <span class="stringliteral">&quot;current_block&quot;</span>, <span class="stringliteral">&quot;maya.hide&quot;</span>, <span class="keyword">true</span>);</div>
<div class="line">    AiMetaDataSetStr(nentry, <span class="stringliteral">&quot;current_block&quot;</span>, <span class="stringliteral">&quot;_synonym&quot;</span>, <span class="stringliteral">&quot;current_Block&quot;</span>);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    AiMetaDataSetBool(nentry, <span class="stringliteral">&quot;filename&quot;</span>, <span class="stringliteral">&quot;maya.hide&quot;</span>, <span class="keyword">true</span>);</div>
<div class="line">    AiMetaDataSetStr(nentry, NULL, <span class="stringliteral">&quot;maya.attr_prefix&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);</div>
<div class="line">    AiMetaDataSetStr(nentry, NULL, <span class="stringliteral">&quot;maya.translator&quot;</span>, <span class="stringliteral">&quot;prz&quot;</span>);</div>
<div class="line">    AiMetaDataSetStr(nentry, NULL, <span class="stringliteral">&quot;_synonym&quot;</span>, <span class="stringliteral">&quot;PresenZDriver&quot;</span>);</div>
<div class="line">    </div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">driver_extension</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span>* extensions[] = { <span class="stringliteral">&quot;prz&quot;</span>, <span class="stringliteral">&quot;przDetect&quot;</span>, <span class="stringliteral">&quot;przRender&quot;</span>, NULL };</div>
<div class="line">    <span class="keywordflow">return</span> extensions;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">driver_supports_pixel_type</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span> pixel_type == AI_TYPE_POINTER || pixel_type == AI_TYPE_NODE;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">node_initialize</div>
<div class="line">{</div>
<div class="line">    AiDriverInitialize(node, <span class="keyword">true</span>);</div>
<div class="line">    DriverData* data = (DriverData*) AiNodeGetLocalData(node);</div>
<div class="line">    <span class="keywordflow">if</span> (data == <span class="keyword">nullptr</span>) {</div>
<div class="line">        data = (DriverData*)AiMalloc(<span class="keyword">sizeof</span>(DriverData));</div>
<div class="line">        data-&gt;m_idValid = <span class="keyword">false</span>;</div>
<div class="line">        data-&gt;m_aovDeclaration = <span class="keyword">nullptr</span>;</div>
<div class="line">        data-&gt;m_numElements = 0;</div>
<div class="line">        AiNodeSetLocalData(node, data);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <a class="code hl_function" href="group___pz_app_logger.html#ga6a60b77d5b79c3fb2d4d98e36433404f">PresenZ::Logger::PzSetDateHeader</a>(<span class="keyword">false</span>);</div>
<div class="line">    <a class="code hl_function" href="group___pz_app_logger.html#ga57c6b13b743e34cf547345173a7b8c4a">PresenZ::Logger::PzSetLogLevelHeader</a>(<span class="keyword">false</span>);</div>
<div class="line">    <a class="code hl_function" href="group___pz_app_logger.html#ga3ec2ec1cb88fd9a6ea0a115731dd753f">PresenZ::Logger::PzSetConsole</a>(<span class="keyword">false</span>);</div>
<div class="line">    <a class="code hl_function" href="group___pz_app_logger.html#ga47dccb155300c8d87d86a3084b5ed685">PresenZ::Logger::PzSetProgressBarType</a>(PresenZ::Logger::PT_vertical);</div>
<div class="line">    <a class="code hl_function" href="group___pz_app_logger.html#gad553edc68869caef27062377dbd1fa3e">PresenZ::Logger::PzSetCallBackLogLevel</a>(PresenZ::Logger::LL_Trace, arnoldLogger, <span class="keyword">static_cast&lt;</span><span class="keywordtype">void</span> *<span class="keyword">&gt;</span>(NULL));</div>
<div class="line">    <a class="code hl_function" href="group___pz_app_logger.html#gaa4854eda2f578deaffb33e081b5fc398">PresenZ::Logger::PzSetCallbackCarriageReturnMode</a>(PresenZ::Logger::CR_NoCarriageReturn);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">node_update </div>
<div class="line">{</div>
<div class="line">    DriverData *data = (DriverData*)AiNodeGetLocalData(node);</div>
<div class="line">    data-&gt;m_idValid = initPresenZ(node);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span>(data-&gt;m_idValid == <span class="keyword">true</span>)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordtype">size_t</span> currentBlock = AiNodeGetInt(node, currentBlockStr);</div>
<div class="line">        <a class="code hl_function" href="group___pz_phase_api.html#gae9136a619889cbaeddc60ea57063cd96">PzSetCurrentBlockIndex</a>(currentBlock);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">        <a class="code hl_define" href="group___pz_app_logger.html#gaf8ab3f1606906a93b3081de7f0cb7be1">PZ_INFO</a>(<span class="stringliteral">&quot;[PresenZ] Driver disabled.&quot;</span>)</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">node_finish</div>
<div class="line">{</div>
<div class="line">    DriverData *data = (DriverData*)AiNodeGetLocalData(node);</div>
<div class="line">    AiFree(data);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Callback invoked by Arnold when it is ready to start rendering an image</span></div>
<div class="line">driver_open</div>
<div class="line">{</div>
<div class="line">    DriverData *data = (DriverData*)AiNodeGetLocalData(node);</div>
<div class="line">    <span class="keywordflow">if</span> (data-&gt;m_idValid == <span class="keyword">false</span>)</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (PresenZ_data_struct::pass == Detect || PresenZ_data_struct::pass == Detect_Reflection)</div>
<div class="line">        <a class="code hl_function" href="group___pz_phase_api.html#ga0712724a7353482a6325ac660aa0059c">PzSetBucketSize</a>(bucket_size, bucket_size);</div>
<div class="line"> </div>
<div class="line">    <a class="code hl_function" href="group___pz_phase_api.html#gaec78fb6ddee0e55ac6524b5eaa5dcbfb">PzPhaseBegin</a>();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> compileManifests(AtUniverse* universe, <span class="keywordtype">bool</span> do_md_material) {</div>
<div class="line">    AtNodeIterator* shape_iterator = AiUniverseGetNodeIterator(universe, AI_NODE_SHAPE);</div>
<div class="line">    <span class="keywordflow">while</span> (!AiNodeIteratorFinished(shape_iterator)) {</div>
<div class="line">        AtNode* node = AiNodeIteratorGetNext(shape_iterator);</div>
<div class="line">        <span class="keywordflow">if</span> (!node || AiNodeIsDisabled(node))</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// skip any list aggregate nodes</span></div>
<div class="line">        <span class="keywordflow">if</span> (AiNodeIs(node, aStr_list_aggregate))</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordtype">char</span> nsp_name[<a class="code hl_define" href="_pz_cryptomatte_api_8h.html#a52a3717199fbc540c58210f997fb8bc6">PZ_CRYPTO_MAX_STRING_LENGTH</a>] = <span class="stringliteral">&quot;&quot;</span>;</div>
<div class="line">        <span class="keywordtype">char</span> obj_name[<a class="code hl_define" href="_pz_cryptomatte_api_8h.html#a52a3717199fbc540c58210f997fb8bc6">PZ_CRYPTO_MAX_STRING_LENGTH</a>] = <span class="stringliteral">&quot;&quot;</span>;</div>
<div class="line"> </div>
<div class="line">        <a class="code hl_function" href="namespace_presen_z_1_1_cryptomatte_1_1v4__1.html#ae631ac509ed7d825f83e331ee413f610">PresenZ::Cryptomatte::PzAddObjectToManifest</a>(AiNodeGetName(node));</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (do_md_material) {</div>
<div class="line">            <span class="comment">// Process all shaders from the objects into the manifest.</span></div>
<div class="line">            <span class="comment">// This includes cluster materials.</span></div>
<div class="line">            AtArray* shaders = AiNodeGetArray(node, shaderStr);</div>
<div class="line">            <span class="keywordflow">if</span> (!shaders)</div>
<div class="line">                <span class="keywordflow">continue</span>;</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">for</span> (uint32_t i = 0; i &lt; AiArrayGetNumElements(shaders); i++) {</div>
<div class="line">                AtNode* shader = <span class="keyword">static_cast&lt;</span>AtNode*<span class="keyword">&gt;</span>(AiArrayGetPtr(shaders, i));</div>
<div class="line">                <span class="keywordflow">if</span> (!shader)</div>
<div class="line">                    <span class="keywordflow">continue</span>;</div>
<div class="line">                <a class="code hl_function" href="namespace_presen_z_1_1_cryptomatte_1_1v4__1.html#a161627255b44a69a262fb70ff028c892">PresenZ::Cryptomatte::PzAddMaterialToManifest</a>(AiNodeGetName(shader));</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    AiNodeIteratorDestroy(shape_iterator);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Callback invoked an image is finished.</span></div>
<div class="line">driver_close</div>
<div class="line">{</div>
<div class="line">    DriverData* data = (DriverData*)AiNodeGetLocalData(node);   </div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">bool</span> objects, materials, assets = <span class="keyword">false</span>;</div>
<div class="line">    <a class="code hl_function" href="namespace_presen_z_1_1_cryptomatte_1_1v4__1.html#a3404d8b67629d5291a6656c413729eaa">PresenZ::Cryptomatte::PzGetActiveCryptomatte</a>(objects, materials, assets);</div>
<div class="line">    <span class="keywordflow">if</span> (objects || materials || assets) {</div>
<div class="line">        </div>
<div class="line">        compileManifests(AiNodeGetUniverse(node), materials);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (PresenZ_data_struct::pass == Detect || PresenZ_data_struct::pass == Detect_Reflection)</div>
<div class="line">        <a class="code hl_function" href="group__bucket_a_p_i.html#gaa4ed3ca9925f6556bd64c9454ef9050d">PzProcessAllBucketsToFile</a>();</div>
<div class="line"> </div>
<div class="line">    restoreAOVs(node);</div>
<div class="line">    <a class="code hl_function" href="group___pz_phase_api.html#ga593691219de55ef1887e6c62dae74abe">PzPhaseTerminate</a>();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">driver_needs_bucket</div>
<div class="line">{</div>
<div class="line">    DriverData *data = (DriverData*)AiNodeGetLocalData(node);</div>
<div class="line">    <span class="keywordflow">if</span> (data-&gt;m_idValid == <span class="keyword">false</span>)</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Callback invoked by Arnold when bucket (image sub zone) is going to be rendered.</span></div>
<div class="line">driver_prepare_bucket</div>
<div class="line">{</div>
<div class="line">    DriverData *data = (DriverData*)AiNodeGetLocalData(node);</div>
<div class="line">    <span class="keywordflow">if</span> (data-&gt;m_idValid == <span class="keyword">false</span>)</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (PresenZ_data_struct::pass == Detect || PresenZ_data_struct::pass == Detect_Reflection)</div>
<div class="line">        <a class="code hl_function" href="group__bucket_a_p_i.html#gafe1645a695f8bebb0cc0ec8d319ead5a">PzInitBucket</a>(tid, bucket_xo, bucket_yo, bucket_xo + bucket_size_x, bucket_yo + bucket_size_y);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Callback invoked by Arnold when a bucket (image sub-zone) is finished, all s haded pixels are forwarded </span></div>
<div class="line"><span class="comment">// to PresenZ for further processing. </span></div>
<div class="line">driver_process_bucket</div>
<div class="line">{</div>
<div class="line"> </div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> write_bucket_detect(AtNode* node, <span class="keyword">struct</span> AtOutputIterator* iterator, <span class="keyword">struct</span> AtAOVSampleIterator* sample_iterator, <span class="keywordtype">int</span> bucket_xo, <span class="keywordtype">int</span> bucket_yo, <span class="keywordtype">int</span> bucket_size_x, <span class="keywordtype">int</span> bucket_size_y)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">void</span>* bucket_data;</div>
<div class="line">    AtString name;</div>
<div class="line">    <span class="keywordtype">int</span> type = AI_TYPE_UNDEFINED;</div>
<div class="line"> </div>
<div class="line">    FilterDataDetect** pixels_data;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">while</span> (AiOutputIteratorGetNext(iterator, &amp;name, &amp;type, &amp;bucket_data)) {</div>
<div class="line">        <span class="keywordflow">if</span> (name == detectPzStr) {</div>
<div class="line">            pixels_data = (FilterDataDetect**)bucket_data;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j &lt; bucket_size_y; ++j) {</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; bucket_size_x; ++i) {</div>
<div class="line">            <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> in_idx = j * bucket_size_x + i;</div>
<div class="line">            <span class="keywordtype">size_t</span> dataSize = pixels_data[in_idx]-&gt;data.size();</div>
<div class="line">            </div>
<div class="line">            <span class="keywordflow">if</span> (dataSize != 0) {</div>
<div class="line">                <a class="code hl_function" href="group__bucket_a_p_i.html#ga4576780aee9296d244bc5c929b5cae92">PzFlushSamplesToFile</a>(pixels_data[in_idx]-&gt;data);</div>
<div class="line">            }</div>
<div class="line"> </div>
<div class="line">            std::vector&lt;PresenZ::DetectSample::SaveDataStructure&gt; empty_vector;</div>
<div class="line">            pixels_data[in_idx]-&gt;data.swap(empty_vector);</div>
<div class="line">            <span class="keyword">delete</span> pixels_data[in_idx];</div>
<div class="line">            pixels_data[in_idx] = <span class="keyword">nullptr</span>; <span class="comment">// Ensure the pointer is not left dangling</span></div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> write_bucket_render(AtNode* node, <span class="keyword">struct</span> AtOutputIterator* iterator, <span class="keyword">struct</span> AtAOVSampleIterator* sample_iterator, <span class="keywordtype">int</span> bucket_xo, <span class="keywordtype">int</span> bucket_yo, <span class="keywordtype">int</span> bucket_size_x, <span class="keywordtype">int</span> bucket_size_y)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">void</span>* bucket_data;</div>
<div class="line">    AtString name;</div>
<div class="line">    <span class="keywordtype">int</span> type = AI_TYPE_UNDEFINED;</div>
<div class="line"> </div>
<div class="line">    FilterData** pixels_data;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">while</span> (AiOutputIteratorGetNext(iterator, &amp;name, &amp;type, &amp;bucket_data)) {</div>
<div class="line">        <span class="keywordflow">if</span> (name == RGBAAtStr) {</div>
<div class="line">            pixels_data = (FilterData**)bucket_data;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j &lt; bucket_size_y; ++j) {</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; bucket_size_x; ++i) {</div>
<div class="line">            <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> in_idx = j * bucket_size_x + i;</div>
<div class="line">            <span class="keywordtype">size_t</span> dataSize = pixels_data[in_idx]-&gt;data.size();</div>
<div class="line">            <span class="keywordflow">if</span> (dataSize != 0) {</div>
<div class="line">                <a class="code hl_function" href="group__bucket_a_p_i.html#ga4576780aee9296d244bc5c929b5cae92">PzFlushSamplesToFile</a>(pixels_data[in_idx]-&gt;data);</div>
<div class="line">            }</div>
<div class="line">            std::vector&lt;PresenZ::RenderSample::PzFilteredSample&gt; empty_vector;</div>
<div class="line">            pixels_data[in_idx]-&gt;data.swap(empty_vector);  </div>
<div class="line">            <span class="keyword">delete</span> pixels_data[in_idx];</div>
<div class="line">            pixels_data[in_idx] = <span class="keyword">nullptr</span>; <span class="comment">// Ensure the pointer is not left dangling        </span></div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Callback invoked by Arnold when bucket (image sub-zone) is finished and can be dismissed.</span></div>
<div class="line">driver_write_bucket</div>
<div class="line">{</div>
<div class="line">    DriverData *data = (DriverData*)AiNodeGetLocalData(node);</div>
<div class="line">    <span class="keywordflow">if</span> (data-&gt;m_idValid == <span class="keyword">false</span>)</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (PresenZ_data_struct::pass == PresenZ::Phase::Detect || PresenZ_data_struct::pass == PresenZ::Phase::Detect_Reflection) {</div>
<div class="line">        write_bucket_detect(node, iterator, sample_iterator, bucket_xo, bucket_yo, bucket_size_x, bucket_size_y);</div>
<div class="line">        <a class="code hl_function" href="group__bucket_a_p_i.html#gac131bd2c254eac1badac0375eb5f082e">PzProcessBucketFlushToFile</a>(bucket_xo, bucket_yo, bucket_xo + bucket_size_x, bucket_yo + bucket_size_y);</div>
<div class="line">        </div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (PresenZ_data_struct::pass == PresenZ::Phase::Render || PresenZ_data_struct::pass == PresenZ::Phase::Render_Reflection)</div>
<div class="line">        write_bucket_render(node, iterator, sample_iterator, bucket_xo, bucket_yo, bucket_size_x, bucket_size_y);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">}</div>
<div class="ttc" id="a_pz_cryptomatte_api_8h_html_a52a3717199fbc540c58210f997fb8bc6"><div class="ttname"><a href="_pz_cryptomatte_api_8h.html#a52a3717199fbc540c58210f997fb8bc6">PZ_CRYPTO_MAX_STRING_LENGTH</a></div><div class="ttdeci">#define PZ_CRYPTO_MAX_STRING_LENGTH</div><div class="ttdef"><b>Definition</b> PzCryptomatteApi.h:11</div></div>
<div class="ttc" id="agroup___pz_app_logger_html_ga3ec2ec1cb88fd9a6ea0a115731dd753f"><div class="ttname"><a href="group___pz_app_logger.html#ga3ec2ec1cb88fd9a6ea0a115731dd753f">PresenZ::Logger::v4_1::PzSetConsole</a></div><div class="ttdeci">void PzSetConsole(bool enabled)</div><div class="ttdoc">Do you want the logs to appear in the STD out.</div></div>
<div class="ttc" id="agroup___pz_app_logger_html_ga47dccb155300c8d87d86a3084b5ed685"><div class="ttname"><a href="group___pz_app_logger.html#ga47dccb155300c8d87d86a3084b5ed685">PresenZ::Logger::v4_1::PzSetProgressBarType</a></div><div class="ttdeci">void PzSetProgressBarType(ProgressBarType progressType)</div><div class="ttdoc">switch to an horizontal progress bax or to a vertical percentage counter</div></div>
<div class="ttc" id="agroup___pz_app_logger_html_ga57c6b13b743e34cf547345173a7b8c4a"><div class="ttname"><a href="group___pz_app_logger.html#ga57c6b13b743e34cf547345173a7b8c4a">PresenZ::Logger::v4_1::PzSetLogLevelHeader</a></div><div class="ttdeci">void PzSetLogLevelHeader(bool enabled)</div><div class="ttdoc">Enable/disable logging in the header, if enabled the highest level of logging will be used.</div></div>
<div class="ttc" id="agroup___pz_app_logger_html_ga57e4c432a80f1ffc8de1a41a42ac07d0"><div class="ttname"><a href="group___pz_app_logger.html#ga57e4c432a80f1ffc8de1a41a42ac07d0">PZ_WARNING</a></div><div class="ttdeci">#define PZ_WARNING(a,...)</div><div class="ttdoc">Printf-like define that forwards a WARNING message to PresenZ logging system.</div><div class="ttdef"><b>Definition</b> PzAppLogger.h:211</div></div>
<div class="ttc" id="agroup___pz_app_logger_html_ga6a60b77d5b79c3fb2d4d98e36433404f"><div class="ttname"><a href="group___pz_app_logger.html#ga6a60b77d5b79c3fb2d4d98e36433404f">PresenZ::Logger::v4_1::PzSetDateHeader</a></div><div class="ttdeci">void PzSetDateHeader(bool enabled)</div><div class="ttdoc">Enable/disable the date/time header.</div></div>
<div class="ttc" id="agroup___pz_app_logger_html_gaa4854eda2f578deaffb33e081b5fc398"><div class="ttname"><a href="group___pz_app_logger.html#gaa4854eda2f578deaffb33e081b5fc398">PresenZ::Logger::v4_1::PzSetCallbackCarriageReturnMode</a></div><div class="ttdeci">void PzSetCallbackCarriageReturnMode(CarriageReturnMode carriageMode)</div><div class="ttdoc">Force enable/disable end of line at each line forwarded to the callback.</div></div>
<div class="ttc" id="agroup___pz_app_logger_html_gad553edc68869caef27062377dbd1fa3e"><div class="ttname"><a href="group___pz_app_logger.html#gad553edc68869caef27062377dbd1fa3e">PresenZ::Logger::v4_1::PzSetCallBackLogLevel</a></div><div class="ttdeci">void PzSetCallBackLogLevel(LogLevel lvl, AppLoggerCallback callback, void *userData)</div><div class="ttdoc">Set the loglevel, which will be the callback for the current application.</div></div>
<div class="ttc" id="agroup___pz_app_logger_html_gaf8ab3f1606906a93b3081de7f0cb7be1"><div class="ttname"><a href="group___pz_app_logger.html#gaf8ab3f1606906a93b3081de7f0cb7be1">PZ_INFO</a></div><div class="ttdeci">#define PZ_INFO(a,...)</div><div class="ttdoc">Printf-like defined method that forwards an INFO message to PresenZ logging system.</div><div class="ttdef"><b>Definition</b> PzAppLogger.h:208</div></div>
<div class="ttc" id="agroup___pz_phase_api_html_ga0712724a7353482a6325ac660aa0059c"><div class="ttname"><a href="group___pz_phase_api.html#ga0712724a7353482a6325ac660aa0059c">PresenZ::Phase::v4_1::PzSetBucketSize</a></div><div class="ttdeci">void PzSetBucketSize(const size_t &amp;width, const size_t &amp;height)</div><div class="ttdoc">Set the width and height for each render bucket.</div></div>
<div class="ttc" id="agroup___pz_phase_api_html_ga0e256374d02c493cea64e1413a0da7f1"><div class="ttname"><a href="group___pz_phase_api.html#ga0e256374d02c493cea64e1413a0da7f1">PresenZ::Phase::v4_1::PzSetFroxtrum</a></div><div class="ttdeci">void PzSetFroxtrum(const bool &amp;enabled=false)</div><div class="ttdoc">By default, froxtrum rendering is off.</div></div>
<div class="ttc" id="agroup___pz_phase_api_html_ga16b450c73fbfd9298b91d051b87fa3dd"><div class="ttname"><a href="group___pz_phase_api.html#ga16b450c73fbfd9298b91d051b87fa3dd">PresenZ::Phase::v4_1::PzSetOutputThreadSafety</a></div><div class="ttdeci">bool PzSetOutputThreadSafety(const bool &amp;threadSafe)</div><div class="ttdoc">Add a thread lock mechanism if the renderer is not thread safe when saving images.</div></div>
<div class="ttc" id="agroup___pz_phase_api_html_ga1a8e8cc90a1fa139011213a3115d80b7"><div class="ttname"><a href="group___pz_phase_api.html#ga1a8e8cc90a1fa139011213a3115d80b7">PresenZ::Phase::v4_1::PzSetDetectionSaveguard</a></div><div class="ttdeci">void PzSetDetectionSaveguard(const float &amp;blockNumber=8.0, unsigned char DSG_ORedFlags=DSG_error)</div><div class="ttdoc">Detection saveguard. trigger a safeguard action when the number of detect block is above blockNumber.</div></div>
<div class="ttc" id="agroup___pz_phase_api_html_ga1aca5cb52d6cc925c72a658a8cae0161"><div class="ttname"><a href="group___pz_phase_api.html#ga1aca5cb52d6cc925c72a658a8cae0161">PresenZ::Phase::v4_1::PzSetSpecularPointOffset</a></div><div class="ttdeci">void PzSetSpecularPointOffset(const NozVector &amp;specularPointOffset)</div><div class="ttdoc">Set which will be the POV used for computing specularity during the rendering phase.</div></div>
<div class="ttc" id="agroup___pz_phase_api_html_ga341b31b72158a06791d4d0e0606c427a"><div class="ttname"><a href="group___pz_phase_api.html#ga341b31b72158a06791d4d0e0606c427a">PresenZ::Phase::v4_1::PzSetCameraUpVector</a></div><div class="ttdeci">void PzSetCameraUpVector(const NozVector &amp;up)</div><div class="ttdoc">Set the camera Up Vector All rotation removed on the camera, in which axis(in scene space),...</div></div>
<div class="ttc" id="agroup___pz_phase_api_html_ga536fd47146cb18c507f803356f5df1d9"><div class="ttname"><a href="group___pz_phase_api.html#ga536fd47146cb18c507f803356f5df1d9">PresenZ::Phase::v4_1::PzSetClippingSphere</a></div><div class="ttdeci">void PzSetClippingSphere(bool enabled, const NozVector &amp;worldPos=NozVector(0.0f), const float radius=100.0f, const bool clipInside=false)</div><div class="ttdoc">Set the clipping sphere (optional).</div></div>
<div class="ttc" id="agroup___pz_phase_api_html_ga593691219de55ef1887e6c62dae74abe"><div class="ttname"><a href="group___pz_phase_api.html#ga593691219de55ef1887e6c62dae74abe">PresenZ::Phase::v4_1::PzPhaseTerminate</a></div><div class="ttdeci">bool PzPhaseTerminate(const TerminatePhaseOptions &amp;option=WRITE_TO_DISC)</div><div class="ttdoc">Once rendering is finishing, PzPhaseTerminate has to be invoked.</div></div>
<div class="ttc" id="agroup___pz_phase_api_html_ga61484e9b774b113f22f6148d811ed715"><div class="ttname"><a href="group___pz_phase_api.html#ga61484e9b774b113f22f6148d811ed715">PresenZ::Phase::v4_1::PzComputeRenderingResolutionParameters</a></div><div class="ttdeci">const PzResolutionParam PzComputeRenderingResolutionParameters(const size_t &amp;blockNumber)</div><div class="ttdoc">Get the resolution to set the rendering engine and to process the phase with a custom number of block...</div></div>
<div class="ttc" id="agroup___pz_phase_api_html_ga6263ef2247a2089acee99bf2dc4891cd"><div class="ttname"><a href="group___pz_phase_api.html#ga6263ef2247a2089acee99bf2dc4891cd">PresenZ::Phase::v4_1::PzSetRenderTransparencyMode</a></div><div class="ttdeci">void PzSetRenderTransparencyMode(const TransparencyRenderingType &amp;type=PRZ_REGULAR, float glassThickness=1.0f)</div><div class="ttdoc">Set which transparency pass you are about to render.</div></div>
<div class="ttc" id="agroup___pz_phase_api_html_ga6864add2dc016bfc5a1e1e980f8ce2cc"><div class="ttname"><a href="group___pz_phase_api.html#ga6864add2dc016bfc5a1e1e980f8ce2cc">PresenZ::Phase::v4_1::PzSetRenderScale</a></div><div class="ttdeci">void PzSetRenderScale(const double &amp;renderScale=1.0)</div><div class="ttdoc">Set the final scale of the 3D points, scaling by 0.1 will make everything 10 times closer.</div></div>
<div class="ttc" id="agroup___pz_phase_api_html_ga770112d6d9328a4cc973dec788ec4c65"><div class="ttname"><a href="group___pz_phase_api.html#ga770112d6d9328a4cc973dec788ec4c65">PresenZ::Phase::v4_1::PzSetRenderInsideBox</a></div><div class="ttdeci">void PzSetRenderInsideBox(bool renderInside)</div><div class="ttdoc">Allow renders inside the render box (false by default, only outside (landscape mode) is renderer).</div></div>
<div class="ttc" id="agroup___pz_phase_api_html_ga7759b42bda5736f78e2fecd80601d16e"><div class="ttname"><a href="group___pz_phase_api.html#ga7759b42bda5736f78e2fecd80601d16e">PresenZ::Phase::v4_1::PzSetOutFilePath</a></div><div class="ttdeci">void PzSetOutFilePath(const char *fullPathFile)</div><div class="ttdoc">Set the output file where you want the data (and intermediary data) to be saved.</div></div>
<div class="ttc" id="agroup___pz_phase_api_html_ga79970a419cce7b5c709765413c5d8fb2"><div class="ttname"><a href="group___pz_phase_api.html#ga79970a419cce7b5c709765413c5d8fb2">PresenZ::Phase::v4_1::PzSetWindowShapesFile</a></div><div class="ttdeci">void PzSetWindowShapesFile(const char *windowShapesFilePath, int windowShapeIndex)</div><div class="ttdoc">Render from a shape with custom camera positions,normals an priority, instead of a box zone of view.</div></div>
<div class="ttc" id="agroup___pz_phase_api_html_ga7aca27da0e5e0e838ec13de88a551a6d"><div class="ttname"><a href="group___pz_phase_api.html#ga7aca27da0e5e0e838ec13de88a551a6d">PresenZ::Phase::v4_1::PzSetCryptomatte</a></div><div class="ttdeci">bool PzSetCryptomatte(const bool &amp;objects, const bool &amp;materials, const bool &amp;assets, const int &amp;objDepth, const int &amp;matDepth, const int &amp;assetDepth)</div><div class="ttdoc">Set the Cryptomatte AOVs we want to output.</div></div>
<div class="ttc" id="agroup___pz_phase_api_html_ga8492ca6f6962498177d3a8a7f0e33b80"><div class="ttname"><a href="group___pz_phase_api.html#ga8492ca6f6962498177d3a8a7f0e33b80">PresenZ::Phase::v4_1::PzSetPresenZBucket</a></div><div class="ttdeci">bool PzSetPresenZBucket(const bool &amp;state)</div><div class="ttdoc">Set it to false if you are not using the PresenZ internal bucket system.</div></div>
<div class="ttc" id="agroup___pz_phase_api_html_ga8fb61701ff43f121a84599ecd7443656"><div class="ttname"><a href="group___pz_phase_api.html#ga8fb61701ff43f121a84599ecd7443656">PresenZ::Phase::v4_1::PzSetRenderingResolutionParameters</a></div><div class="ttdeci">bool PzSetRenderingResolutionParameters(const PzResolutionParam &amp;params)</div><div class="ttdoc">Once you have sorted out what will be the render target resolution, pass this information to PresenZ.</div></div>
<div class="ttc" id="agroup___pz_phase_api_html_ga949129ceea6602d8e188e8edde8c9596"><div class="ttname"><a href="group___pz_phase_api.html#ga949129ceea6602d8e188e8edde8c9596">PresenZ::Phase::v4_1::PzSetDeepReflection</a></div><div class="ttdeci">void PzSetDeepReflection(const Eye &amp;eye, const double &amp;IPD=63.5)</div><div class="ttdoc">Set Deep reflection data.</div></div>
<div class="ttc" id="agroup___pz_phase_api_html_ga9d205f548fd171cda282661a9c849b3d"><div class="ttname"><a href="group___pz_phase_api.html#ga9d205f548fd171cda282661a9c849b3d">PresenZ::Phase::v4_1::PzSetCurrentFrame</a></div><div class="ttdeci">void PzSetCurrentFrame(const int &amp;frameNumber, const size_t &amp;padding=4)</div><div class="ttdoc">Set which frame you are about to render.</div></div>
<div class="ttc" id="agroup___pz_phase_api_html_ga9e5a704692330cca20bc7cc81219228e"><div class="ttname"><a href="group___pz_phase_api.html#ga9e5a704692330cca20bc7cc81219228e">PresenZ::Phase::v4_1::PzSetZovScaling</a></div><div class="ttdeci">void PzSetZovScaling(const float &amp;scaleX, const float &amp;scaleY, const float &amp;scaleZ)</div><div class="ttdoc">Set the box scaling (in units) of the Zone of View.</div></div>
<div class="ttc" id="agroup___pz_phase_api_html_gaa99ece6cbf6d1f8a07966bb2e17cbcb5"><div class="ttname"><a href="group___pz_phase_api.html#gaa99ece6cbf6d1f8a07966bb2e17cbcb5">PresenZ::Phase::v4_1::PzSetIdealPointSizeTarget</a></div><div class="ttdeci">void PzSetIdealPointSizeTarget(const double &amp;idealPointsize)</div><div class="ttdoc">lower the PresenZ definition by x2, x6 or x24 to prevent having points below a predefined size</div></div>
<div class="ttc" id="agroup___pz_phase_api_html_gaae62eec6ec456bd4c638f1c0b4bf470f"><div class="ttname"><a href="group___pz_phase_api.html#gaae62eec6ec456bd4c638f1c0b4bf470f">PresenZ::Phase::v4_1::PzSetZovOffset</a></div><div class="ttdeci">void PzSetZovOffset(const int &amp;offsetX, const int &amp;offsetY, const int &amp;offsetZ)</div><div class="ttdoc">Set the offset (in units) of the center of the Zone of View.</div></div>
<div class="ttc" id="agroup___pz_phase_api_html_gaaf7df9d321491e87bd3fa52ad5c648a0"><div class="ttname"><a href="group___pz_phase_api.html#gaaf7df9d321491e87bd3fa52ad5c648a0">PresenZ::Phase::v4_1::PzSetDetectFilePath</a></div><div class="ttdeci">void PzSetDetectFilePath(const char *fullPathFile)</div><div class="ttdoc">Set the file path to the Detection File created during the first phase.</div></div>
<div class="ttc" id="agroup___pz_phase_api_html_gab23e6ab698846a91a469c5a3c91fb5d0"><div class="ttname"><a href="group___pz_phase_api.html#gab23e6ab698846a91a469c5a3c91fb5d0">PresenZ::Phase::v4_1::PzSetExternalCounter</a></div><div class="ttdeci">void PzSetExternalCounter(const bool &amp;hasExternalCounter=false)</div><div class="ttdoc">Declare if we are using an external ray counter, using PzSetSamplesCount.</div></div>
<div class="ttc" id="agroup___pz_phase_api_html_gab3f9a2ad1e2b489787fb177116e3e248"><div class="ttname"><a href="group___pz_phase_api.html#gab3f9a2ad1e2b489787fb177116e3e248">PresenZ::Phase::v4_1::PzSetFroxtrumDepth</a></div><div class="ttdeci">void PzSetFroxtrumDepth(const int &amp;depth=6)</div><div class="ttdoc">Set the depth density of frustrum.</div></div>
<div class="ttc" id="agroup___pz_phase_api_html_gab7d28db69c251d7d1761412440d41068"><div class="ttname"><a href="group___pz_phase_api.html#gab7d28db69c251d7d1761412440d41068">PresenZ::Phase::v4_1::PzSetCameraToWorldMatrix</a></div><div class="ttdeci">void PzSetCameraToWorldMatrix(const NozMatrix &amp;camToWorld)</div><div class="ttdoc">Set the current camera transform.</div></div>
<div class="ttc" id="agroup___pz_phase_api_html_gab97cf9e993c581aca0a1eb7401faf784"><div class="ttname"><a href="group___pz_phase_api.html#gab97cf9e993c581aca0a1eb7401faf784">PresenZ::Phase::v4_1::PzSetMotionVector</a></div><div class="ttdeci">void PzSetMotionVector(const bool &amp;detectMotionVector)</div><div class="ttdoc">Set motion vector computation.</div></div>
<div class="ttc" id="agroup___pz_phase_api_html_gabeff0a36ad7a222a509922e10096c20f"><div class="ttname"><a href="group___pz_phase_api.html#gabeff0a36ad7a222a509922e10096c20f">PresenZ::Phase::v4_1::PzSetDraft</a></div><div class="ttdeci">void PzSetDraft(const bool &amp;isDraft=true)</div><div class="ttdoc">Set to true if you want to shortcut the rendering and have a quick preview.</div></div>
<div class="ttc" id="agroup___pz_phase_api_html_gabfdb2cfc6e11bc80cc3d8f27bff0768e"><div class="ttname"><a href="group___pz_phase_api.html#gabfdb2cfc6e11bc80cc3d8f27bff0768e">PresenZ::Phase::v4_1::PzSetDistanceToGround</a></div><div class="ttdeci">void PzSetDistanceToGround(const double &amp;distanceToGround=1.6)</div><div class="ttdoc">Set what is the estimated distance from ground.</div></div>
<div class="ttc" id="agroup___pz_phase_api_html_gacfccac9e817766726140bc8ee2ce0ae5"><div class="ttname"><a href="group___pz_phase_api.html#gacfccac9e817766726140bc8ee2ce0ae5">PresenZ::Phase::v4_1::PzInitPhase</a></div><div class="ttdeci">void PzInitPhase(const Phase &amp;phase, const PresenZ::Util::RenderingEngineId &amp;renderEngineId)</div><div class="ttdoc">This is the very first call to PresenZ.</div></div>
<div class="ttc" id="agroup___pz_phase_api_html_gadb463d0048e422dc0b613361de76d887"><div class="ttname"><a href="group___pz_phase_api.html#gadb463d0048e422dc0b613361de76d887">PresenZ::Phase::v4_1::PzSetVolumeDepth</a></div><div class="ttdeci">void PzSetVolumeDepth(const int &amp;depth=9)</div><div class="ttdoc">Set the depth density of volumetrics.</div></div>
<div class="ttc" id="agroup___pz_phase_api_html_gae379dd62e45b425b22c82f70455acfb8"><div class="ttname"><a href="group___pz_phase_api.html#gae379dd62e45b425b22c82f70455acfb8">PresenZ::Phase::v4_1::PzSetDetectionMinimumDistance</a></div><div class="ttdeci">void PzSetDetectionMinimumDistance(double minimumDistance)</div><div class="ttdoc">enforce PresenZ to perform the detection from a distance (in cm ) bigger than the input parameter.</div></div>
<div class="ttc" id="agroup___pz_phase_api_html_gae9136a619889cbaeddc60ea57063cd96"><div class="ttname"><a href="group___pz_phase_api.html#gae9136a619889cbaeddc60ea57063cd96">PresenZ::Phase::v4_1::PzSetCurrentBlockIndex</a></div><div class="ttdeci">bool PzSetCurrentBlockIndex(const size_t &amp;blockIndex)</div><div class="ttdoc">If you are in blocked mode: you will have to specify which block you are currently rendering to Prese...</div></div>
<div class="ttc" id="agroup___pz_phase_api_html_gaec78fb6ddee0e55ac6524b5eaa5dcbfb"><div class="ttname"><a href="group___pz_phase_api.html#gaec78fb6ddee0e55ac6524b5eaa5dcbfb">PresenZ::Phase::v4_1::PzPhaseBegin</a></div><div class="ttdeci">bool PzPhaseBegin()</div><div class="ttdoc">After initialization and once you have invoked all the necessary Setters (see above).</div></div>
<div class="ttc" id="agroup___pz_phase_api_html_gaf893250a30d9bea6182a59fbe66dbe9c"><div class="ttname"><a href="group___pz_phase_api.html#gaf893250a30d9bea6182a59fbe66dbe9c">PresenZ::Phase::v4_1::PzSetThreadNumber</a></div><div class="ttdeci">void PzSetThreadNumber(const size_t &amp;bucketNumber)</div><div class="ttdoc">Set the number of thread that will perform the rendering.</div></div>
<div class="ttc" id="agroup__bucket_a_p_i_html_ga4576780aee9296d244bc5c929b5cae92"><div class="ttname"><a href="group__bucket_a_p_i.html#ga4576780aee9296d244bc5c929b5cae92">PresenZ::BinIO::v4_1::PzFlushSamplesToFile</a></div><div class="ttdeci">bool PzFlushSamplesToFile(std::vector&lt; PresenZ::DetectSample::SaveDataStructure &gt; &amp;detectionsSamples)</div><div class="ttdoc">Flush the result to the disk, returns true if successful.</div></div>
<div class="ttc" id="agroup__bucket_a_p_i_html_gaa4ed3ca9925f6556bd64c9454ef9050d"><div class="ttname"><a href="group__bucket_a_p_i.html#gaa4ed3ca9925f6556bd64c9454ef9050d">PresenZ::BinIO::v4_1::PzProcessAllBucketsToFile</a></div><div class="ttdeci">void PzProcessAllBucketsToFile()</div><div class="ttdoc">This will go through all buckets and write any contained data to disk.</div></div>
<div class="ttc" id="agroup__bucket_a_p_i_html_gac131bd2c254eac1badac0375eb5f082e"><div class="ttname"><a href="group__bucket_a_p_i.html#gac131bd2c254eac1badac0375eb5f082e">PresenZ::BinIO::v4_1::PzProcessBucketFlushToFile</a></div><div class="ttdeci">bool PzProcessBucketFlushToFile(const size_t &amp;bucketId)</div><div class="ttdoc">Process the samples in the bucket into pixels and flush the result to the disk, returns true if succe...</div></div>
<div class="ttc" id="agroup__bucket_a_p_i_html_gafe1645a695f8bebb0cc0ec8d319ead5a"><div class="ttname"><a href="group__bucket_a_p_i.html#gafe1645a695f8bebb0cc0ec8d319ead5a">PresenZ::BinIO::v4_1::PzInitBucket</a></div><div class="ttdeci">void PzInitBucket(const size_t &amp;bucketId, const int &amp;x0, const int &amp;y0, const int &amp;x1, const int &amp;y1)</div><div class="ttdoc">Initialize a bucket (attached to a bucketId) that will contain pixels for the Region [x0,...</div></div>
<div class="ttc" id="amatrix_8h_html_a15eb5c4da255c65c60623dc95ca45bc1"><div class="ttname"><a href="matrix_8h.html#a15eb5c4da255c65c60623dc95ca45bc1">NozMatrix</a></div><div class="ttdeci">std::array&lt; std::array&lt; float, 4 &gt;, 4 &gt; NozMatrix</div><div class="ttdef"><b>Definition</b> matrix.h:8</div></div>
<div class="ttc" id="anamespace_presen_z_1_1_camera_html"><div class="ttname"><a href="namespace_presen_z_1_1_camera.html">PresenZ::Camera</a></div><div class="ttdef"><b>Definition</b> PzCameraApi.h:15</div></div>
<div class="ttc" id="anamespace_presen_z_1_1_cryptomatte_1_1v4__1_html_a161627255b44a69a262fb70ff028c892"><div class="ttname"><a href="namespace_presen_z_1_1_cryptomatte_1_1v4__1.html#a161627255b44a69a262fb70ff028c892">PresenZ::Cryptomatte::v4_1::PzAddMaterialToManifest</a></div><div class="ttdeci">void PzAddMaterialToManifest(const char *name)</div></div>
<div class="ttc" id="anamespace_presen_z_1_1_cryptomatte_1_1v4__1_html_ae631ac509ed7d825f83e331ee413f610"><div class="ttname"><a href="namespace_presen_z_1_1_cryptomatte_1_1v4__1.html#ae631ac509ed7d825f83e331ee413f610">PresenZ::Cryptomatte::v4_1::PzAddObjectToManifest</a></div><div class="ttdeci">void PzAddObjectToManifest(const char *name)</div></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md58"></a>
10.6 Operator</h1>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;ai.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &quot;presenz_global_parameters.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;arnoldWrapper.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="_pz_phase_api_8h.html">API/PzPhaseApi.h</a>&quot;</span></div>
<div class="line"> </div>
<div class="line">AI_OPERATOR_NODE_EXPORT_METHODS(PresenZOperatorMethods);</div>
<div class="line"> </div>
<div class="line">node_parameters</div>
<div class="line">{</div>
<div class="line">    AiParameterStr(<span class="stringliteral">&quot;selection&quot;</span>, <span class="stringliteral">&quot;*&quot;</span>);</div>
<div class="line">    AiParameterInt(<span class="stringliteral">&quot;pass&quot;</span>, -1);</div>
<div class="line">    AiParameterInt(<span class="stringliteral">&quot;rendering_eye&quot;</span>, 0);</div>
<div class="line">    AiParameterBool(<span class="stringliteral">&quot;override_bucket_size&quot;</span>, <span class="keyword">true</span>);</div>
<div class="line">    AiMetaDataSetStr(nentry, NULL, <span class="stringliteral">&quot;_synonym&quot;</span>, <span class="stringliteral">&quot;PresenZOperator&quot;</span>);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Operator are invoked every time the scene is ready to be rendered.</span></div>
<div class="line">operator_init</div>
<div class="line">{</div>
<div class="line">    <a class="code hl_function" href="group___pz_app_logger.html#ga3ec2ec1cb88fd9a6ea0a115731dd753f">PresenZ::Logger::PzSetConsole</a>(<span class="keyword">false</span>);</div>
<div class="line">    <a class="code hl_function" href="group___pz_app_logger.html#gad553edc68869caef27062377dbd1fa3e">PresenZ::Logger::PzSetCallBackLogLevel</a>(PresenZ::Logger::LL_Trace, PresenArnoldLogger, NULL);</div>
<div class="line">    <a class="code hl_function" href="group___pz_app_logger.html#gaa4854eda2f578deaffb33e081b5fc398">PresenZ::Logger::PzSetCallbackCarriageReturnMode</a>(PresenZ::Logger::CR_NoCarriageReturn);</div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Invoked at the end of a render.</span></div>
<div class="line">operator_cleanup</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">operator_post_cook</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// The cook operator is applied on every object on the scened. In this method</span></div>
<div class="line"><span class="comment">// we set up correctly PresenZ objects and connect every shape to the PresenZAOV</span></div>
<div class="line"><span class="comment">// shader. This will make sure we receive hits and normals for seen geometry.</span></div>
<div class="line">operator_cook</div>
<div class="line">{</div>
<div class="line">    AtUniverse* universe = AiNodeGetUniverse(node);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (AiNodeEntryGetType(AiNodeGetNodeEntry(node)) == AI_NODE_CAMERA)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">if</span> (AiNodeIs(node, PresenzCameraName))</div>
<div class="line">        {</div>
<div class="line">            <span class="comment">// near clip for chaotics</span></div>
<div class="line">            AiNodeSetFlt(node, nearClipStr, 0.0001f);</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">if</span>(AiNodeGetInt(op, renderingEyeStr) != -1)</div>
<div class="line">                AiNodeSetInt(node, renderingEyeStr, AiNodeGetInt(op, renderingEyeStr));</div>
<div class="line"> </div>
<div class="line">            <span class="comment">// We set the screen_window_min/screen_window_max to the actual resolution.</span></div>
<div class="line">            AtUniverse* current_universe = AiNodeGetUniverse(node);</div>
<div class="line">            AtNode* options = AiUniverseGetOptions(current_universe);</div>
<div class="line">            <span class="keywordtype">int</span> xres = AiNodeGetInt(options, xresStr);</div>
<div class="line">            <span class="keywordtype">int</span> yres = AiNodeGetInt(options, yresStr);</div>
<div class="line"> </div>
<div class="line">            <span class="keywordtype">float</span> frame_aspect_ratio = (float)xres / (<span class="keywordtype">float</span>)yres;</div>
<div class="line">            AiNodeSetVec2(node, screenWindowMinStr, 0, 0);</div>
<div class="line">            AiNodeSetVec2(node, screenWindowMaxStr, (<span class="keywordtype">float</span>)xres, ((<span class="keywordtype">float</span>)(yres)) * frame_aspect_ratio);</div>
<div class="line"> </div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (AiNodeEntryGetType(AiNodeGetNodeEntry(node)) == AI_NODE_DRIVER)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">if</span> (AiNodeIs(node, PresenZDriver)) {</div>
<div class="line">            <span class="keywordflow">if</span> (AiNodeGetInt(op, passStr) != -1)</div>
<div class="line">                AiNodeSetInt(node, passStr, AiNodeGetInt(op, passStr));</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">            <span class="comment">//get the pass in the driver</span></div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">int</span> pass = AiNodeGetInt(node, passStr);</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">if</span> (pass == PresenZ::Phase::Render || pass == PresenZ::Phase::Render_Reflection) {</div>
<div class="line">                registerAOVs(node);</div>
<div class="line"> </div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">bool</span> do_crypto_object = AiNodeGetBool(node, cryptomatteObjectStr);</div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">bool</span> do_crypto_material = AiNodeGetBool(node, cryptomatteMaterialStr);</div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">bool</span> do_crypto_asset = AiNodeGetBool(node, cryptomatteAssetStr);</div>
<div class="line"> </div>
<div class="line">                createCryptomatteOutput(node, do_crypto_object, do_crypto_material, do_crypto_asset);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pass == PresenZ::Phase::Detect || pass == PresenZ::Phase::Detect_Reflection) {</div>
<div class="line">                registerAOVsDetect(node);</div>
<div class="line"> </div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (AiNodeEntryGetType(AiNodeGetNodeEntry(node)) == AI_NODE_LIGHT)</div>
<div class="line">    {</div>
<div class="line">        </div>
<div class="line">        <span class="keywordflow">if</span> (AiNodeIs(node, skydomeLightAtStr) &amp;&amp; (AiNodeGetInt(op, passStr) == PresenZ::Phase::Detect || AiNodeGetInt(op, passStr) == PresenZ::Phase::Detect_Reflection))</div>
<div class="line">        {  </div>
<div class="line">            <span class="keywordflow">if</span> (AiNodeGetFlt(node, cameraStr) &lt;= AI_EPSILON) {</div>
<div class="line">                AiNodeSetDisabled(node, <span class="keyword">true</span>);</div>
<div class="line">                </div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (AiNodeEntryGetType(AiNodeGetNodeEntry(node)) == AI_NODE_OPTIONS)</div>
<div class="line">    {</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span>(AiNodeGetBool(op, overrideBucketSizeStr))</div>
<div class="line">            AiNodeSetInt(node, bucketSizeStr, 16);</div>
<div class="line"> </div>
<div class="line">        AiNodeSetStr(node, LPEStr, glassLPEStr);</div>
<div class="line"> </div>
<div class="line">        AtUniverse* current_universe = AiNodeGetUniverse(node);</div>
<div class="line">        AtNode* pzCamera = AiUniverseGetCamera(current_universe);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (AiNodeIs(pzCamera, PresenzCameraName) == <span class="keyword">false</span>)</div>
<div class="line">        {</div>
<div class="line">            AtArray *mCamera = AiNodeGetArray(pzCamera, matrixStr);</div>
<div class="line">            AtNode *new_camera = AiNode(current_universe, PresenzCameraName, PresenZZOVStr);</div>
<div class="line"> </div>
<div class="line">            AiNodeSetArray(new_camera, matrixStr, AiArrayCopy(mCamera));</div>
<div class="line">            AiNodeSetFlt(new_camera, farClipStr, AiNodeGetFlt(pzCamera, farClipStr));</div>
<div class="line">            AiNodeSetFlt(new_camera, nearClipStr, 0.0001f);</div>
<div class="line">            <a class="code hl_define" href="group___pz_app_logger.html#gaf8ab3f1606906a93b3081de7f0cb7be1">PZ_INFO</a>(<span class="stringliteral">&quot;Converting current camera to a PresenZ Zone Of View&quot;</span>);</div>
<div class="line">            AiNodeSetPtr(node, cameraStr, new_camera);</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">if</span> (AiNodeGetInt(op, renderingEyeStr) != -1)</div>
<div class="line">                AiNodeSetInt(new_camera, renderingEyeStr, AiNodeGetInt(op, renderingEyeStr));</div>
<div class="line"> </div>
<div class="line">            <span class="comment">// near clip for chaotcis</span></div>
<div class="line">            AiNodeSetFlt(new_camera, nearClipStr, 0.0001f);</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        AtArray *outputs = AiNodeGetArray(node, outputsAtStr);</div>
<div class="line">        <span class="keywordflow">if</span> (AiArrayGetNumElements(outputs) == 0)</div>
<div class="line">        {</div>
<div class="line">            <a class="code hl_define" href="group___pz_app_logger.html#gaf8ab3f1606906a93b3081de7f0cb7be1">PZ_INFO</a>(<span class="stringliteral">&quot;Reconnecting the presenz driver&quot;</span>);</div>
<div class="line">            outputs = AiArrayAllocate(1, 1, AI_TYPE_STRING);</div>
<div class="line">            <span class="comment">// search for a presenz driver</span></div>
<div class="line"> </div>
<div class="line">            AtNodeIterator* iter = AiUniverseGetNodeIterator(current_universe, AI_NODE_DRIVER);</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">while</span> (!AiNodeIteratorFinished(iter))</div>
<div class="line">            {</div>
<div class="line">                AtNode *driver = AiNodeIteratorGetNext(iter);</div>
<div class="line">                <span class="keywordflow">if</span> (AiNodeIs(driver, PresenZDriver))</div>
<div class="line">                {</div>
<div class="line">                    AtNodeIterator* iterFilter = AiUniverseGetNodeIterator(current_universe, AI_NODE_FILTER);</div>
<div class="line"> </div>
<div class="line">                    <span class="keywordflow">while</span> (!AiNodeIteratorFinished(iterFilter))</div>
<div class="line">                    {</div>
<div class="line">                        AtNode *filter = AiNodeIteratorGetNext(iterFilter);</div>
<div class="line">                        <span class="keywordflow">if</span> (AiNodeIs(filter, PresenZFilter))</div>
<div class="line">                        {</div>
<div class="line">                            <span class="keywordtype">char</span>   str[1024];</div>
<div class="line">                            sprintf(str, <span class="stringliteral">&quot;RGBA RGBA %s %s&quot;</span>, AiNodeGetName(filter), AiNodeGetName(driver));</div>
<div class="line">                            <a class="code hl_define" href="group___pz_app_logger.html#gaf8ab3f1606906a93b3081de7f0cb7be1">PZ_INFO</a>(<span class="stringliteral">&quot;Setting %s as output&quot;</span>, AiNodeGetName(driver));</div>
<div class="line">                            AiArraySetStr(outputs, 0, str);</div>
<div class="line">                            AiNodeSetArray(node, outputsAtStr, outputs);</div>
<div class="line">                            <span class="keywordflow">break</span>;</div>
<div class="line">                        }</div>
<div class="line">                    }</div>
<div class="line">                    AiNodeIteratorDestroy(iterFilter);</div>
<div class="line"> </div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">            AiNodeIteratorDestroy(iter);</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">        <span class="comment">//Check the AOV shader list</span></div>
<div class="line">        AtArray *AOVShaderList = AiNodeGetArray(node, aovShadersAtStr);</div>
<div class="line">        uint32_t numShaders = AiArrayGetNumElements(AOVShaderList);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordtype">bool</span> foundPresenZPostAOVShader = <span class="keyword">false</span>;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (uint32_t i = 0; i &lt; numShaders; i++) {</div>
<div class="line">            AtNode* shader = (AtNode*)AiArrayGetPtr(AOVShaderList, i);</div>
<div class="line">            <span class="keywordflow">if</span> (AiNodeIs(shader, PresenZPostAOVShader)) {</div>
<div class="line">                foundPresenZPostAOVShader = <span class="keyword">true</span>;</div>
<div class="line">                <span class="keywordflow">continue</span>;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// We should create and add it to the list</span></div>
<div class="line">        <span class="keywordflow">if</span> (foundPresenZPostAOVShader == <span class="keyword">false</span>) {</div>
<div class="line">            AiMsgInfo(<span class="stringliteral">&quot;[PresenZ] Creating and adding PresenZ Post AOVs Shader in option node.&quot;</span>);</div>
<div class="line">            numShaders = numShaders + 1;</div>
<div class="line">            AiArrayResize(AOVShaderList, numShaders, 1);</div>
<div class="line">            AtNode* AOVShader = AiNode(universe, PresenZPostAOVShader, PresenZPostAOVShader);</div>
<div class="line">            AiArraySetPtr(AOVShaderList, numShaders-1, AOVShader);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"> </div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md59"></a>
10.7 Shader Operator</h1>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;ai.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &quot;presenz_global_parameters.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;arnoldWrapper.h&quot;</span></div>
<div class="line"> </div>
<div class="line">AI_OPERATOR_NODE_EXPORT_METHODS(PresenZOperatorShadersMethods);</div>
<div class="line"> </div>
<div class="line">std::string addPzPrefixToLastToken(<span class="keyword">const</span> std::string&amp; inputPath) {</div>
<div class="line">    <span class="keywordtype">size_t</span> lastSlashPos = inputPath.find_last_of(<span class="stringliteral">&quot;/|&quot;</span>);</div>
<div class="line">    <span class="keywordflow">if</span> (lastSlashPos == std::string::npos || lastSlashPos + 1 &gt;= inputPath.length()) {</div>
<div class="line">        <span class="comment">// No slash found or nothing after the last slash</span></div>
<div class="line">        <span class="keywordflow">return</span> <span class="stringliteral">&quot;Pz_&quot;</span> + inputPath;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    std::string prefix = inputPath.substr(0, lastSlashPos + 1);</div>
<div class="line">    std::string lastToken = inputPath.substr(lastSlashPos + 1);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> prefix + <span class="stringliteral">&quot;Pz_&quot;</span> + lastToken;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">node_parameters</div>
<div class="line">{</div>
<div class="line">    AiParameterStr(<span class="stringliteral">&quot;selection&quot;</span>, <span class="stringliteral">&quot;*&quot;</span>);</div>
<div class="line">    AiMetaDataSetStr(nentry, NULL, <span class="stringliteral">&quot;_synonym&quot;</span>, <span class="stringliteral">&quot;PresenZOperatorShaders&quot;</span>);</div>
<div class="line"> </div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Operator are invoked every time the scene is ready to be rendered.</span></div>
<div class="line">operator_init</div>
<div class="line">{</div>
<div class="line"><span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Invoked at the end of a render.</span></div>
<div class="line">operator_cleanup</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">operator_post_cook</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// The cook operator is applied on every object on the scened. In this method</span></div>
<div class="line"><span class="comment">// we set up correctly PresenZ objects and connect every shape to the PresenZAOV</span></div>
<div class="line"><span class="comment">// shader. This will make sure we receive hits and normals for seen geometry.</span></div>
<div class="line">operator_cook</div>
<div class="line">{</div>
<div class="line">    AtUniverse* universe = AiNodeGetUniverse(node);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (AiNodeEntryGetType(AiNodeGetNodeEntry(node)) == AI_NODE_SHAPE) {</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (AiNodeIs(node, AtString(<span class="stringliteral">&quot;procedural&quot;</span>))) {</div>
<div class="line">            <a class="code hl_define" href="group___pz_app_logger.html#gad79dc53c351eeff13f901542c29f6e57">PZ_DEBUG</a>(<span class="stringliteral">&quot;Skipping procedural %s&quot;</span>, AiNodeGetName(node));</div>
<div class="line">            <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">const</span> AtNodeEntry* nentry = AiNodeGetNodeEntry(node);</div>
<div class="line">        <span class="keywordflow">if</span> (AiNodeEntryGetDerivedType(nentry) == AI_NODE_SHAPE_PROCEDURAL) {</div>
<div class="line">            <a class="code hl_define" href="group___pz_app_logger.html#gad79dc53c351eeff13f901542c29f6e57">PZ_DEBUG</a>(<span class="stringliteral">&quot;Skipping procedural shape %s&quot;</span>, AiNodeGetName(node));</div>
<div class="line">            <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">        <span class="comment">// check the shape parent. if we had tags on the parent, we should copy them  it to the child.</span></div>
<div class="line">        AtNode* parentNode = AiNodeGetParent(node);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (parentNode != NULL) {</div>
<div class="line">            <span class="keyword">const</span> AtNodeEntry* nentry = AiNodeGetNodeEntry(parentNode);</div>
<div class="line">            <span class="keywordflow">if</span> (AiNodeEntryGetDerivedType(nentry) == AI_NODE_SHAPE_PROCEDURAL)</div>
<div class="line">            {</div>
<div class="line">                <span class="keywordflow">if</span> (AiNodeLookUpUserParameter(parentNode, przGlassAtStr) != NULL</div>
<div class="line">                    &amp;&amp; AiNodeLookUpUserParameter(node, przGlassAtStr) == NULL)</div>
<div class="line">                {</div>
<div class="line">                    AiNodeDeclare(node, przGlassAtStr, <span class="stringliteral">&quot;constant INT&quot;</span>);</div>
<div class="line">                    AiNodeSetInt(node, przGlassAtStr, AiNodeGetInt(parentNode, przGlassAtStr));</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">if</span> (AiNodeLookUpUserParameter(parentNode, przChaoticAtStr) != NULL</div>
<div class="line">                    &amp;&amp; AiNodeLookUpUserParameter(node, przChaoticAtStr) == NULL)</div>
<div class="line">                {</div>
<div class="line">                    AiNodeDeclare(node, przChaoticAtStr, <span class="stringliteral">&quot;constant INT&quot;</span>);</div>
<div class="line">                    AiNodeSetInt(node, przChaoticAtStr, AiNodeGetInt(parentNode, przChaoticAtStr));</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">if</span> (AiNodeLookUpUserParameter(parentNode, przIsolatedAtStr) != NULL</div>
<div class="line">                    &amp;&amp; AiNodeLookUpUserParameter(node, przIsolatedAtStr) == NULL)</div>
<div class="line">                {</div>
<div class="line">                    AiNodeDeclare(node, przIsolatedAtStr, <span class="stringliteral">&quot;constant INT&quot;</span>);</div>
<div class="line">                    AiNodeSetInt(node, przIsolatedAtStr, AiNodeGetInt(parentNode, przIsolatedAtStr));</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">if</span> (AiNodeLookUpUserParameter(parentNode, przStereoAtStr) != NULL</div>
<div class="line">                    &amp;&amp; AiNodeLookUpUserParameter(node, przStereoAtStr) == NULL)</div>
<div class="line">                {</div>
<div class="line">                    AiNodeDeclare(node, przStereoAtStr, <span class="stringliteral">&quot;constant INT&quot;</span>);</div>
<div class="line">                    AiNodeSetInt(node, przStereoAtStr, AiNodeGetInt(parentNode, przStereoAtStr));</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordtype">bool</span> glassMaterial = <span class="keyword">false</span>;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordtype">float</span> step_size = 0.0f;</div>
<div class="line">        <span class="keyword">const</span> AtParamEntry* pentry = AiNodeEntryLookUpParameter(nentry, stepSizeStr);</div>
<div class="line">        <span class="keywordflow">if</span>(pentry != <span class="keyword">nullptr</span>)</div>
<div class="line">            step_size = AiNodeGetFlt(node, stepSizeStr);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (AiNodeLookUpUserParameter(node, przGlassAtStr) != NULL) {</div>
<div class="line">            <span class="keywordtype">int</span> transp = AiNodeGetInt(node, przGlassAtStr);</div>
<div class="line">            glassMaterial = (transp == 1);</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (glassMaterial) {</div>
<div class="line">            <span class="comment">// If we are transparent, we tag the glass</span></div>
<div class="line">            <span class="comment">// We also tag it as non-opaque.</span></div>
<div class="line">            AtArray* current_trace_set_array = AiNodeGetArray(node, traceSetsStr);</div>
<div class="line">            <span class="keywordtype">int</span> num_elements = AiArrayGetNumElements(current_trace_set_array);</div>
<div class="line">            AiArrayResize(current_trace_set_array, num_elements + 1, AiArrayGetNumKeys(current_trace_set_array));</div>
<div class="line">            AiArraySetStr(current_trace_set_array, num_elements, przGlassAtStr);</div>
<div class="line">            AiNodeSetArray(node, traceSetsStr, current_trace_set_array);</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        AtArray* shaders = AiNodeGetArray(node, shaderStr);</div>
<div class="line">        uint32_t numShaders = AiArrayGetNumElements(shaders);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (uint32_t i = 0; i &lt; numShaders; i++) {</div>
<div class="line">            AtNode* shader = (AtNode*)AiArrayGetPtr(shaders, i);</div>
<div class="line">            <span class="keywordflow">if</span> (shader == NULL || AiNodeIs(shader, PresenZShader) || AiNodeIs(shader, PresenZVolumeShader)) {</div>
<div class="line">                <span class="keywordflow">continue</span>;</div>
<div class="line">            }</div>
<div class="line"> </div>
<div class="line">            <span class="comment">// Got all the renders stalling with 5.4.3.1. (maya2024) arnoldSpreingAov.ma res 360x240 </span></div>
<div class="line">            <span class="comment">// Got only one stall over 6 renderings with 5.5.1 (maya2025) </span></div>
<div class="line">            parentNode = <span class="keyword">nullptr</span>; <span class="comment">// prevents stallings  </span></div>
<div class="line"> </div>
<div class="line">            std::string newName = addPzPrefixToLastToken(std::string(AiNodeGetName(shader)));</div>
<div class="line">            AtString newNameStr = AtString(newName.c_str());</div>
<div class="line">            AtNode* AOVShader = AiNodeLookUpByName(universe, newNameStr, parentNode);</div>
<div class="line">            <span class="keywordflow">if</span> (AOVShader == NULL) {</div>
<div class="line">                <span class="keywordflow">if</span> (AiNodeEntryGetDerivedType(nentry) == AI_NODE_SHAPE_VOLUME || step_size != 0.0) {</div>
<div class="line">                    AOVShader = AiNode(universe, PresenZVolumeShader, newNameStr, parentNode);</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">else</span> {</div>
<div class="line">                    AOVShader = AiNode(universe, PresenZShader, newNameStr, parentNode);</div>
<div class="line">                }</div>
<div class="line">                </div>
<div class="line">                AiNodeLink(shader, <span class="stringliteral">&quot;beauty&quot;</span>, AOVShader);</div>
<div class="line">                <span class="comment">//if (glassMaterial) {</span></div>
<div class="line">                    <span class="comment">//AiNodeSetRGB(AOVShader, opacityStr, 0.5, 0.5, 0.5);</span></div>
<div class="line">                <span class="comment">//}</span></div>
<div class="line">            }</div>
<div class="line">            AiArraySetPtr(shaders, i, AOVShader);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md60"></a>
10.8 Geometry Procedural</h1>
<div class="fragment"><div class="line"><span class="comment">// VRRender.cpp : Defines the entry point for the console application.</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;sstream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;iomanip&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &quot;ai.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;vrutils.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;underscan.h&quot;</span></div>
<div class="line"> </div>
<div class="line">AI_PROCEDURAL_NODE_EXPORT_METHODS(PrzGeometryMtd);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Procedural parameters</span></div>
<div class="line"><span class="keyword">struct </span>PrzGeom</div>
<div class="line">{</div>
<div class="line">    std::string file;</div>
<div class="line">    AtUniverse* universe;     <span class="comment">// Universe to add the point shape to</span></div>
<div class="line">    std::vector&lt;AtNode*&gt; nodes;</div>
<div class="line"> </div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line">node_parameters</div>
<div class="line">{</div>
<div class="line">   AiParameterStr(<span class="stringliteral">&quot;prz_file&quot;</span>        , <span class="stringliteral">&quot;in.####.przRender&quot;</span>);</div>
<div class="line">   AiMetaDataSetStr(nentry, <span class="stringliteral">&quot;prz_file&quot;</span>, <span class="stringliteral">&quot;path&quot;</span>, <span class="stringliteral">&quot;file&quot;</span>);</div>
<div class="line"> </div>
<div class="line">   AiParameterInt(<span class="stringliteral">&quot;frame&quot;</span>, 0);</div>
<div class="line">   AiMetaDataSetBool(nentry, <span class="stringliteral">&quot;frame&quot;</span>, <span class="stringliteral">&quot;linkable&quot;</span>, <span class="keyword">true</span>);</div>
<div class="line">   </div>
<div class="line">   AiMetaDataSetBool(nentry, NULL, <span class="stringliteral">&quot;maya.procedural&quot;</span>, <span class="keyword">true</span>);</div>
<div class="line"> </div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">std::string replaceHashesWithNumber(<span class="keyword">const</span> std::string&amp; path, <span class="keywordtype">int</span> number) {</div>
<div class="line">    std::string result = path;</div>
<div class="line">    <span class="keywordtype">size_t</span> pos = result.find(<span class="charliteral">&#39;#&#39;</span>);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">while</span> (pos != std::string::npos) {</div>
<div class="line">        <span class="keywordtype">size_t</span> endPos = pos;</div>
<div class="line">        <span class="keywordflow">while</span> (endPos &lt; result.size() &amp;&amp; result[endPos] == <span class="charliteral">&#39;#&#39;</span>) {</div>
<div class="line">            ++endPos;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordtype">size_t</span> hashCount = endPos - pos; <span class="comment">// Count the number of # characters</span></div>
<div class="line">        std::ostringstream ss;</div>
<div class="line">        ss &lt;&lt; std::setw(hashCount) &lt;&lt; std::setfill(<span class="charliteral">&#39;0&#39;</span>) &lt;&lt; number;</div>
<div class="line"> </div>
<div class="line">        result.replace(pos, hashCount, ss.str());</div>
<div class="line"> </div>
<div class="line">        pos = result.find(<span class="charliteral">&#39;#&#39;</span>, pos + ss.str().size());</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> result;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">procedural_init</div>
<div class="line">{</div>
<div class="line">    PrzGeom* przGeom = <span class="keyword">new</span> PrzGeom();</div>
<div class="line">    *user_ptr = przGeom;</div>
<div class="line"> </div>
<div class="line">   <span class="comment">// get the universe this procedural belongs to, and use it create all ginstances</span></div>
<div class="line">    przGeom-&gt;universe = AiNodeGetUniverse(node);</div>
<div class="line"> </div>
<div class="line">    AtString filePath = AiNodeGetStr(node, AtString(<span class="stringliteral">&quot;prz_file&quot;</span>));</div>
<div class="line"> </div>
<div class="line">    std::string filePathNumber = replaceHashesWithNumber(filePath.c_str(), AiNodeGetInt(node, AtString(<span class="stringliteral">&quot;frame&quot;</span>)));</div>
<div class="line">    </div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (PresenZ::BinIO::isPrzRender(filePathNumber.c_str())) {</div>
<div class="line">        przGeom-&gt;file = filePathNumber;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> {</div>
<div class="line">        AiMsgWarning(<span class="stringliteral">&quot;[PresenZ - Geometry] %s is not a valid przRender file.&quot;</span>, filePathNumber.c_str());</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    AtNode* shader = (AtNode*)AiNodeGetPtr(node, AtString(<span class="stringliteral">&quot;shader&quot;</span>));</div>
<div class="line">    AtNode* matteShader = NULL;</div>
<div class="line">    <span class="keywordflow">if</span> (shader == NULL || std::string(AiNodeGetName(shader)) == <span class="stringliteral">&quot;ai_default_reflection_shader&quot;</span>) {</div>
<div class="line">        AiMsgInfo(<span class="stringliteral">&quot;[PresenZ - Geometry] Creating shader&quot;</span>);</div>
<div class="line">        </div>
<div class="line">        std::string matteName = <span class="stringliteral">&quot;Pz_Matte_&quot;</span> + std::string(AiNodeGetName(node));</div>
<div class="line">        std::string uDataName = <span class="stringliteral">&quot;Pz_user_data_rgba_&quot;</span> + std::string(AiNodeGetName(node));</div>
<div class="line"> </div>
<div class="line">        matteShader = AiNode(przGeom-&gt;universe, AtString(<span class="stringliteral">&quot;matte&quot;</span>), AtString(matteName.c_str()), node);</div>
<div class="line">        AtNode* uDataShader = AiNode(przGeom-&gt;universe, AtString(<span class="stringliteral">&quot;user_data_rgba&quot;</span>), AtString(uDataName.c_str()), node);</div>
<div class="line">        AiNodeSetStr(uDataShader, AtString(<span class="stringliteral">&quot;attribute&quot;</span>), AtString(<span class="stringliteral">&quot;Cd&quot;</span>));</div>
<div class="line"> </div>
<div class="line">        AiNodeLink(uDataShader, AtString(<span class="stringliteral">&quot;color&quot;</span>), matteShader);</div>
<div class="line">        AiNodeLinkOutput(uDataShader, AtString(<span class="stringliteral">&quot;a&quot;</span>), matteShader, AtString(<span class="stringliteral">&quot;opacity&quot;</span>));</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">        </div>
<div class="line"> </div>
<div class="line">        przGeom-&gt;nodes.push_back(matteShader);</div>
<div class="line">        przGeom-&gt;nodes.push_back(uDataShader);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    </div>
<div class="line"> </div>
<div class="line">    PresenZ::BinIO::PRZFILEDATA przRenderData;</div>
<div class="line">    PresenZ::BinIO::PRZDATAHEADER przHeader;</div>
<div class="line">    int32_t hashValue;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (przGeom-&gt;file.empty())</div>
<div class="line">        <span class="keywordflow">return</span> NULL;</div>
<div class="line"> </div>
<div class="line">    PresenZ::BinIO::PrzReaderError err = przReader(przGeom-&gt;file.c_str(), przHeader, przRenderData, hashValue);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">size_t</span> numPts = przHeader.sampleNums;</div>
<div class="line"> </div>
<div class="line">    PresenZ::Camera::TCameraInfos orderedCameras = PresenZ::Camera::getCameras();</div>
<div class="line">    PresenZ::Camera::TCameraViewInfos cameraInfos;</div>
<div class="line">    cameraInfos.initFromHeader(przHeader.cameras, przHeader.CamToWorld, przHeader.globalScale, przHeader.boxScale, przHeader.camOffset[0], przHeader.camOffset[1], przHeader.camOffset[2]);</div>
<div class="line">    RenderingContext r(cameraInfos, przHeader.widthDisplay, przHeader.heightDisplay, 0.25f, przHeader.underscansFactors);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    AtArray* a_nsides = AiArrayAllocate(numPts, 1, AI_TYPE_UINT);</div>
<div class="line">    AtArray* a_vidx = AiArrayAllocate(numPts * 4, 1, AI_TYPE_UINT);</div>
<div class="line">    AtArray* a_nidxs = AiArrayAllocate(numPts * 4, 1, AI_TYPE_UINT);</div>
<div class="line">    AtArray* a_vlist = AiArrayAllocate(numPts * 4, 2, AI_TYPE_VECTOR);</div>
<div class="line">    AtArray* a_nlist = AiArrayAllocate(numPts * 4, 2, AI_TYPE_VECTOR);</div>
<div class="line">    AtArray* a_colors = AiArrayAllocate(numPts, 1, AI_TYPE_RGBA);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="comment">//przRenderData.render.left_eye.a</span></div>
<div class="line"> </div>
<div class="line">    <span class="keyword">auto</span> renderData = przRenderData.render.data.getcamNumSizeExpValues();</div>
<div class="line">    <span class="keyword">auto</span> renderXYData = przRenderData.render.data.getPositionXYValues();</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;AtVector&gt; pos_first_key(numPts * 4);</div>
<div class="line">    std::vector&lt;AtVector&gt; pos_second_key(numPts * 4);</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;AtVector&gt; normal_key(numPts * 4);</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#pragma omp parallel</span></div>
<div class="line">    {</div>
<div class="line"><span class="preprocessor">#pragma omp for nowait</span></div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">long</span> i = 0; i &lt; numPts; i++) {</div>
<div class="line"> </div>
<div class="line">            AiArraySetUInt(a_nsides, i, 4);</div>
<div class="line"> </div>
<div class="line">            TMainPoints mainPoints;</div>
<div class="line">            <a class="code hl_struct" href="struct_noz_point.html">NozVector</a> center;</div>
<div class="line">            <a class="code hl_struct" href="struct_noz_point.html">NozVector</a> normal(przRenderData.render.data.normalX[i], przRenderData.render.data.normalY[i], przRenderData.render.data.normalZ[i]);</div>
<div class="line"> </div>
<div class="line">            GetPlaqueMainPoints(r, renderData[i].cam,</div>
<div class="line">                renderXYData.first[i], renderXYData.second[i],</div>
<div class="line">                normal, przRenderData.render.data.z[i], 1, 1, renderData[i].expSize, 1.0f, mainPoints, center);</div>
<div class="line"> </div>
<div class="line">            <span class="keyword">const</span> <a class="code hl_struct" href="struct_noz_point.html">NozVector</a>&amp; p1 = mainPoints[DownLeft];</div>
<div class="line">            <span class="keyword">const</span> <a class="code hl_struct" href="struct_noz_point.html">NozVector</a>&amp; p2 = mainPoints[DownRight];</div>
<div class="line">            <span class="keyword">const</span> <a class="code hl_struct" href="struct_noz_point.html">NozVector</a>&amp; p3 = mainPoints[UpRight];</div>
<div class="line">            <span class="keyword">const</span> <a class="code hl_struct" href="struct_noz_point.html">NozVector</a>&amp; p4 = mainPoints[UpLeft];</div>
<div class="line"> </div>
<div class="line">            <span class="keyword">const</span> AtRGBA color(przRenderData.render.left_eye.r[i], przRenderData.render.left_eye.g[i], przRenderData.render.left_eye.b[i], przRenderData.render.left_eye.a[i]);</div>
<div class="line"> </div>
<div class="line">            <span class="comment">// Each quad will have its own set of 4 vertices, so we start from i*4</span></div>
<div class="line">            <span class="keywordtype">size_t</span> baseIdx = i * 4;</div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> j = 0; j &lt; 4; j++) {</div>
<div class="line">                AiArraySetUInt(a_vidx, baseIdx + j, baseIdx + j);</div>
<div class="line">                AiArraySetUInt(a_nidxs, baseIdx + j, baseIdx + j);</div>
<div class="line"> </div>
<div class="line">                normal_key[baseIdx + j] = AtVector(normal.x, normal.y, normal.z);</div>
<div class="line">            }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">            <span class="comment">// Set vertex coordinates and normals</span></div>
<div class="line">            pos_first_key[baseIdx + 0] = AtVector(p1.<a class="code hl_variable" href="group___n_o_z__vector.html#gad0da36b2558901e21e7a30f6c227a45e">x</a>, p1.<a class="code hl_variable" href="group___n_o_z__vector.html#gaa4f0d3eebc3c443f9be81bf48561a217">y</a>, p1.<a class="code hl_variable" href="group___n_o_z__vector.html#gaf73583b1e980b0aa03f9884812e9fd4d">z</a>);</div>
<div class="line">            pos_first_key[baseIdx + 1] = AtVector(p2.<a class="code hl_variable" href="group___n_o_z__vector.html#gad0da36b2558901e21e7a30f6c227a45e">x</a>, p2.<a class="code hl_variable" href="group___n_o_z__vector.html#gaa4f0d3eebc3c443f9be81bf48561a217">y</a>, p2.<a class="code hl_variable" href="group___n_o_z__vector.html#gaf73583b1e980b0aa03f9884812e9fd4d">z</a>);</div>
<div class="line">            pos_first_key[baseIdx + 2] = AtVector(p3.<a class="code hl_variable" href="group___n_o_z__vector.html#gad0da36b2558901e21e7a30f6c227a45e">x</a>, p3.<a class="code hl_variable" href="group___n_o_z__vector.html#gaa4f0d3eebc3c443f9be81bf48561a217">y</a>, p3.<a class="code hl_variable" href="group___n_o_z__vector.html#gaf73583b1e980b0aa03f9884812e9fd4d">z</a>);</div>
<div class="line">            pos_first_key[baseIdx + 3] = AtVector(p4.<a class="code hl_variable" href="group___n_o_z__vector.html#gad0da36b2558901e21e7a30f6c227a45e">x</a>, p4.<a class="code hl_variable" href="group___n_o_z__vector.html#gaa4f0d3eebc3c443f9be81bf48561a217">y</a>, p4.<a class="code hl_variable" href="group___n_o_z__vector.html#gaf73583b1e980b0aa03f9884812e9fd4d">z</a>);</div>
<div class="line"> </div>
<div class="line">            <span class="keywordtype">float</span> velocityX = przRenderData.render.data.velocityX[i];</div>
<div class="line">            <span class="keywordtype">float</span> velocityY = przRenderData.render.data.velocityY[i];</div>
<div class="line">            <span class="keywordtype">float</span> velocityZ = przRenderData.render.data.velocityZ[i];</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">if</span> (isnan(velocityX)</div>
<div class="line">                || isnan(velocityY)</div>
<div class="line">                || isnan(velocityZ)</div>
<div class="line">                || isinf(velocityX)</div>
<div class="line">                || isinf(velocityY)</div>
<div class="line">                || isinf(velocityZ)</div>
<div class="line">            ) {</div>
<div class="line">                velocityX = 0;</div>
<div class="line">                velocityY = 0;</div>
<div class="line">                velocityZ = 0;</div>
<div class="line">            }</div>
<div class="line"> </div>
<div class="line">            pos_second_key[baseIdx + 0] = AtVector(p1.<a class="code hl_variable" href="group___n_o_z__vector.html#gad0da36b2558901e21e7a30f6c227a45e">x</a> + velocityX, p1.<a class="code hl_variable" href="group___n_o_z__vector.html#gaa4f0d3eebc3c443f9be81bf48561a217">y</a> + velocityY, p1.<a class="code hl_variable" href="group___n_o_z__vector.html#gaf73583b1e980b0aa03f9884812e9fd4d">z</a> + velocityZ);</div>
<div class="line">            pos_second_key[baseIdx + 1] = AtVector(p2.<a class="code hl_variable" href="group___n_o_z__vector.html#gad0da36b2558901e21e7a30f6c227a45e">x</a> + velocityX, p2.<a class="code hl_variable" href="group___n_o_z__vector.html#gaa4f0d3eebc3c443f9be81bf48561a217">y</a> + velocityY, p2.<a class="code hl_variable" href="group___n_o_z__vector.html#gaf73583b1e980b0aa03f9884812e9fd4d">z</a> + velocityZ);</div>
<div class="line">            pos_second_key[baseIdx + 2] = AtVector(p3.<a class="code hl_variable" href="group___n_o_z__vector.html#gad0da36b2558901e21e7a30f6c227a45e">x</a> + velocityX, p3.<a class="code hl_variable" href="group___n_o_z__vector.html#gaa4f0d3eebc3c443f9be81bf48561a217">y</a> + velocityY, p3.<a class="code hl_variable" href="group___n_o_z__vector.html#gaf73583b1e980b0aa03f9884812e9fd4d">z</a> + velocityZ);</div>
<div class="line">            pos_second_key[baseIdx + 3] = AtVector(p4.<a class="code hl_variable" href="group___n_o_z__vector.html#gad0da36b2558901e21e7a30f6c227a45e">x</a> + velocityX, p4.<a class="code hl_variable" href="group___n_o_z__vector.html#gaa4f0d3eebc3c443f9be81bf48561a217">y</a> + velocityY, p4.<a class="code hl_variable" href="group___n_o_z__vector.html#gaf73583b1e980b0aa03f9884812e9fd4d">z</a> + velocityZ);</div>
<div class="line"> </div>
<div class="line">            AiArraySetRGBA(a_colors, i, color);</div>
<div class="line"> </div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    AiArraySetKey(a_vlist, 0, pos_first_key.data());</div>
<div class="line">    AiArraySetKey(a_vlist, 1, pos_second_key.data());</div>
<div class="line"> </div>
<div class="line">    AiArraySetKey(a_nlist, 0, normal_key.data());</div>
<div class="line">    AiArraySetKey(a_nlist, 1, normal_key.data());</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// create node with procedural node as parent</span></div>
<div class="line">    AtNode* geometry_node = AiNode(przGeom-&gt;universe, AtString(<span class="stringliteral">&quot;polymesh&quot;</span>), AtString(<span class="stringliteral">&quot;przGeom&quot;</span>), node);</div>
<div class="line">    AiNodeSetArray(geometry_node, AtString(<span class="stringliteral">&quot;nsides&quot;</span>), a_nsides);</div>
<div class="line">    AiNodeSetArray(geometry_node, AtString(<span class="stringliteral">&quot;vidxs&quot;</span>), a_vidx);</div>
<div class="line">    AiNodeSetArray(geometry_node, AtString(<span class="stringliteral">&quot;nidxs&quot;</span>), a_nidxs);</div>
<div class="line">    AiNodeSetArray(geometry_node, AtString(<span class="stringliteral">&quot;vlist&quot;</span>), a_vlist);</div>
<div class="line">    AiNodeSetArray(geometry_node, AtString(<span class="stringliteral">&quot;nlist&quot;</span>), a_nlist);</div>
<div class="line"> </div>
<div class="line">    AiNodeDeclare(geometry_node, AtString(<span class="stringliteral">&quot;Cd&quot;</span>), <span class="stringliteral">&quot;uniform RGBA&quot;</span>);</div>
<div class="line">    AiNodeSetArray(geometry_node, AtString(<span class="stringliteral">&quot;Cd&quot;</span>), a_colors);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span>(matteShader != NULL)</div>
<div class="line">        AiNodeSetPtr(geometry_node, AtString(<span class="stringliteral">&quot;shader&quot;</span>), matteShader);</div>
<div class="line"> </div>
<div class="line">    przGeom-&gt;nodes.push_back(geometry_node);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">procedural_cleanup</div>
<div class="line">{</div>
<div class="line">   PrzGeom* przGeom = (PrzGeom*)user_ptr;</div>
<div class="line">   <span class="keyword">delete</span> przGeom;</div>
<div class="line">   <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">procedural_num_nodes</div>
<div class="line">{</div>
<div class="line">    PrzGeom* przGeom = (PrzGeom*)user_ptr;</div>
<div class="line">    <span class="keywordflow">return</span> przGeom-&gt;nodes.size();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">procedural_get_node</div>
<div class="line">{</div>
<div class="line">   PrzGeom* przGeom = (PrzGeom*)user_ptr;</div>
<div class="line">   <span class="keywordflow">return</span> przGeom-&gt;nodes[i];</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">node_loader</div>
<div class="line">{</div>
<div class="line">   <span class="keywordflow">if</span> (i &gt; 0)</div>
<div class="line">      <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"> </div>
<div class="line">   node-&gt;methods = PrzGeometryMtd;</div>
<div class="line">   node-&gt;output_type = AI_TYPE_NONE;</div>
<div class="line">   node-&gt;name = <span class="stringliteral">&quot;prz_geometry&quot;</span>;</div>
<div class="line">   node-&gt;node_type = AI_NODE_SHAPE_PROCEDURAL;</div>
<div class="line">   strcpy(node-&gt;version, AI_VERSION);</div>
<div class="line"> </div>
<div class="line">   <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="ttc" id="agroup___n_o_z__vector_html_gaf73583b1e980b0aa03f9884812e9fd4d"><div class="ttname"><a href="group___n_o_z__vector.html#gaf73583b1e980b0aa03f9884812e9fd4d">NozPoint::z</a></div><div class="ttdeci">float z</div><div class="ttdoc">z</div><div class="ttdef"><b>Definition</b> vector.h:33</div></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md61"></a>
10.9 Loader</h1>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;ai.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;cstdio&gt;</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">extern</span> <span class="keyword">const</span> AtNodeMethods* PresenZCameraMethods;</div>
<div class="line"><span class="keyword">extern</span> <span class="keyword">const</span> AtNodeMethods* nozPresenZDriverMethods;</div>
<div class="line"><span class="keyword">extern</span> <span class="keyword">const</span> AtNodeMethods* PresenZShaderMtd;</div>
<div class="line"><span class="keyword">extern</span> <span class="keyword">const</span> AtNodeMethods* PresenZOperatorMethods;</div>
<div class="line"><span class="keyword">extern</span> <span class="keyword">const</span> AtNodeMethods* PresenZFilterMethods;</div>
<div class="line"><span class="keyword">extern</span> <span class="keyword">const</span> AtNodeMethods* PresenZPostAOVShaderMethods;</div>
<div class="line"><span class="keyword">extern</span> <span class="keyword">const</span> AtNodeMethods* PresenZOperatorShadersMethods;</div>
<div class="line"><span class="keyword">extern</span> <span class="keyword">const</span> AtNodeMethods* PresenZVolumeShaderMtd;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">enum</span>{</div>
<div class="line">   PRESENZ_CAMERA = 0,</div>
<div class="line">   PRESENZ_DRIVER = 1,</div>
<div class="line">   PRESENZ_SHADER = 2,</div>
<div class="line">   PRESENZ_OPERATOR = 3,</div>
<div class="line">   PRESENZ_FILTER = 4,</div>
<div class="line">   PRESENZ_POST_AOV_SHADER = 5,</div>
<div class="line">   PRESENZ_OPERATOR_SHADERS = 6,</div>
<div class="line">   PRESENZ_VOLUME_SHADER = 7</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="comment">// plugin initialization callback for Arnold.</span></div>
<div class="line">node_loader</div>
<div class="line">{</div>
<div class="line">   <span class="keywordflow">switch</span> (i)</div>
<div class="line">   {</div>
<div class="line">   <span class="keywordflow">case</span> PRESENZ_CAMERA:</div>
<div class="line">        node-&gt;methods = PresenZCameraMethods;</div>
<div class="line">        node-&gt;output_type = AI_TYPE_NONE;</div>
<div class="line">        node-&gt;name = <span class="stringliteral">&quot;presenz_camera&quot;</span>;</div>
<div class="line">        node-&gt;node_type = AI_NODE_CAMERA;</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line"> </div>
<div class="line">   <span class="keywordflow">case</span> PRESENZ_DRIVER:</div>
<div class="line">        node-&gt;methods = nozPresenZDriverMethods;</div>
<div class="line">        node-&gt;output_type = AI_TYPE_NONE;</div>
<div class="line">        node-&gt;name = <span class="stringliteral">&quot;presenz_driver&quot;</span>;</div>
<div class="line">        node-&gt;node_type = AI_NODE_DRIVER;</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line"> </div>
<div class="line">   <span class="keywordflow">case</span> PRESENZ_SHADER:</div>
<div class="line">        node-&gt;methods = PresenZShaderMtd;</div>
<div class="line">        node-&gt;output_type = AI_TYPE_CLOSURE;</div>
<div class="line">        node-&gt;name = <span class="stringliteral">&quot;presenz_shader&quot;</span>;</div>
<div class="line">        node-&gt;node_type = AI_NODE_SHADER;</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line"> </div>
<div class="line">   <span class="keywordflow">case</span> PRESENZ_POST_AOV_SHADER:</div>
<div class="line">       node-&gt;methods = PresenZPostAOVShaderMethods;</div>
<div class="line">       node-&gt;output_type = AI_TYPE_CLOSURE;</div>
<div class="line">       node-&gt;name = <span class="stringliteral">&quot;presenz_post_aov_shader&quot;</span>;</div>
<div class="line">       node-&gt;node_type = AI_NODE_SHADER;</div>
<div class="line">       <span class="keywordflow">break</span>;</div>
<div class="line"> </div>
<div class="line">   <span class="keywordflow">case</span> PRESENZ_OPERATOR:</div>
<div class="line">       node-&gt;methods = PresenZOperatorMethods;</div>
<div class="line">       node-&gt;output_type = AI_TYPE_NONE;</div>
<div class="line">       node-&gt;name = <span class="stringliteral">&quot;presenz_operator&quot;</span>;</div>
<div class="line">       node-&gt;node_type = AI_NODE_OPERATOR;</div>
<div class="line">       <span class="keywordflow">break</span>;</div>
<div class="line"> </div>
<div class="line">   <span class="keywordflow">case</span> PRESENZ_FILTER:</div>
<div class="line">       node-&gt;methods = PresenZFilterMethods;</div>
<div class="line">       node-&gt;output_type = AI_TYPE_NONE;</div>
<div class="line">       node-&gt;name = <span class="stringliteral">&quot;presenz_filter&quot;</span>;</div>
<div class="line">       node-&gt;node_type = AI_NODE_FILTER;</div>
<div class="line">       <span class="keywordflow">break</span>;</div>
<div class="line">   <span class="keywordflow">case</span> PRESENZ_OPERATOR_SHADERS:</div>
<div class="line">       node-&gt;methods = PresenZOperatorShadersMethods;</div>
<div class="line">       node-&gt;output_type = AI_TYPE_NONE;</div>
<div class="line">       node-&gt;name = <span class="stringliteral">&quot;presenz_operator_shaders&quot;</span>;</div>
<div class="line">       node-&gt;node_type = AI_NODE_OPERATOR;</div>
<div class="line">       <span class="keywordflow">break</span>;</div>
<div class="line">   <span class="keywordflow">case</span> PRESENZ_VOLUME_SHADER:</div>
<div class="line">       node-&gt;methods = PresenZVolumeShaderMtd;</div>
<div class="line">       node-&gt;output_type = AI_TYPE_CLOSURE;</div>
<div class="line">       node-&gt;name = <span class="stringliteral">&quot;presenz_volume_shader&quot;</span>;</div>
<div class="line">       node-&gt;node_type = AI_NODE_SHADER;</div>
<div class="line">       <span class="keywordflow">break</span>;</div>
<div class="line">   <span class="keywordflow">default</span>:</div>
<div class="line">      <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">   }</div>
<div class="line"> </div>
<div class="line">   sprintf(node-&gt;version, AI_VERSION);</div>
<div class="line"> </div>
<div class="line">   <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.10.0 </li>
  </ul>
</div>
</body>
</html>

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.5"/>
<title>PresenZ SDK: Implementation in Arnold</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">PresenZ SDK
   &#160;<span id="projectnumber">4.1.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.5 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('md__home_presenz_jk_workspace__presen_z__s_d_k__linux_master@2_resources__s_d_k_manual_10-implementation-arnold.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(11)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(12)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Implementation in Arnold </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Here is the implementation code for <a class="el" href="namespace_presen_z.html">PresenZ</a> inside SolidAngle Arnold.</p>
<h1>10.1 Camera</h1>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;ai.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;map&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;thread&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="_pz_camera_api_8h.html">API/PzCameraApi.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="_pz_assert_8h.html">API/PzAssert.h</a>&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &quot;arnoldWrapper.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;presenz_global_parameters.h&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">struct </span>FromRev {</div>
<div class="line">    FromRev() :rev(0) {}</div>
<div class="line">    FromRev(<span class="keyword">const</span> AtVector2&amp; s) {</div>
<div class="line">        rev = 1;</div>
<div class="line">        sx=s.x;</div>
<div class="line">        sy=s.y;</div>
<div class="line">    }</div>
<div class="line">    int8_t rev;</div>
<div class="line">    <span class="keywordtype">float</span> sx;</div>
<div class="line">    <span class="keywordtype">float</span> sy;</div>
<div class="line">};</div>
<div class="line"><span class="keyword">static</span> std::map&lt;std::thread::id, FromRev&gt; fromRevMap;</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line">AI_CAMERA_NODE_EXPORT_METHODS(PresenZCameraMethods)</div>
<div class="line"></div>
<div class="line">const AtCameraInput&amp; getCamInput(const AtCameraInput &amp;input) { <span class="keywordflow">return</span> input; }</div>
<div class="line">AtCameraOutput&amp; getCamOutput(AtCameraOutput &amp;output) { <span class="keywordflow">return</span> output; }</div>
<div class="line"></div>
<div class="line"><span class="keyword">enum</span> <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#a3104904c134a52357b85f763f6dfd48f">Eye</a></div>
<div class="line">{</div>
<div class="line">    <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#a3104904c134a52357b85f763f6dfd48fa4280d82f18d6dbafdeb68c811112455e">RC_Left</a> = 0,</div>
<div class="line">    <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#a3104904c134a52357b85f763f6dfd48fac2b22af1f16cebd2cc909767c763a713">RC_Right</a> = 1</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span>* rendering_eye_enum[] =</div>
<div class="line">{</div>
<div class="line">    <span class="stringliteral">&quot;left&quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;right&quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;leftThenRight&quot;</span>, <span class="comment">// usefull to comunicate with the python code which then trigger a left and a right if the user specify &quot;leftTheRight&quot;</span></div>
<div class="line">    NULL</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</div>
<div class="line"><span class="keyword">inline</span> T clamp(<span class="keyword">const</span> T&amp; u, <span class="keyword">const</span> T&amp; umin, <span class="keyword">const</span> T&amp; umax) { <span class="keywordflow">return</span>  (u &lt; umin ? umin : (u &gt; umax ? umax : u)); }</div>
<div class="line"></div>
<div class="line"><span class="keyword">struct </span>multiCamData_t</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">size_t</span> renderSizeX;</div>
<div class="line">    <span class="keywordtype">size_t</span> renderSizeY;</div>
<div class="line">    <span class="keywordtype">double</span> render_aspect;</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keyword">inline</span> multiCamData_t * GetLocalData(<span class="keyword">const</span> AtNode* node)</div>
<div class="line">{</div>
<div class="line">    multiCamData_t *data = (multiCamData_t*)AiNodeGetLocalData(node);</div>
<div class="line">    <span class="keywordflow">return</span> data;</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> camInitialize(AtNode* node, <span class="keywordtype">void</span> *data) {</div>
<div class="line"></div>
<div class="line">    AiCameraInitialize(node);</div>
<div class="line">    AiNodeSetLocalData(node, data);</div>
<div class="line"></div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">node_parameters</div>
<div class="line">{</div>
<div class="line">    AiParameterInt(<span class="stringliteral">&quot;multibox_offset_right&quot;</span>, 0);</div>
<div class="line">    AiParameterInt(<span class="stringliteral">&quot;multibox_offset_top&quot;</span>, 0);</div>
<div class="line">    AiParameterInt(<span class="stringliteral">&quot;multibox_offset_back&quot;</span>, 0);</div>
<div class="line">    AiParameterFlt(<span class="stringliteral">&quot;distance_to_ground&quot;</span>, 1.6f);</div>
<div class="line">    AiParameterFlt(<span class="stringliteral">&quot;ipd&quot;</span>, 63.65f);               <span class="comment">// male mean  64.7(mm) ; female mean 62.6(mm)</span></div>
<div class="line">    AiParameterBool(<span class="stringliteral">&quot;draft_mode&quot;</span>, <span class="keyword">false</span>);</div>
<div class="line">    AiParameterFlt(<span class="stringliteral">&quot;presenz_scene_scale&quot;</span>, 1.0f);</div>
<div class="line"></div>
<div class="line">    AiParameterVec(<span class="stringliteral">&quot;view_scale&quot;</span>, 1.0f, 0.5f, 1.0f);</div>
<div class="line">    AiParameterVec(<span class="stringliteral">&quot;specular_point_offset&quot;</span>, 0.0f, 0.0f, 0.0f);</div>
<div class="line">    AiParameterEnum(<span class="stringliteral">&quot;rendering_eye&quot;</span>, <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#a3104904c134a52357b85f763f6dfd48fa4280d82f18d6dbafdeb68c811112455e">Eye::RC_Left</a>, rendering_eye_enum);</div>
<div class="line">    AiParameterInt(<span class="stringliteral">&quot;render_inside_zov&quot;</span>, 0);</div>
<div class="line">    AiParameterBool(<span class="stringliteral">&quot;clipping_enable&quot;</span>, <span class="keyword">false</span>);</div>
<div class="line">    AiParameterVec(<span class="stringliteral">&quot;clipping_position&quot;</span>, 0.0f, 0.0f, 0.0f);</div>
<div class="line">    AiParameterFlt(<span class="stringliteral">&quot;clipping_radius&quot;</span>, 100.0f);</div>
<div class="line">    AiParameterBool(<span class="stringliteral">&quot;clipping_outside&quot;</span>, <span class="keyword">false</span>);</div>
<div class="line"></div>
<div class="line">    AiParameterFlt(<span class="stringliteral">&quot;ideal_point_size&quot;</span>, 0.1f);</div>
<div class="line"></div>
<div class="line">    AiParameterBool(<span class="stringliteral">&quot;enable_froxtrum&quot;</span>, <span class="keyword">true</span>);</div>
<div class="line">    AiParameterInt(<span class="stringliteral">&quot;froxtrum_depth&quot;</span>, 7);</div>
<div class="line">    AiParameterInt(<span class="stringliteral">&quot;volume_depth&quot;</span>, 9);</div>
<div class="line">    </div>
<div class="line"></div>
<div class="line">    AiParameterBool(<span class="stringliteral">&quot;block_range&quot;</span>, <span class="keyword">false</span>);</div>
<div class="line">    AiParameterInt(<span class="stringliteral">&quot;block_range_in&quot;</span>, 0);</div>
<div class="line">    AiParameterInt(<span class="stringliteral">&quot;block_range_out&quot;</span>, 0);</div>
<div class="line"></div>
<div class="line">    AiParameterBool(<span class="stringliteral">&quot;render_isolated&quot;</span>, <span class="keyword">false</span>);</div>
<div class="line">    AiParameterInt(<span class="stringliteral">&quot;stereo_right_eye&quot;</span>, 0);</div>
<div class="line"></div>
<div class="line">    AiParameterStr(<span class="stringliteral">&quot;window_shapes_file&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);</div>
<div class="line">    AiParameterInt(<span class="stringliteral">&quot;window_shape_index&quot;</span>, 0 );</div>
<div class="line">    AiParameterFlt(<span class="stringliteral">&quot;min_dist_to_screen&quot;</span>,100.0f);</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line">    AiMetaDataSetStr(nentry, NULL, <span class="stringliteral">&quot;maya.translator&quot;</span>, <span class="stringliteral">&quot;przCamera&quot;</span>);</div>
<div class="line">    AiMetaDataSetStr(nentry, NULL, <span class="stringliteral">&quot;_synonym&quot;</span>, <span class="stringliteral">&quot;PresenZCamera&quot;</span>);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">node_initialize</div>
<div class="line">{</div>
<div class="line">    multiCamData_t* data = <span class="keyword">new</span> multiCamData_t();</div>
<div class="line">    camInitialize(node, data);</div>
<div class="line"><span class="preprocessor">#if AI_VERSION_ARCH_NUM &gt;= 7 &amp;&amp; AI_VERSION_MAJOR_NUM &gt;= 4</span></div>
<div class="line"><span class="preprocessor"></span>    <span class="keyword">const</span> AtNode* render_options = AiRenderSessionGetOptions(render_session);</div>
<div class="line">    AiNodeAddDependency(node, render_options, xresStr);</div>
<div class="line">    AiNodeAddDependency(node, render_options, yresStr);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>}</div>
<div class="line"></div>
<div class="line">node_update</div>
<div class="line">{</div>
<div class="line"></div>
<div class="line">    AiCameraUpdate(node, <span class="keyword">false</span>);</div>
<div class="line">    AiNodeSetFlt(node, shutterStartStr, 0.0f);</div>
<div class="line">    AiNodeSetFlt(node, shutterEndStr, 0.0f);</div>
<div class="line"></div>
<div class="line">    multiCamData_t *data = GetLocalData(node);</div>
<div class="line"></div>
<div class="line">    <span class="keyword">const</span> AtNode* render_options = AiRenderSessionGetOptions(render_session);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">int</span> xres = AiNodeGetInt(render_options, xresStr); </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">int</span> yres = AiNodeGetInt(render_options, yresStr);</div>
<div class="line">    data-&gt;renderSizeX = xres;</div>
<div class="line">    data-&gt;renderSizeY = yres;</div>
<div class="line">    data-&gt;render_aspect = (double(xres) / double(yres));</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">node_finish</div>
<div class="line">{</div>
<div class="line">    multiCamData_t *data = GetLocalData(node);</div>
<div class="line">    <span class="keyword">delete</span> data;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">camera_reverse_ray</div>
<div class="line">{</div>
<div class="line">    multiCamData_t *data = GetLocalData(node);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// normalized direction</span></div>
<div class="line">    AtVector dir = AiV3Normalize(Po);</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">double</span> u, v;</div>
<div class="line">    <a class="code" href="group___pz_camera_api.html#gadb09037723e000d53f5c2e665a9b6b9c">PresenZ::Camera::PzGetUVFromRay</a>(<a class="code" href="group___n_o_z__vector.html#ga347d85f3e636cf273a47949aa0613a8f">NozVector</a>(dir.x,dir.y,dir.z), u, v);</div>
<div class="line">    <span class="comment">// Calculate screen coordinates</span></div>
<div class="line">    Ps.x = ((float)u*2.0f)-1.0f;</div>
<div class="line">    Ps.y = ((2.0f*(-(float)v+1))-1.0f)/ (float)data-&gt;render_aspect;</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">     </div>
<div class="line">    <span class="comment">// This fonction is called by the to perform the arnold adaptativeSubdivision</span></div>
<div class="line">    <span class="comment">// while this is working, the others thread are still going on, casting rays.</span></div>
<div class="line"></div>
<div class="line">    <span class="comment">// &quot;camera_create_ray&quot; is directly caller imedialty after every call of &quot;camera_reverse_ray&quot;,     </span></div>
<div class="line">    <span class="comment">// so if fromrevers == 1 in the &quot;camera_create_ray&quot; scope we know fromrevers went through &quot;camera_reverse_ray&quot;</span></div>
<div class="line">    <span class="comment">// and this is going to be a subdiv ray so we wont consider this ray as a presenz ray. and we&#39;ll just do a standard cubeMap projection.</span></div>
<div class="line">    <span class="comment">// warning : in a case, dir(0.5,0.5,0.5) gives Ps=(-0.3333,0.0), The camera_create_ray(-0.3333,0.0) is never called after.</span></div>
<div class="line"></div>
<div class="line">    fromRevMap[std::this_thread::get_id()] = FromRev(Ps);</div>
<div class="line">    <span class="comment">//PZ_INFO(&quot;---&gt; %f %f %d rev \n&quot;,Ps.x,Ps.y, std::this_thread::get_id());</span></div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Get the camera origin/direction for each pixel on the image. This will query the information to PresenZ in turn.</span></div>
<div class="line">camera_create_ray</div>
<div class="line">{</div>
<div class="line"></div>
<div class="line">    multiCamData_t *data = GetLocalData(node);</div>
<div class="line">    <span class="keyword">const</span> AtCameraInput&amp; camInput = getCamInput(input);</div>
<div class="line">    AtCameraOutput&amp; camOutput = getCamOutput(output);</div>
<div class="line">    </div>
<div class="line">    camOutput.dOdx = AI_V3_ZERO;</div>
<div class="line">    camOutput.dOdy = AI_V3_ZERO;</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">double</span> sy = (((double)data-&gt;renderSizeY - (<span class="keywordtype">double</span>)camInput.sy)); <span class="comment">//sy in in range [0, resy], but upside down.</span></div>
<div class="line"></div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> pixelX = AiClamp((<span class="keywordtype">double</span>)camInput.sx, 0.0, (<span class="keywordtype">double</span>)data-&gt;renderSizeX);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> pixelY = AiClamp(sy, 0.0, (<span class="keywordtype">double</span>)data-&gt;renderSizeY);</div>
<div class="line">    </div>
<div class="line">    </div>
<div class="line">    <span class="keyword">const</span> std::thread::id this_id = std::this_thread::get_id();</div>
<div class="line">    <span class="comment">// see &quot;camera_reverse_ray&quot; </span></div>
<div class="line">    <span class="keywordflow">if</span> (fromRevMap[this_id].rev == 1 &amp;&amp; camInput.sx == fromRevMap[this_id].sx &amp;&amp; camInput.sy == fromRevMap[this_id].sy) {</div>
<div class="line">        <span class="comment">//PZ_INFO(&quot;---&gt; %f %f %d rray  *\n&quot;, camInput.sx, camInput.sy, this_id);</span></div>
<div class="line">        <a class="code" href="struct_presen_z_1_1_camera_1_1v4__1_1_1_pz_camera_ray.html">PresenZ::Camera::PzCameraRay</a> rayCtx = <a class="code" href="group___pz_camera_api.html#ga4451427bcc8d24005e2acad17c96ec2f">PresenZ::Camera::PzGetSpecularRay</a>(pixelX, pixelY);</div>
<div class="line"></div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">float</span> dsx = 2.0f / (data-&gt;renderSizeX * 3.f);  <span class="comment">// or (2/Rx)/3   </span></div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">float</span> dsy = 1.0f / data-&gt;renderSizeY;         <span class="comment">// or (2/Ry)/2</span></div>
<div class="line"></div>
<div class="line">        camOutput.dDdx = AtVectorFromNozPoint(rayCtx.<a class="code" href="struct_presen_z_1_1_camera_1_1v4__1_1_1_pz_camera_ray.html#a736153c8076e6040f9703e238e5b987c">dDdx</a> * dsx);</div>
<div class="line">        camOutput.dDdy = AtVectorFromNozPoint(rayCtx.<a class="code" href="struct_presen_z_1_1_camera_1_1v4__1_1_1_pz_camera_ray.html#aeb84bfd699fd4a7c535d38f19449e6b4">dDdy</a> * dsy);</div>
<div class="line">        camOutput.weight = AI_RGB_WHITE ;</div>
<div class="line">        camOutput.dir = AtVectorFromNozPoint(rayCtx.<a class="code" href="struct_presen_z_1_1_camera_1_1v4__1_1_1_pz_camera_ray.html#a7d4ae5b50b35b0b0e860ffe3192b05da">dir</a>);</div>
<div class="line">        camOutput.origin = AI_V3_ZERO;</div>
<div class="line">        camOutput.dOdx = AI_V3_ZERO;</div>
<div class="line">        camOutput.dOdy = AI_V3_ZERO;</div>
<div class="line"></div>
<div class="line">        fromRevMap[this_id].rev = 0;</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    fromRevMap[this_id].rev = 0;</div>
<div class="line"></div>
<div class="line">    <a class="code" href="struct_presen_z_1_1_camera_1_1v4__1_1_1_pz_camera_ray.html">PresenZ::Camera::PzCameraRay</a> rayCtx;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">int</span> x = <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(pixelX), y = static_cast&lt;int&gt;(pixelY);</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">    rayCtx = <a class="code" href="group___pz_camera_api.html#ga426d1a432761e49712a03e935bb71720">PresenZ::Camera::PzGetCameraRay</a>(x, y);</div>
<div class="line">    <span class="keywordflow">if</span> (rayCtx.<a class="code" href="struct_presen_z_1_1_camera_1_1v4__1_1_1_pz_camera_ray.html#aac1b70a2ed67ead038c4d3f5ac4d8a81">isValid</a>()) {</div>
<div class="line">        <span class="comment">// Theses 1.5 dsx dsy factors has been empiricaly found </span></div>
<div class="line">        <span class="comment">// and match the ones from the Arnold cube3x2map camera in 720x480</span></div>
<div class="line">        <span class="comment">// const float mydsx = 2.0 / ( double(data-&gt;renderSizeX) * 1.5 );      // should be equal Ai_dsx in input // but I dnt know where these 1.5 factors are comming from !!!</span></div>
<div class="line">        <span class="comment">// const float mydsy = (2.0 / ( double(data-&gt;renderSizeY) * 1.5 * 1.5)); // should be equal Ai_dsy in input // same</span></div>
<div class="line">        <span class="comment">// in order to get the same derivativ (or mipmap level) than the arnold cube map camera, we had to :</span></div>
<div class="line">        <span class="comment">// dsx = mydsx</span></div>
<div class="line">        <span class="comment">// dsy = mydsy * 1.5</span></div>
<div class="line">        <span class="comment">// then finaly dsy,dsy was equal to :</span></div>
<div class="line">        <span class="comment">// const float dsx = 4.0 / ( data-&gt;renderSizeX * 3.);</span></div>
<div class="line">        <span class="comment">// const float dsy = 4.0 / ( data-&gt;renderSizeY * 3 );</span></div>
<div class="line"></div>
<div class="line">        <span class="comment">// then we choose to take a 90deg perspectiva camera to set the derivative of our faces</span></div>
<div class="line">        <span class="comment">// this gives us</span></div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">float</span> dsx = 2.0f / (data-&gt;renderSizeX * 3.f);  <span class="comment">// or (2/Rx)/3   </span></div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">float</span> dsy = 1.0f / data-&gt;renderSizeY;         <span class="comment">// or (2/Ry)/2</span></div>
<div class="line"></div>
<div class="line">        camOutput.dDdx = AtVectorFromNozPoint(rayCtx.<a class="code" href="struct_presen_z_1_1_camera_1_1v4__1_1_1_pz_camera_ray.html#a736153c8076e6040f9703e238e5b987c">dDdx</a>*dsx);</div>
<div class="line">        camOutput.dDdy = AtVectorFromNozPoint(rayCtx.<a class="code" href="struct_presen_z_1_1_camera_1_1v4__1_1_1_pz_camera_ray.html#aeb84bfd699fd4a7c535d38f19449e6b4">dDdy</a>*dsy);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> {</div>
<div class="line">        camOutput.dDdx = AI_V3_ONE; </div>
<div class="line">        camOutput.dDdy = AI_V3_ONE;</div>
<div class="line"></div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    camOutput.weight = rayCtx.<a class="code" href="struct_presen_z_1_1_camera_1_1v4__1_1_1_pz_camera_ray.html#aac1b70a2ed67ead038c4d3f5ac4d8a81">isValid</a>() ? AI_RGB_WHITE : AI_RGB_BLACK;</div>
<div class="line">    camOutput.dir = rayCtx.<a class="code" href="struct_presen_z_1_1_camera_1_1v4__1_1_1_pz_camera_ray.html#aac1b70a2ed67ead038c4d3f5ac4d8a81">isValid</a>() ? AtVectorFromNozPoint(rayCtx.<a class="code" href="struct_presen_z_1_1_camera_1_1v4__1_1_1_pz_camera_ray.html#a7d4ae5b50b35b0b0e860ffe3192b05da">dir</a>) : AI_V3_ZERO;</div>
<div class="line">    camOutput.origin = AtVectorFromNozPoint(rayCtx.<a class="code" href="struct_presen_z_1_1_camera_1_1v4__1_1_1_pz_camera_ray.html#a3e1a826396726caf4930542970259fef">origin</a>);</div>
<div class="line">}</div>
</div><!-- fragment --><h1>10.2 AOV shader</h1>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;arnoldWrapper.h&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="_pz_detect_sample_api_8h.html">API/PzDetectSampleApi.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="_pz_app_logger_8h.html">API/PzAppLogger.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="_pz_shading_api_8h.html">API/PzShadingApi.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="_pz_cryptomatte_api_8h.html">API/PzCryptomatteApi.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;presenz_global_parameters.h&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">namespace</span></div>
<div class="line">{</div>
<div class="line">    <span class="keyword">enum</span> PresenZAOVsParams</div>
<div class="line">    {</div>
<div class="line">        p_beauty,</div>
<div class="line">    };</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line">AI_SHADER_NODE_EXPORT_METHODS(PresenZPostAOVShaderMethods);</div>
<div class="line"></div>
<div class="line">node_parameters</div>
<div class="line">{</div>
<div class="line">    AiMetaDataSetStr(nentry, NULL, <span class="stringliteral">&quot;_synonym&quot;</span>, <span class="stringliteral">&quot;PresenZPostAOVShader&quot;</span>);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span></div>
<div class="line">{</div>
<div class="line">    AtNode* renderCamera;</div>
<div class="line">    <span class="keywordtype">bool</span> renderIsolated;</div>
<div class="line">    <span class="keywordtype">float</span> maxDistance;</div>
<div class="line">    <span class="keywordtype">bool</span> hasEnv;</div>
<div class="line"></div>
<div class="line">} postShaderData;</div>
<div class="line"></div>
<div class="line"><span class="keyword">struct </span>CryptoUserData</div>
<div class="line">{</div>
<div class="line">    CryptoUserData(AtShaderGlobals* input) : sg(input) {}</div>
<div class="line">    ~CryptoUserData(){}</div>
<div class="line">    AtShaderGlobals* sg;</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keyword">struct </span>ArnoldUserData : <span class="keyword">public</span> ArnoldUserDataBase</div>
<div class="line">{</div>
<div class="line">    ArnoldUserData(AtShaderGlobals* input) : ArnoldUserDataBase(input), sgout(0), hasEnv(false), maxDist(0) {</div>
<div class="line">        sgout = AiShaderGlobals();</div>
<div class="line">    }</div>
<div class="line">    ~ArnoldUserData()</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">if</span> (sgout)</div>
<div class="line">        {</div>
<div class="line">            AiShaderGlobalsDestroy(sgout);</div>
<div class="line">            sgout = 0;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    AtShaderGlobals *sgout;</div>
<div class="line">    <span class="keywordtype">bool</span> hasEnv;</div>
<div class="line">    <span class="keywordtype">float</span> maxDist;</div>
<div class="line"></div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keyword">inline</span> <span class="keywordtype">void</span> setOut(AtShaderGlobals* sg, <span class="keyword">const</span> AtNode* node, PresenZAOVsParams p_beauty) { sg-&gt;out.CLOSURE() = AiShaderEvalParamClosure(p_beauty); }</div>
<div class="line"><span class="keyword">inline</span> <span class="keywordtype">void</span> setOutBlack(AtShaderGlobals* sg) { sg-&gt;out.RGBA() = AI_RGBA_ZERO; }</div>
<div class="line"><span class="keyword">inline</span> <span class="keywordtype">void</span> setOutWhite(AtShaderGlobals* sg) { sg-&gt;out.RGBA() = AI_RGBA_WHITE; }</div>
<div class="line"><span class="keyword">inline</span> uint8_t getRecursionLevel(AtShaderGlobals* sg) { <span class="keywordflow">return</span> sg-&gt;bounces; }</div>
<div class="line"><span class="keyword">inline</span> uint8_t getReflectionLevel(AtShaderGlobals* sg) { <span class="keywordflow">return</span> sg-&gt;bounces_reflect; }</div>
<div class="line"><span class="keyword">inline</span> uint8_t getRefractionLevel(AtShaderGlobals* sg) { <span class="keywordflow">return</span> sg-&gt;bounces_transmit; }</div>
<div class="line"><span class="keyword">inline</span> uint8_t getDiffractionLevel(AtShaderGlobals* sg) { <span class="keywordflow">return</span> sg-&gt;bounces_diffuse; }</div>
<div class="line"><span class="keyword">inline</span> uint8_t getGlossyLevel(AtShaderGlobals* sg) { <span class="keywordflow">return</span> sg-&gt;bounces_specular; }</div>
<div class="line"><span class="keyword">inline</span> <span class="keywordtype">void</span> setVelocityVec(AtShaderGlobals* sg) { AtVector P1; AiShaderGlobalsGetPositionAtTime(sg, 1.0f, P1, NULL, NULL, NULL); AiAOVSetVec(sg, velocityAtStr, AtVector(P1.x - sg-&gt;P.x, P1.y - sg-&gt;P.y, P1.z - sg-&gt;P.z)); }</div>
<div class="line"><span class="keyword">inline</span> <span class="keywordtype">void</span> setShaderGlobals(AtShaderGlobals* sg, uint8_t Rr, uint8_t Rr_refl, uint8_t Rr_refr, uint8_t Rr_diff, uint8_t Rr_gloss) { sg-&gt;bounces = Rr; sg-&gt;bounces_reflect = Rr_refl; sg-&gt;bounces_transmit = Rr_refr; sg-&gt;bounces_diffuse = Rr_diff; sg-&gt;bounces_specular = Rr_gloss; }</div>
<div class="line"><span class="keyword">inline</span> <span class="keywordtype">void</span> setGlassMaterialAOV(AtShaderGlobals* sg) { AiAOVSetBool(sg, przGlassAtStr, <span class="keyword">true</span>); }</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span>* GetNodeName(<span class="keywordtype">void</span>* ptr, <span class="keywordtype">void</span>* userData) {</div>
<div class="line">    <span class="keywordflow">return</span> AiNodeGetName((AtNode*)ptr);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span>* GetMaterialName(<span class="keywordtype">void</span>* ptr, <span class="keywordtype">void</span>* userData) {</div>
<div class="line">    CryptoUserData&amp; context = *<span class="keyword">reinterpret_cast&lt;</span>CryptoUserData*<span class="keyword">&gt;</span>(userData);</div>
<div class="line">    AtNode* shader = AiShaderGlobalsGetShader(context.sg);</div>
<div class="line">    <span class="keywordflow">return</span> AiNodeGetName(shader);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">bool</span> IsMaterialCacheable(<span class="keywordtype">void</span>* ptr, <span class="keywordtype">void</span>* userData) {</div>
<div class="line">    AtArray* shaders = AiNodeGetArray((AtNode*)ptr, shaderStr);</div>
<div class="line">    <span class="keywordflow">return</span> shaders ? AiArrayGetNumElements(shaders) == 1 : <span class="keyword">false</span>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">bool</span> ArnoldGetPreviousHitData(<a class="code" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_pz_previous_detect_glass_sample.html">PresenZ::DetectSample::PzPreviousDetectGlassSample</a>&amp; prevSample, <span class="keywordtype">bool</span> save, <span class="keywordtype">void</span>* userData) {</div>
<div class="line">    ArnoldUserData&amp; context = *<span class="keyword">reinterpret_cast&lt;</span>ArnoldUserData*<span class="keyword">&gt;</span>(userData);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (save) {</div>
<div class="line">        <span class="comment">// We tag the ray so we can get the previous value at the next intersection</span></div>
<div class="line">        AiMessageSetVecFunc(context.sg, msgPreviousPStr, context.sg-&gt;P);</div>
<div class="line">        AiMessageSetVecFunc(context.sg, msgPreviousNStr, context.sg-&gt;Ng);</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> {</div>
<div class="line">        <span class="comment">//If we are coming from another glass, we get the value</span></div>
<div class="line">        <span class="keywordflow">if</span> (context.sg-&gt;transp_index &gt; 0) {</div>
<div class="line">            AtVector previousP, previousN;</div>
<div class="line">            AiMessageGetVecFunc(context.sg, msgPreviousPStr, &amp;previousP);</div>
<div class="line">            AiMessageGetVecFunc(context.sg, msgPreviousNStr, &amp;previousN);</div>
<div class="line">            prevSample.<a class="code" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_pz_previous_detect_glass_sample.html#a39246df9bccc12078d74da138ecfbfa4">hitPoint</a> = NozPointFromAiPoint(previousP);</div>
<div class="line">            prevSample.<a class="code" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_pz_previous_detect_glass_sample.html#a89abeba874f4701e91ff5ad7601dd164">hitNormal</a> = NozVectorFromAiVector(previousN);</div>
<div class="line">            <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">false</span>;   </div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">bool</span> ArnoldHitTest(<span class="keyword">const</span> <a class="code" href="struct_noz_point.html">NozVector</a>&amp; origin, <span class="keyword">const</span> <a class="code" href="struct_noz_point.html">NozVector</a>&amp; dir, <span class="keyword">const</span> <span class="keywordtype">double</span> dist, <a class="code" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_ray_test_result.html">PresenZ::DetectSample::RayTestResult</a>&amp; out, <span class="keywordtype">void</span>* userData) {</div>
<div class="line">    ArnoldUserData&amp; context = *<span class="keyword">reinterpret_cast&lt;</span>ArnoldUserData*<span class="keyword">&gt;</span>(userData);</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">bool</span> hitOk = <span class="keyword">false</span>;</div>
<div class="line"></div>
<div class="line">    AtVector atOrigin = AtVectorFromNozVector(origin);</div>
<div class="line">    AtVector atDir = AtVectorFromNozVector(dir);</div>
<div class="line"></div>
<div class="line">    AiShaderGlobalsSetTraceSet(context.sg, przGlassAtStr, <span class="keyword">false</span>);</div>
<div class="line">    AtRay probe = AiMakeRay(AI_RAY_CAMERA, atOrigin, &amp;atDir, (<span class="keywordtype">float</span>)dist, context.sg);</div>
<div class="line">    hitOk = AiTraceProbe(probe, context.sgout);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (hitOk)</div>
<div class="line">    {</div>
<div class="line"></div>
<div class="line">        out.<a class="code" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_ray_test_result.html#a9d3ba7a09d203fbcadc59723666e37fe">hit</a> = NozVectorFromAiVector(context.sgout-&gt;P);</div>
<div class="line">        out.<a class="code" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_ray_test_result.html#a58649588b953a60c4ab3fb9b2143a87b">normal</a> = NozVectorFromAiVector(context.sgout-&gt;Ng);</div>
<div class="line">        out.<a class="code" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_ray_test_result.html#a873684cefeb665f3d5e6b495de57fc0d">d</a> = context.sgout-&gt;Rl;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (context.hasEnv)</div>
<div class="line">    {</div>
<div class="line">        hitOk = <span class="keyword">true</span>;</div>
<div class="line">        <a class="code" href="struct_noz_point.html">NozPoint</a> camPos = <a class="code" href="group___pz_phase_api.html#ga1069325bd956cd5801b61d46b29a69cb">PresenZ::Phase::PzGetZOVWorldPosition</a>();</div>
<div class="line"></div>
<div class="line">        std::vector&lt;float&gt; distances = hit_sphere(camPos, context.maxDist, dir, origin);</div>
<div class="line">        out.<a class="code" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_ray_test_result.html#a9d3ba7a09d203fbcadc59723666e37fe">hit</a> = origin + (dir * distances[0]);</div>
<div class="line">        out.<a class="code" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_ray_test_result.html#a58649588b953a60c4ab3fb9b2143a87b">normal</a> = <a class="code" href="group___n_o_z__vector.html#ga19bf5d776ee066f688d5432fe9ce257f">NozVecNormalize</a>(-dir);</div>
<div class="line">        out.<a class="code" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_ray_test_result.html#a873684cefeb665f3d5e6b495de57fc0d">d</a> = <a class="code" href="group___n_o_z__vector.html#gaec436ed5ffc599d804a9fd8fb464b70d">NozVecDist</a>(origin, out.<a class="code" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_ray_test_result.html#a9d3ba7a09d203fbcadc59723666e37fe">hit</a>);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> hitOk;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">uint64_t ArnoldQueryFlags(uint64_t flags, <span class="keywordtype">void</span>* userData)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">const</span> ArnoldUserData&amp; context = *<span class="keyword">reinterpret_cast&lt;</span><span class="keyword">const </span>ArnoldUserData*<span class="keyword">&gt;</span>(userData);</div>
<div class="line">    <span class="keywordtype">int</span> retval = 0;</div>
<div class="line">    <span class="keywordflow">if</span> (flags)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">if</span>(AiNodeIs(context.sg-&gt;Op, curveAtStr) || IsTaggedAsHair(context.sg))</div>
<div class="line">            retval += 1;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> retval;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">shader_evaluate</div>
<div class="line">{</div>
<div class="line">    </div>
<div class="line">    postShaderData* data = (postShaderData*)AiNodeGetLocalData(node);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (PresenZ_data_struct::pass == <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#ae1c5184dc404edf057ed537bcfddef84a48a95ceab76284afa466622424eba555">PresenZ::Phase::Detect</a>)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// Early out if it&#39;s not a camera ray.</span></div>
<div class="line">        <span class="keywordflow">if</span> (!(sg-&gt;Rt &amp; AI_RAY_CAMERA))</div>
<div class="line">            <span class="keywordflow">return</span>;</div>
<div class="line"></div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">bool</span> isCurve = AiNodeIs(sg-&gt;Op, curveAtStr);</div>
<div class="line"></div>
<div class="line">        <span class="keyword">const</span> uint32_t faceIndex = sg-&gt;fi;</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">bool</span> hemi = sg-&gt;fhemi;</div>
<div class="line">        <span class="comment">//sg-&gt;fhemi = false;</span></div>
<div class="line">        </div>
<div class="line">        <span class="keywordflow">if</span>(!isCurve)</div>
<div class="line">            sg-&gt;fi = UINT32_MAX;</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">if</span> (sg-&gt;fi == 0)</div>
<div class="line">                sg-&gt;fi = sg-&gt;fi+1;</div>
<div class="line">            <span class="keywordflow">else</span></div>
<div class="line">                sg-&gt;fi = 0;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        ArnoldUserData userData(sg);</div>
<div class="line">        </div>
<div class="line"></div>
<div class="line"></div>
<div class="line">        <a class="code" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_pz_detect_sample.html">PresenZ::DetectSample::PzDetectSample</a> sample;</div>
<div class="line">        <a class="code" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_pz_previous_detect_glass_sample.html">PresenZ::DetectSample::PzPreviousDetectGlassSample</a> previousSample;</div>
<div class="line">        sample.<a class="code" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_pz_detect_sample.html#a75f8ddf992db0cfc3cd1aa024086b6f3">pixelX</a> = sg-&gt;x;</div>
<div class="line">        sample.<a class="code" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_pz_detect_sample.html#aaa0423628e784003c3f5754ca1e56e70">pixelY</a> = sg-&gt;y;</div>
<div class="line">        sample.<a class="code" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_pz_detect_sample.html#a4c9257ffdd839b215aabfba5f05fa02e">hitNormal</a> = NozPointFromAiPoint(sg-&gt;Ng);</div>
<div class="line">        sample.<a class="code" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_pz_detect_sample.html#a39246df9bccc12078d74da138ecfbfa4">hitPoint</a> = NozPointFromAiPoint(sg-&gt;P);      </div>
<div class="line">        <a class="code" href="group___pz_detect_sample_api.html#gae8232121c525cb245371920f76a19b98">PresenZ::DetectSample::PzMatchSampleIndex</a>(sample, NozPointFromAiPoint(sg-&gt;Ro));</div>
<div class="line">        <span class="comment">// so yup, this bad boy right above is there to recompute the sample index from the ray direction.</span></div>
<div class="line">        <span class="comment">// because apparently some indices trown from the camera doesn&#39;t come with the same number in the shader</span></div>
<div class="line">        <span class="comment">//</span></div>
<div class="line">        <span class="comment">// This might be due to the fact that before... some camera ray was not really trown to the scene but was just evaluated for the adaptiveSubdivision/displacement calculation </span></div>
<div class="line">        <span class="comment">// now these subdiv/disp ray are taken in account by PresenZ, so we&#39;are not wasting PresenZ ray and indices anymore. </span></div>
<div class="line">        </div>
<div class="line">        <span class="keywordflow">if</span> (IsTaggedAsHair(sg))</div>
<div class="line">        {</div>
<div class="line">            sample.<a class="code" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_pz_detect_sample.html#ad50b77be6452fcd203fa25771dd4f69e">isHair</a> = <span class="keyword">true</span>;</div>
<div class="line">            sample.<a class="code" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_pz_detect_sample.html#a4c9257ffdd839b215aabfba5f05fa02e">hitNormal</a> = <a class="code" href="struct_noz_point.html">NozPoint</a>(0.0f);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (IsTaggedAsGlass(sg) == <span class="keyword">true</span>) {</div>
<div class="line">            sample.<a class="code" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_pz_detect_sample.html#ae89f8742850b3f5fb55f23ccf9a55d86">transpType</a> = <a class="code" href="namespace_presen_z_1_1_detect_sample_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#a4235bda2ada163773d83c4d1d6c75bc0ae0e0d5fadce4b0933385ee555c8f7a53">PresenZ::DetectSample::DST_glass</a>;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (IsTaggedAsChaotic(sg) == <span class="keyword">true</span>)</div>
<div class="line">            sample.<a class="code" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_pz_detect_sample.html#a8a33ba6ff4f3da7799e33a2827f9d297">isChaotic</a> = <span class="keyword">true</span>;</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">bool</span> notisolated = (data-&gt;renderIsolated ) &amp;&amp; (!IsTaggedAsRenderIsolated(sg));</div>
<div class="line">        <span class="keywordflow">if</span> (notisolated) { <span class="comment">// not isolated And render isolated on... </span></div>
<div class="line">            <span class="keywordflow">return</span>;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">        <span class="comment">//const AtNodeEntry* entry = AiNodeGetNodeEntry(sg-&gt;Op);</span></div>
<div class="line">        <span class="keywordflow">if</span>(sg-&gt;Rl &gt;= data-&gt;maxDistance)</div>
<div class="line">        {</div>
<div class="line">            <a class="code" href="struct_noz_point.html">NozPoint</a> camPos = <a class="code" href="group___pz_phase_api.html#ga1069325bd956cd5801b61d46b29a69cb">PresenZ::Phase::PzGetZOVWorldPosition</a>();</div>
<div class="line">            <a class="code" href="struct_noz_point.html">NozVector</a> rayDir(sg-&gt;Rd.x, sg-&gt;Rd.y, sg-&gt;Rd.z);</div>
<div class="line">            <a class="code" href="struct_noz_point.html">NozVector</a> rayOrigin = NozPointFromAiPoint(sg-&gt;Ro);</div>
<div class="line">            std::vector&lt;float&gt; distances = hit_sphere(camPos, data-&gt;maxDistance, rayDir, rayOrigin);</div>
<div class="line">            sample.<a class="code" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_pz_detect_sample.html#a39246df9bccc12078d74da138ecfbfa4">hitPoint</a> = rayOrigin + (rayDir * distances[0]);</div>
<div class="line">            sample.<a class="code" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_pz_detect_sample.html#a4c9257ffdd839b215aabfba5f05fa02e">hitNormal</a> = -rayDir;</div>
<div class="line">            userData.hasEnv = <span class="keyword">true</span>;</div>
<div class="line">            userData.maxDist = data-&gt;maxDistance;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <a class="code" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_ray_test_interface.html">PresenZ::DetectSample::RayTestInterface</a> probe(&amp;userData, ArnoldHitTest, ArnoldQueryFlags, ArnoldSaveDetect, ArnoldGetPreviousHitData);</div>
<div class="line">        <a class="code" href="group___pz_detect_sample_api.html#ga0cca44a660fba1c326e072afabdb2d9a">PresenZ::DetectSample::PzProcessDetectSample</a>(&amp;probe, sample, sg-&gt;tid);</div>
<div class="line"></div>
<div class="line">        sg-&gt;fhemi = hemi;</div>
<div class="line">        sg-&gt;fi = faceIndex;</div>
<div class="line">      </div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (PresenZ_data_struct::pass == <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#ae1c5184dc404edf057ed537bcfddef84a9e72290cbba5243f4449f84168a3c99c">PresenZ::Phase::Detect_Reflection</a>)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// Early out if it&#39;s not a camera ray.</span></div>
<div class="line">        <span class="keywordflow">if</span> (!(sg-&gt;Rt &amp; AI_RAY_CAMERA))</div>
<div class="line">            <span class="keywordflow">return</span>;</div>
<div class="line"></div>
<div class="line">        <a class="code" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_pz_detect_sample.html">PresenZ::DetectSample::PzDetectSample</a> sample;</div>
<div class="line">        sample.<a class="code" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_pz_detect_sample.html#a75f8ddf992db0cfc3cd1aa024086b6f3">pixelX</a> = sg-&gt;x;</div>
<div class="line">        sample.<a class="code" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_pz_detect_sample.html#aaa0423628e784003c3f5754ca1e56e70">pixelY</a> = sg-&gt;y;</div>
<div class="line">        sample.<a class="code" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_pz_detect_sample.html#a4c9257ffdd839b215aabfba5f05fa02e">hitNormal</a> = NozPointFromAiPoint(sg-&gt;Ng);</div>
<div class="line">        sample.<a class="code" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_pz_detect_sample.html#a39246df9bccc12078d74da138ecfbfa4">hitPoint</a> = NozPointFromAiPoint(sg-&gt;P);</div>
<div class="line">        <span class="comment">//sample.sampleIndex = sg-&gt;si;</span></div>
<div class="line">        <a class="code" href="group___pz_detect_sample_api.html#gae8232121c525cb245371920f76a19b98">PresenZ::DetectSample::PzMatchSampleIndex</a>(sample, NozPointFromAiPoint(sg-&gt;Ro));</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (AiNodeIs(sg-&gt;Op, curveAtStr) || IsTaggedAsHair(sg))</div>
<div class="line">        {</div>
<div class="line">            sample.<a class="code" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_pz_detect_sample.html#ad50b77be6452fcd203fa25771dd4f69e">isHair</a> = <span class="keyword">true</span>;</div>
<div class="line">            sample.<a class="code" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_pz_detect_sample.html#a4c9257ffdd839b215aabfba5f05fa02e">hitNormal</a> = <a class="code" href="struct_noz_point.html">NozPoint</a>(0.0f);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (IsTaggedAsGlass(sg) == <span class="keyword">true</span>) {</div>
<div class="line">            sample.<a class="code" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_pz_detect_sample.html#ae89f8742850b3f5fb55f23ccf9a55d86">transpType</a> = <a class="code" href="namespace_presen_z_1_1_detect_sample_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#a4235bda2ada163773d83c4d1d6c75bc0ae0e0d5fadce4b0933385ee555c8f7a53">PresenZ::DetectSample::DST_glass</a>;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (IsTaggedAsChaotic(sg) == <span class="keyword">true</span>)</div>
<div class="line">            sample.<a class="code" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_pz_detect_sample.html#a8a33ba6ff4f3da7799e33a2827f9d297">isChaotic</a> = <span class="keyword">true</span>;</div>
<div class="line"></div>
<div class="line">        </div>
<div class="line">        ArnoldUserData userData(sg);</div>
<div class="line">        <a class="code" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_ray_test_interface.html">PresenZ::DetectSample::RayTestInterface</a> probe(&amp;userData, ArnoldHitTest, ArnoldQueryFlags, <span class="keyword">nullptr</span>, <span class="keyword">nullptr</span>);</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">        <a class="code" href="group___pz_detect_sample_api.html#ga0cca44a660fba1c326e072afabdb2d9a">PresenZ::DetectSample::PzProcessDetectSample</a>(&amp;probe, sample, sg-&gt;tid);</div>
<div class="line"></div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">if</span> (!(sg-&gt;Rt &amp; AI_RAY_CAMERA))</div>
<div class="line">            <span class="keywordflow">return</span>;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (PresenZ_data_struct::pass == <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#ae1c5184dc404edf057ed537bcfddef84a4fa71226841d5dc4359c2e48fa8a079e">PresenZ::Phase::Render_Reflection</a>)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">if</span>(sg-&gt;bounces == 1)</div>
<div class="line">            {</div>
<div class="line">                AiAOVSetVec(sg, rayDirAOVStr, sg-&gt;Rd);</div>
<div class="line">                AiAOVSetVec(sg, rayOrigAOVStr, sg-&gt;Ro);</div>
<div class="line">                AiAOVSetVec(sg, NCameraAtStr, sg-&gt;Ng);</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">        {</div>
<div class="line"></div>
<div class="line">            AiAOVSetVec(sg, rayDirAOVStr, sg-&gt;Rd);</div>
<div class="line">            AiAOVSetVec(sg, rayOrigAOVStr, sg-&gt;Ro);</div>
<div class="line">            <span class="keywordflow">if</span> (sg-&gt;Rl &gt;= data-&gt;maxDistance)</div>
<div class="line">                AiAOVSetVec(sg, NCameraAtStr, AiV3Normalize(-sg-&gt;Rd));</div>
<div class="line">            <span class="keywordflow">else</span></div>
<div class="line">                AiAOVSetVec(sg, NCameraAtStr, sg-&gt;Ng);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (sg-&gt;sc == AI_CONTEXT_SURFACE) {</div>
<div class="line">            <span class="keywordflow">if</span> (PresenZ_data_struct::do_crypto) {</div>
<div class="line"></div>
<div class="line">                <span class="keywordtype">float</span> nsp_hash, obj_hash, mat_hash;</div>
<div class="line"></div>
<div class="line">                CryptoUserData userData(sg);</div>
<div class="line"></div>
<div class="line">                <a class="code" href="struct_presen_z_1_1_cryptomatte_1_1v4__1_1_1_crypto_mattet_interface.html">PresenZ::Cryptomatte::CryptoMattetInterface</a> getCryptoInfo((<span class="keywordtype">void</span>*)sg-&gt;Op, &amp;userData, GetNodeName, GetMaterialName, IsMaterialCacheable);</div>
<div class="line">                <a class="code" href="namespace_presen_z_1_1_cryptomatte_1_1v4__1.html#a3ffe2c7a777b006cd9467a9a6fe61ddb">PresenZ::Cryptomatte::PzProcessNode</a>(&amp;getCryptoInfo, sg-&gt;tid, nsp_hash, obj_hash, mat_hash);</div>
<div class="line">                AiAOVSetFlt(sg, crypto_objectAOVStr, obj_hash);</div>
<div class="line">                AiAOVSetFlt(sg, crypto_materialAOVStr, mat_hash);</div>
<div class="line">                AiAOVSetFlt(sg, crypto_assetAOVStr, nsp_hash);</div>
<div class="line"></div>
<div class="line">                AtVector P1, P2;</div>
<div class="line">                AiShaderGlobalsGetPositionAtTime(sg, 0.0f, P1, NULL, NULL, NULL);</div>
<div class="line">                AiShaderGlobalsGetPositionAtTime(sg, 1.0f, P2, NULL, NULL, NULL);</div>
<div class="line">                AiAOVSetVec(sg, velocityAtStr, AtVector(P2.x - P1.x, P2.y - P1.y, P2.z - P1.z));</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">node_initialize</div>
<div class="line">{</div>
<div class="line">    postShaderData *data = (postShaderData*)AiMalloc(<span class="keyword">sizeof</span>(postShaderData));</div>
<div class="line">    AiNodeSetLocalData(node, data);</div>
<div class="line">    <span class="keyword">const</span> AtUniverse* universe = AiNodeGetUniverse(node);</div>
<div class="line">    AtNode* camera = AiUniverseGetCamera(universe);</div>
<div class="line">    data-&gt;renderCamera = camera;</div>
<div class="line"><span class="preprocessor">#if AI_VERSION_ARCH_NUM &gt;= 7 &amp;&amp; AI_VERSION_MAJOR_NUM &gt;= 4</span></div>
<div class="line"><span class="preprocessor"></span>    AiNodeAddDependency(node, camera, farClipStr);</div>
<div class="line">    AiNodeAddDependency(node, camera, renderIsolatedStr);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>}</div>
<div class="line"></div>
<div class="line">node_update</div>
<div class="line">{</div>
<div class="line"></div>
<div class="line">    postShaderData *data = (postShaderData*)AiNodeGetLocalData(node);</div>
<div class="line"></div>
<div class="line">    <span class="keyword">const</span> AtUniverse* universe = AiNodeGetUniverse(node);</div>
<div class="line">    AtNode* pzCamera = AiUniverseGetCamera(universe);</div>
<div class="line"><span class="preprocessor">#if AI_VERSION_ARCH_NUM &gt;= 7 &amp;&amp; AI_VERSION_MAJOR_NUM &gt;= 4</span></div>
<div class="line"><span class="preprocessor"></span>    AiNodeClearDependency(node, data-&gt;renderCamera);</div>
<div class="line">    AiNodeAddDependency(node, pzCamera, farClipStr);</div>
<div class="line">    AiNodeAddDependency(node, pzCamera, renderIsolatedStr);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>    data-&gt;renderCamera = pzCamera;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (AiNodeIs(pzCamera, PresenzCameraName))</div>
<div class="line">    {</div>
<div class="line">        data-&gt;renderIsolated = AiNodeGetBool(pzCamera, renderIsolatedStr);</div>
<div class="line">        data-&gt;maxDistance = AiNodeGetFlt(pzCamera, farClipStr);;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">        <a class="code" href="group___pz_app_logger.html#gafd8b815a0f76d6b121f44f62d5730ee4">PZ_ERROR</a>(<span class="stringliteral">&quot;[PresenZ] Could not find the PresenZ camera.&quot;</span>);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">node_finish</div>
<div class="line">{</div>
<div class="line">}</div>
</div><!-- fragment --><h1>10.3 Intersection shader</h1>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;arnoldWrapper.h&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="_pz_detect_sample_api_8h.html">API/PzDetectSampleApi.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="_pz_app_logger_8h.html">API/PzAppLogger.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="_pz_shading_api_8h.html">API/PzShadingApi.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;presenz_global_parameters.h&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">namespace</span></div>
<div class="line">{</div>
<div class="line">    <span class="keyword">enum</span> PresenZAOVsParams</div>
<div class="line">    {</div>
<div class="line">        p_beauty,</div>
<div class="line">        p_opacity</div>
<div class="line">    };</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line">AI_SHADER_NODE_EXPORT_METHODS(PresenZShaderMtd);</div>
<div class="line"></div>
<div class="line">node_parameters</div>
<div class="line">{</div>
<div class="line">    AiParameterClosure(<span class="stringliteral">&quot;beauty&quot;</span>);</div>
<div class="line">    AiParameterRGB(<span class="stringliteral">&quot;opacity&quot;</span>, 1.0, 1.0, 1.0);</div>
<div class="line">    AiMetaDataSetInt(nentry, <span class="stringliteral">&quot;opacity&quot;</span>, <span class="stringliteral">&quot;opacity_term&quot;</span>, 1);</div>
<div class="line">    AiMetaDataSetInt(nentry, <span class="stringliteral">&quot;beauty&quot;</span>, <span class="stringliteral">&quot;opacity_term&quot;</span>, 0);</div>
<div class="line">    AiMetaDataSetStr(nentry, NULL, <span class="stringliteral">&quot;_synonym&quot;</span>, <span class="stringliteral">&quot;PresenZShader&quot;</span>);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span></div>
<div class="line">{</div>
<div class="line">    AtNode* renderCamera;</div>
<div class="line">    <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#a3104904c134a52357b85f763f6dfd48f">PresenZ::Phase::Eye</a> eye;</div>
<div class="line">    <span class="keywordtype">bool</span> renderIsolated;</div>
<div class="line">    uint8_t stereoRightEye;</div>
<div class="line"></div>
<div class="line">} ShaderData;</div>
<div class="line"></div>
<div class="line"><span class="keyword">inline</span> <span class="keywordtype">void</span> setOut(AtShaderGlobals* sg, <span class="keyword">const</span> AtNode* node, PresenZAOVsParams p_beauty) { sg-&gt;out.CLOSURE() = AiShaderEvalParamClosure(p_beauty); }</div>
<div class="line"><span class="keyword">inline</span> <span class="keywordtype">void</span> setOutBlack(AtShaderGlobals* sg) { sg-&gt;out.RGBA() = AI_RGBA_ZERO; }</div>
<div class="line"><span class="keyword">inline</span> <span class="keywordtype">void</span> setOutWhite(AtShaderGlobals* sg) { sg-&gt;out.RGBA() = AI_RGBA_WHITE; }</div>
<div class="line"><span class="keyword">inline</span> uint8_t getRecursionLevel(AtShaderGlobals* sg) { <span class="keywordflow">return</span> sg-&gt;bounces; }</div>
<div class="line"><span class="keyword">inline</span> uint8_t getReflectionLevel(AtShaderGlobals* sg) { <span class="keywordflow">return</span> sg-&gt;bounces_reflect; }</div>
<div class="line"><span class="keyword">inline</span> uint8_t getRefractionLevel(AtShaderGlobals* sg) { <span class="keywordflow">return</span> sg-&gt;bounces_transmit; }</div>
<div class="line"><span class="keyword">inline</span> uint8_t getDiffractionLevel(AtShaderGlobals* sg) { <span class="keywordflow">return</span> sg-&gt;bounces_diffuse; }</div>
<div class="line"><span class="keyword">inline</span> uint8_t getGlossyLevel(AtShaderGlobals* sg) { <span class="keywordflow">return</span> sg-&gt;bounces_specular; }</div>
<div class="line"><span class="keyword">inline</span> <span class="keywordtype">void</span> setVelocityVec(AtShaderGlobals* sg) { AtVector P1; AiShaderGlobalsGetPositionAtTime(sg, 1.0f, P1, NULL, NULL, NULL); AiAOVSetVec(sg, velocityAtStr, AtVector(P1.x - sg-&gt;P.x, P1.y - sg-&gt;P.y, P1.z - sg-&gt;P.z)); }</div>
<div class="line"><span class="keyword">inline</span> <span class="keywordtype">void</span> setShaderGlobals(AtShaderGlobals* sg, uint8_t Rr, uint8_t Rr_refl, uint8_t Rr_refr, uint8_t Rr_diff, uint8_t Rr_gloss) { sg-&gt;bounces = Rr; sg-&gt;bounces_reflect = Rr_refl; sg-&gt;bounces_transmit = Rr_refr; sg-&gt;bounces_diffuse = Rr_diff; sg-&gt;bounces_specular = Rr_gloss; }</div>
<div class="line"><span class="keyword">inline</span> <span class="keywordtype">void</span> setGlassMaterialAOV(AtShaderGlobals* sg) { AiAOVSetBool(sg, przGlassAtStr, <span class="keyword">true</span>); }</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">bool</span> SolveLinearSystem2x2(<span class="keyword">const</span> <span class="keywordtype">float</span> A[2][2], <span class="keyword">const</span> <span class="keywordtype">float</span> B[2], <span class="keywordtype">float</span> *x0, <span class="keywordtype">float</span> *x1)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">float</span> det = A[0][0] * A[1][1] - A[0][1] * A[1][0];</div>
<div class="line">    <span class="keywordflow">if</span> (fabsf(det) &lt; 1e-10f)</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">    *x0 = (A[1][1] * B[0] - A[0][1] * B[1]) / det;</div>
<div class="line">    *x1 = (A[0][0] * B[1] - A[1][0] * B[0]) / det;</div>
<div class="line">    <span class="keywordflow">if</span> (isnan(*x0) || isnan(*x1))</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> computeUVDifferentials(<span class="keyword">const</span> AtVector&amp; nn,  <span class="keyword">const</span> AtVector &amp;dPdx, <span class="keyword">const</span> AtVector &amp;dPdy, <span class="keyword">const</span> AtVector &amp;dPdu, <span class="keyword">const</span> AtVector &amp;dPdv,</div>
<div class="line">    <span class="keywordtype">float</span> &amp;dudx,<span class="keywordtype">float</span> &amp;dudy, <span class="keywordtype">float</span> &amp;dvdx, <span class="keywordtype">float</span> &amp;dvdy  ) {</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">float</span> A[2][2], Bx[2], By[2];</div>
<div class="line">    <span class="keywordtype">int</span> axes[2];</div>
<div class="line">    <span class="keywordflow">if</span> (fabsf(nn.x) &gt; fabsf(nn.y) &amp;&amp; fabsf(nn.x) &gt; fabsf(nn.z)) {</div>
<div class="line">        axes[0] = 1; axes[1] = 2;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fabsf(nn.y) &gt; fabsf(nn.z)) {</div>
<div class="line">        axes[0] = 0; axes[1] = 2;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> {</div>
<div class="line">        axes[0] = 0; axes[1] = 1;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    A[0][0] = dPdu[axes[0]];</div>
<div class="line">    A[0][1] = dPdv[axes[0]];</div>
<div class="line">    A[1][0] = dPdu[axes[1]];</div>
<div class="line">    A[1][1] = dPdv[axes[1]];</div>
<div class="line">    Bx[0] = dPdx[axes[0]];</div>
<div class="line">    Bx[1] = dPdx[axes[1]];</div>
<div class="line">    By[0] = dPdy[axes[0]];</div>
<div class="line">    By[1] = dPdy[axes[1]];</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (!SolveLinearSystem2x2(A, Bx, &amp;dudx, &amp;dvdx)) {</div>
<div class="line">        dudx = 0.; dvdx = 0.;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (!SolveLinearSystem2x2(A, By, &amp;dudy, &amp;dvdy)) {</div>
<div class="line">        dudy = 0.; dvdy = 0.;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line">AtVector GetPlaneIntersect(<span class="keyword">const</span> AtVector&amp; planePoint, <span class="keyword">const</span> AtVector&amp; planeNormal, <span class="keyword">const</span> AtVector&amp; linePoint, <span class="keyword">const</span> AtVector&amp; lineDir)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> denom = AiV3Dot(planeNormal, lineDir);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (fabs(denom) &gt; FLT_EPSILON) {</div>
<div class="line"></div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> p0l0x = <span class="keyword">static_cast&lt;</span><span class="keywordtype">double</span><span class="keyword">&gt;</span>(planePoint.x) - static_cast&lt;double&gt;(linePoint.x);</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> p0l0y = <span class="keyword">static_cast&lt;</span><span class="keywordtype">double</span><span class="keyword">&gt;</span>(planePoint.y) - static_cast&lt;double&gt;(linePoint.y);</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> p0l0z = <span class="keyword">static_cast&lt;</span><span class="keywordtype">double</span><span class="keyword">&gt;</span>(planePoint.z) - static_cast&lt;double&gt;(linePoint.z);</div>
<div class="line"></div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> num = p0l0x * planeNormal.x + p0l0y * planeNormal.y + p0l0z * planeNormal.z;</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> t = num / denom;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">return</span> linePoint + (float)t * lineDir;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> planePoint;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">bool</span> isStereoRightEye(uint8_t stereoRightEye, <span class="keywordtype">bool</span> stereoTag) {</div>
<div class="line">    <span class="keywordflow">if</span> (stereoRightEye == 0) <span class="keywordflow">return</span> <span class="keyword">true</span>; <span class="comment">// render all surfaces, ignore stereo tag</span></div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (stereoRightEye == 1 &amp;&amp; stereoTag ) <span class="keywordflow">return</span> <span class="keyword">true</span>; <span class="comment">// render tagged surface in stereo</span></div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (stereoRightEye == 2 &amp;&amp; !stereoTag) <span class="keywordflow">return</span> <span class="keyword">true</span>; <span class="comment">// render tagged surface in stereo</span></div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">shader_evaluate</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (PresenZ_data_struct::pass == <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#ae1c5184dc404edf057ed537bcfddef84ac677a954de25220db675695edacb4f71">PresenZ::Phase::Render</a> || PresenZ_data_struct::pass == <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#ae1c5184dc404edf057ed537bcfddef84a4fa71226841d5dc4359c2e48fa8a079e">PresenZ::Phase::Render_Reflection</a>)</div>
<div class="line">    {</div>
<div class="line">        ShaderData *data = (ShaderData*)AiNodeGetLocalData(node);</div>
<div class="line"></div>
<div class="line">        AiAOVSetVec(sg, NCameraAtStr, sg-&gt;Ng);</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">        </div>
<div class="line"></div>
<div class="line">        <span class="comment">// for left eye you should always evaluate shader, for right eye we need to check that hitpoint is not too far</span></div>
<div class="line"></div>
<div class="line"></div>
<div class="line">        <span class="comment">// If it&#39;s not a camera ray, we are just evaluating the shader</span></div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (!(sg-&gt;Rt &amp; AI_RAY_CAMERA))</div>
<div class="line">        {</div>
<div class="line">            <span class="comment">// Transmission case.</span></div>
<div class="line">            <span class="comment">/*if (sg-&gt;Rt &amp; AI_RAY_ALL_TRANSMIT)</span></div>
<div class="line"><span class="comment">            {</span></div>
<div class="line"><span class="comment">                bool fromGlass = false;</span></div>
<div class="line"><span class="comment">                bool found = AiStateGetMsgBool(przGlassAtStr, &amp;fromGlass);</span></div>
<div class="line"><span class="comment"></span></div>
<div class="line"><span class="comment">                if (found)</span></div>
<div class="line"><span class="comment">                {</span></div>
<div class="line"><span class="comment">                // If  we are coming from a glass, and we are not, we don&#39;t want the refraction, so we return nothing.</span></div>
<div class="line"><span class="comment">                if (IsTaggedAsGlass(sg-&gt;Op) == false)</span></div>
<div class="line"><span class="comment">                    return;</span></div>
<div class="line"><span class="comment">                else</span></div>
<div class="line"><span class="comment">                    sg-&gt;out.CLOSURE() = closureList;</span></div>
<div class="line"><span class="comment">                }</span></div>
<div class="line"><span class="comment">                else</span></div>
<div class="line"><span class="comment">                    sg-&gt;out.CLOSURE() = closureList;</span></div>
<div class="line"><span class="comment">                    return;</span></div>
<div class="line"><span class="comment">            }</span></div>
<div class="line"><span class="comment">            else*/</span></div>
<div class="line">                sg-&gt;out.CLOSURE() = AiShaderEvalParamClosure(p_beauty);</div>
<div class="line"></div>
<div class="line">        }</div>
<div class="line">        <span class="comment">// Camera ray...</span></div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">        {</div>
<div class="line"></div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">int</span> originalx = sg-&gt;x;</div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">int</span> originaly = sg-&gt;y;</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">bool</span> notisolated = (data-&gt;renderIsolated) &amp;&amp; (!IsTaggedAsRenderIsolated(sg));</div>
<div class="line">            <span class="keywordflow">if</span> (notisolated) {</div>
<div class="line">                sg-&gt;out.CLOSURE() = AiClosureMatte(sg);</div>
<div class="line">                <span class="keywordflow">return</span>;</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> (<a class="code" href="group___pz_shading_api.html#ga46b99da06dfd3ad42a3511f678e206db">PresenZ::Shading::PzIsValidEvaluation</a>(originalx, originaly, sg-&gt;Rl, IsTaggedAsChaotic(sg)) == <span class="keyword">false</span>)</div>
<div class="line">            {</div>
<div class="line">                sg-&gt;out.CLOSURE() = AiClosureMatte(sg);</div>
<div class="line">                <span class="keywordflow">return</span>;</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="keyword">const</span> AtVector originalRd = sg-&gt;Rd;</div>
<div class="line">            <a class="code" href="struct_noz_point.html">NozPoint</a> bestCamWS = <a class="code" href="group___pz_shading_api.html#gaa02e80ddd91d3172a0bbef5fbd02ffec">PresenZ::Shading::PzGetBestCameraWSPosition</a>(originalx, originaly);</div>
<div class="line">            <a class="code" href="struct_noz_point.html">NozVector</a> bestCamWsDir = <a class="code" href="group___n_o_z__vector.html#ga19bf5d776ee066f688d5432fe9ce257f">NozVecNormalize</a>( NozPointFromAiPoint(sg-&gt;P) - bestCamWS );</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">            <a class="code" href="struct_presen_z_1_1_shading_1_1v4__1_1_1_pz_bend_ray.html">PresenZ::Shading::PzBendRay</a> bendRay = <a class="code" href="group___pz_shading_api.html#gacaa41d3befa6df73d9b111e6b2e5a935">PresenZ::Shading::PzGetBendRayRenderPhase</a>(</div>
<div class="line">                data-&gt;eye, </div>
<div class="line">                NozPointFromAiPoint(sg-&gt;Ng),</div>
<div class="line">                NozPointFromAiPoint(sg-&gt;Ns), </div>
<div class="line">                NozPointFromAiPoint(originalRd),</div>
<div class="line">                NozPointFromAiPoint(sg-&gt;P), </div>
<div class="line">                sg-&gt;Rl,</div>
<div class="line">                bestCamWS); <span class="comment">// eye, normal, worldcameradir, worldpoint, hitdistance</span></div>
<div class="line"></div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">bool</span> stereoRightEye = isStereoRightEye(data-&gt;stereoRightEye, IsTaggedAsStereoRightEye(sg) );</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> (data-&gt;eye == <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#a3104904c134a52357b85f763f6dfd48fa4280d82f18d6dbafdeb68c811112455e">PresenZ::Phase::Eye::RC_Left</a> || (data-&gt;eye == <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#a3104904c134a52357b85f763f6dfd48fac2b22af1f16cebd2cc909767c763a713">PresenZ::Phase::Eye::RC_Right</a> &amp;&amp; stereoRightEye &amp;&amp; bendRay.<a class="code" href="struct_presen_z_1_1_shading_1_1v4__1_1_1_pz_bend_ray.html#a25d24f3fc254ac9d7f43b9be22fadd34">isStereoScopic</a>))</div>
<div class="line">            {</div>
<div class="line">                <span class="keywordtype">int</span> realX = 0;</div>
<div class="line">                <span class="keywordtype">int</span> realY = 0;</div>
<div class="line">                <span class="keywordflow">if</span> (<a class="code" href="group___pz_shading_api.html#gaf2bfef182917f383983c8dead2df3440">PresenZ::Shading::PzGetPixelCoordinates</a>(originalx, originaly, realX, realY)) {</div>
<div class="line">                    sg-&gt;x = realX;</div>
<div class="line">                    sg-&gt;y = realY;</div>
<div class="line">                }</div>
<div class="line"></div>
<div class="line">                <a class="code" href="struct_noz_point2.html">NozVector2</a> inPixelPos = <a class="code" href="group___pz_shading_api.html#ga61f6e3d14eda73649838d664e3f8b165">PresenZ::Shading::PzGetXYInPixelPosition</a>(originalx, originaly, sg-&gt;si);</div>
<div class="line">                sg-&gt;px = inPixelPos.<a class="code" href="struct_noz_point2.html#ad0da36b2558901e21e7a30f6c227a45e">x</a>;</div>
<div class="line">                sg-&gt;py = inPixelPos.<a class="code" href="struct_noz_point2.html#aa4f0d3eebc3c443f9be81bf48561a217">y</a>;</div>
<div class="line">                </div>
<div class="line">                sg-&gt;Rd = AtVectorFromNozPoint(bendRay.<a class="code" href="struct_presen_z_1_1_shading_1_1v4__1_1_1_pz_bend_ray.html#a7d4ae5b50b35b0b0e860ffe3192b05da">dir</a>);</div>
<div class="line">                sg-&gt;Rl = (float)bendRay.<a class="code" href="struct_presen_z_1_1_shading_1_1v4__1_1_1_pz_bend_ray.html#ab44f0a3b38724b93889067c8dc6e9469">wHitDistance</a>;</div>
<div class="line">                sg-&gt;Ro = sg-&gt;P - AtVectorFromNozPoint(bendRay.<a class="code" href="struct_presen_z_1_1_shading_1_1v4__1_1_1_pz_bend_ray.html#a7d4ae5b50b35b0b0e860ffe3192b05da">dir</a>) * (float)bendRay.<a class="code" href="struct_presen_z_1_1_shading_1_1v4__1_1_1_pz_bend_ray.html#ab44f0a3b38724b93889067c8dc6e9469">wHitDistance</a>;</div>
<div class="line">                <span class="keywordtype">double</span> resX = 0.;</div>
<div class="line">                <span class="keywordtype">double</span> resY = 0.;</div>
<div class="line">                <a class="code" href="group___pz_shading_api.html#gab9d7b3f42199457436fcd73ebdb454f2">PresenZ::Shading::PzGetRenderingResolution</a>(resX, resY);</div>
<div class="line"></div>
<div class="line">                <span class="comment">// Previously we took the arnold cube map camera derivative into reference </span></div>
<div class="line">                <span class="comment">// but we found out they were a bit too long, this was making arnold using too high mipmap level</span></div>
<div class="line">                </div>
<div class="line">                <span class="comment">// const float dsx = 2.0 / (resX * 1.5);    // matching camera screenspace derivatives </span></div>
<div class="line">                <span class="comment">// const float dsy = ( 2.0 / (resY * 1.5 * 1.5) ) * 1.5 ;</span></div>
<div class="line">                <span class="comment">// equaling this</span></div>
<div class="line">                <span class="comment">// const float dsx = 4.0 / (resX * 3.);</span></div>
<div class="line">                <span class="comment">// const float dsy = 4.0 / (resY * 3 );</span></div>
<div class="line">                </div>
<div class="line">                <span class="comment">// now we are using a 90deg perspective camera derivative as a refenrece </span></div>
<div class="line">                <span class="comment">// to set the derivative for each face of our cube map projection. </span></div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">float</span> dsx = 2.0f / ((float)resX * 3.f) ;  <span class="comment">// or (2/Ry)/3   </span></div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">float</span> dsy = 1.0f / (float)resY;         <span class="comment">// or (2/Ry)/2</span></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line">                sg-&gt;dDdx = AtVectorFromNozVector( bendRay.<a class="code" href="struct_presen_z_1_1_shading_1_1v4__1_1_1_pz_bend_ray.html#a736153c8076e6040f9703e238e5b987c">dDdx</a> ) *  dsx;</div>
<div class="line">                sg-&gt;dDdy = AtVectorFromNozVector( bendRay.<a class="code" href="struct_presen_z_1_1_shading_1_1v4__1_1_1_pz_bend_ray.html#aeb84bfd699fd4a7c535d38f19449e6b4">dDdy</a> ) *  dsy;</div>
<div class="line">                </div>
<div class="line">                AtVector sgrd = AtVectorFromNozPoint(bestCamWsDir);</div>
<div class="line">                AtVector sgro = AtVectorFromNozPoint(bestCamWS);</div>
<div class="line"></div>
<div class="line">                sg-&gt;dPdx = GetPlaneIntersect(sg-&gt;P, sg-&gt;Ng, sgro, sgrd + sg-&gt;dDdx) - sg-&gt;P;</div>
<div class="line">                sg-&gt;dPdy = GetPlaneIntersect(sg-&gt;P, sg-&gt;Ng, sgro, sgrd + sg-&gt;dDdy) - sg-&gt;P;</div>
<div class="line">                </div>
<div class="line"></div>
<div class="line">                computeUVDifferentials(sg-&gt;Ng, sg-&gt;dPdx, sg-&gt;dPdy, sg-&gt;dPdu, sg-&gt;dPdv, sg-&gt;dudx, sg-&gt;dudy, sg-&gt;dvdx, sg-&gt;dvdy);</div>
<div class="line"></div>
<div class="line">                AtClosureList closureList = AiShaderEvalParamClosure(p_beauty);</div>
<div class="line">                AtRGB opacity = AiShaderEvalParamOpacity(p_opacity);</div>
<div class="line">                closureList.add(AiClosureTransparent(sg, AI_RGB_WHITE - opacity));</div>
<div class="line">                closureList *= opacity;</div>
<div class="line"></div>
<div class="line">                <span class="keywordflow">if</span> (IsTaggedAsGlass(sg) == <span class="keyword">true</span>)</div>
<div class="line">                {</div>
<div class="line">                    <span class="keywordflow">if</span> (PresenZ_data_struct::pass == <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#ae1c5184dc404edf057ed537bcfddef84a4fa71226841d5dc4359c2e48fa8a079e">PresenZ::Phase::Render_Reflection</a>)</div>
<div class="line">                    {</div>
<div class="line">                        AtScrSample sample;</div>
<div class="line">                        AtVector reflectionRay = AiReflect(originalRd, sg-&gt;Nf);</div>
<div class="line">                        AtRay ray = AiMakeRay(AI_RAY_CAMERA, sg-&gt;P, &amp;reflectionRay, AI_INFINITE, sg);</div>
<div class="line">                        AiTrace(ray, AI_RGB_WHITE, sample);</div>
<div class="line"></div>
<div class="line">                        AiAOVSetFlt(sg, Z_Refl_AtStr, sample.z);</div>
<div class="line">                        AtRGBA rgba = sample.color;</div>
<div class="line">                        rgba.a = sample.alpha;</div>
<div class="line">                        AiAOVSetRGBA(sg, RGBA_Refl_AtStr, rgba);</div>
<div class="line">                        AiAOVSetVec(sg, NHitPoint_Refl_AtStr, sample.point);</div>
<div class="line">                        sg-&gt;out.CLOSURE() = AiClosureMatte(sg);</div>
<div class="line">                        <span class="keywordflow">return</span>;</div>
<div class="line"></div>
<div class="line">                    }</div>
<div class="line">                    <span class="comment">// If we are tagged as glass, we are making the object transparent so our ray continue.</span></div>
<div class="line">                    <span class="comment">// We also tag the ray for further depth != camera.</span></div>
<div class="line">                    setGlassMaterialAOV(sg);</div>
<div class="line">                    AiStateSetMsgBool(przGlassAtStr, <span class="keyword">true</span>);</div>
<div class="line"></div>
<div class="line">                    <span class="keywordtype">bool</span> goThrough = <span class="keyword">false</span>;</div>
<div class="line">                    <span class="keyword">const</span> <span class="keywordtype">bool</span> shadeCurrentPoint = <a class="code" href="group___pz_shading_api.html#ga30c24504061fb1f4e216b32eced47caa">PresenZ::Shading::PzShouldShade</a>(NozPointFromAiPoint(sg-&gt;P), NozPointFromAiPoint(sg-&gt;Ns), originalx, originaly, goThrough);</div>
<div class="line">                    <span class="keywordflow">if</span> (!shadeCurrentPoint) {</div>
<div class="line">                        <span class="keywordflow">if</span> (goThrough)</div>
<div class="line">                            sg-&gt;out.CLOSURE() = AiClosureTransparent(sg);</div>
<div class="line">                        <span class="keywordflow">else</span></div>
<div class="line">                            sg-&gt;out.CLOSURE() = AiClosureMatte(sg);</div>
<div class="line">                        <span class="keywordflow">return</span>;</div>
<div class="line">                    }                   </div>
<div class="line">                    </div>
<div class="line">                    <span class="keywordflow">if</span> (goThrough){</div>
<div class="line">                        closureList.add(AiClosureTransparent(sg));</div>
<div class="line">                    }</div>
<div class="line">                    sg-&gt;out.CLOSURE() = closureList;</div>
<div class="line">                    <span class="keywordflow">return</span>;</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">else</span></div>
<div class="line">                {</div>
<div class="line">                    <span class="comment">// Normal evaluation</span></div>
<div class="line">                    sg-&gt;out.CLOSURE()= closureList;</div>
<div class="line">                    <span class="keywordflow">return</span>;</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (IsTaggedAsGlass(sg) == <span class="keyword">true</span>)</div>
<div class="line">            {</div>
<div class="line">                sg-&gt;out.CLOSURE() = AiClosureTransparent(sg);</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span></div>
<div class="line">                sg-&gt;out.CLOSURE() = AiClosureMatte(sg);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// Early out if it&#39;s not a camera ray.</span></div>
<div class="line">        <span class="keywordflow">if</span> (!(sg-&gt;Rt &amp; AI_RAY_CAMERA))</div>
<div class="line">            <span class="keywordflow">return</span>;</div>
<div class="line"></div>
<div class="line">        AiAOVSetInt(sg, pixelYStr, -1);</div>
<div class="line">        AiAOVSetInt(sg, pixelXStr, -1);</div>
<div class="line">        AiAOVSetInt(sg, detectTBestCamStr, -1);</div>
<div class="line">        <span class="keywordflow">if</span> (IsTaggedAsGlass(sg) == <span class="keyword">true</span>)</div>
<div class="line">        {</div>
<div class="line">            sg-&gt;out.CLOSURE() = AiClosureTransparent(sg, AI_RGB_50GREY);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">            sg-&gt;out.CLOSURE();</div>
<div class="line">    }</div>
<div class="line"><span class="keywordflow">return</span>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">node_initialize</div>
<div class="line">{</div>
<div class="line">    ShaderData *data = (ShaderData*)AiMalloc(<span class="keyword">sizeof</span>(ShaderData));</div>
<div class="line">    AiNodeSetLocalData(node, data);</div>
<div class="line"></div>
<div class="line">    AtNode* camera = AiUniverseGetCamera(AiNodeGetUniverse(node));</div>
<div class="line">    data-&gt;renderCamera = camera;</div>
<div class="line"><span class="preprocessor">#if AI_VERSION_ARCH_NUM &gt;= 7 &amp;&amp; AI_VERSION_MAJOR_NUM &gt;= 4</span></div>
<div class="line"><span class="preprocessor"></span>    AiNodeAddDependency(node, camera, renderingEyeStr);</div>
<div class="line">    AiNodeAddDependency(node, camera, stereoRightEyeStr);</div>
<div class="line">    AiNodeAddDependency(node, camera, renderIsolatedStr);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">    <a class="code" href="group___pz_app_logger.html#gad79dc53c351eeff13f901542c29f6e57">PZ_DEBUG</a>(<span class="stringliteral">&quot;node initialized&quot;</span>);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">node_update</div>
<div class="line">{</div>
<div class="line">    ShaderData *data = (ShaderData*)AiNodeGetLocalData(node);</div>
<div class="line">    AtNode* pzCamera = AiUniverseGetCamera(AiNodeGetUniverse(node));</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#if AI_VERSION_ARCH_NUM &gt;= 7 &amp;&amp; AI_VERSION_MAJOR_NUM &gt;= 4</span></div>
<div class="line"><span class="preprocessor"></span>    AiNodeClearDependency(node, data-&gt;renderCamera);</div>
<div class="line">    AiNodeAddDependency(node, pzCamera, renderingEyeStr);</div>
<div class="line">    AiNodeAddDependency(node, pzCamera, stereoRightEyeStr);</div>
<div class="line">    AiNodeAddDependency(node, pzCamera, renderIsolatedStr);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>    data-&gt;renderCamera = pzCamera;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (AiNodeIs(pzCamera, PresenzCameraName))</div>
<div class="line">    {</div>
<div class="line">        data-&gt;eye = AiNodeGetInt(pzCamera, renderingEyeStr) ? <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#a3104904c134a52357b85f763f6dfd48fac2b22af1f16cebd2cc909767c763a713">PresenZ::Phase::Eye::RC_Right</a> : <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#a3104904c134a52357b85f763f6dfd48fa4280d82f18d6dbafdeb68c811112455e">PresenZ::Phase::Eye::RC_Left</a>;</div>
<div class="line">        data-&gt;renderIsolated = AiNodeGetBool(pzCamera, renderIsolatedStr);</div>
<div class="line">        data-&gt;stereoRightEye = AiNodeGetInt(pzCamera, stereoRightEyeStr);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">        <a class="code" href="group___pz_app_logger.html#gafd8b815a0f76d6b121f44f62d5730ee4">PZ_ERROR</a>(<span class="stringliteral">&quot;[PresenZ] Could not find the PresenZ camera.&quot;</span>);</div>
<div class="line">    </div>
<div class="line">    <a class="code" href="group___pz_app_logger.html#gad79dc53c351eeff13f901542c29f6e57">PZ_DEBUG</a>(<span class="stringliteral">&quot;node updated&quot;</span>);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">node_finish</div>
<div class="line">{</div>
<div class="line">    ShaderData *data = (ShaderData*)AiNodeGetLocalData(node);</div>
<div class="line">    AiFree(data);</div>
<div class="line">}</div>
</div><!-- fragment --><h1>10.4 Filter</h1>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;ai.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &quot;arnoldWrapper.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;presenz_global_parameters.h&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="_pz_bucket_api_8h.html">API/PzBucketApi.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="_pz_render_sample_api_8h.html">API/PzRenderSampleApi.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="_pz_detect_sample_api_8h.html">API/PzDetectSampleApi.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="_pz_phase_api_8h.html">API/PzPhaseApi.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="_pz_cryptomatte_api_8h.html">API/PzCryptomatteApi.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="_pz_assert_8h.html">API/PzAssert.h</a>&quot;</span></div>
<div class="line"></div>
<div class="line">AI_FILTER_NODE_EXPORT_METHODS(PresenZFilterMethods);</div>
<div class="line"></div>
<div class="line"><span class="keyword">using namespace </span><a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#ae1c5184dc404edf057ed537bcfddef84">PresenZ::Phase</a>;</div>
<div class="line"><span class="keyword">using namespace </span>PresenZ::BinIO;</div>
<div class="line"><span class="keyword">using namespace </span>PresenZ::RenderSample;</div>
<div class="line"><span class="keyword">using namespace </span>PresenZ::Cryptomatte;</div>
<div class="line"></div>
<div class="line">node_parameters</div>
<div class="line">{</div>
<div class="line">    AiParameterFlt(<span class="stringliteral">&quot;width&quot;</span>, 1.0);</div>
<div class="line">    AiMetaDataSetStr(nentry, NULL, <span class="stringliteral">&quot;_synonym&quot;</span>, <span class="stringliteral">&quot;PresenZFilter&quot;</span>);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">node_initialize</div>
<div class="line">{</div>
<div class="line"></div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span>* necessary_aovs[] = { <span class="stringliteral">&quot;FLOAT Z&quot;</span>, <span class="keyword">nullptr</span>};</div>
<div class="line">    AiFilterInitialize(node, <span class="keyword">true</span>, necessary_aovs);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">node_finish</div>
<div class="line">{</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">node_update</div>
<div class="line">{</div>
<div class="line">    <span class="comment">//AiFilterUpdate(node, AiNodeGetFlt(node, &quot;width&quot;));</span></div>
<div class="line">    AiFilterUpdate(node, 1.0);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">filter_output_type</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span> AI_TYPE_POINTER;</div>
<div class="line"></div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> filter_detect(AtNode* node, AtAOVSampleIterator* iterator, <span class="keywordtype">void</span>* data_out, uint8_t data_type)</div>
<div class="line">{</div>
<div class="line">    AtString AOVFiltered = AiAOVSampleIteratorGetAOVName(iterator);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (AOVFiltered == detectPzStr) {</div>
<div class="line">        </div>
<div class="line">        FilterDataDetect* out_data = <span class="keyword">new</span> FilterDataDetect();</div>
<div class="line">        </div>
<div class="line">        <span class="keywordflow">while</span> (AiAOVSampleIteratorGetNext(iterator)) {</div>
<div class="line">            <span class="keywordflow">while</span> (AiAOVSampleIteratorGetNextDepth(iterator)) {</div>
<div class="line">                </div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">int</span> curDepth = AiAOVSampleIteratorGetDepth(iterator);</div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">bool</span> pzSample = AiAOVSampleIteratorGetAOVBool(iterator, detectPzStr);</div>
<div class="line">                <span class="keywordflow">if</span> (!pzSample)</div>
<div class="line">                    <span class="keywordflow">continue</span>;</div>
<div class="line"></div>
<div class="line">                <a class="code" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_save_data_structure.html">PresenZ::DetectSample::SaveDataStructure</a> info;</div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">int</span> bestCam = AiAOVSampleIteratorGetAOVInt(iterator, detectTBestCamStr);</div>
<div class="line">                <span class="comment">// We don&#39;t actually have a real value in that case.</span></div>
<div class="line">                <span class="keywordflow">if</span> (bestCam == -1)</div>
<div class="line">                    <span class="keywordflow">continue</span>;</div>
<div class="line">                info.<a class="code" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_save_data_structure.html#a1cdedf2e87044c140c64183314f9d522">bestCam</a> = bestCam;</div>
<div class="line">                info.<a class="code" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_save_data_structure.html#a9267c6b3eae71d461769e6ea6a8fe2c0">camera</a> = AiAOVSampleIteratorGetAOVInt(iterator, detectCameraStr);</div>
<div class="line">                info.<a class="code" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_save_data_structure.html#a2228d652eb39da15933e2b9345893951">expSize</a> = AiAOVSampleIteratorGetAOVInt(iterator, detectexpSizeStr);</div>
<div class="line">                info.<a class="code" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_save_data_structure.html#a8a33ba6ff4f3da7799e33a2827f9d297">isChaotic</a> = AiAOVSampleIteratorGetAOVBool(iterator, detectChaoticStr);</div>
<div class="line">                info.<a class="code" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_save_data_structure.html#ac66c2e837c24a5cd822b7b42ed61558d">isDraft</a> = AiAOVSampleIteratorGetAOVBool(iterator, detectDraftStr);</div>
<div class="line">                info.<a class="code" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_save_data_structure.html#a97876727134fadec3c9fc1dd3e6fbaff">isEstimated</a> = AiAOVSampleIteratorGetAOVBool(iterator, detectEstimatedStr);</div>
<div class="line">                info.<a class="code" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_save_data_structure.html#a6ada42ea3d29a108ebf63a249a02d0fb">isVolumetric</a> = AiAOVSampleIteratorGetAOVBool(iterator, detectVolumetricStr);</div>
<div class="line">                info.<a class="code" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_save_data_structure.html#ad50b77be6452fcd203fa25771dd4f69e">isHair</a> = AiAOVSampleIteratorGetAOVBool(iterator, detectHairStr);</div>
<div class="line">                info.<a class="code" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_save_data_structure.html#a1a4f15d1f73a8a725318a64a4303630c">maxZ</a> = AiAOVSampleIteratorGetAOVFlt(iterator, detectTmaxZStr);</div>
<div class="line">                info.<a class="code" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_save_data_structure.html#a10783e24924a7160fed76c3a48530298">minZ</a> = AiAOVSampleIteratorGetAOVFlt(iterator, detectTminZStr);</div>
<div class="line">                info.<a class="code" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_save_data_structure.html#afdddd54644ca7c73b3d22f7b2d206ca8">normal</a> = NozVectorFromAiVector(AiAOVSampleIteratorGetAOVVec(iterator, detectTNormalStr));</div>
<div class="line">                info.<a class="code" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_save_data_structure.html#ac132759c29737e9daf6c071e2d49db6b">transpType</a> = AiAOVSampleIteratorGetAOVInt(iterator, detectTranspTypeStr);</div>
<div class="line">                info.<a class="code" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_save_data_structure.html#af73583b1e980b0aa03f9884812e9fd4d">z</a> = AiAOVSampleIteratorGetAOVFlt(iterator, detectZStr);</div>
<div class="line">                info.<a class="code" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_save_data_structure.html#a75f8ddf992db0cfc3cd1aa024086b6f3">pixelX</a> = AiAOVSampleIteratorGetAOVInt(iterator, pixelXStr);</div>
<div class="line">                info.<a class="code" href="struct_presen_z_1_1_detect_sample_1_1v4__1_1_1_save_data_structure.html#aaa0423628e784003c3f5754ca1e56e70">pixelY</a> = AiAOVSampleIteratorGetAOVInt(iterator, pixelYStr);</div>
<div class="line">                out_data-&gt;data.push_back(info);</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">        *((<span class="keywordtype">void</span>**)data_out) = (<span class="keywordtype">void</span>*)out_data;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> filter_render(AtNode* node, AtAOVSampleIterator* iterator, <span class="keywordtype">void</span>* data_out, uint8_t data_type)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">const</span> AtUniverse* universe = AiNodeGetUniverse(node);</div>
<div class="line">    <span class="keyword">const</span> AtNode* pzCamera = AiUniverseGetCamera(universe);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">float</span> far_clip = AiNodeGetFlt(pzCamera, farClipStr);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">float</span> scene_scale = AiNodeGetFlt(pzCamera, presenzSceneScaleStr);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">float</span> max_distance = far_clip - (0.1f * scene_scale);</div>
<div class="line"></div>
<div class="line">    </div>
<div class="line">    AtString AOVFiltered = AiAOVSampleIteratorGetAOVName(iterator);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (AOVFiltered == RGBAAtStr) {</div>
<div class="line"></div>
<div class="line">        FilterData* out_data = <span class="keyword">new</span> FilterData();</div>
<div class="line"></div>
<div class="line">        <span class="keywordtype">float</span> lastTransmission = 1.0f;</div>
<div class="line">        <span class="keywordtype">int</span> lastDepth = -1;</div>
<div class="line"></div>
<div class="line">        <span class="keywordtype">int</span> x, y;</div>
<div class="line">        AiAOVSampleIteratorGetPixel(iterator, x, y);</div>
<div class="line"></div>
<div class="line">        std::vector&lt;PzRenderSample&gt; renderSamples;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">while</span> (AiAOVSampleIteratorGetNext(iterator)) {</div>
<div class="line">            <span class="keyword">const</span> AtVector2 offset = AiAOVSampleIteratorGetOffset(iterator);</div>
<div class="line">            <span class="keywordflow">while</span> (AiAOVSampleIteratorGetNextDepth(iterator)) {</div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">int</span> curDepth = AiAOVSampleIteratorGetDepth(iterator);</div>
<div class="line">                <span class="comment">// Depth 0, we reset the transmission.</span></div>
<div class="line">                <span class="keywordflow">if</span> (curDepth == 0) {</div>
<div class="line">                    lastTransmission = 1.0f;</div>
<div class="line">                    lastDepth = -1;</div>
<div class="line">                }</div>
<div class="line"></div>
<div class="line">                AtRGBA <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#add16db84a471b163119fa85bfa9df0fdae75845ff0980839032f4a78a0d42753c">RGBA</a> = AiAOVSampleIteratorGetRGBA(iterator);</div>
<div class="line">                <span class="comment">// Getting all our other data</span></div>
<div class="line">                <span class="keyword">const</span> AtVector P = AiAOVSampleIteratorGetAOVVec(iterator, NHitPointAtStr);</div>
<div class="line">                <span class="keyword">const</span> AtVector N = AiAOVSampleIteratorGetAOVVec(iterator, NCameraAtStr);</div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">float</span> distance = AiAOVSampleIteratorGetAOVFlt(iterator, ZAtStr);</div>
<div class="line"></div>
<div class="line">                <a class="code" href="struct_presen_z_1_1_render_sample_1_1v4__1_1_1_pz_render_sample.html">PzRenderSample</a> winSample;</div>
<div class="line"></div>
<div class="line">                <a class="code" href="group___render_sample.html#ga513c491eb60b3521e27c2c4afafc24d1">PzSetSamplePosition</a>(winSample, NozVectorFromAiVector(P));</div>
<div class="line">                <a class="code" href="group___render_sample.html#ga74fae5c164e1062e86f0d1e817dc6b9f">PzSetSampleNormal</a>(winSample, NozVectorFromAiVector(N));</div>
<div class="line">                <a class="code" href="group___render_sample.html#ga095b5f3425c28e9f1f8006f0f45e8522">PzSetSampleZ</a>(winSample, distance);</div>
<div class="line">                <a class="code" href="group___render_sample.html#ga0ad36a0e7be7c5769ba026b657cb8838">PzSetSamplePosXY</a>(winSample, offset.x + 0.5f, offset.y + 0.5f);</div>
<div class="line">                <a class="code" href="group___render_sample.html#ga4387ead5499974ea69d4ea1dec9d906c">PzSetSampleDepth</a>(winSample, curDepth);</div>
<div class="line"></div>
<div class="line">                <span class="keywordflow">if</span> (PresenZ_data_struct::do_crypto) {</div>
<div class="line">                    <span class="keywordtype">bool</span> do_object, do_material, do_asset = <span class="keyword">false</span>;</div>
<div class="line">                    <a class="code" href="namespace_presen_z_1_1_cryptomatte_1_1v4__1.html#afcbb0d852c28f6a7c339c2ea4cf9e88d">PzGetActiveCryptomatte</a>(do_object, do_material, do_asset);</div>
<div class="line">                    <span class="keywordflow">if</span> (do_object)</div>
<div class="line">                        <a class="code" href="namespace_presen_z_1_1_cryptomatte_1_1v4__1.html#a74463c227a86d3e9300d3262f6310d1f">PzSetSampleCrypto</a>(winSample, <a class="code" href="namespace_presen_z_1_1_cryptomatte_1_1v4__1.html#a7a7eaab162f0d2b949603d600f496164acf7088fae10ac1c888296c6abe135276">cryptoType::object</a>, AiAOVSampleIteratorGetAOVFlt(iterator, crypto_objectAOVStr));</div>
<div class="line">                    <span class="keywordflow">if</span> (do_material)</div>
<div class="line">                        <a class="code" href="namespace_presen_z_1_1_cryptomatte_1_1v4__1.html#a74463c227a86d3e9300d3262f6310d1f">PzSetSampleCrypto</a>(winSample, <a class="code" href="namespace_presen_z_1_1_cryptomatte_1_1v4__1.html#a7a7eaab162f0d2b949603d600f496164a8b9fc0d9cd2b57d3a07272fe50d80edc">cryptoType::material</a>, AiAOVSampleIteratorGetAOVFlt(iterator, crypto_materialAOVStr));</div>
<div class="line">                    <span class="keywordflow">if</span> (do_asset)</div>
<div class="line">                        <a class="code" href="namespace_presen_z_1_1_cryptomatte_1_1v4__1.html#a74463c227a86d3e9300d3262f6310d1f">PzSetSampleCrypto</a>(winSample, <a class="code" href="namespace_presen_z_1_1_cryptomatte_1_1v4__1.html#a7a7eaab162f0d2b949603d600f496164a3b01a9554831a27f47d6e6c53c7ad49e">cryptoType::asset</a>, AiAOVSampleIteratorGetAOVFlt(iterator, crypto_assetAOVStr));</div>
<div class="line">                }</div>
<div class="line"></div>
<div class="line">                <span class="keywordtype">bool</span> isGlass = AiAOVSampleIteratorGetAOVBool(iterator, przGlassAtStr);</div>
<div class="line">                <span class="keywordflow">if</span> (isGlass) {</div>
<div class="line">                    <span class="keyword">const</span> AtRGB transmission = AiAOVSampleIteratorGetAOVRGB(iterator, transmissionAOV);</div>
<div class="line">                    <span class="keyword">const</span> <span class="keywordtype">float</span> transmissionAlbedo = (transmission.r + transmission.g + transmission.b) / 3.0f;</div>
<div class="line"></div>
<div class="line">                    <span class="keywordflow">if</span> (transmissionAlbedo != 0.0f) {</div>
<div class="line">                        RGBA = AiAOVSampleIteratorGetAOVRGBA(iterator, glassRGBOVStr);</div>
<div class="line">                        <span class="keywordtype">float</span> curTransmission = 1.0f - transmissionAlbedo;</div>
<div class="line">                        <span class="keywordflow">if</span> (curDepth &gt; lastDepth) {</div>
<div class="line">                            curTransmission *= lastTransmission;</div>
<div class="line">                            lastDepth = curDepth;</div>
<div class="line">                            lastTransmission = curTransmission;</div>
<div class="line">                        }</div>
<div class="line">                        RGBA.a = curTransmission;</div>
<div class="line">                        <a class="code" href="group___render_sample.html#ga78042b8eb4c9e35175724d732347b2d3">PzAddGlassSampleAov</a>(winSample, 1);</div>
<div class="line">                    }</div>
<div class="line">                    <span class="keywordflow">else</span></div>
<div class="line">                        <a class="code" href="group___render_sample.html#ga78042b8eb4c9e35175724d732347b2d3">PzAddGlassSampleAov</a>(winSample, 0);</div>
<div class="line"></div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">else</span></div>
<div class="line">                    <a class="code" href="group___render_sample.html#ga78042b8eb4c9e35175724d732347b2d3">PzAddGlassSampleAov</a>(winSample, 0);</div>
<div class="line"></div>
<div class="line">                <a class="code" href="group___render_sample.html#ga43ca0aee99f6bc7d10dee89afe74d3d1">PzSetSampleColor</a>(winSample, NozRGBAFromAiRGBA(RGBA));</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line">                <span class="keywordflow">if</span> (AiAOVSampleIteratorHasAOVValue(iterator, velocityAtStr, AI_TYPE_VECTOR))</div>
<div class="line">                    <a class="code" href="group___render_sample.html#ga9dcdb7e6308d49f31183dc08c0f77155">PzAddVelocitySampleAov</a>(winSample, NozVectorFromAiVector(AiAOVSampleIteratorGetAOVVec(iterator, velocityAtStr)));</div>
<div class="line"></div>
<div class="line">                <span class="comment">// Matte objects</span></div>
<div class="line">                <span class="keywordflow">if</span>(distance == 0.0f)</div>
<div class="line">                    <a class="code" href="group___render_sample.html#ga095b5f3425c28e9f1f8006f0f45e8522">PzSetSampleZ</a>(winSample, <a class="code" href="constant_8h.html#a22dd49f4a5b95f2951748a7bef17d100">NOZ_INFINITE</a>);</div>
<div class="line">                <span class="comment">// Fixing dome/max clip plane samples</span></div>
<div class="line">                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (distance &gt;= max_distance) { <span class="comment">//Hit the skydome sphere, need to recompute hitpoint and normal with virtual sphere around ZOV</span></div>
<div class="line">                    <span class="keywordflow">if</span>(RGBA.a == 0.0) {</div>
<div class="line">                        <span class="comment">// Alpha at 0 = We hit nothing. We set the sample as a background one.</span></div>
<div class="line">                        <a class="code" href="group___render_sample.html#ga095b5f3425c28e9f1f8006f0f45e8522">PzSetSampleZ</a>(winSample, <a class="code" href="constant_8h.html#a22dd49f4a5b95f2951748a7bef17d100">NOZ_INFINITE</a>);</div>
<div class="line">                    } <span class="keywordflow">else</span> {</div>
<div class="line">                        <a class="code" href="struct_noz_point.html">NozPoint</a> camPos = <a class="code" href="group___pz_phase_api.html#ga1069325bd956cd5801b61d46b29a69cb">PresenZ::Phase::PzGetZOVWorldPosition</a>();</div>
<div class="line">                        <a class="code" href="struct_noz_point.html">NozVector</a> rayDir(NozVectorFromAiVector(AiAOVSampleIteratorGetAOVVec(iterator, rayDirAOVStr)));</div>
<div class="line">                        <span class="keywordflow">if</span>(<a class="code" href="group___n_o_z__vector.html#ga145b6f75c1c66f24c8c4ab97f9564a55">NozVecLength</a>(rayDir) != 0) {</div>
<div class="line">                            <a class="code" href="struct_noz_point.html">NozVector</a> rayOrigin(NozVectorFromAiVector(AiAOVSampleIteratorGetAOVVec(iterator, rayOrigAOVStr)));</div>
<div class="line">                            std::vector&lt;float&gt; distances = hit_sphere(camPos, max_distance, rayDir, rayOrigin);</div>
<div class="line">                            <a class="code" href="group___render_sample.html#ga513c491eb60b3521e27c2c4afafc24d1">PzSetSamplePosition</a>(winSample, rayOrigin + (rayDir * distances[0]));</div>
<div class="line">                            <a class="code" href="group___render_sample.html#ga74fae5c164e1062e86f0d1e817dc6b9f">PzSetSampleNormal</a>(winSample, -rayDir);</div>
<div class="line">                            <a class="code" href="group___render_sample.html#ga095b5f3425c28e9f1f8006f0f45e8522">PzSetSampleZ</a>(winSample, distances[0]);</div>
<div class="line">                        }</div>
<div class="line">                    }</div>
<div class="line">                }</div>
<div class="line"></div>
<div class="line">                <span class="keywordtype">size_t</span> numAovs = <a class="code" href="group___pz_phase_api.html#gaa7b6d437173e92effc4a08fb7ebbdf43">PzRenderPhaseGetNumAov</a>();</div>
<div class="line">                <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; numAovs; ++i) {</div>
<div class="line">                    std::string name;</div>
<div class="line">                    <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#add16db84a471b163119fa85bfa9df0fd">PresenZ::Phase::AOVType</a> type;</div>
<div class="line">                    <a class="code" href="group___pz_phase_api.html#gadb804df437a12e5bc79445c09d725b32">PzGetAOVInfo</a>(i, name, type);</div>
<div class="line"></div>
<div class="line">                    AtString AOVname(name.c_str());</div>
<div class="line">                    <span class="keywordflow">if</span> (AOVname != przvelocityAtStr &amp;&amp; AOVname != presenzStr) {</div>
<div class="line">                        <span class="keywordflow">switch</span> (type) {</div>
<div class="line">                            <span class="keywordflow">case</span> <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#add16db84a471b163119fa85bfa9df0fdafd5a5f51ce25953f3db2c7e93eb7864a">PresenZ::Phase::AOVType::INT</a>: {</div>
<div class="line">                                <span class="keyword">auto</span> value = AiAOVSampleIteratorGetAOVInt(iterator, AOVname);</div>
<div class="line">                                <a class="code" href="group___render_sample.html#ga6175896d26440519e390e174695648fd">PzAddSampleAov</a>(winSample, (<span class="keywordtype">void</span>*)&amp;value, name); <span class="keywordflow">break</span>;</div>
<div class="line">                            }</div>
<div class="line">                            <span class="keywordflow">case</span> <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#add16db84a471b163119fa85bfa9df0fdae663dbb8f8244e122acb5bd6b2c216e1">PresenZ::Phase::AOVType::BOOL</a>: {</div>
<div class="line">                                <span class="keyword">auto</span> value = AiAOVSampleIteratorGetAOVBool(iterator, AOVname);</div>
<div class="line">                                <a class="code" href="group___render_sample.html#ga6175896d26440519e390e174695648fd">PzAddSampleAov</a>(winSample, (<span class="keywordtype">void</span>*)&amp;value, name); <span class="keywordflow">break</span>;</div>
<div class="line">                            }</div>
<div class="line">                            <span class="keywordflow">case</span> <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#add16db84a471b163119fa85bfa9df0fda9cf4a0866224b0bb4a7a895da27c9c4c">PresenZ::Phase::AOVType::FLOAT</a>: {</div>
<div class="line">                                <span class="keyword">auto</span> value = AiAOVSampleIteratorGetAOVFlt(iterator, AOVname);</div>
<div class="line">                                <a class="code" href="group___render_sample.html#ga6175896d26440519e390e174695648fd">PzAddSampleAov</a>(winSample, (<span class="keywordtype">void</span>*)&amp;value, name); <span class="keywordflow">break</span>;</div>
<div class="line">                            }</div>
<div class="line">                            <span class="keywordflow">case</span> <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#add16db84a471b163119fa85bfa9df0fda30447e9f6efa4afdd251f9afc1d5fb44">PresenZ::Phase::AOVType::RGB</a>: {</div>
<div class="line">                                <span class="keyword">auto</span> value = AiAOVSampleIteratorGetAOVRGB(iterator, AOVname);</div>
<div class="line">                                <a class="code" href="group___render_sample.html#ga6175896d26440519e390e174695648fd">PzAddSampleAov</a>(winSample, (<span class="keywordtype">void</span>*)&amp;value, name); <span class="keywordflow">break</span>;</div>
<div class="line">                            }</div>
<div class="line">                            <span class="keywordflow">case</span> <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#add16db84a471b163119fa85bfa9df0fdae75845ff0980839032f4a78a0d42753c">PresenZ::Phase::AOVType::RGBA</a>: {</div>
<div class="line">                                <span class="keyword">auto</span> value = AiAOVSampleIteratorGetAOVRGBA(iterator, AOVname);</div>
<div class="line">                                <a class="code" href="group___render_sample.html#ga6175896d26440519e390e174695648fd">PzAddSampleAov</a>(winSample, (<span class="keywordtype">void</span>*)&amp;value, name); <span class="keywordflow">break</span>;</div>
<div class="line">                            }</div>
<div class="line">                            <span class="keywordflow">case</span> <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#add16db84a471b163119fa85bfa9df0fdacff9b70db3f47a019c78e266909da55c">PresenZ::Phase::AOVType::VEC</a>: {</div>
<div class="line">                                <span class="keyword">auto</span> value = AiAOVSampleIteratorGetAOVVec(iterator, AOVname);</div>
<div class="line">                                <a class="code" href="group___render_sample.html#ga6175896d26440519e390e174695648fd">PzAddSampleAov</a>(winSample, (<span class="keywordtype">void</span>*)&amp;value, name); <span class="keywordflow">break</span>;</div>
<div class="line">                            }</div>
<div class="line">                            <span class="keywordflow">case</span> <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#add16db84a471b163119fa85bfa9df0fdab77decd1c62766213f0df1b81b3e9647">PresenZ::Phase::AOVType::VEC2</a>: {</div>
<div class="line">                                <span class="keyword">auto</span> value = AiAOVSampleIteratorGetAOVVec2(iterator, AOVname);</div>
<div class="line">                                <a class="code" href="group___render_sample.html#ga6175896d26440519e390e174695648fd">PzAddSampleAov</a>(winSample, (<span class="keywordtype">void</span>*)&amp;value, name); <span class="keywordflow">break</span>;</div>
<div class="line">                            }</div>
<div class="line">                        }</div>
<div class="line">                    }</div>
<div class="line">                }</div>
<div class="line">                renderSamples.push_back(winSample);</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">if</span> (renderSamples.empty() == <span class="keyword">false</span>)</div>
<div class="line">        {</div>
<div class="line">            <a class="code" href="group___render_sample.html#gab163484eff81e8c9a96a0f87945a7550">PzSetSamplesCount</a>(x, y, (<span class="keywordtype">int</span>)renderSamples.size());</div>
<div class="line">            <a class="code" href="group___render_sample.html#gaa3d16ec6e9ff16626ed6005e1064987d">PzFilterRenderSample</a>(x, y, renderSamples, out_data-&gt;data);</div>
<div class="line">        }</div>
<div class="line">    </div>
<div class="line">        *((<span class="keywordtype">void</span>**)data_out) = (<span class="keywordtype">void</span>*)out_data;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">filter_pixel</div>
<div class="line">{</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (PresenZ_data_struct::pass == <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#ae1c5184dc404edf057ed537bcfddef84a48a95ceab76284afa466622424eba555">PresenZ::Phase::Detect</a> || PresenZ_data_struct::pass == <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#ae1c5184dc404edf057ed537bcfddef84a9e72290cbba5243f4449f84168a3c99c">PresenZ::Phase::Detect_Reflection</a>)</div>
<div class="line">        filter_detect(node, iterator, data_out, data_type);</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (PresenZ_data_struct::pass == <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#ae1c5184dc404edf057ed537bcfddef84ac677a954de25220db675695edacb4f71">PresenZ::Phase::Render</a> || PresenZ_data_struct::pass == <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#ae1c5184dc404edf057ed537bcfddef84a4fa71226841d5dc4359c2e48fa8a079e">PresenZ::Phase::Render_Reflection</a>)</div>
<div class="line">        filter_render(node, iterator, data_out, data_type);</div>
<div class="line"></div>
<div class="line">}</div>
</div><!-- fragment --><h1>10.5 Driver</h1>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;ai.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &quot;arnoldWrapper.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;presenz_global_parameters.h&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="_pz_bucket_api_8h.html">API/PzBucketApi.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="_pz_render_sample_api_8h.html">API/PzRenderSampleApi.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="_pz_detect_sample_api_8h.html">API/PzDetectSampleApi.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="_pz_phase_api_8h.html">API/PzPhaseApi.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="_pz_camera_api_8h.html">API/PzCameraApi.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="_pz_cryptomatte_api_8h.html">API/PzCryptomatteApi.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="_pz_assert_8h.html">API/PzAssert.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &lt;map&gt;</span></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keyword">using namespace </span><a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#ae1c5184dc404edf057ed537bcfddef84">PresenZ::Phase</a>;</div>
<div class="line"><span class="keyword">using namespace </span>PresenZ::BinIO;</div>
<div class="line"><span class="keyword">using namespace </span>PresenZ::RenderSample;</div>
<div class="line"><span class="keyword">using namespace </span><a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#ab11a1dda34491acff014ddfc9e6bafb8a72159b99f162eb7444ea0810dcce4442">PresenZ::Camera</a>;</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">// Invoke all the PresenZ parameters that are related to the Camera</span></div>
<div class="line"><span class="keywordtype">void</span> initPresenZCameraParameters(<span class="keyword">const</span> AtNode* pzCamera, <span class="keyword">const</span> <span class="keywordtype">int</span> renderTargetResX, <span class="keyword">const</span> <span class="keywordtype">int</span> renderTargetResY, <span class="keyword">const</span> <span class="keywordtype">float</span> ipd)</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="group___pz_phase_api.html#ga435a401cdf44485eeaaecf8ede1cdb87">PzSetOutputResolution</a>(renderTargetResX, renderTargetResY);</div>
<div class="line"></div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">int</span> renderEye = AiNodeGetInt(pzCamera, renderingEyeStr);</div>
<div class="line">    <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#a3104904c134a52357b85f763f6dfd48f">PresenZ::Phase::Eye</a> eye = <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#a3104904c134a52357b85f763f6dfd48faa1703c467e4e95c2a7194aabb4db866f">PresenZ::Phase::Eye::RC_LeftAndRight</a>;</div>
<div class="line">    <span class="keywordflow">if</span> (renderEye == 0) { eye = <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#a3104904c134a52357b85f763f6dfd48fa4280d82f18d6dbafdeb68c811112455e">PresenZ::Phase::Eye::RC_Left</a>; }</div>
<div class="line">    <span class="keywordflow">if</span> (renderEye == 1) { eye = <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#a3104904c134a52357b85f763f6dfd48fac2b22af1f16cebd2cc909767c763a713">PresenZ::Phase::Eye::RC_Right</a>; }</div>
<div class="line"></div>
<div class="line">    <a class="code" href="group___pz_phase_api.html#ga7d4690051e4e84fe33b6dad6a2adc4ab">PzSetDeepReflection</a>(eye, ipd);</div>
<div class="line"></div>
<div class="line">    <a class="code" href="group___pz_phase_api.html#ga0d447a6018f571c38e0ab90cbe8a3c8a">PzSetDistanceToGround</a>(AiNodeGetFlt(pzCamera, distanceToGroundStr));</div>
<div class="line">    <a class="code" href="group___pz_phase_api.html#gac3ec6dabe09a411b714e08a2632cbbf6">PzSetSpecularPointOffset</a>(NozPointFromAiPoint(AiNodeGetVec(pzCamera, specularPointOffsetStr)));</div>
<div class="line"></div>
<div class="line">    <span class="keyword">const</span> AtVector viewscale = AiNodeGetVec(pzCamera, viewScaleStr);</div>
<div class="line">    <a class="code" href="group___pz_phase_api.html#ga52ed59c08e674a5c062e93344ebe8149">PzSetZovScaling</a>(viewscale.x, viewscale.y, viewscale.z);</div>
<div class="line"></div>
<div class="line">    <a class="code" href="group___pz_phase_api.html#ga0c087994fa7b618933e2510115ede4ed">PzSetZovOffset</a>(AiNodeGetInt(pzCamera, multiboxOffsetRightStr), AiNodeGetInt(pzCamera, multiboxOffsetTopStr), AiNodeGetInt(pzCamera, multiboxOffsetBackStr));</div>
<div class="line"></div>
<div class="line">    AtMatrix AtCamToWorldMat4;</div>
<div class="line">    AiCameraToWorldMatrix(pzCamera, 0.5, AtCamToWorldMat4);</div>
<div class="line"></div>
<div class="line">    <a class="code" href="matrix_8h.html#a15eb5c4da255c65c60623dc95ca45bc1">NozMatrix</a> worldToCam;</div>
<div class="line">    AtMatrixToNozMatrix(AtCamToWorldMat4, worldToCam);</div>
<div class="line">    <a class="code" href="group___pz_phase_api.html#ga6fdb64e09afd9af1064e43d2a381a600">PzSetCameraToWorldMatrix</a>(worldToCam);</div>
<div class="line"></div>
<div class="line">    <a class="code" href="group___pz_phase_api.html#ga7d2cf07fb8e12112ccdfd3becf574ff2">PzSetClippingSphere</a>(AiNodeGetBool(pzCamera, clippingEnableStr),</div>
<div class="line">        <a class="code" href="group___n_o_z__vector.html#ga347d85f3e636cf273a47949aa0613a8f">NozVector</a>(AiNodeGetVec(pzCamera, clippingPositionStr).x, AiNodeGetVec(pzCamera, clippingPositionStr).y, AiNodeGetVec(pzCamera, clippingPositionStr).z),</div>
<div class="line">        AiNodeGetFlt(pzCamera, clippingRadiusStr), !AiNodeGetBool(pzCamera, clippingOutsideStr));</div>
<div class="line"></div>
<div class="line">    <a class="code" href="group___pz_phase_api.html#ga128464f4aeae7d92658cc8a90a9e7468">PzSetRenderInsideBox</a>(AiNodeGetInt(pzCamera, renderInsideZOVStr));</div>
<div class="line"></div>
<div class="line">    <a class="code" href="group___pz_phase_api.html#gaf565f25f51932827fb667abf05772025">PzSetFroxtrum</a>(AiNodeGetBool(pzCamera, enableFroxtrumStr));</div>
<div class="line">    <a class="code" href="group___pz_phase_api.html#ga545875cf46f09ac2da8b69d2fbeadd03">PzSetFroxtrumDepth</a>(AiNodeGetInt(pzCamera, froxtrumDepthStr));</div>
<div class="line">    <a class="code" href="group___pz_phase_api.html#gaa7292ded4c4c7d5a6f720192f409bb74">PzSetVolumeDepth</a>(AiNodeGetInt(pzCamera, volumeDepthStr));</div>
<div class="line"></div>
<div class="line">    <span class="keyword">const</span> AtString windowShapesFile = AiNodeGetStr(pzCamera, windowShapesFileStr);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">int</span> windowShapeIndex = AiNodeGetInt(pzCamera, windowShapeIndexStr);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">float</span> minDistToScreen = AiNodeGetFlt(pzCamera, minDistToScreenStr);</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">if</span> (windowShapesFile.length() != 0 ){</div>
<div class="line">        <a class="code" href="group___pz_phase_api.html#gafe1e53d2524523eb9c798066d08090b1">PzSetWindowShapesFile</a>(windowShapesFile.c_str(), windowShapeIndex);</div>
<div class="line">        <a class="code" href="group___pz_phase_api.html#gab22d03a8358147d17bec2ea91fb10e9d">PzSetDetectionMinimumDistance</a>(minDistToScreen);</div>
<div class="line">        <a class="code" href="group___pz_app_logger.html#gaf8ab3f1606906a93b3081de7f0cb7be1">PZ_INFO</a>(<span class="stringliteral">&quot;[PresenZ] Set the minimum distance of detection to %f cm for window shape rendering\n&quot;</span>, minDistToScreen);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Forward all the parameters from Arnold to PresenZ.</span></div>
<div class="line"><span class="keywordtype">bool</span> initPresenZ(AtNode *node)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">const</span> AtUniverse* universe = AiNodeGetUniverse(node);</div>
<div class="line">    <span class="keyword">const</span> AtNode* pzCamera = AiUniverseGetCamera(universe);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (AiNodeIs(pzCamera, PresenzCameraName) == <span class="keyword">false</span>)</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="group___pz_app_logger.html#ga57e4c432a80f1ffc8de1a41a42ac07d0">PZ_WARNING</a>(<span class="stringliteral">&quot;[PresenZ] Could not find the PresenZ camera.&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">    }</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">int</span> pass = AiNodeGetInt(node, passStr);</div>
<div class="line">    PresenZ_data_struct::pass = pass;</div>
<div class="line"></div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">int</span> renderEye = AiNodeGetInt(pzCamera, renderingEyeStr);</div>
<div class="line">    <span class="keyword">const</span> AtNode *universeOptions = AiRenderSessionGetOptions(AiUniverseGetRenderSession(universe));</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (pass == <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#ae1c5184dc404edf057ed537bcfddef84a48a95ceab76284afa466622424eba555">Detect</a> || pass == <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#ae1c5184dc404edf057ed537bcfddef84a9e72290cbba5243f4449f84168a3c99c">Detect_Reflection</a>)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">if</span> (AiNodeGetInt(universeOptions, AASamplesStr) != 16)</div>
<div class="line">            <a class="code" href="group___pz_app_logger.html#gafd8b815a0f76d6b121f44f62d5730ee4">PZ_ERROR</a>(<span class="stringliteral">&quot;Detection phase requires 16 AA_Samples&quot;</span>);</div>
<div class="line">        <span class="keywordflow">if</span> (AiNodeGetBool(universeOptions, enableAdaptiveSamplingStr) == <span class="keyword">true</span>)</div>
<div class="line">            <a class="code" href="group___pz_app_logger.html#gafd8b815a0f76d6b121f44f62d5730ee4">PZ_ERROR</a>(<span class="stringliteral">&quot;Detection phase requires adaptative sampling disabled.&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (AiNodeGetFlt(universeOptions, pixelAspectRatioStr) != 1.0f)</div>
<div class="line">        <a class="code" href="group___pz_app_logger.html#gafd8b815a0f76d6b121f44f62d5730ee4">PZ_ERROR</a>(<span class="stringliteral">&quot;Device aspect ratio is not 1.0&quot;</span>);</div>
<div class="line"></div>
<div class="line">    <a class="code" href="group___pz_phase_api.html#ga9f46fddf7c200938291feccff5e51871">PzInitPhase</a>((<a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#ae1c5184dc404edf057ed537bcfddef84">Phase</a>)pass, PresenZ::Util::RenderingEngineId::ARNOLD);</div>
<div class="line"></div>
<div class="line">    <a class="code" href="group___pz_phase_api.html#ga85471c4c328153c385d909635c5a27c9">PzSetRenderTransparencyMode</a>(<a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#a36a74ae11377f0edba8dcb5070390a4d">PresenZ::Phase::TransparencyRenderingType</a>(<a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#a36a74ae11377f0edba8dcb5070390a4daf1fb663f950f6e485ca1a18bf9d3f2ee">PresenZ::Phase::TransparencyRenderingType::PRZ_BOTH</a>));</div>
<div class="line">    PresenZ_data_struct::glass_pass_mode = <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#a36a74ae11377f0edba8dcb5070390a4daf1fb663f950f6e485ca1a18bf9d3f2ee">PresenZ::Phase::TransparencyRenderingType::PRZ_BOTH</a>;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (pass == <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#ae1c5184dc404edf057ed537bcfddef84ac677a954de25220db675695edacb4f71">Render</a> || pass == <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#ae1c5184dc404edf057ed537bcfddef84a4fa71226841d5dc4359c2e48fa8a079e">Render_Reflection</a>)</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="group___pz_phase_api.html#ga0b2fad483fa3b61bcc47b5ad52093978">PzSetExternalCounter</a>(<span class="keyword">true</span>);</div>
<div class="line">        registerAdditionalAOVs(node);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">    <a class="code" href="group___pz_phase_api.html#gaa60c2415614ae8b3274a97c62a20ea5a">PzSetDetectionSaveguard</a>(8.0, <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#ad9f2e08d4f565bc8e1d21ceb48f50a72ae31eaee77988d5953bff8791498e4cbd">DSG_disabled</a>);</div>
<div class="line">    <span class="comment">// Arnold is thread safe when writing files.</span></div>
<div class="line">    <a class="code" href="group___pz_phase_api.html#ga344093f1309e2682049528699090c8cc">PzSetOutputThreadSafety</a>(<span class="keyword">false</span>);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (pass == <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#ae1c5184dc404edf057ed537bcfddef84a48a95ceab76284afa466622424eba555">Detect</a> || pass == <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#ae1c5184dc404edf057ed537bcfddef84a9e72290cbba5243f4449f84168a3c99c">Detect_Reflection</a>) {</div>
<div class="line">        <a class="code" href="group___pz_phase_api.html#gafc2d23746daa3b771bdbc3716bc5e5d9">PzSetPresenZBucket</a>(<span class="keyword">true</span>);</div>
<div class="line">        <a class="code" href="group___pz_phase_api.html#ga8f09a0e12853598d3b9dffa13b7227e2">PzSetThreadNumber</a>(AiNodeGetInt(universeOptions, threadsStr));</div>
<div class="line"></div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> {</div>
<div class="line">        <a class="code" href="group___pz_phase_api.html#gafc2d23746daa3b771bdbc3716bc5e5d9">PzSetPresenZBucket</a>(<span class="keyword">false</span>);</div>
<div class="line">        <a class="code" href="group___pz_phase_api.html#ga8f09a0e12853598d3b9dffa13b7227e2">PzSetThreadNumber</a>(0);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">    <a class="code" href="group___pz_phase_api.html#ga9c08742cc79fe9fbccf230ebb883a358">PzSetCameraUpVector</a>(<a class="code" href="group___n_o_z__vector.html#ga347d85f3e636cf273a47949aa0613a8f">NozVector</a>(0.0, 1.0, 0.0));</div>
<div class="line">    <a class="code" href="group___pz_phase_api.html#gaa7bdbe5d84ca4a9640c38fafbfaed513">PzSetDetectFilePath</a>(GetOutputDirectoryDetectFilePath(node).c_str());</div>
<div class="line">    <a class="code" href="group___pz_phase_api.html#ga7765c1e1ea5304932a5f216913be6c98">PzSetOutFilePath</a>(GetOutputDirectoryFilePath(node).c_str());</div>
<div class="line">    <a class="code" href="group___pz_phase_api.html#gac06779d5f536cd1c0e787c482d31da35">PzSetCurrentFrame</a>((<span class="keywordtype">int</span>)AiNodeGetFlt(universeOptions, frameStr));</div>
<div class="line">    <a class="code" href="group___pz_phase_api.html#ga7b67476c80f6c252bd7afe87f0b4cb67">PzSetDraft</a>(AiNodeGetBool(pzCamera, draftModeStr));</div>
<div class="line">    <a class="code" href="group___pz_phase_api.html#ga7d4690051e4e84fe33b6dad6a2adc4ab">PzSetDeepReflection</a>(<a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#a3104904c134a52357b85f763f6dfd48faa1703c467e4e95c2a7194aabb4db866f">Eye::RC_LeftAndRight</a>, AiNodeGetFlt(pzCamera, ipdStr));</div>
<div class="line">    </div>
<div class="line">    <a class="code" href="group___pz_phase_api.html#ga444088b74ca4ad37253ea82be55c6086">PzSetIdealPointSizeTarget</a>(AiNodeGetFlt(pzCamera, idealPointSizeStr));</div>
<div class="line">    <a class="code" href="group___pz_phase_api.html#gaa60077bf14d0892eba85eaa204befd20">PzSetRenderScale</a>(AiNodeGetFlt(pzCamera, presenzSceneScaleStr));</div>
<div class="line">    </div>
<div class="line">    </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">int</span> renderTargetResX = AiNodeGetInt(universeOptions, xresStr);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">int</span> renderTargetResY = AiNodeGetInt(universeOptions, yresStr);</div>
<div class="line"></div>
<div class="line">    initPresenZCameraParameters(pzCamera, renderTargetResX, renderTargetResY, AiNodeGetFlt(pzCamera, ipdStr));</div>
<div class="line"></div>
<div class="line">    <a class="code" href="group___pz_phase_api.html#ga19ab56ff8deaa01029a44666eb9f98b1">PzSetMotionVector</a>(<span class="keyword">true</span>);</div>
<div class="line"></div>
<div class="line">    <a class="code" href="group___pz_phase_api.html#ga6d43f8e83409f28c54299350ab75a74e">PzSetRenderingResolutionParameters</a>(<a class="code" href="group___pz_phase_api.html#ga62db03efc145d8078e4b90cc7ab380f7">PzComputeRenderingResolutionParameters</a>(renderTargetResX, renderTargetResY));</div>
<div class="line">    <span class="comment">//PzSetRenderingResolutionParameters(PzGetRenderingResolutionParameters());</span></div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (pass == <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#ae1c5184dc404edf057ed537bcfddef84ac677a954de25220db675695edacb4f71">Render</a> || pass == <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#ae1c5184dc404edf057ed537bcfddef84a4fa71226841d5dc4359c2e48fa8a079e">Render_Reflection</a>) {</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">bool</span> do_crypto_object = AiNodeGetBool(node, cryptomatteObjectStr);</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">bool</span> do_crypto_material = AiNodeGetBool(node, cryptomatteMaterialStr);</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">bool</span> do_crypto_asset = AiNodeGetBool(node, cryptomatteAssetStr);</div>
<div class="line"></div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">int</span> depth_object = AiNodeGetInt(node, cryptomatteObjectDepthStr);</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">int</span> depth_material = AiNodeGetInt(node, cryptomatteMaterialDepthStr);</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">int</span> depth_asset = AiNodeGetInt(node, cryptomatteAssetDepthStr);</div>
<div class="line"></div>
<div class="line">        PresenZ_data_struct::do_crypto = do_crypto_object || do_crypto_material || do_crypto_asset;</div>
<div class="line">        <a class="code" href="group___pz_phase_api.html#ga23b1d26df6e95434a37ca458aa2be2ee">PzSetCryptomatte</a>(do_crypto_object, do_crypto_material, do_crypto_asset, depth_object, depth_material, depth_asset);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">AI_DRIVER_NODE_EXPORT_METHODS(nozPresenZDriverMethods);</div>
<div class="line"></div>
<div class="line">node_parameters</div>
<div class="line">{</div>
<div class="line">    AiParameterStr(<span class="stringliteral">&quot;filename&quot;</span>, <span class="stringliteral">&quot;presenz.prz&quot;</span>);</div>
<div class="line">    AiParameterStr(<span class="stringliteral">&quot;detect_file&quot;</span>, <span class="stringliteral">&quot;presenz.przDetect&quot;</span>);</div>
<div class="line">    AiMetaDataSetBool(nentry, <span class="stringliteral">&quot;detect_file&quot;</span>, <span class="stringliteral">&quot;maya.hide&quot;</span>, <span class="keyword">true</span>);</div>
<div class="line">    AiParameterStr(<span class="stringliteral">&quot;color_space&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);          <span class="comment">// No idea what to do with that, but otherwise MtoA barf about it.</span></div>
<div class="line">    AiParameterInt(<span class="stringliteral">&quot;pass&quot;</span>, 0);</div>
<div class="line">    AiMetaDataSetBool(nentry, <span class="stringliteral">&quot;pass&quot;</span>, <span class="stringliteral">&quot;maya.hide&quot;</span>, <span class="keyword">true</span>);</div>
<div class="line"></div>
<div class="line">    AiParameterBool(<span class="stringliteral">&quot;cryptomatte_object&quot;</span>, <span class="keyword">true</span>);</div>
<div class="line">    AiParameterInt(<span class="stringliteral">&quot;cryptomatte_object_depth&quot;</span>, 2);</div>
<div class="line">    AiParameterBool(<span class="stringliteral">&quot;cryptomatte_material&quot;</span>, <span class="keyword">false</span>);</div>
<div class="line">    AiParameterInt(<span class="stringliteral">&quot;cryptomatte_material_depth&quot;</span>, 2);</div>
<div class="line">    AiParameterBool(<span class="stringliteral">&quot;cryptomatte_asset&quot;</span>, <span class="keyword">false</span>);</div>
<div class="line">    AiParameterInt(<span class="stringliteral">&quot;cryptomatte_asset_depth&quot;</span>, 2);</div>
<div class="line"></div>
<div class="line">    AiParameterInt(<span class="stringliteral">&quot;current_block&quot;</span>, 0);         <span class="comment">// &quot;Current block to render&quot;</span></div>
<div class="line">    AiMetaDataSetBool(nentry, <span class="stringliteral">&quot;current_block&quot;</span>, <span class="stringliteral">&quot;maya.hide&quot;</span>, <span class="keyword">true</span>);</div>
<div class="line">    AiMetaDataSetStr(nentry, <span class="stringliteral">&quot;current_block&quot;</span>, <span class="stringliteral">&quot;_synonym&quot;</span>, <span class="stringliteral">&quot;current_Block&quot;</span>);</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">    AiMetaDataSetBool(nentry, <span class="stringliteral">&quot;filename&quot;</span>, <span class="stringliteral">&quot;maya.hide&quot;</span>, <span class="keyword">true</span>);</div>
<div class="line">    AiMetaDataSetStr(nentry, NULL, <span class="stringliteral">&quot;maya.attr_prefix&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);</div>
<div class="line">    AiMetaDataSetStr(nentry, NULL, <span class="stringliteral">&quot;maya.translator&quot;</span>, <span class="stringliteral">&quot;prz&quot;</span>);</div>
<div class="line">    AiMetaDataSetStr(nentry, NULL, <span class="stringliteral">&quot;_synonym&quot;</span>, <span class="stringliteral">&quot;PresenZDriver&quot;</span>);</div>
<div class="line">    </div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">driver_extension</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span>* extensions[] = { <span class="stringliteral">&quot;prz&quot;</span>, <span class="stringliteral">&quot;przDetect&quot;</span>, <span class="stringliteral">&quot;przRender&quot;</span>, NULL };</div>
<div class="line">    <span class="keywordflow">return</span> extensions;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">driver_supports_pixel_type</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span> pixel_type == AI_TYPE_POINTER || pixel_type == AI_TYPE_NODE;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">node_initialize</div>
<div class="line">{</div>
<div class="line">    AiDriverInitialize(node, <span class="keyword">true</span>);</div>
<div class="line">    DriverData* data = (DriverData*) AiNodeGetLocalData(node);</div>
<div class="line">    <span class="keywordflow">if</span> (data == <span class="keyword">nullptr</span>) {</div>
<div class="line">        data = (DriverData*)AiMalloc(<span class="keyword">sizeof</span>(DriverData));</div>
<div class="line">        data-&gt;m_idValid = <span class="keyword">false</span>;</div>
<div class="line">        data-&gt;m_aovDeclaration = <span class="keyword">nullptr</span>;</div>
<div class="line">        data-&gt;m_numElements = 0;</div>
<div class="line">        AiNodeSetLocalData(node, data);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">    <a class="code" href="group___pz_app_logger.html#ga6c2daa2959e416d397b68a18c13842af">PresenZ::Logger::PzSetDateHeader</a>(<span class="keyword">false</span>);</div>
<div class="line">    <a class="code" href="group___pz_app_logger.html#gadedfd3a41954b4628b80d4f21a067e16">PresenZ::Logger::PzSetLogLevelHeader</a>(<span class="keyword">false</span>);</div>
<div class="line">    <a class="code" href="group___pz_app_logger.html#ga206c3c49af4c27469605d9c1ecb0208d">PresenZ::Logger::PzSetConsole</a>(<span class="keyword">false</span>);</div>
<div class="line">    <a class="code" href="group___pz_app_logger.html#ga0b6dbccf7a4b8a079e4778d98687dd72">PresenZ::Logger::PzSetProgressBarType</a>(<a class="code" href="namespace_presen_z_1_1_logger_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#a797e8f0ee9ab4aad21b8a9ea23c5f457acf64a7a93c17e0fb483f1256a33e13f9">PresenZ::Logger::PT_vertical</a>);</div>
<div class="line">    <a class="code" href="group___pz_app_logger.html#gad553edc68869caef27062377dbd1fa3e">PresenZ::Logger::PzSetCallBackLogLevel</a>(<a class="code" href="namespace_presen_z_1_1_logger_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#aca1fd1d8935433e6ba2e3918214e07f9a1ef17fe4022551db4da98ddd8838a626">PresenZ::Logger::LL_Trace</a>, arnoldLogger, static_cast&lt;void *&gt;(NULL));</div>
<div class="line">    <a class="code" href="group___pz_app_logger.html#ga69fa5b01d6b1acceaef8cbfb9cbe769b">PresenZ::Logger::PzSetCallbackCarriageReturnMode</a>(<a class="code" href="namespace_presen_z_1_1_logger_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#a09c183db9d6f5f4e369cab8b6a566a92a4794744b59a0b9c9ee7267cd770f03fb">PresenZ::Logger::CR_NoCarriageReturn</a>);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">node_update </div>
<div class="line">{</div>
<div class="line">    DriverData *data = (DriverData*)AiNodeGetLocalData(node);</div>
<div class="line">    data-&gt;m_idValid = initPresenZ(node);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span>(data-&gt;m_idValid == <span class="keyword">true</span>)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordtype">size_t</span> currentBlock = AiNodeGetInt(node, currentBlockStr);</div>
<div class="line">        <a class="code" href="group___pz_phase_api.html#ga650d92ab278b226c5dc600f3c61dc831">PzSetCurrentBlockIndex</a>(currentBlock);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">        <a class="code" href="group___pz_app_logger.html#gaf8ab3f1606906a93b3081de7f0cb7be1">PZ_INFO</a>(<span class="stringliteral">&quot;[PresenZ] Driver disabled.&quot;</span>)</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">node_finish</div>
<div class="line">{</div>
<div class="line">    DriverData *data = (DriverData*)AiNodeGetLocalData(node);</div>
<div class="line">    AiFree(data);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Callback invoked by Arnold when it is ready to start rendering an image</span></div>
<div class="line">driver_open</div>
<div class="line">{</div>
<div class="line">    DriverData *data = (DriverData*)AiNodeGetLocalData(node);</div>
<div class="line">    <span class="keywordflow">if</span> (data-&gt;m_idValid == <span class="keyword">false</span>)</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (PresenZ_data_struct::pass == <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#ae1c5184dc404edf057ed537bcfddef84a48a95ceab76284afa466622424eba555">Detect</a> || PresenZ_data_struct::pass == <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#ae1c5184dc404edf057ed537bcfddef84a9e72290cbba5243f4449f84168a3c99c">Detect_Reflection</a>)</div>
<div class="line">        <a class="code" href="group___pz_phase_api.html#ga7917a06467a8dcf304f2a82ccf02a6fe">PzSetBucketSize</a>(bucket_size, bucket_size);</div>
<div class="line"></div>
<div class="line">    <a class="code" href="group___pz_phase_api.html#gad456080d403b66cb5b692ab542d4e332">PzPhaseBegin</a>();</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> compileManifests(AtUniverse* universe, <span class="keywordtype">bool</span> do_md_material) {</div>
<div class="line">    AtNodeIterator* shape_iterator = AiUniverseGetNodeIterator(universe, AI_NODE_SHAPE);</div>
<div class="line">    <span class="keywordflow">while</span> (!AiNodeIteratorFinished(shape_iterator)) {</div>
<div class="line">        AtNode* node = AiNodeIteratorGetNext(shape_iterator);</div>
<div class="line">        <span class="keywordflow">if</span> (!node || AiNodeIsDisabled(node))</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line"></div>
<div class="line">        <span class="comment">// skip any list aggregate nodes</span></div>
<div class="line">        <span class="keywordflow">if</span> (AiNodeIs(node, aStr_list_aggregate))</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line"></div>
<div class="line">        <span class="keywordtype">char</span> nsp_name[<a class="code" href="_pz_cryptomatte_api_8h.html#a52a3717199fbc540c58210f997fb8bc6">PZ_CRYPTO_MAX_STRING_LENGTH</a>] = <span class="stringliteral">&quot;&quot;</span>;</div>
<div class="line">        <span class="keywordtype">char</span> obj_name[<a class="code" href="_pz_cryptomatte_api_8h.html#a52a3717199fbc540c58210f997fb8bc6">PZ_CRYPTO_MAX_STRING_LENGTH</a>] = <span class="stringliteral">&quot;&quot;</span>;</div>
<div class="line"></div>
<div class="line">        <a class="code" href="namespace_presen_z_1_1_cryptomatte_1_1v4__1.html#add5846e546be718498b286fcf043632a">PresenZ::Cryptomatte::PzAddObjectToManifest</a>(AiNodeGetName(node));</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (do_md_material) {</div>
<div class="line">            <span class="comment">// Process all shaders from the objects into the manifest.</span></div>
<div class="line">            <span class="comment">// This includes cluster materials.</span></div>
<div class="line">            AtArray* shaders = AiNodeGetArray(node, shaderStr);</div>
<div class="line">            <span class="keywordflow">if</span> (!shaders)</div>
<div class="line">                <span class="keywordflow">continue</span>;</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">for</span> (uint32_t i = 0; i &lt; AiArrayGetNumElements(shaders); i++) {</div>
<div class="line">                AtNode* shader = <span class="keyword">static_cast&lt;</span>AtNode*<span class="keyword">&gt;</span>(AiArrayGetPtr(shaders, i));</div>
<div class="line">                <span class="keywordflow">if</span> (!shader)</div>
<div class="line">                    <span class="keywordflow">continue</span>;</div>
<div class="line">                <a class="code" href="namespace_presen_z_1_1_cryptomatte_1_1v4__1.html#ae089b72fde052aae764dc4128d1bd7e8">PresenZ::Cryptomatte::PzAddMaterialToManifest</a>(AiNodeGetName(shader));</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    AiNodeIteratorDestroy(shape_iterator);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">// Callback invoked an image is finished.</span></div>
<div class="line">driver_close</div>
<div class="line">{</div>
<div class="line">    DriverData* data = (DriverData*)AiNodeGetLocalData(node);   </div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">bool</span> objects, materials, assets = <span class="keyword">false</span>;</div>
<div class="line">    <a class="code" href="namespace_presen_z_1_1_cryptomatte_1_1v4__1.html#afcbb0d852c28f6a7c339c2ea4cf9e88d">PresenZ::Cryptomatte::PzGetActiveCryptomatte</a>(objects, materials, assets);</div>
<div class="line">    <span class="keywordflow">if</span> (objects || materials || assets) {</div>
<div class="line">        </div>
<div class="line">        compileManifests(AiNodeGetUniverse(node), materials);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (PresenZ_data_struct::pass == <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#ae1c5184dc404edf057ed537bcfddef84a48a95ceab76284afa466622424eba555">Detect</a> || PresenZ_data_struct::pass == <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#ae1c5184dc404edf057ed537bcfddef84a9e72290cbba5243f4449f84168a3c99c">Detect_Reflection</a>)</div>
<div class="line">        <a class="code" href="group__bucket_a_p_i.html#gaa7bd86f8733ac69bb40301fae63b7feb">PzProcessAllBucketsToFile</a>();</div>
<div class="line"></div>
<div class="line">    restoreAOVs(node);</div>
<div class="line">    <a class="code" href="group___pz_phase_api.html#ga9b74d99ec6ae25fd148b2d828c56e432">PzPhaseTerminate</a>();</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">driver_needs_bucket</div>
<div class="line">{</div>
<div class="line">    DriverData *data = (DriverData*)AiNodeGetLocalData(node);</div>
<div class="line">    <span class="keywordflow">if</span> (data-&gt;m_idValid == <span class="keyword">false</span>)</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Callback invoked by Arnold when bucket (image sub zone) is going to be rendered.</span></div>
<div class="line">driver_prepare_bucket</div>
<div class="line">{</div>
<div class="line">    DriverData *data = (DriverData*)AiNodeGetLocalData(node);</div>
<div class="line">    <span class="keywordflow">if</span> (data-&gt;m_idValid == <span class="keyword">false</span>)</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (PresenZ_data_struct::pass == <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#ae1c5184dc404edf057ed537bcfddef84a48a95ceab76284afa466622424eba555">Detect</a> || PresenZ_data_struct::pass == <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#ae1c5184dc404edf057ed537bcfddef84a9e72290cbba5243f4449f84168a3c99c">Detect_Reflection</a>)</div>
<div class="line">        <a class="code" href="group__bucket_a_p_i.html#gac89c51d8d00e9934052276ecd10f0eda">PzInitBucket</a>(tid, bucket_xo, bucket_yo, bucket_xo + bucket_size_x, bucket_yo + bucket_size_y);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Callback invoked by Arnold when a bucket (image sub-zone) is finished, all s haded pixels are forwarded </span></div>
<div class="line"><span class="comment">// to PresenZ for further processing. </span></div>
<div class="line">driver_process_bucket</div>
<div class="line">{</div>
<div class="line"> </div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> write_bucket_detect(AtNode* node, <span class="keyword">struct</span> AtOutputIterator* iterator, <span class="keyword">struct</span> AtAOVSampleIterator* sample_iterator, <span class="keywordtype">int</span> bucket_xo, <span class="keywordtype">int</span> bucket_yo, <span class="keywordtype">int</span> bucket_size_x, <span class="keywordtype">int</span> bucket_size_y)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">void</span>* bucket_data;</div>
<div class="line">    AtString name;</div>
<div class="line">    <span class="keywordtype">int</span> type = AI_TYPE_UNDEFINED;</div>
<div class="line"></div>
<div class="line">    FilterDataDetect** pixels_data;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">while</span> (AiOutputIteratorGetNext(iterator, &amp;name, &amp;type, &amp;bucket_data)) {</div>
<div class="line">        <span class="keywordflow">if</span> (name == detectPzStr) {</div>
<div class="line">            pixels_data = (FilterDataDetect**)bucket_data;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j &lt; bucket_size_y; ++j) {</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; bucket_size_x; ++i) {</div>
<div class="line">            <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> in_idx = j * bucket_size_x + i;</div>
<div class="line">            <span class="keywordtype">size_t</span> dataSize = pixels_data[in_idx]-&gt;data.size();</div>
<div class="line">            </div>
<div class="line">            <span class="keywordflow">if</span> (dataSize != 0) {</div>
<div class="line">                <a class="code" href="group__bucket_a_p_i.html#ga50ddc5c12cc6e87e55b7971563ec7e7a">PzFlushSamplesToFile</a>(pixels_data[in_idx]-&gt;data);</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            std::vector&lt;PresenZ::DetectSample::SaveDataStructure&gt; empty_vector;</div>
<div class="line">            pixels_data[in_idx]-&gt;data.swap(empty_vector);</div>
<div class="line">            <span class="keyword">delete</span> pixels_data[in_idx];</div>
<div class="line">            pixels_data[in_idx] = <span class="keyword">nullptr</span>; <span class="comment">// Ensure the pointer is not left dangling</span></div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> write_bucket_render(AtNode* node, <span class="keyword">struct</span> AtOutputIterator* iterator, <span class="keyword">struct</span> AtAOVSampleIterator* sample_iterator, <span class="keywordtype">int</span> bucket_xo, <span class="keywordtype">int</span> bucket_yo, <span class="keywordtype">int</span> bucket_size_x, <span class="keywordtype">int</span> bucket_size_y)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">void</span>* bucket_data;</div>
<div class="line">    AtString name;</div>
<div class="line">    <span class="keywordtype">int</span> type = AI_TYPE_UNDEFINED;</div>
<div class="line"></div>
<div class="line">    FilterData** pixels_data;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">while</span> (AiOutputIteratorGetNext(iterator, &amp;name, &amp;type, &amp;bucket_data)) {</div>
<div class="line">        <span class="keywordflow">if</span> (name == RGBAAtStr) {</div>
<div class="line">            pixels_data = (FilterData**)bucket_data;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j &lt; bucket_size_y; ++j) {</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; bucket_size_x; ++i) {</div>
<div class="line">            <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> in_idx = j * bucket_size_x + i;</div>
<div class="line">            <span class="keywordtype">size_t</span> dataSize = pixels_data[in_idx]-&gt;data.size();</div>
<div class="line">            <span class="keywordflow">if</span> (dataSize != 0) {</div>
<div class="line">                <a class="code" href="group__bucket_a_p_i.html#ga50ddc5c12cc6e87e55b7971563ec7e7a">PzFlushSamplesToFile</a>(pixels_data[in_idx]-&gt;data);</div>
<div class="line">            }</div>
<div class="line">            std::vector&lt;PresenZ::RenderSample::PzFilteredSample&gt; empty_vector;</div>
<div class="line">            pixels_data[in_idx]-&gt;data.swap(empty_vector);  </div>
<div class="line">            <span class="keyword">delete</span> pixels_data[in_idx];</div>
<div class="line">            pixels_data[in_idx] = <span class="keyword">nullptr</span>; <span class="comment">// Ensure the pointer is not left dangling        </span></div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Callback invoked by Arnold when bucket (image sub-zone) is finished and can be dismissed.</span></div>
<div class="line">driver_write_bucket</div>
<div class="line">{</div>
<div class="line">    DriverData *data = (DriverData*)AiNodeGetLocalData(node);</div>
<div class="line">    <span class="keywordflow">if</span> (data-&gt;m_idValid == <span class="keyword">false</span>)</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (PresenZ_data_struct::pass == <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#ae1c5184dc404edf057ed537bcfddef84a48a95ceab76284afa466622424eba555">PresenZ::Phase::Detect</a> || PresenZ_data_struct::pass == <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#ae1c5184dc404edf057ed537bcfddef84a9e72290cbba5243f4449f84168a3c99c">PresenZ::Phase::Detect_Reflection</a>) {</div>
<div class="line">        write_bucket_detect(node, iterator, sample_iterator, bucket_xo, bucket_yo, bucket_size_x, bucket_size_y);</div>
<div class="line">        <a class="code" href="group__bucket_a_p_i.html#gaac96ec1f497d20deb0d2554355955175">PzProcessBucketFlushToFile</a>(bucket_xo, bucket_yo, bucket_xo + bucket_size_x, bucket_yo + bucket_size_y);</div>
<div class="line">        </div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (PresenZ_data_struct::pass == <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#ae1c5184dc404edf057ed537bcfddef84ac677a954de25220db675695edacb4f71">PresenZ::Phase::Render</a> || PresenZ_data_struct::pass == <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#ae1c5184dc404edf057ed537bcfddef84a4fa71226841d5dc4359c2e48fa8a079e">PresenZ::Phase::Render_Reflection</a>)</div>
<div class="line">        write_bucket_render(node, iterator, sample_iterator, bucket_xo, bucket_yo, bucket_size_x, bucket_size_y);</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">}</div>
</div><!-- fragment --><h1>10.6 Operator</h1>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;ai.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &quot;presenz_global_parameters.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;arnoldWrapper.h&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="_pz_phase_api_8h.html">API/PzPhaseApi.h</a>&quot;</span></div>
<div class="line"></div>
<div class="line">AI_OPERATOR_NODE_EXPORT_METHODS(PresenZOperatorMethods);</div>
<div class="line"></div>
<div class="line">node_parameters</div>
<div class="line">{</div>
<div class="line">    AiParameterStr(<span class="stringliteral">&quot;selection&quot;</span>, <span class="stringliteral">&quot;*&quot;</span>);</div>
<div class="line">    AiParameterInt(<span class="stringliteral">&quot;pass&quot;</span>, -1);</div>
<div class="line">    AiParameterInt(<span class="stringliteral">&quot;rendering_eye&quot;</span>, 0);</div>
<div class="line">    AiParameterBool(<span class="stringliteral">&quot;override_bucket_size&quot;</span>, <span class="keyword">true</span>);</div>
<div class="line">    AiMetaDataSetStr(nentry, NULL, <span class="stringliteral">&quot;_synonym&quot;</span>, <span class="stringliteral">&quot;PresenZOperator&quot;</span>);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">// Operator are invoked every time the scene is ready to be rendered.</span></div>
<div class="line">operator_init</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="group___pz_app_logger.html#ga206c3c49af4c27469605d9c1ecb0208d">PresenZ::Logger::PzSetConsole</a>(<span class="keyword">false</span>);</div>
<div class="line">    <a class="code" href="group___pz_app_logger.html#gad553edc68869caef27062377dbd1fa3e">PresenZ::Logger::PzSetCallBackLogLevel</a>(<a class="code" href="namespace_presen_z_1_1_logger_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#aca1fd1d8935433e6ba2e3918214e07f9a1ef17fe4022551db4da98ddd8838a626">PresenZ::Logger::LL_Trace</a>, PresenArnoldLogger, NULL);</div>
<div class="line">    <a class="code" href="group___pz_app_logger.html#ga69fa5b01d6b1acceaef8cbfb9cbe769b">PresenZ::Logger::PzSetCallbackCarriageReturnMode</a>(<a class="code" href="namespace_presen_z_1_1_logger_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#a09c183db9d6f5f4e369cab8b6a566a92a4794744b59a0b9c9ee7267cd770f03fb">PresenZ::Logger::CR_NoCarriageReturn</a>);</div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Invoked at the end of a render.</span></div>
<div class="line">operator_cleanup</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">operator_post_cook</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// The cook operator is applied on every object on the scened. In this method</span></div>
<div class="line"><span class="comment">// we set up correctly PresenZ objects and connect every shape to the PresenZAOV</span></div>
<div class="line"><span class="comment">// shader. This will make sure we receive hits and normals for seen geometry.</span></div>
<div class="line">operator_cook</div>
<div class="line">{</div>
<div class="line">    AtUniverse* universe = AiNodeGetUniverse(node);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (AiNodeEntryGetType(AiNodeGetNodeEntry(node)) == AI_NODE_CAMERA)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">if</span> (AiNodeIs(node, PresenzCameraName))</div>
<div class="line">        {</div>
<div class="line">            <span class="comment">// near clip for chaotics</span></div>
<div class="line">            AiNodeSetFlt(node, nearClipStr, 0.0001f);</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span>(AiNodeGetInt(op, renderingEyeStr) != -1)</div>
<div class="line">                AiNodeSetInt(node, renderingEyeStr, AiNodeGetInt(op, renderingEyeStr));</div>
<div class="line"></div>
<div class="line">            <span class="comment">// We set the screen_window_min/screen_window_max to the actual resolution.</span></div>
<div class="line">            AtUniverse* current_universe = AiNodeGetUniverse(node);</div>
<div class="line">            AtNode* options = AiUniverseGetOptions(current_universe);</div>
<div class="line">            <span class="keywordtype">int</span> xres = AiNodeGetInt(options, xresStr);</div>
<div class="line">            <span class="keywordtype">int</span> yres = AiNodeGetInt(options, yresStr);</div>
<div class="line"></div>
<div class="line">            <span class="keywordtype">float</span> frame_aspect_ratio = (float)xres / (<span class="keywordtype">float</span>)yres;</div>
<div class="line">            AiNodeSetVec2(node, screenWindowMinStr, 0, 0);</div>
<div class="line">            AiNodeSetVec2(node, screenWindowMaxStr, (<span class="keywordtype">float</span>)xres, ((<span class="keywordtype">float</span>)(yres)) * frame_aspect_ratio);</div>
<div class="line"></div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (AiNodeEntryGetType(AiNodeGetNodeEntry(node)) == AI_NODE_DRIVER)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">if</span> (AiNodeIs(node, PresenZDriver)) {</div>
<div class="line">            <span class="keywordflow">if</span> (AiNodeGetInt(op, passStr) != -1)</div>
<div class="line">                AiNodeSetInt(node, passStr, AiNodeGetInt(op, passStr));</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">            <span class="comment">//get the pass in the driver</span></div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">int</span> pass = AiNodeGetInt(node, passStr);</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> (pass == <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#ae1c5184dc404edf057ed537bcfddef84ac677a954de25220db675695edacb4f71">PresenZ::Phase::Render</a> || pass == <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#ae1c5184dc404edf057ed537bcfddef84a4fa71226841d5dc4359c2e48fa8a079e">PresenZ::Phase::Render_Reflection</a>) {</div>
<div class="line">                registerAOVs(node);</div>
<div class="line"></div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">bool</span> do_crypto_object = AiNodeGetBool(node, cryptomatteObjectStr);</div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">bool</span> do_crypto_material = AiNodeGetBool(node, cryptomatteMaterialStr);</div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">bool</span> do_crypto_asset = AiNodeGetBool(node, cryptomatteAssetStr);</div>
<div class="line"></div>
<div class="line">                createCryptomatteOutput(node, do_crypto_object, do_crypto_material, do_crypto_asset);</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pass == <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#ae1c5184dc404edf057ed537bcfddef84a48a95ceab76284afa466622424eba555">PresenZ::Phase::Detect</a> || pass == <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#ae1c5184dc404edf057ed537bcfddef84a9e72290cbba5243f4449f84168a3c99c">PresenZ::Phase::Detect_Reflection</a>) {</div>
<div class="line">                registerAOVsDetect(node);</div>
<div class="line"></div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (AiNodeEntryGetType(AiNodeGetNodeEntry(node)) == AI_NODE_LIGHT)</div>
<div class="line">    {</div>
<div class="line">        </div>
<div class="line">        <span class="keywordflow">if</span> (AiNodeIs(node, skydomeLightAtStr) &amp;&amp; (AiNodeGetInt(op, passStr) == <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#ae1c5184dc404edf057ed537bcfddef84a48a95ceab76284afa466622424eba555">PresenZ::Phase::Detect</a> || AiNodeGetInt(op, passStr) == <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#ae1c5184dc404edf057ed537bcfddef84a9e72290cbba5243f4449f84168a3c99c">PresenZ::Phase::Detect_Reflection</a>))</div>
<div class="line">        {  </div>
<div class="line">            <span class="keywordflow">if</span> (AiNodeGetFlt(node, cameraStr) &lt;= AI_EPSILON) {</div>
<div class="line">                AiNodeSetDisabled(node, <span class="keyword">true</span>);</div>
<div class="line">                </div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (AiNodeEntryGetType(AiNodeGetNodeEntry(node)) == AI_NODE_OPTIONS)</div>
<div class="line">    {</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span>(AiNodeGetBool(op, overrideBucketSizeStr))</div>
<div class="line">            AiNodeSetInt(node, bucketSizeStr, 16);</div>
<div class="line"></div>
<div class="line">        AiNodeSetStr(node, LPEStr, glassLPEStr);</div>
<div class="line"></div>
<div class="line">        AtUniverse* current_universe = AiNodeGetUniverse(node);</div>
<div class="line">        AtNode* pzCamera = AiUniverseGetCamera(current_universe);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (AiNodeIs(pzCamera, PresenzCameraName) == <span class="keyword">false</span>)</div>
<div class="line">        {</div>
<div class="line">            AtArray *mCamera = AiNodeGetArray(pzCamera, matrixStr);</div>
<div class="line">            AtNode *new_camera = AiNode(current_universe, PresenzCameraName, PresenZZOVStr);</div>
<div class="line"></div>
<div class="line">            AiNodeSetArray(new_camera, matrixStr, AiArrayCopy(mCamera));</div>
<div class="line">            AiNodeSetFlt(new_camera, farClipStr, AiNodeGetFlt(pzCamera, farClipStr));</div>
<div class="line">            AiNodeSetFlt(new_camera, nearClipStr, 0.0001f);</div>
<div class="line">            <a class="code" href="group___pz_app_logger.html#gaf8ab3f1606906a93b3081de7f0cb7be1">PZ_INFO</a>(<span class="stringliteral">&quot;Converting current camera to a PresenZ Zone Of View&quot;</span>);</div>
<div class="line">            AiNodeSetPtr(node, cameraStr, new_camera);</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> (AiNodeGetInt(op, renderingEyeStr) != -1)</div>
<div class="line">                AiNodeSetInt(new_camera, renderingEyeStr, AiNodeGetInt(op, renderingEyeStr));</div>
<div class="line"></div>
<div class="line">            <span class="comment">// near clip for chaotcis</span></div>
<div class="line">            AiNodeSetFlt(new_camera, nearClipStr, 0.0001f);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        AtArray *outputs = AiNodeGetArray(node, outputsAtStr);</div>
<div class="line">        <span class="keywordflow">if</span> (AiArrayGetNumElements(outputs) == 0)</div>
<div class="line">        {</div>
<div class="line">            <a class="code" href="group___pz_app_logger.html#gaf8ab3f1606906a93b3081de7f0cb7be1">PZ_INFO</a>(<span class="stringliteral">&quot;Reconnecting the presenz driver&quot;</span>);</div>
<div class="line">            outputs = AiArrayAllocate(1, 1, AI_TYPE_STRING);</div>
<div class="line">            <span class="comment">// search for a presenz driver</span></div>
<div class="line"></div>
<div class="line">            AtNodeIterator* iter = AiUniverseGetNodeIterator(current_universe, AI_NODE_DRIVER);</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">while</span> (!AiNodeIteratorFinished(iter))</div>
<div class="line">            {</div>
<div class="line">                AtNode *driver = AiNodeIteratorGetNext(iter);</div>
<div class="line">                <span class="keywordflow">if</span> (AiNodeIs(driver, PresenZDriver))</div>
<div class="line">                {</div>
<div class="line">                    AtNodeIterator* iterFilter = AiUniverseGetNodeIterator(current_universe, AI_NODE_FILTER);</div>
<div class="line"></div>
<div class="line">                    <span class="keywordflow">while</span> (!AiNodeIteratorFinished(iterFilter))</div>
<div class="line">                    {</div>
<div class="line">                        AtNode *filter = AiNodeIteratorGetNext(iterFilter);</div>
<div class="line">                        <span class="keywordflow">if</span> (AiNodeIs(filter, PresenZFilter))</div>
<div class="line">                        {</div>
<div class="line">                            <span class="keywordtype">char</span>   str[1024];</div>
<div class="line">                            sprintf(str, <span class="stringliteral">&quot;RGBA RGBA %s %s&quot;</span>, AiNodeGetName(filter), AiNodeGetName(driver));</div>
<div class="line">                            <a class="code" href="group___pz_app_logger.html#gaf8ab3f1606906a93b3081de7f0cb7be1">PZ_INFO</a>(<span class="stringliteral">&quot;Setting %s as output&quot;</span>, AiNodeGetName(driver));</div>
<div class="line">                            AiArraySetStr(outputs, 0, str);</div>
<div class="line">                            AiNodeSetArray(node, outputsAtStr, outputs);</div>
<div class="line">                            <span class="keywordflow">break</span>;</div>
<div class="line">                        }</div>
<div class="line">                    }</div>
<div class="line">                    AiNodeIteratorDestroy(iterFilter);</div>
<div class="line"></div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">            AiNodeIteratorDestroy(iter);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">        <span class="comment">//Check the AOV shader list</span></div>
<div class="line">        AtArray *AOVShaderList = AiNodeGetArray(node, aovShadersAtStr);</div>
<div class="line">        uint32_t numShaders = AiArrayGetNumElements(AOVShaderList);</div>
<div class="line"></div>
<div class="line">        <span class="keywordtype">bool</span> foundPresenZPostAOVShader = <span class="keyword">false</span>;</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">for</span> (uint32_t i = 0; i &lt; numShaders; i++) {</div>
<div class="line">            AtNode* shader = (AtNode*)AiArrayGetPtr(AOVShaderList, i);</div>
<div class="line">            <span class="keywordflow">if</span> (AiNodeIs(shader, PresenZPostAOVShader)) {</div>
<div class="line">                foundPresenZPostAOVShader = <span class="keyword">true</span>;</div>
<div class="line">                <span class="keywordflow">continue</span>;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">// We should create and add it to the list</span></div>
<div class="line">        <span class="keywordflow">if</span> (foundPresenZPostAOVShader == <span class="keyword">false</span>) {</div>
<div class="line">            AiMsgInfo(<span class="stringliteral">&quot;[PresenZ] Creating and adding PresenZ Post AOVs Shader in option node.&quot;</span>);</div>
<div class="line">            numShaders = numShaders + 1;</div>
<div class="line">            AiArrayResize(AOVShaderList, numShaders, 1);</div>
<div class="line">            AtNode* AOVShader = AiNode(universe, PresenZPostAOVShader, PresenZPostAOVShader);</div>
<div class="line">            AiArraySetPtr(AOVShaderList, numShaders-1, AOVShader);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"></div>
<div class="line">}</div>
</div><!-- fragment --><h1>10.7 Shader Operator</h1>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;ai.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &quot;presenz_global_parameters.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;arnoldWrapper.h&quot;</span></div>
<div class="line"></div>
<div class="line">AI_OPERATOR_NODE_EXPORT_METHODS(PresenZOperatorShadersMethods);</div>
<div class="line"></div>
<div class="line">std::string addPzPrefixToLastToken(<span class="keyword">const</span> std::string&amp; inputPath) {</div>
<div class="line">    <span class="keywordtype">size_t</span> lastSlashPos = inputPath.find_last_of(<span class="stringliteral">&quot;/|&quot;</span>);</div>
<div class="line">    <span class="keywordflow">if</span> (lastSlashPos == std::string::npos || lastSlashPos + 1 &gt;= inputPath.length()) {</div>
<div class="line">        <span class="comment">// No slash found or nothing after the last slash</span></div>
<div class="line">        <span class="keywordflow">return</span> <span class="stringliteral">&quot;Pz_&quot;</span> + inputPath;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    std::string prefix = inputPath.substr(0, lastSlashPos + 1);</div>
<div class="line">    std::string lastToken = inputPath.substr(lastSlashPos + 1);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> prefix + <span class="stringliteral">&quot;Pz_&quot;</span> + lastToken;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">node_parameters</div>
<div class="line">{</div>
<div class="line">    AiParameterStr(<span class="stringliteral">&quot;selection&quot;</span>, <span class="stringliteral">&quot;*&quot;</span>);</div>
<div class="line">    AiMetaDataSetStr(nentry, NULL, <span class="stringliteral">&quot;_synonym&quot;</span>, <span class="stringliteral">&quot;PresenZOperatorShaders&quot;</span>);</div>
<div class="line"></div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Operator are invoked every time the scene is ready to be rendered.</span></div>
<div class="line">operator_init</div>
<div class="line">{</div>
<div class="line"><span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Invoked at the end of a render.</span></div>
<div class="line">operator_cleanup</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">operator_post_cook</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// The cook operator is applied on every object on the scened. In this method</span></div>
<div class="line"><span class="comment">// we set up correctly PresenZ objects and connect every shape to the PresenZAOV</span></div>
<div class="line"><span class="comment">// shader. This will make sure we receive hits and normals for seen geometry.</span></div>
<div class="line">operator_cook</div>
<div class="line">{</div>
<div class="line">    AtUniverse* universe = AiNodeGetUniverse(node);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (AiNodeEntryGetType(AiNodeGetNodeEntry(node)) == AI_NODE_SHAPE) {</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (AiNodeIs(node, AtString(<span class="stringliteral">&quot;procedural&quot;</span>))) {</div>
<div class="line">            <a class="code" href="group___pz_app_logger.html#gad79dc53c351eeff13f901542c29f6e57">PZ_DEBUG</a>(<span class="stringliteral">&quot;Skipping procedural %s&quot;</span>, AiNodeGetName(node));</div>
<div class="line">            <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="keyword">const</span> AtNodeEntry* nentry = AiNodeGetNodeEntry(node);</div>
<div class="line">        <span class="keywordflow">if</span> (AiNodeEntryGetDerivedType(nentry) == AI_NODE_SHAPE_PROCEDURAL) {</div>
<div class="line">            <a class="code" href="group___pz_app_logger.html#gad79dc53c351eeff13f901542c29f6e57">PZ_DEBUG</a>(<span class="stringliteral">&quot;Skipping procedural shape %s&quot;</span>, AiNodeGetName(node));</div>
<div class="line">            <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">        <span class="comment">// check the shape parent. if we had tags on the parent, we should copy them  it to the child.</span></div>
<div class="line">        AtNode* parentNode = AiNodeGetParent(node);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (parentNode != NULL) {</div>
<div class="line">            <span class="keyword">const</span> AtNodeEntry* nentry = AiNodeGetNodeEntry(parentNode);</div>
<div class="line">            <span class="keywordflow">if</span> (AiNodeEntryGetDerivedType(nentry) == AI_NODE_SHAPE_PROCEDURAL)</div>
<div class="line">            {</div>
<div class="line">                <span class="keywordflow">if</span> (AiNodeLookUpUserParameter(parentNode, przGlassAtStr) != NULL</div>
<div class="line">                    &amp;&amp; AiNodeLookUpUserParameter(node, przGlassAtStr) == NULL)</div>
<div class="line">                {</div>
<div class="line">                    AiNodeDeclare(node, przGlassAtStr, <span class="stringliteral">&quot;constant INT&quot;</span>);</div>
<div class="line">                    AiNodeSetInt(node, przGlassAtStr, AiNodeGetInt(parentNode, przGlassAtStr));</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">if</span> (AiNodeLookUpUserParameter(parentNode, przChaoticAtStr) != NULL</div>
<div class="line">                    &amp;&amp; AiNodeLookUpUserParameter(node, przChaoticAtStr) == NULL)</div>
<div class="line">                {</div>
<div class="line">                    AiNodeDeclare(node, przChaoticAtStr, <span class="stringliteral">&quot;constant INT&quot;</span>);</div>
<div class="line">                    AiNodeSetInt(node, przChaoticAtStr, AiNodeGetInt(parentNode, przChaoticAtStr));</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">if</span> (AiNodeLookUpUserParameter(parentNode, przIsolatedAtStr) != NULL</div>
<div class="line">                    &amp;&amp; AiNodeLookUpUserParameter(node, przIsolatedAtStr) == NULL)</div>
<div class="line">                {</div>
<div class="line">                    AiNodeDeclare(node, przIsolatedAtStr, <span class="stringliteral">&quot;constant INT&quot;</span>);</div>
<div class="line">                    AiNodeSetInt(node, przIsolatedAtStr, AiNodeGetInt(parentNode, przIsolatedAtStr));</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">if</span> (AiNodeLookUpUserParameter(parentNode, przStereoAtStr) != NULL</div>
<div class="line">                    &amp;&amp; AiNodeLookUpUserParameter(node, przStereoAtStr) == NULL)</div>
<div class="line">                {</div>
<div class="line">                    AiNodeDeclare(node, przStereoAtStr, <span class="stringliteral">&quot;constant INT&quot;</span>);</div>
<div class="line">                    AiNodeSetInt(node, przStereoAtStr, AiNodeGetInt(parentNode, przStereoAtStr));</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="keywordtype">bool</span> glassMaterial = <span class="keyword">false</span>;</div>
<div class="line"></div>
<div class="line">        <span class="keywordtype">float</span> step_size = 0.0f;</div>
<div class="line">        <span class="keyword">const</span> AtParamEntry* pentry = AiNodeEntryLookUpParameter(nentry, stepSizeStr);</div>
<div class="line">        <span class="keywordflow">if</span>(pentry != <span class="keyword">nullptr</span>)</div>
<div class="line">            step_size = AiNodeGetFlt(node, stepSizeStr);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (AiNodeLookUpUserParameter(node, przGlassAtStr) != NULL) {</div>
<div class="line">            <span class="keywordtype">int</span> transp = AiNodeGetInt(node, przGlassAtStr);</div>
<div class="line">            glassMaterial = (transp == 1);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (glassMaterial) {</div>
<div class="line">            <span class="comment">// If we are transparent, we tag the glass</span></div>
<div class="line">            <span class="comment">// We also tag it as non-opaque.</span></div>
<div class="line">            AtArray* current_trace_set_array = AiNodeGetArray(node, traceSetsStr);</div>
<div class="line">            <span class="keywordtype">int</span> num_elements = AiArrayGetNumElements(current_trace_set_array);</div>
<div class="line">            AiArrayResize(current_trace_set_array, num_elements + 1, AiArrayGetNumKeys(current_trace_set_array));</div>
<div class="line">            AiArraySetStr(current_trace_set_array, num_elements, przGlassAtStr);</div>
<div class="line">            AiNodeSetArray(node, traceSetsStr, current_trace_set_array);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        AtArray* shaders = AiNodeGetArray(node, shaderStr);</div>
<div class="line">        uint32_t numShaders = AiArrayGetNumElements(shaders);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">for</span> (uint32_t i = 0; i &lt; numShaders; i++) {</div>
<div class="line">            AtNode* shader = (AtNode*)AiArrayGetPtr(shaders, i);</div>
<div class="line">            <span class="keywordflow">if</span> (shader == NULL || AiNodeIs(shader, PresenZShader) || AiNodeIs(shader, PresenZVolumeShader)) {</div>
<div class="line">                <span class="keywordflow">continue</span>;</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="comment">// Got all the renders stalling with 5.4.3.1. (maya2024) arnoldSpreingAov.ma res 360x240 </span></div>
<div class="line">            <span class="comment">// Got only one stall over 6 renderings with 5.5.1 (maya2025) </span></div>
<div class="line">            parentNode = <span class="keyword">nullptr</span>; <span class="comment">// prevents stallings  </span></div>
<div class="line"></div>
<div class="line">            std::string newName = addPzPrefixToLastToken(std::string(AiNodeGetName(shader)));</div>
<div class="line">            AtString newNameStr = AtString(newName.c_str());</div>
<div class="line">            AtNode* AOVShader = AiNodeLookUpByName(universe, newNameStr, parentNode);</div>
<div class="line">            <span class="keywordflow">if</span> (AOVShader == NULL) {</div>
<div class="line">                <span class="keywordflow">if</span> (AiNodeEntryGetDerivedType(nentry) == AI_NODE_SHAPE_VOLUME || step_size != 0.0) {</div>
<div class="line">                    AOVShader = AiNode(universe, PresenZVolumeShader, newNameStr, parentNode);</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">else</span> {</div>
<div class="line">                    AOVShader = AiNode(universe, PresenZShader, newNameStr, parentNode);</div>
<div class="line">                }</div>
<div class="line">                </div>
<div class="line">                AiNodeLink(shader, <span class="stringliteral">&quot;beauty&quot;</span>, AOVShader);</div>
<div class="line">                <span class="comment">//if (glassMaterial) {</span></div>
<div class="line">                    <span class="comment">//AiNodeSetRGB(AOVShader, opacityStr, 0.5, 0.5, 0.5);</span></div>
<div class="line">                <span class="comment">//}</span></div>
<div class="line">            }</div>
<div class="line">            AiArraySetPtr(shaders, i, AOVShader);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
</div><!-- fragment --><h1>10.8 Geometry Procedural</h1>
<div class="fragment"><div class="line"><span class="comment">// VRRender.cpp : Defines the entry point for the console application.</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;sstream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;iomanip&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &quot;ai.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;vrutils.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;underscan.h&quot;</span></div>
<div class="line"></div>
<div class="line">AI_PROCEDURAL_NODE_EXPORT_METHODS(PrzGeometryMtd);</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">// Procedural parameters</span></div>
<div class="line"><span class="keyword">struct </span>PrzGeom</div>
<div class="line">{</div>
<div class="line">    std::string file;</div>
<div class="line">    AtUniverse* universe;     <span class="comment">// Universe to add the point shape to</span></div>
<div class="line">    std::vector&lt;AtNode*&gt; nodes;</div>
<div class="line"></div>
<div class="line">};</div>
<div class="line"></div>
<div class="line">node_parameters</div>
<div class="line">{</div>
<div class="line">   AiParameterStr(<span class="stringliteral">&quot;prz_file&quot;</span>        , <span class="stringliteral">&quot;in.####.przRender&quot;</span>);</div>
<div class="line">   AiMetaDataSetStr(nentry, <span class="stringliteral">&quot;prz_file&quot;</span>, <span class="stringliteral">&quot;path&quot;</span>, <span class="stringliteral">&quot;file&quot;</span>);</div>
<div class="line"></div>
<div class="line">   AiParameterInt(<span class="stringliteral">&quot;frame&quot;</span>, 0);</div>
<div class="line">   AiMetaDataSetBool(nentry, <span class="stringliteral">&quot;frame&quot;</span>, <span class="stringliteral">&quot;linkable&quot;</span>, <span class="keyword">true</span>);</div>
<div class="line">   </div>
<div class="line">   AiMetaDataSetBool(nentry, NULL, <span class="stringliteral">&quot;maya.procedural&quot;</span>, <span class="keyword">true</span>);</div>
<div class="line"></div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">std::string replaceHashesWithNumber(<span class="keyword">const</span> std::string&amp; path, <span class="keywordtype">int</span> number) {</div>
<div class="line">    std::string result = path;</div>
<div class="line">    <span class="keywordtype">size_t</span> pos = result.find(<span class="charliteral">&#39;#&#39;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">while</span> (pos != std::string::npos) {</div>
<div class="line">        <span class="keywordtype">size_t</span> endPos = pos;</div>
<div class="line">        <span class="keywordflow">while</span> (endPos &lt; result.size() &amp;&amp; result[endPos] == <span class="charliteral">&#39;#&#39;</span>) {</div>
<div class="line">            ++endPos;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="keywordtype">size_t</span> hashCount = endPos - pos; <span class="comment">// Count the number of # characters</span></div>
<div class="line">        std::ostringstream ss;</div>
<div class="line">        ss &lt;&lt; std::setw(hashCount) &lt;&lt; std::setfill(<span class="charliteral">&#39;0&#39;</span>) &lt;&lt; number;</div>
<div class="line"></div>
<div class="line">        result.replace(pos, hashCount, ss.str());</div>
<div class="line"></div>
<div class="line">        pos = result.find(<span class="charliteral">&#39;#&#39;</span>, pos + ss.str().size());</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> result;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">procedural_init</div>
<div class="line">{</div>
<div class="line">    PrzGeom* przGeom = <span class="keyword">new</span> PrzGeom();</div>
<div class="line">    *user_ptr = przGeom;</div>
<div class="line"></div>
<div class="line">   <span class="comment">// get the universe this procedural belongs to, and use it create all ginstances</span></div>
<div class="line">    przGeom-&gt;universe = AiNodeGetUniverse(node);</div>
<div class="line"></div>
<div class="line">    AtString filePath = AiNodeGetStr(node, AtString(<span class="stringliteral">&quot;prz_file&quot;</span>));</div>
<div class="line"></div>
<div class="line">    std::string filePathNumber = replaceHashesWithNumber(filePath.c_str(), AiNodeGetInt(node, AtString(<span class="stringliteral">&quot;frame&quot;</span>)));</div>
<div class="line">    </div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (PresenZ::BinIO::isPrzRender(filePathNumber.c_str())) {</div>
<div class="line">        przGeom-&gt;file = filePathNumber;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> {</div>
<div class="line">        AiMsgWarning(<span class="stringliteral">&quot;[PresenZ - Geometry] %s is not a valid przRender file.&quot;</span>, filePathNumber.c_str());</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">    AtNode* shader = (AtNode*)AiNodeGetPtr(node, AtString(<span class="stringliteral">&quot;shader&quot;</span>));</div>
<div class="line">    AtNode* matteShader = NULL;</div>
<div class="line">    <span class="keywordflow">if</span> (shader == NULL || std::string(AiNodeGetName(shader)) == <span class="stringliteral">&quot;ai_default_reflection_shader&quot;</span>) {</div>
<div class="line">        AiMsgInfo(<span class="stringliteral">&quot;[PresenZ - Geometry] Creating shader&quot;</span>);</div>
<div class="line">        </div>
<div class="line">        std::string matteName = <span class="stringliteral">&quot;Pz_Matte_&quot;</span> + std::string(AiNodeGetName(node));</div>
<div class="line">        std::string uDataName = <span class="stringliteral">&quot;Pz_user_data_rgba_&quot;</span> + std::string(AiNodeGetName(node));</div>
<div class="line"></div>
<div class="line">        matteShader = AiNode(przGeom-&gt;universe, AtString(<span class="stringliteral">&quot;matte&quot;</span>), AtString(matteName.c_str()), node);</div>
<div class="line">        AtNode* uDataShader = AiNode(przGeom-&gt;universe, AtString(<span class="stringliteral">&quot;user_data_rgba&quot;</span>), AtString(uDataName.c_str()), node);</div>
<div class="line">        AiNodeSetStr(uDataShader, AtString(<span class="stringliteral">&quot;attribute&quot;</span>), AtString(<span class="stringliteral">&quot;Cd&quot;</span>));</div>
<div class="line"></div>
<div class="line">        AiNodeLink(uDataShader, AtString(<span class="stringliteral">&quot;color&quot;</span>), matteShader);</div>
<div class="line">        AiNodeLinkOutput(uDataShader, AtString(<span class="stringliteral">&quot;a&quot;</span>), matteShader, AtString(<span class="stringliteral">&quot;opacity&quot;</span>));</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">        </div>
<div class="line"></div>
<div class="line">        przGeom-&gt;nodes.push_back(matteShader);</div>
<div class="line">        przGeom-&gt;nodes.push_back(uDataShader);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line">    </div>
<div class="line"></div>
<div class="line">    PresenZ::BinIO::PRZFILEDATA przRenderData;</div>
<div class="line">    PresenZ::BinIO::PRZDATAHEADER przHeader;</div>
<div class="line">    int32_t hashValue;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (przGeom-&gt;file.empty())</div>
<div class="line">        <span class="keywordflow">return</span> NULL;</div>
<div class="line"></div>
<div class="line">    PresenZ::BinIO::PrzReaderError err = przReader(przGeom-&gt;file.c_str(), przHeader, przRenderData, hashValue);</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">size_t</span> numPts = przHeader.sampleNums;</div>
<div class="line"></div>
<div class="line">    PresenZ::Camera::TCameraInfos orderedCameras = PresenZ::Camera::getCameras();</div>
<div class="line">    PresenZ::Camera::TCameraViewInfos cameraInfos;</div>
<div class="line">    cameraInfos.initFromHeader(przHeader.cameras, przHeader.CamToWorld, przHeader.globalScale, przHeader.boxScale, przHeader.camOffset[0], przHeader.camOffset[1], przHeader.camOffset[2]);</div>
<div class="line">    RenderingContext r(cameraInfos, przHeader.widthDisplay, przHeader.heightDisplay, 0.25f, przHeader.underscansFactors);</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">    AtArray* a_nsides = AiArrayAllocate(numPts, 1, AI_TYPE_UINT);</div>
<div class="line">    AtArray* a_vidx = AiArrayAllocate(numPts * 4, 1, AI_TYPE_UINT);</div>
<div class="line">    AtArray* a_nidxs = AiArrayAllocate(numPts * 4, 1, AI_TYPE_UINT);</div>
<div class="line">    AtArray* a_vlist = AiArrayAllocate(numPts * 4, 2, AI_TYPE_VECTOR);</div>
<div class="line">    AtArray* a_nlist = AiArrayAllocate(numPts * 4, 2, AI_TYPE_VECTOR);</div>
<div class="line">    AtArray* a_colors = AiArrayAllocate(numPts, 1, AI_TYPE_RGBA);</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">    <span class="comment">//przRenderData.render.left_eye.a</span></div>
<div class="line"></div>
<div class="line">    <span class="keyword">auto</span> renderData = przRenderData.render.data.getcamNumSizeExpValues();</div>
<div class="line">    <span class="keyword">auto</span> renderXYData = przRenderData.render.data.getPositionXYValues();</div>
<div class="line"></div>
<div class="line">    std::vector&lt;AtVector&gt; pos_first_key(numPts * 4);</div>
<div class="line">    std::vector&lt;AtVector&gt; pos_second_key(numPts * 4);</div>
<div class="line"></div>
<div class="line">    std::vector&lt;AtVector&gt; normal_key(numPts * 4);</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#pragma omp parallel</span></div>
<div class="line"><span class="preprocessor"></span>    {</div>
<div class="line"><span class="preprocessor">#pragma omp for nowait</span></div>
<div class="line"><span class="preprocessor"></span>        <span class="keywordflow">for</span> (<span class="keywordtype">long</span> i = 0; i &lt; numPts; i++) {</div>
<div class="line"></div>
<div class="line">            AiArraySetUInt(a_nsides, i, 4);</div>
<div class="line"></div>
<div class="line">            TMainPoints mainPoints;</div>
<div class="line">            <a class="code" href="struct_noz_point.html">NozVector</a> center;</div>
<div class="line">            <a class="code" href="struct_noz_point.html">NozVector</a> normal(przRenderData.render.data.normalX[i], przRenderData.render.data.normalY[i], przRenderData.render.data.normalZ[i]);</div>
<div class="line"></div>
<div class="line">            GetPlaqueMainPoints(r, renderData[i].cam,</div>
<div class="line">                renderXYData.first[i], renderXYData.second[i],</div>
<div class="line">                normal, przRenderData.render.data.z[i], 1, 1, renderData[i].expSize, 1.0f, mainPoints, center);</div>
<div class="line"></div>
<div class="line">            <span class="keyword">const</span> <a class="code" href="struct_noz_point.html">NozVector</a>&amp; p1 = mainPoints[DownLeft];</div>
<div class="line">            <span class="keyword">const</span> <a class="code" href="struct_noz_point.html">NozVector</a>&amp; p2 = mainPoints[DownRight];</div>
<div class="line">            <span class="keyword">const</span> <a class="code" href="struct_noz_point.html">NozVector</a>&amp; p3 = mainPoints[UpRight];</div>
<div class="line">            <span class="keyword">const</span> <a class="code" href="struct_noz_point.html">NozVector</a>&amp; p4 = mainPoints[UpLeft];</div>
<div class="line"></div>
<div class="line">            <span class="keyword">const</span> AtRGBA color(przRenderData.render.left_eye.r[i], przRenderData.render.left_eye.g[i], przRenderData.render.left_eye.b[i], przRenderData.render.left_eye.a[i]);</div>
<div class="line"></div>
<div class="line">            <span class="comment">// Each quad will have its own set of 4 vertices, so we start from i*4</span></div>
<div class="line">            <span class="keywordtype">size_t</span> baseIdx = i * 4;</div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> j = 0; j &lt; 4; j++) {</div>
<div class="line">                AiArraySetUInt(a_vidx, baseIdx + j, baseIdx + j);</div>
<div class="line">                AiArraySetUInt(a_nidxs, baseIdx + j, baseIdx + j);</div>
<div class="line"></div>
<div class="line">                normal_key[baseIdx + j] = AtVector(normal.x, normal.y, normal.z);</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">            <span class="comment">// Set vertex coordinates and normals</span></div>
<div class="line">            pos_first_key[baseIdx + 0] = AtVector(p1.<a class="code" href="struct_noz_point.html#ad0da36b2558901e21e7a30f6c227a45e">x</a>, p1.<a class="code" href="struct_noz_point.html#aa4f0d3eebc3c443f9be81bf48561a217">y</a>, p1.<a class="code" href="struct_noz_point.html#af73583b1e980b0aa03f9884812e9fd4d">z</a>);</div>
<div class="line">            pos_first_key[baseIdx + 1] = AtVector(p2.<a class="code" href="struct_noz_point.html#ad0da36b2558901e21e7a30f6c227a45e">x</a>, p2.<a class="code" href="struct_noz_point.html#aa4f0d3eebc3c443f9be81bf48561a217">y</a>, p2.<a class="code" href="struct_noz_point.html#af73583b1e980b0aa03f9884812e9fd4d">z</a>);</div>
<div class="line">            pos_first_key[baseIdx + 2] = AtVector(p3.<a class="code" href="struct_noz_point.html#ad0da36b2558901e21e7a30f6c227a45e">x</a>, p3.<a class="code" href="struct_noz_point.html#aa4f0d3eebc3c443f9be81bf48561a217">y</a>, p3.<a class="code" href="struct_noz_point.html#af73583b1e980b0aa03f9884812e9fd4d">z</a>);</div>
<div class="line">            pos_first_key[baseIdx + 3] = AtVector(p4.<a class="code" href="struct_noz_point.html#ad0da36b2558901e21e7a30f6c227a45e">x</a>, p4.<a class="code" href="struct_noz_point.html#aa4f0d3eebc3c443f9be81bf48561a217">y</a>, p4.<a class="code" href="struct_noz_point.html#af73583b1e980b0aa03f9884812e9fd4d">z</a>);</div>
<div class="line"></div>
<div class="line">            <span class="keywordtype">float</span> velocityX = przRenderData.render.data.velocityX[i];</div>
<div class="line">            <span class="keywordtype">float</span> velocityY = przRenderData.render.data.velocityY[i];</div>
<div class="line">            <span class="keywordtype">float</span> velocityZ = przRenderData.render.data.velocityZ[i];</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> (isnan(velocityX)</div>
<div class="line">                || isnan(velocityY)</div>
<div class="line">                || isnan(velocityZ)</div>
<div class="line">                || isinf(velocityX)</div>
<div class="line">                || isinf(velocityY)</div>
<div class="line">                || isinf(velocityZ)</div>
<div class="line">            ) {</div>
<div class="line">                velocityX = 0;</div>
<div class="line">                velocityY = 0;</div>
<div class="line">                velocityZ = 0;</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            pos_second_key[baseIdx + 0] = AtVector(p1.<a class="code" href="struct_noz_point.html#ad0da36b2558901e21e7a30f6c227a45e">x</a> + velocityX, p1.<a class="code" href="struct_noz_point.html#aa4f0d3eebc3c443f9be81bf48561a217">y</a> + velocityY, p1.<a class="code" href="struct_noz_point.html#af73583b1e980b0aa03f9884812e9fd4d">z</a> + velocityZ);</div>
<div class="line">            pos_second_key[baseIdx + 1] = AtVector(p2.<a class="code" href="struct_noz_point.html#ad0da36b2558901e21e7a30f6c227a45e">x</a> + velocityX, p2.<a class="code" href="struct_noz_point.html#aa4f0d3eebc3c443f9be81bf48561a217">y</a> + velocityY, p2.<a class="code" href="struct_noz_point.html#af73583b1e980b0aa03f9884812e9fd4d">z</a> + velocityZ);</div>
<div class="line">            pos_second_key[baseIdx + 2] = AtVector(p3.<a class="code" href="struct_noz_point.html#ad0da36b2558901e21e7a30f6c227a45e">x</a> + velocityX, p3.<a class="code" href="struct_noz_point.html#aa4f0d3eebc3c443f9be81bf48561a217">y</a> + velocityY, p3.<a class="code" href="struct_noz_point.html#af73583b1e980b0aa03f9884812e9fd4d">z</a> + velocityZ);</div>
<div class="line">            pos_second_key[baseIdx + 3] = AtVector(p4.<a class="code" href="struct_noz_point.html#ad0da36b2558901e21e7a30f6c227a45e">x</a> + velocityX, p4.<a class="code" href="struct_noz_point.html#aa4f0d3eebc3c443f9be81bf48561a217">y</a> + velocityY, p4.<a class="code" href="struct_noz_point.html#af73583b1e980b0aa03f9884812e9fd4d">z</a> + velocityZ);</div>
<div class="line"></div>
<div class="line">            AiArraySetRGBA(a_colors, i, color);</div>
<div class="line"></div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    AiArraySetKey(a_vlist, 0, pos_first_key.data());</div>
<div class="line">    AiArraySetKey(a_vlist, 1, pos_second_key.data());</div>
<div class="line"></div>
<div class="line">    AiArraySetKey(a_nlist, 0, normal_key.data());</div>
<div class="line">    AiArraySetKey(a_nlist, 1, normal_key.data());</div>
<div class="line"></div>
<div class="line">    <span class="comment">// create node with procedural node as parent</span></div>
<div class="line">    AtNode* geometry_node = AiNode(przGeom-&gt;universe, AtString(<span class="stringliteral">&quot;polymesh&quot;</span>), AtString(<span class="stringliteral">&quot;przGeom&quot;</span>), node);</div>
<div class="line">    AiNodeSetArray(geometry_node, AtString(<span class="stringliteral">&quot;nsides&quot;</span>), a_nsides);</div>
<div class="line">    AiNodeSetArray(geometry_node, AtString(<span class="stringliteral">&quot;vidxs&quot;</span>), a_vidx);</div>
<div class="line">    AiNodeSetArray(geometry_node, AtString(<span class="stringliteral">&quot;nidxs&quot;</span>), a_nidxs);</div>
<div class="line">    AiNodeSetArray(geometry_node, AtString(<span class="stringliteral">&quot;vlist&quot;</span>), a_vlist);</div>
<div class="line">    AiNodeSetArray(geometry_node, AtString(<span class="stringliteral">&quot;nlist&quot;</span>), a_nlist);</div>
<div class="line"></div>
<div class="line">    AiNodeDeclare(geometry_node, AtString(<span class="stringliteral">&quot;Cd&quot;</span>), <span class="stringliteral">&quot;uniform RGBA&quot;</span>);</div>
<div class="line">    AiNodeSetArray(geometry_node, AtString(<span class="stringliteral">&quot;Cd&quot;</span>), a_colors);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span>(matteShader != NULL)</div>
<div class="line">        AiNodeSetPtr(geometry_node, AtString(<span class="stringliteral">&quot;shader&quot;</span>), matteShader);</div>
<div class="line"></div>
<div class="line">    przGeom-&gt;nodes.push_back(geometry_node);</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">procedural_cleanup</div>
<div class="line">{</div>
<div class="line">   PrzGeom* przGeom = (PrzGeom*)user_ptr;</div>
<div class="line">   <span class="keyword">delete</span> przGeom;</div>
<div class="line">   <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">procedural_num_nodes</div>
<div class="line">{</div>
<div class="line">    PrzGeom* przGeom = (PrzGeom*)user_ptr;</div>
<div class="line">    <span class="keywordflow">return</span> przGeom-&gt;nodes.size();</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">procedural_get_node</div>
<div class="line">{</div>
<div class="line">   PrzGeom* przGeom = (PrzGeom*)user_ptr;</div>
<div class="line">   <span class="keywordflow">return</span> przGeom-&gt;nodes[i];</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">node_loader</div>
<div class="line">{</div>
<div class="line">   <span class="keywordflow">if</span> (i &gt; 0)</div>
<div class="line">      <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"></div>
<div class="line">   node-&gt;methods = PrzGeometryMtd;</div>
<div class="line">   node-&gt;output_type = AI_TYPE_NONE;</div>
<div class="line">   node-&gt;name = <span class="stringliteral">&quot;prz_geometry&quot;</span>;</div>
<div class="line">   node-&gt;node_type = AI_NODE_SHAPE_PROCEDURAL;</div>
<div class="line">   strcpy(node-&gt;version, AI_VERSION);</div>
<div class="line"></div>
<div class="line">   <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
</div><!-- fragment --><h1>10.9 Loader</h1>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;ai.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;cstdio&gt;</span></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keyword">extern</span> <span class="keyword">const</span> AtNodeMethods* PresenZCameraMethods;</div>
<div class="line"><span class="keyword">extern</span> <span class="keyword">const</span> AtNodeMethods* nozPresenZDriverMethods;</div>
<div class="line"><span class="keyword">extern</span> <span class="keyword">const</span> AtNodeMethods* PresenZShaderMtd;</div>
<div class="line"><span class="keyword">extern</span> <span class="keyword">const</span> AtNodeMethods* PresenZOperatorMethods;</div>
<div class="line"><span class="keyword">extern</span> <span class="keyword">const</span> AtNodeMethods* PresenZFilterMethods;</div>
<div class="line"><span class="keyword">extern</span> <span class="keyword">const</span> AtNodeMethods* PresenZPostAOVShaderMethods;</div>
<div class="line"><span class="keyword">extern</span> <span class="keyword">const</span> AtNodeMethods* PresenZOperatorShadersMethods;</div>
<div class="line"><span class="keyword">extern</span> <span class="keyword">const</span> AtNodeMethods* PresenZVolumeShaderMtd;</div>
<div class="line"></div>
<div class="line"><span class="keyword">enum</span>{</div>
<div class="line">   PRESENZ_CAMERA = 0,</div>
<div class="line">   PRESENZ_DRIVER = 1,</div>
<div class="line">   PRESENZ_SHADER = 2,</div>
<div class="line">   PRESENZ_OPERATOR = 3,</div>
<div class="line">   PRESENZ_FILTER = 4,</div>
<div class="line">   PRESENZ_POST_AOV_SHADER = 5,</div>
<div class="line">   PRESENZ_OPERATOR_SHADERS = 6,</div>
<div class="line">   PRESENZ_VOLUME_SHADER = 7</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="comment">// plugin initialization callback for Arnold.</span></div>
<div class="line">node_loader</div>
<div class="line">{</div>
<div class="line">   <span class="keywordflow">switch</span> (i)</div>
<div class="line">   {</div>
<div class="line">   <span class="keywordflow">case</span> PRESENZ_CAMERA:</div>
<div class="line">        node-&gt;methods = PresenZCameraMethods;</div>
<div class="line">        node-&gt;output_type = AI_TYPE_NONE;</div>
<div class="line">        node-&gt;name = <span class="stringliteral">&quot;presenz_camera&quot;</span>;</div>
<div class="line">        node-&gt;node_type = AI_NODE_CAMERA;</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">   <span class="keywordflow">case</span> PRESENZ_DRIVER:</div>
<div class="line">        node-&gt;methods = nozPresenZDriverMethods;</div>
<div class="line">        node-&gt;output_type = AI_TYPE_NONE;</div>
<div class="line">        node-&gt;name = <span class="stringliteral">&quot;presenz_driver&quot;</span>;</div>
<div class="line">        node-&gt;node_type = AI_NODE_DRIVER;</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">   <span class="keywordflow">case</span> PRESENZ_SHADER:</div>
<div class="line">        node-&gt;methods = PresenZShaderMtd;</div>
<div class="line">        node-&gt;output_type = AI_TYPE_CLOSURE;</div>
<div class="line">        node-&gt;name = <span class="stringliteral">&quot;presenz_shader&quot;</span>;</div>
<div class="line">        node-&gt;node_type = AI_NODE_SHADER;</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">   <span class="keywordflow">case</span> PRESENZ_POST_AOV_SHADER:</div>
<div class="line">       node-&gt;methods = PresenZPostAOVShaderMethods;</div>
<div class="line">       node-&gt;output_type = AI_TYPE_CLOSURE;</div>
<div class="line">       node-&gt;name = <span class="stringliteral">&quot;presenz_post_aov_shader&quot;</span>;</div>
<div class="line">       node-&gt;node_type = AI_NODE_SHADER;</div>
<div class="line">       <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">   <span class="keywordflow">case</span> PRESENZ_OPERATOR:</div>
<div class="line">       node-&gt;methods = PresenZOperatorMethods;</div>
<div class="line">       node-&gt;output_type = AI_TYPE_NONE;</div>
<div class="line">       node-&gt;name = <span class="stringliteral">&quot;presenz_operator&quot;</span>;</div>
<div class="line">       node-&gt;node_type = AI_NODE_OPERATOR;</div>
<div class="line">       <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">   <span class="keywordflow">case</span> PRESENZ_FILTER:</div>
<div class="line">       node-&gt;methods = PresenZFilterMethods;</div>
<div class="line">       node-&gt;output_type = AI_TYPE_NONE;</div>
<div class="line">       node-&gt;name = <span class="stringliteral">&quot;presenz_filter&quot;</span>;</div>
<div class="line">       node-&gt;node_type = AI_NODE_FILTER;</div>
<div class="line">       <span class="keywordflow">break</span>;</div>
<div class="line">   <span class="keywordflow">case</span> PRESENZ_OPERATOR_SHADERS:</div>
<div class="line">       node-&gt;methods = PresenZOperatorShadersMethods;</div>
<div class="line">       node-&gt;output_type = AI_TYPE_NONE;</div>
<div class="line">       node-&gt;name = <span class="stringliteral">&quot;presenz_operator_shaders&quot;</span>;</div>
<div class="line">       node-&gt;node_type = AI_NODE_OPERATOR;</div>
<div class="line">       <span class="keywordflow">break</span>;</div>
<div class="line">   <span class="keywordflow">case</span> PRESENZ_VOLUME_SHADER:</div>
<div class="line">       node-&gt;methods = PresenZVolumeShaderMtd;</div>
<div class="line">       node-&gt;output_type = AI_TYPE_CLOSURE;</div>
<div class="line">       node-&gt;name = <span class="stringliteral">&quot;presenz_volume_shader&quot;</span>;</div>
<div class="line">       node-&gt;node_type = AI_NODE_SHADER;</div>
<div class="line">       <span class="keywordflow">break</span>;</div>
<div class="line">   <span class="keywordflow">default</span>:</div>
<div class="line">      <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">   }</div>
<div class="line"></div>
<div class="line">   sprintf(node-&gt;version, AI_VERSION);</div>
<div class="line"></div>
<div class="line">   <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.5 </li>
  </ul>
</div>
</body>
</html>

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.5"/>
<title>PresenZ SDK: Buckets and Threading</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">PresenZ SDK
   &#160;<span id="projectnumber">4.1.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.5 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('md__home_presenz_jk_workspace__presen_z__s_d_k__linux_master@2_resources__s_d_k_manual_05-threading.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(11)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(12)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Buckets and Threading </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Modern renderers often try to take advantage of the numerous CPU cores available on recent computers. The usual method for that is to cut the image into small patches and assign them to available computing units (thread).</p>
<p>In practice: every little patch is assigned to a thread. Every sample processed in the patch will then be sent into “a bucket”. There is no threading safety around buckets as they are supposed to be accessed by only one thread at a time.</p>
<div class="image">
<img src="buckets.png" alt="buckets.png"/>
</div>
<p><a class="el" href="namespace_presen_z.html">PresenZ</a> is architectured around this concept: <a class="el" href="namespace_presen_z.html">PresenZ</a> expects the renderer to communicate when a bucket is initialized and when a bucket is finished. Depending on the phase being executed, buckets will be filled with PzDetectSamples or PzRenderSamples. <a class="el" href="namespace_presen_z.html">PresenZ</a> does not have special thread safety around its buckets either.</p>
<p>During bucket initialization, <a class="el" href="namespace_presen_z.html">PresenZ</a> expect a thread/bucket identifier (between 0 and N) and the target zone that is being rendered. After that, buckets can be accessed by the identifier or by the xy position on the final image.</p>
<pre class="fragment">void PzInitBucket(bucketId, topX, topY, bottomX, bottomY);
</pre><p>And similarly, when a bucket is finished,</p>
<pre class="fragment">bool PzProcessBucketFlushToFile(bucketId);
</pre><p>should be invoked.</p>
<h1>5.1 What if there’s no bucket system in your renderer</h1>
<p>It is possible that the renderer does not work with buckets. If this is the case, one solution is to divide the image into small patches and process each patch one by one. Set <a class="el" href="group___pz_phase_api.html#ga8f09a0e12853598d3b9dffa13b7227e2" title="Set the number of thread that will perform the rendering. ">PzSetThreadNumber()</a> to 1 and every time that a patch is completed, call <a class="el" href="group__bucket_a_p_i.html#gac89c51d8d00e9934052276ecd10f0eda" title="Initialize a bucket (attached to a bucketId) that will contain pixels for the Region [x0...">PzInitBucket()</a> / <a class="el" href="group__bucket_a_p_i.html#gaac96ec1f497d20deb0d2554355955175" title="Process the samples in the bucket into pixels and flush the result to the disk, returns true if succe...">PzProcessBucketFlushToFile()</a>.</p>
<p>If this solution is not possible either, then the only option remaining is to initialize a bucket with the same dimension as the render target resolution. It is recommended that you terminate and re-initialize the bucket at regular intervals so that you don’t end up having the full image in memory.</p>
<h1>5.2 Serializing buckets for distributed rendering</h1>
<p>As the patches are a natural subdivision of the total computational work, it is often the case that the work units are dispatched to other nodes on the network instead of CPU cores.</p>
<p>If this is the case, the final results of buckets need to be copied to and from memory in order to be communicated through the network.</p>
<p>First, you can request how much memory is needed to copy a bucket into a memory buffer.</p>
<pre class="fragment">int PzProcessBucketGetBufferSize(bucketId);
</pre><p>You can then allocate the correct amount of bytes and copy the bucket content into it with :</p>
<pre class="fragment">bool PzBucketFlushToMemory(bucketId, bufferSize, buffer);
</pre><p>And your buffer is ready to be sent.</p>
<p>Once the buffer is fully received on another machine, it can be processed with :</p>
<pre class="fragment">bool PzFlushMemoryBufferToFile(buffer, bufferSize);</pre> </div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.5 </li>
  </ul>
</div>
</body>
</html>

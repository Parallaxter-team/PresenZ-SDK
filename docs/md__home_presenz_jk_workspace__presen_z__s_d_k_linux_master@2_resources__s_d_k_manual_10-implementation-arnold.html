<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.5"/>
<title>PresenZ SDK: Implementation in Arnold</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">PresenZ SDK
   &#160;<span id="projectnumber">3.0.3</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.5 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('md__home_presenz_jk_workspace__presen_z__s_d_k_linux_master@2_resources__s_d_k_manual_10-implementation-arnold.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(11)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(12)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Implementation in Arnold </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Here is the implementation code for <a class="el" href="namespace_presen_z.html">PresenZ</a> inside SolidAngle Arnold.</p>
<h1>10.1 Camera</h1>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;ai.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;map&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;thread&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="_pz_camera_api_8h.html">API/PzCameraApi.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="_pz_assert_8h.html">API/PzAssert.h</a>&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &quot;arnoldWrapper.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;presenz_global_parameters.h&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">struct </span>FromRev {</div>
<div class="line">    FromRev() :rev(0) {}</div>
<div class="line">    FromRev(<span class="keyword">const</span> AtVector2&amp; s) {</div>
<div class="line">        rev = 1;</div>
<div class="line">        sx=s.x;</div>
<div class="line">        sy=s.y;</div>
<div class="line">    }</div>
<div class="line">    int8_t rev;</div>
<div class="line">    <span class="keywordtype">float</span> sx;</div>
<div class="line">    <span class="keywordtype">float</span> sy;</div>
<div class="line">};</div>
<div class="line"><span class="keyword">static</span> std::map&lt;std::thread::id, FromRev&gt; fromRevMap;</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line">AI_CAMERA_NODE_EXPORT_METHODS(PresenZMainCameraMethods)</div>
<div class="line"></div>
<div class="line">const AtCameraInput&amp; getCamInput(const AtCameraInput &amp;input) { <span class="keywordflow">return</span> input; }</div>
<div class="line">AtCameraOutput&amp; getCamOutput(AtCameraOutput &amp;output) { <span class="keywordflow">return</span> output; }</div>
<div class="line"></div>
<div class="line"><span class="keyword">enum</span> <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#a3104904c134a52357b85f763f6dfd48f">Eye</a></div>
<div class="line">{</div>
<div class="line">    <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#a3104904c134a52357b85f763f6dfd48fa4280d82f18d6dbafdeb68c811112455e">RC_Left</a> = 0,</div>
<div class="line">    <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#a3104904c134a52357b85f763f6dfd48fac2b22af1f16cebd2cc909767c763a713">RC_Right</a> = 1</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span>* rendering_eye_enum[] =</div>
<div class="line">{</div>
<div class="line">    <span class="stringliteral">&quot;left&quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;right&quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;leftThenRight&quot;</span>, <span class="comment">// usefull to comunicate with the python code which then trigger a left and a right if the user specify &quot;leftTheRight&quot;</span></div>
<div class="line">    NULL</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</div>
<div class="line"><span class="keyword">inline</span> T clamp(<span class="keyword">const</span> T&amp; u, <span class="keyword">const</span> T&amp; umin, <span class="keyword">const</span> T&amp; umax) { <span class="keywordflow">return</span>  (u &lt; umin ? umin : (u &gt; umax ? umax : u)); }</div>
<div class="line"></div>
<div class="line"><span class="keyword">struct </span>multiCamData_t</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">size_t</span> renderSizeX;</div>
<div class="line">    <span class="keywordtype">size_t</span> renderSizeY;</div>
<div class="line">    <span class="keywordtype">double</span> render_aspect;</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keyword">inline</span> multiCamData_t * GetLocalData(<span class="keyword">const</span> AtNode* node)</div>
<div class="line">{</div>
<div class="line">    multiCamData_t *data = (multiCamData_t*)AiNodeGetLocalData(node);</div>
<div class="line">    <span class="keywordflow">return</span> data;</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> camInitialize(AtNode* node, <span class="keywordtype">void</span> *data) {</div>
<div class="line"></div>
<div class="line">    AiCameraInitialize(node);</div>
<div class="line">    AiNodeSetLocalData(node, data);</div>
<div class="line"></div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">node_parameters</div>
<div class="line">{</div>
<div class="line">    AiParameterInt(<span class="stringliteral">&quot;multibox_offset_right&quot;</span>, 0);</div>
<div class="line">    AiParameterInt(<span class="stringliteral">&quot;multibox_offset_top&quot;</span>, 0);</div>
<div class="line">    AiParameterInt(<span class="stringliteral">&quot;multibox_offset_back&quot;</span>, 0);</div>
<div class="line">    AiParameterFlt(<span class="stringliteral">&quot;distance_to_ground&quot;</span>, 1.6);</div>
<div class="line">    AiParameterFlt(<span class="stringliteral">&quot;ipd&quot;</span>, 63.65);               <span class="comment">// male mean  64.7(mm) ; female mean 62.6(mm)</span></div>
<div class="line">    AiParameterBool(<span class="stringliteral">&quot;draft_mode&quot;</span>, <span class="keyword">false</span>);</div>
<div class="line">    AiParameterFlt(<span class="stringliteral">&quot;presenz_scene_scale&quot;</span>, 1.0f);</div>
<div class="line">    AiParameterBool(<span class="stringliteral">&quot;compute_motion_vector&quot;</span>, <span class="keyword">true</span>);</div>
<div class="line"></div>
<div class="line">    AiParameterVec(<span class="stringliteral">&quot;view_scale&quot;</span>, 1.0, 0.5, 1.0);</div>
<div class="line">    AiParameterVec(<span class="stringliteral">&quot;specular_point_offset&quot;</span>, 0.0, 0.0, 0.0);</div>
<div class="line">    AiParameterEnum(<span class="stringliteral">&quot;rendering_eye&quot;</span>, <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#a3104904c134a52357b85f763f6dfd48fa4280d82f18d6dbafdeb68c811112455e">Eye::RC_Left</a>, rendering_eye_enum);</div>
<div class="line">    AiParameterInt(<span class="stringliteral">&quot;render_inside_zov&quot;</span>, 0);</div>
<div class="line">    AiParameterBool(<span class="stringliteral">&quot;clipping_enable&quot;</span>, <span class="keyword">false</span>);</div>
<div class="line">    AiParameterVec(<span class="stringliteral">&quot;clipping_position&quot;</span>, 0.0, 0.0, 0.0);</div>
<div class="line">    AiParameterFlt(<span class="stringliteral">&quot;clipping_radius&quot;</span>, 100.0);</div>
<div class="line">    AiParameterBool(<span class="stringliteral">&quot;clipping_outside&quot;</span>, <span class="keyword">false</span>);</div>
<div class="line"></div>
<div class="line">    AiParameterFlt(<span class="stringliteral">&quot;ideal_point_size&quot;</span>, 0.1f);</div>
<div class="line"></div>
<div class="line">    AiParameterBool(<span class="stringliteral">&quot;enable_froxtrum&quot;</span>, <span class="keyword">true</span>);</div>
<div class="line">    AiParameterInt(<span class="stringliteral">&quot;froxtrum_depth&quot;</span>, 2);</div>
<div class="line"></div>
<div class="line">    AiParameterBool(<span class="stringliteral">&quot;block_range&quot;</span>, <span class="keyword">false</span>);</div>
<div class="line">    AiParameterInt(<span class="stringliteral">&quot;block_range_in&quot;</span>, 0);</div>
<div class="line">    AiParameterInt(<span class="stringliteral">&quot;block_range_out&quot;</span>, 0);</div>
<div class="line"></div>
<div class="line">    AiParameterBool(<span class="stringliteral">&quot;render_isolated&quot;</span>, <span class="keyword">false</span>);</div>
<div class="line">    AiParameterInt(<span class="stringliteral">&quot;stereo_right_eye&quot;</span>, 0);</div>
<div class="line"></div>
<div class="line">    AiParameterStr(<span class="stringliteral">&quot;window_shapes_file&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);</div>
<div class="line">    AiParameterInt(<span class="stringliteral">&quot;window_shape_index&quot;</span>, 0 );</div>
<div class="line">    AiParameterFlt(<span class="stringliteral">&quot;min_dist_to_screen&quot;</span>,100.0);</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line">    AiMetaDataSetStr(nentry, NULL, <span class="stringliteral">&quot;maya.translator&quot;</span>, <span class="stringliteral">&quot;przCamera&quot;</span>);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">node_initialize</div>
<div class="line">{</div>
<div class="line">    multiCamData_t* data = <span class="keyword">new</span> multiCamData_t();</div>
<div class="line">    camInitialize(node, data);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">node_update</div>
<div class="line">{</div>
<div class="line"></div>
<div class="line">    AiCameraUpdate(node, <span class="keyword">false</span>);</div>
<div class="line">    AiNodeSetFlt(node, <span class="stringliteral">&quot;shutter_start&quot;</span>, 0.0f);</div>
<div class="line">    AiNodeSetFlt(node, <span class="stringliteral">&quot;shutter_end&quot;</span>, 0.0f);</div>
<div class="line"></div>
<div class="line">    multiCamData_t *data = GetLocalData(node);</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#if AI_VERSION_ARCH_NUM &lt;= 6</span></div>
<div class="line"><span class="preprocessor"></span>    <span class="keyword">const</span> AtNode *option = AiUniverseGetOptions();</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>    <span class="keyword">const</span> AtNode *option = AiUniverseGetOptions(AiNodeGetUniverse(node));</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>    <span class="keyword">const</span> <span class="keywordtype">int</span> xres = AiNodeGetInt(option, <span class="stringliteral">&quot;xres&quot;</span>); </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">int</span> yres = AiNodeGetInt(option, <span class="stringliteral">&quot;yres&quot;</span>);</div>
<div class="line">    data-&gt;renderSizeX = xres;</div>
<div class="line">    data-&gt;renderSizeY = yres;</div>
<div class="line">    data-&gt;render_aspect = (double(xres) / double(yres));</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">node_finish</div>
<div class="line">{</div>
<div class="line">    multiCamData_t *data = GetLocalData(node);</div>
<div class="line">    <span class="keyword">delete</span> data;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">camera_reverse_ray</div>
<div class="line">{</div>
<div class="line">    multiCamData_t *data = GetLocalData(node);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// normalized direction</span></div>
<div class="line">    AtVector dir = AiV3Normalize(Po);</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">double</span> u, v;</div>
<div class="line">    <a class="code" href="group___pz_camera_api.html#ga7e29619a64903895a588a4a8ecd9b1c2">PresenZ::Camera::PzGetUVFromRay</a>(<a class="code" href="group___n_o_z__vector.html#ga347d85f3e636cf273a47949aa0613a8f">NozVector</a>(dir.x,dir.y,dir.z), u, v);</div>
<div class="line">    <span class="comment">// Calculate screen coordinates</span></div>
<div class="line">    Ps.x = (u*2.0)-1.0;</div>
<div class="line">    Ps.y = ((2.0*(-v+1))-1.0)/data-&gt;render_aspect;</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">     </div>
<div class="line">    <span class="comment">// This fonction is called by the to perform the arnold adaptativeSubdivision</span></div>
<div class="line">    <span class="comment">// while this is working, the others thread are still going on, casting rays.</span></div>
<div class="line"></div>
<div class="line">    <span class="comment">// &quot;camera_create_ray&quot; is directly caller imedialty after every call of &quot;camera_reverse_ray&quot;,     </span></div>
<div class="line">    <span class="comment">// so if fromrevers == 1 in the &quot;camera_create_ray&quot; scope we know fromrevers went through &quot;camera_reverse_ray&quot;</span></div>
<div class="line">    <span class="comment">// and this is going to be a subdiv ray so we wont consider this ray as a presenz ray. and we&#39;ll just do a standard cubeMap projection.</span></div>
<div class="line">    <span class="comment">// warning : in a case, dir(0.5,0.5,0.5) gives Ps=(-0.3333,0.0), The camera_create_ray(-0.3333,0.0) is never called after.</span></div>
<div class="line"></div>
<div class="line">    fromRevMap[std::this_thread::get_id()] = FromRev(Ps);</div>
<div class="line">    <span class="comment">//PZ_INFO(&quot;---&gt; %f %f %d rev \n&quot;,Ps.x,Ps.y, std::this_thread::get_id());</span></div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Get the camera origin/direction for each pixel on the image. This will query the information to PresenZ in turn.</span></div>
<div class="line">camera_create_ray</div>
<div class="line">{</div>
<div class="line"></div>
<div class="line">    multiCamData_t *data = GetLocalData(node);</div>
<div class="line">    <span class="keyword">const</span> AtCameraInput&amp; camInput = getCamInput(input);</div>
<div class="line">    AtCameraOutput&amp; camOutput = getCamOutput(output);</div>
<div class="line">    camOutput.dOdx = AI_V3_ZERO;</div>
<div class="line">    camOutput.dOdy = AI_V3_ZERO;</div>
<div class="line">    </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> uval = (1.0f + camInput.sx) / 2.0f;            <span class="comment">// -&gt; sx / sy in [-1,1]  range.</span></div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> pixelX = (uval)*data-&gt;renderSizeX;</div>
<div class="line"></div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> vval = 1.0f - ((1.0f + camInput.sy*data-&gt;render_aspect) / 2.0f); <span class="comment">// Not sure the multiplication by the render_aspect is necessary, since we are square and the value shoukld e 1....</span></div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> pixelY = (vval)*data-&gt;renderSizeY;</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">double</span> intpart;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> fractpartx = modf(pixelX, &amp;intpart);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> fractparty = modf(pixelY, &amp;intpart);</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">    <span class="keyword">const</span> std::thread::id this_id = std::this_thread::get_id();</div>
<div class="line">    <span class="comment">// see &quot;camera_reverse_ray&quot; </span></div>
<div class="line">    <span class="keywordflow">if</span> (fromRevMap[this_id].rev == 1 &amp;&amp; camInput.sx == fromRevMap[this_id].sx &amp;&amp; camInput.sy == fromRevMap[this_id].sy) {</div>
<div class="line">        <span class="comment">//PZ_INFO(&quot;---&gt; %f %f %d rray  *\n&quot;, camInput.sx, camInput.sy, this_id);</span></div>
<div class="line">        <a class="code" href="struct_presen_z_1_1_camera_1_1v3__0_1_1_pz_camera_ray.html">PresenZ::Camera::PzCameraRay</a> rayCtx = <a class="code" href="group___pz_camera_api.html#ga886f1b22774afe58b527b98b10e26c3a">PresenZ::Camera::PzGetSpecularRay</a>(pixelX, pixelY);</div>
<div class="line"></div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">float</span> dsx = 2.0 / (data-&gt;renderSizeX * 3.);  <span class="comment">// or (2/Rx)/3   </span></div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">float</span> dsy = 1.0 / data-&gt;renderSizeY;         <span class="comment">// or (2/Ry)/2</span></div>
<div class="line"></div>
<div class="line">        camOutput.dDdx = AtVectorFromNozPoint(rayCtx.<a class="code" href="struct_presen_z_1_1_camera_1_1v3__0_1_1_pz_camera_ray.html#a736153c8076e6040f9703e238e5b987c">dDdx</a> * dsx);</div>
<div class="line">        camOutput.dDdy = AtVectorFromNozPoint(rayCtx.<a class="code" href="struct_presen_z_1_1_camera_1_1v3__0_1_1_pz_camera_ray.html#aeb84bfd699fd4a7c535d38f19449e6b4">dDdy</a> * dsy);</div>
<div class="line">        camOutput.weight = AI_RGB_WHITE ;</div>
<div class="line">        camOutput.dir = AtVectorFromNozPoint(rayCtx.<a class="code" href="struct_presen_z_1_1_camera_1_1v3__0_1_1_pz_camera_ray.html#a7d4ae5b50b35b0b0e860ffe3192b05da">dir</a>);</div>
<div class="line">        camOutput.origin = AI_V3_ZERO;</div>
<div class="line">        camOutput.dOdx = AI_V3_ZERO;</div>
<div class="line">        camOutput.dOdy = AI_V3_ZERO;</div>
<div class="line"></div>
<div class="line">        fromRevMap[this_id].rev = 0;</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="comment">//PZ_INFO(&quot;---&gt; %f %f %d cray \n&quot;, camInput.sx, camInput.sy, this_id);</span></div>
<div class="line">    fromRevMap[this_id].rev = 0;</div>
<div class="line">    <span class="comment">// We need to force the AAseed to 170 during the detection phase because this is one of the seed pattern</span></div>
<div class="line">    <span class="comment">// that does not produce any border pixel sample at 16AA, that means we should be safe during the detection phase if we keep this seed. </span></div>
<div class="line">    <span class="comment">// on the other hand during the rendering phase, AA varies and the sampling varies with the AA. thus some samples may bleed and this produces flying particels.</span></div>
<div class="line">    <span class="comment">// to avoid that we are not throwing those samples ( because we won&#39;t be able to re-assign them to teh original pixel later on)</span></div>
<div class="line">    <span class="keywordflow">if</span> (PresenZ_data_struct::pass == <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#ae1c5184dc404edf057ed537bcfddef84ac677a954de25220db675695edacb4f71">PresenZ::Phase::Render</a>) {</div>
<div class="line">        <span class="keywordflow">if</span> (fractpartx &lt; 0.001 || fractpartx &gt; 0.999 || fractparty &lt; 0.001 || fractparty &gt; 0.999) {</div>
<div class="line">            <a class="code" href="group___pz_app_logger.html#ga57e4c432a80f1ffc8de1a41a42ac07d0">PZ_WARNING</a>(<span class="stringliteral">&quot;[Arnold][PresenZ][Camera] rejected samples too close to pixel edges.&quot;</span>);</div>
<div class="line">            camOutput.weight = AI_RGB_BLACK; <span class="comment">// Even if the ray is zero weighted;</span></div>
<div class="line">            camOutput.dDdx = AI_V3_ONE; <span class="comment">// nullifying derivatives</span></div>
<div class="line">            camOutput.dDdy = AI_V3_ONE; <span class="comment">// will NOT prevent the camera_create_ray function</span></div>
<div class="line">            camOutput.dir = AI_V3_ZERO; <span class="comment">// to be called again to compute derivatives.</span></div>
<div class="line">            camOutput.origin = AI_V3_ZERO;</div>
<div class="line">            <span class="keywordflow">return</span>;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    </div>
<div class="line"></div>
<div class="line">    <a class="code" href="struct_presen_z_1_1_camera_1_1v3__0_1_1_pz_camera_ray.html">PresenZ::Camera::PzCameraRay</a> rayCtx;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">int</span> x = <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(pixelX), y = static_cast&lt;int&gt;(pixelY);</div>
<div class="line">    rayCtx = <a class="code" href="group___pz_camera_api.html#ga2eb896736291c40c72f66d8a7591dc12">PresenZ::Camera::PzGetCameraRay</a>(x, y);</div>
<div class="line">    <span class="keywordflow">if</span> (rayCtx.<a class="code" href="struct_presen_z_1_1_camera_1_1v3__0_1_1_pz_camera_ray.html#aac1b70a2ed67ead038c4d3f5ac4d8a81">isValid</a>()) {</div>
<div class="line">        <span class="comment">// Theses 1.5 dsx dsy factors has been empiricaly found </span></div>
<div class="line">        <span class="comment">// and match the ones from the Arnold cube3x2map camera in 720x480</span></div>
<div class="line">        <span class="comment">// const float mydsx = 2.0 / ( double(data-&gt;renderSizeX) * 1.5 );      // should be equal Ai_dsx in input // but I dnt know where these 1.5 factors are comming from !!!</span></div>
<div class="line">        <span class="comment">// const float mydsy = (2.0 / ( double(data-&gt;renderSizeY) * 1.5 * 1.5)); // should be equal Ai_dsy in input // same</span></div>
<div class="line">        <span class="comment">// in order to get the same derivativ (or mipmap level) than the arnold cube map camera, we had to :</span></div>
<div class="line">        <span class="comment">// dsx = mydsx</span></div>
<div class="line">        <span class="comment">// dsy = mydsy * 1.5</span></div>
<div class="line">        <span class="comment">// then finaly dsy,dsy was equal to :</span></div>
<div class="line">        <span class="comment">// const float dsx = 4.0 / ( data-&gt;renderSizeX * 3.);</span></div>
<div class="line">        <span class="comment">// const float dsy = 4.0 / ( data-&gt;renderSizeY * 3 );</span></div>
<div class="line"></div>
<div class="line">        <span class="comment">// then we choose to take a 90deg perspectiva camera to set the derivative of our faces</span></div>
<div class="line">        <span class="comment">// this gives us</span></div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">float</span> dsx = 2.0 / (data-&gt;renderSizeX * 3.);  <span class="comment">// or (2/Rx)/3   </span></div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">float</span> dsy = 1.0 / data-&gt;renderSizeY;         <span class="comment">// or (2/Ry)/2</span></div>
<div class="line"></div>
<div class="line">        camOutput.dDdx = AtVectorFromNozPoint(rayCtx.<a class="code" href="struct_presen_z_1_1_camera_1_1v3__0_1_1_pz_camera_ray.html#a736153c8076e6040f9703e238e5b987c">dDdx</a>*dsx);</div>
<div class="line">        camOutput.dDdy = AtVectorFromNozPoint(rayCtx.<a class="code" href="struct_presen_z_1_1_camera_1_1v3__0_1_1_pz_camera_ray.html#aeb84bfd699fd4a7c535d38f19449e6b4">dDdy</a>*dsy);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> {</div>
<div class="line">        camOutput.dDdx = AI_V3_ONE; </div>
<div class="line">        camOutput.dDdy = AI_V3_ONE;</div>
<div class="line"></div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    camOutput.weight = rayCtx.<a class="code" href="struct_presen_z_1_1_camera_1_1v3__0_1_1_pz_camera_ray.html#aac1b70a2ed67ead038c4d3f5ac4d8a81">isValid</a>() ? AI_RGB_WHITE : AI_RGB_BLACK;</div>
<div class="line">    camOutput.dir = rayCtx.<a class="code" href="struct_presen_z_1_1_camera_1_1v3__0_1_1_pz_camera_ray.html#aac1b70a2ed67ead038c4d3f5ac4d8a81">isValid</a>() ? AtVectorFromNozPoint(rayCtx.<a class="code" href="struct_presen_z_1_1_camera_1_1v3__0_1_1_pz_camera_ray.html#a7d4ae5b50b35b0b0e860ffe3192b05da">dir</a>) : AI_V3_ZERO;</div>
<div class="line">    camOutput.origin = AtVectorFromNozPoint(rayCtx.<a class="code" href="struct_presen_z_1_1_camera_1_1v3__0_1_1_pz_camera_ray.html#a3e1a826396726caf4930542970259fef">origin</a>);</div>
<div class="line">}</div>
</div><!-- fragment --><h1>10.2 AOV shader</h1>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;arnoldWrapper.h&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="_pz_detect_sample_api_8h.html">API/PzDetectSampleApi.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="_pz_app_logger_8h.html">API/PzAppLogger.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="_pz_shading_api_8h.html">API/PzShadingApi.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;presenz_global_parameters.h&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">namespace</span></div>
<div class="line">{</div>
<div class="line">    <span class="keyword">enum</span> PresenZAOVsParams</div>
<div class="line">    {</div>
<div class="line">        p_beauty,</div>
<div class="line">    };</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line">AI_SHADER_NODE_EXPORT_METHODS(PresenZDetectAOVsMtd);</div>
<div class="line"></div>
<div class="line">node_parameters</div>
<div class="line">{</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span></div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">bool</span> renderIsolated;</div>
<div class="line">    <span class="keywordtype">float</span> maxDistance;</div>
<div class="line">    <span class="keywordtype">bool</span> hasEnv;</div>
<div class="line"></div>
<div class="line">} postShaderData;</div>
<div class="line"></div>
<div class="line"><span class="keyword">struct </span>ArnoldUserData</div>
<div class="line">{</div>
<div class="line">    ArnoldUserData(AtShaderGlobals *input) : sg(input), sgout(0), hasEnv(false), maxDist(0) {</div>
<div class="line">        sgout = AiShaderGlobals();</div>
<div class="line">    }</div>
<div class="line">    ~ArnoldUserData()</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">if</span> (sgout)</div>
<div class="line">        {</div>
<div class="line">            AiShaderGlobalsDestroy(sgout);</div>
<div class="line">            sgout = 0;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    AtShaderGlobals *sg;</div>
<div class="line">    AtShaderGlobals *sgout;</div>
<div class="line">    <span class="keywordtype">bool</span> hasEnv;</div>
<div class="line">    <span class="keywordtype">float</span> maxDist;</div>
<div class="line"></div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keyword">inline</span> <span class="keywordtype">void</span> setOut(AtShaderGlobals* sg, <span class="keyword">const</span> AtNode* node, PresenZAOVsParams p_beauty) { sg-&gt;out.CLOSURE() = AiShaderEvalParamClosure(p_beauty); }</div>
<div class="line"><span class="keyword">inline</span> <span class="keywordtype">void</span> setOutBlack(AtShaderGlobals* sg) { sg-&gt;out.RGBA() = AI_RGBA_ZERO; }</div>
<div class="line"><span class="keyword">inline</span> <span class="keywordtype">void</span> setOutWhite(AtShaderGlobals* sg) { sg-&gt;out.RGBA() = AI_RGBA_WHITE; }</div>
<div class="line"><span class="keyword">inline</span> uint8_t getRecursionLevel(AtShaderGlobals* sg) { <span class="keywordflow">return</span> sg-&gt;bounces; }</div>
<div class="line"><span class="keyword">inline</span> uint8_t getReflectionLevel(AtShaderGlobals* sg) { <span class="keywordflow">return</span> sg-&gt;bounces_reflect; }</div>
<div class="line"><span class="keyword">inline</span> uint8_t getRefractionLevel(AtShaderGlobals* sg) { <span class="keywordflow">return</span> sg-&gt;bounces_transmit; }</div>
<div class="line"><span class="keyword">inline</span> uint8_t getDiffractionLevel(AtShaderGlobals* sg) { <span class="keywordflow">return</span> sg-&gt;bounces_diffuse; }</div>
<div class="line"><span class="keyword">inline</span> uint8_t getGlossyLevel(AtShaderGlobals* sg) { <span class="keywordflow">return</span> sg-&gt;bounces_specular; }</div>
<div class="line"><span class="keyword">inline</span> <span class="keywordtype">void</span> setVelocityVec(AtShaderGlobals* sg) { AtVector P1; AiShaderGlobalsGetPositionAtTime(sg, 1.0f, P1, NULL, NULL, NULL); AiAOVSetVec(sg, velocityAtStr, AtVector(P1.x - sg-&gt;P.x, P1.y - sg-&gt;P.y, P1.z - sg-&gt;P.z)); }</div>
<div class="line"><span class="keyword">inline</span> <span class="keywordtype">void</span> setShaderGlobals(AtShaderGlobals* sg, uint8_t Rr, uint8_t Rr_refl, uint8_t Rr_refr, uint8_t Rr_diff, uint8_t Rr_gloss) { sg-&gt;bounces = Rr; sg-&gt;bounces_reflect = Rr_refl; sg-&gt;bounces_transmit = Rr_refr; sg-&gt;bounces_diffuse = Rr_diff; sg-&gt;bounces_specular = Rr_gloss; }</div>
<div class="line"><span class="keyword">inline</span> <span class="keywordtype">void</span> setGlassMaterialAOV(AtShaderGlobals* sg) { AiAOVSetBool(sg, przGlassAtStr, <span class="keyword">true</span>); }</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">bool</span> ArnoldHitTest(<span class="keyword">const</span> <a class="code" href="struct_noz_point.html">NozVector</a>&amp; origin, <span class="keyword">const</span> <a class="code" href="struct_noz_point.html">NozVector</a>&amp; dir, <span class="keyword">const</span> <span class="keywordtype">double</span> dist, <a class="code" href="struct_presen_z_1_1_detect_sample_1_1v3__0_1_1_ray_test_result.html">PresenZ::DetectSample::RayTestResult</a>&amp; out, <span class="keywordtype">void</span>* userData)</div>
<div class="line">{</div>
<div class="line">    ArnoldUserData&amp; context = *<span class="keyword">reinterpret_cast&lt;</span>ArnoldUserData*<span class="keyword">&gt;</span>(userData);</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">bool</span> hitOk = <span class="keyword">false</span>;</div>
<div class="line"></div>
<div class="line">    AtVector atOrigin = AtVectorFromNozVector(origin);</div>
<div class="line">    AtVector atDir = AtVectorFromNozVector(dir);</div>
<div class="line"></div>
<div class="line">    AiShaderGlobalsSetTraceSet(context.sg, przGlassAtStr, <span class="keyword">false</span>);</div>
<div class="line">    AtRay probe = AiMakeRay(AI_RAY_CAMERA, atOrigin, &amp;atDir, dist, context.sg);</div>
<div class="line">    hitOk = AiTraceProbe(probe, context.sgout);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (hitOk)</div>
<div class="line">    {</div>
<div class="line"></div>
<div class="line">        out.<a class="code" href="struct_presen_z_1_1_detect_sample_1_1v3__0_1_1_ray_test_result.html#a9d3ba7a09d203fbcadc59723666e37fe">hit</a> = NozVectorFromAiVector(context.sgout-&gt;P);</div>
<div class="line">        out.<a class="code" href="struct_presen_z_1_1_detect_sample_1_1v3__0_1_1_ray_test_result.html#a58649588b953a60c4ab3fb9b2143a87b">normal</a> = NozVectorFromAiVector(context.sgout-&gt;Ng);</div>
<div class="line">        out.<a class="code" href="struct_presen_z_1_1_detect_sample_1_1v3__0_1_1_ray_test_result.html#a873684cefeb665f3d5e6b495de57fc0d">d</a> = context.sgout-&gt;Rl;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (context.hasEnv)</div>
<div class="line">    {</div>
<div class="line">        hitOk = <span class="keyword">true</span>;</div>
<div class="line">        <a class="code" href="struct_noz_point.html">NozPoint</a> camPos = <a class="code" href="group___pz_phase_api.html#ga14ef4db9fbaa07463fb8c6eeb68f4a1e">PresenZ::Phase::PzGetZOVWorldPosition</a>();</div>
<div class="line"></div>
<div class="line">        std::vector&lt;float&gt; distances = hit_sphere(camPos, context.maxDist, dir, origin);</div>
<div class="line">        out.<a class="code" href="struct_presen_z_1_1_detect_sample_1_1v3__0_1_1_ray_test_result.html#a9d3ba7a09d203fbcadc59723666e37fe">hit</a> = origin + (dir * distances[0]);</div>
<div class="line">        out.<a class="code" href="struct_presen_z_1_1_detect_sample_1_1v3__0_1_1_ray_test_result.html#a58649588b953a60c4ab3fb9b2143a87b">normal</a> = <a class="code" href="group___n_o_z__vector.html#ga19bf5d776ee066f688d5432fe9ce257f">NozVecNormalize</a>(-dir);</div>
<div class="line">        out.<a class="code" href="struct_presen_z_1_1_detect_sample_1_1v3__0_1_1_ray_test_result.html#a873684cefeb665f3d5e6b495de57fc0d">d</a> = <a class="code" href="group___n_o_z__vector.html#gaec436ed5ffc599d804a9fd8fb464b70d">NozVecDist</a>(origin, out.<a class="code" href="struct_presen_z_1_1_detect_sample_1_1v3__0_1_1_ray_test_result.html#a9d3ba7a09d203fbcadc59723666e37fe">hit</a>);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> hitOk;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">uint64_t ArnoldQueryFlags(uint64_t flags, <span class="keywordtype">void</span>* userData)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">const</span> ArnoldUserData&amp; context = *<span class="keyword">reinterpret_cast&lt;</span><span class="keyword">const </span>ArnoldUserData*<span class="keyword">&gt;</span>(userData);</div>
<div class="line">    <span class="keywordtype">int</span> retval = 0;</div>
<div class="line">    <span class="keywordflow">if</span> (flags)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">if</span>(AiNodeIs(context.sg-&gt;Op, curveAtStr) || IsTaggedAsHair(context.sg))</div>
<div class="line">            retval += 1;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> retval;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">shader_evaluate</div>
<div class="line">{</div>
<div class="line"></div>
<div class="line">    postShaderData* data = (postShaderData*)AiNodeGetLocalData(node);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (PresenZ_data_struct::pass == <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#ae1c5184dc404edf057ed537bcfddef84a48a95ceab76284afa466622424eba555">PresenZ::Phase::Detect</a>)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// Early out if it&#39;s not a camera ray.</span></div>
<div class="line">        <span class="keywordflow">if</span> (!(sg-&gt;Rt &amp; AI_RAY_CAMERA))</div>
<div class="line">            <span class="keywordflow">return</span>;</div>
<div class="line"></div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">bool</span> isCurve = AiNodeIs(sg-&gt;Op, curveAtStr);</div>
<div class="line"></div>
<div class="line">        <span class="keyword">const</span> uint32_t faceIndex = sg-&gt;fi;</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">bool</span> hemi = sg-&gt;fhemi;</div>
<div class="line">        <span class="comment">//sg-&gt;fhemi = false;</span></div>
<div class="line">        </div>
<div class="line">        <span class="keywordflow">if</span>(!isCurve)</div>
<div class="line">            sg-&gt;fi = UINT32_MAX;</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">if</span> (sg-&gt;fi == 0)</div>
<div class="line">                sg-&gt;fi = sg-&gt;fi+1;</div>
<div class="line">            <span class="keywordflow">else</span></div>
<div class="line">                sg-&gt;fi = 0;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        ArnoldUserData userData(sg);</div>
<div class="line">        </div>
<div class="line">        </div>
<div class="line"></div>
<div class="line">        <a class="code" href="struct_presen_z_1_1_detect_sample_1_1v3__0_1_1_pz_detect_sample.html">PresenZ::DetectSample::PzDetectSample</a> sample;</div>
<div class="line">        sample.<a class="code" href="struct_presen_z_1_1_detect_sample_1_1v3__0_1_1_pz_detect_sample.html#a75f8ddf992db0cfc3cd1aa024086b6f3">pixelX</a> = sg-&gt;x;</div>
<div class="line">        sample.<a class="code" href="struct_presen_z_1_1_detect_sample_1_1v3__0_1_1_pz_detect_sample.html#aaa0423628e784003c3f5754ca1e56e70">pixelY</a> = sg-&gt;y;</div>
<div class="line">        sample.<a class="code" href="struct_presen_z_1_1_detect_sample_1_1v3__0_1_1_pz_detect_sample.html#a4c9257ffdd839b215aabfba5f05fa02e">hitNormal</a> = NozPointFromAiPoint(sg-&gt;Ng);</div>
<div class="line">        sample.<a class="code" href="struct_presen_z_1_1_detect_sample_1_1v3__0_1_1_pz_detect_sample.html#a39246df9bccc12078d74da138ecfbfa4">hitPoint</a> = NozPointFromAiPoint(sg-&gt;P);</div>
<div class="line">        <span class="comment">// The following line was valid with Arnold 4 but it is not necessarily true with Arnold 5</span></div>
<div class="line">        <span class="comment">// sample.sampleIndex = sg-&gt;si; </span></div>
<div class="line">        </div>
<div class="line">        <a class="code" href="group___pz_detect_sample_api.html#ga958fc98bb65f1c0cb1e28ec6f47b743f">PresenZ::DetectSample::PzMatchSampleIndex</a>(sample, NozPointFromAiPoint(sg-&gt;Ro));</div>
<div class="line">        <span class="comment">// so yup, this bad boy right above is there to recompute the sample index from the ray direction.</span></div>
<div class="line">        <span class="comment">// because apparently some indices trown from the camera doesn&#39;t come with the same number in the shader</span></div>
<div class="line">        <span class="comment">//</span></div>
<div class="line">        <span class="comment">// This might be due to the fact that before... some camera ray was not really trown to the scene but was just evaluated for the adaptiveSubdivision/displacement calculation </span></div>
<div class="line">        <span class="comment">// now these subdiv/disp ray are taken in account by PresenZ, so we&#39;are not wasting PresenZ ray and indices anymore. </span></div>
<div class="line">        </div>
<div class="line">        <span class="keywordflow">if</span> (IsTaggedAsHair(sg))</div>
<div class="line">        {</div>
<div class="line">            sample.<a class="code" href="struct_presen_z_1_1_detect_sample_1_1v3__0_1_1_pz_detect_sample.html#ad50b77be6452fcd203fa25771dd4f69e">isHair</a> = <span class="keyword">true</span>;</div>
<div class="line">            sample.<a class="code" href="struct_presen_z_1_1_detect_sample_1_1v3__0_1_1_pz_detect_sample.html#a4c9257ffdd839b215aabfba5f05fa02e">hitNormal</a> = <a class="code" href="struct_noz_point.html">NozPoint</a>(0.0f);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (IsTaggedAsGlass(sg) == <span class="keyword">true</span>)</div>
<div class="line">            sample.<a class="code" href="struct_presen_z_1_1_detect_sample_1_1v3__0_1_1_pz_detect_sample.html#ae89f8742850b3f5fb55f23ccf9a55d86">transpType</a> = <a class="code" href="namespace_presen_z_1_1_detect_sample_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#a4235bda2ada163773d83c4d1d6c75bc0ae0e0d5fadce4b0933385ee555c8f7a53">PresenZ::DetectSample::DST_glass</a>;</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (IsTaggedAsChaotic(sg) == <span class="keyword">true</span>)</div>
<div class="line">            sample.<a class="code" href="struct_presen_z_1_1_detect_sample_1_1v3__0_1_1_pz_detect_sample.html#a8a33ba6ff4f3da7799e33a2827f9d297">isChaotic</a> = <span class="keyword">true</span>;</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">bool</span> notisolated = (data-&gt;renderIsolated ) &amp;&amp; (!IsTaggedAsRenderIsolated(sg));</div>
<div class="line">        <span class="keywordflow">if</span> (notisolated) { <span class="comment">// not isolated And render isolated on... </span></div>
<div class="line">            <span class="keywordflow">return</span>;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">        <span class="comment">//const AtNodeEntry* entry = AiNodeGetNodeEntry(sg-&gt;Op);</span></div>
<div class="line">        <span class="keywordflow">if</span>(sg-&gt;Rl &gt;= data-&gt;maxDistance)</div>
<div class="line">        {</div>
<div class="line">            <a class="code" href="struct_noz_point.html">NozPoint</a> camPos = <a class="code" href="group___pz_phase_api.html#ga14ef4db9fbaa07463fb8c6eeb68f4a1e">PresenZ::Phase::PzGetZOVWorldPosition</a>();</div>
<div class="line">            <a class="code" href="struct_noz_point.html">NozVector</a> rayDir(sg-&gt;Rd.x, sg-&gt;Rd.y, sg-&gt;Rd.z);</div>
<div class="line">            <a class="code" href="struct_noz_point.html">NozVector</a> rayOrigin = NozPointFromAiPoint(sg-&gt;Ro);</div>
<div class="line">            std::vector&lt;float&gt; distances = hit_sphere(camPos, data-&gt;maxDistance, rayDir, rayOrigin);</div>
<div class="line">            sample.<a class="code" href="struct_presen_z_1_1_detect_sample_1_1v3__0_1_1_pz_detect_sample.html#a39246df9bccc12078d74da138ecfbfa4">hitPoint</a> = rayOrigin + (rayDir * distances[0]);</div>
<div class="line">            sample.<a class="code" href="struct_presen_z_1_1_detect_sample_1_1v3__0_1_1_pz_detect_sample.html#a4c9257ffdd839b215aabfba5f05fa02e">hitNormal</a> = -rayDir;</div>
<div class="line">            userData.hasEnv = <span class="keyword">true</span>;</div>
<div class="line">            userData.maxDist = data-&gt;maxDistance;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <a class="code" href="struct_presen_z_1_1_detect_sample_1_1v3__0_1_1_ray_test_interface.html">PresenZ::DetectSample::RayTestInterface</a> probe = { &amp;userData, ArnoldHitTest, ArnoldQueryFlags };</div>
<div class="line">        <a class="code" href="group___pz_detect_sample_api.html#gac6410e7ecfb3cf5a078a69240fc33ea8">PresenZ::DetectSample::PzProcessDetectSample</a>(&amp;probe, sample, sg-&gt;tid);</div>
<div class="line"></div>
<div class="line">        sg-&gt;fhemi = hemi;</div>
<div class="line">        sg-&gt;fi = faceIndex;</div>
<div class="line">      </div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (PresenZ_data_struct::pass == <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#ae1c5184dc404edf057ed537bcfddef84a9e72290cbba5243f4449f84168a3c99c">PresenZ::Phase::Detect_Reflection</a>)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// Early out if it&#39;s not a camera ray.</span></div>
<div class="line">        <span class="keywordflow">if</span> (!(sg-&gt;Rt &amp; AI_RAY_CAMERA))</div>
<div class="line">            <span class="keywordflow">return</span>;</div>
<div class="line"></div>
<div class="line">        <a class="code" href="struct_presen_z_1_1_detect_sample_1_1v3__0_1_1_pz_detect_sample.html">PresenZ::DetectSample::PzDetectSample</a> sample;</div>
<div class="line">        sample.<a class="code" href="struct_presen_z_1_1_detect_sample_1_1v3__0_1_1_pz_detect_sample.html#a75f8ddf992db0cfc3cd1aa024086b6f3">pixelX</a> = sg-&gt;x;</div>
<div class="line">        sample.<a class="code" href="struct_presen_z_1_1_detect_sample_1_1v3__0_1_1_pz_detect_sample.html#aaa0423628e784003c3f5754ca1e56e70">pixelY</a> = sg-&gt;y;</div>
<div class="line">        sample.<a class="code" href="struct_presen_z_1_1_detect_sample_1_1v3__0_1_1_pz_detect_sample.html#a4c9257ffdd839b215aabfba5f05fa02e">hitNormal</a> = NozPointFromAiPoint(sg-&gt;Ng);</div>
<div class="line">        sample.<a class="code" href="struct_presen_z_1_1_detect_sample_1_1v3__0_1_1_pz_detect_sample.html#a39246df9bccc12078d74da138ecfbfa4">hitPoint</a> = NozPointFromAiPoint(sg-&gt;P);</div>
<div class="line">        <span class="comment">//sample.sampleIndex = sg-&gt;si;</span></div>
<div class="line">        <a class="code" href="group___pz_detect_sample_api.html#ga958fc98bb65f1c0cb1e28ec6f47b743f">PresenZ::DetectSample::PzMatchSampleIndex</a>(sample, NozPointFromAiPoint(sg-&gt;Ro));</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (AiNodeIs(sg-&gt;Op, curveAtStr) || IsTaggedAsHair(sg))</div>
<div class="line">        {</div>
<div class="line">            sample.<a class="code" href="struct_presen_z_1_1_detect_sample_1_1v3__0_1_1_pz_detect_sample.html#ad50b77be6452fcd203fa25771dd4f69e">isHair</a> = <span class="keyword">true</span>;</div>
<div class="line">            sample.<a class="code" href="struct_presen_z_1_1_detect_sample_1_1v3__0_1_1_pz_detect_sample.html#a4c9257ffdd839b215aabfba5f05fa02e">hitNormal</a> = <a class="code" href="struct_noz_point.html">NozPoint</a>(0.0f);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (IsTaggedAsGlass(sg) == <span class="keyword">true</span>)</div>
<div class="line">            sample.<a class="code" href="struct_presen_z_1_1_detect_sample_1_1v3__0_1_1_pz_detect_sample.html#ae89f8742850b3f5fb55f23ccf9a55d86">transpType</a> = <a class="code" href="namespace_presen_z_1_1_detect_sample_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#a4235bda2ada163773d83c4d1d6c75bc0ae0e0d5fadce4b0933385ee555c8f7a53">PresenZ::DetectSample::DST_glass</a>;</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (IsTaggedAsChaotic(sg) == <span class="keyword">true</span>)</div>
<div class="line">            sample.<a class="code" href="struct_presen_z_1_1_detect_sample_1_1v3__0_1_1_pz_detect_sample.html#a8a33ba6ff4f3da7799e33a2827f9d297">isChaotic</a> = <span class="keyword">true</span>;</div>
<div class="line"></div>
<div class="line">        </div>
<div class="line">        ArnoldUserData userData(sg);</div>
<div class="line">        <a class="code" href="struct_presen_z_1_1_detect_sample_1_1v3__0_1_1_ray_test_interface.html">PresenZ::DetectSample::RayTestInterface</a> probe = { &amp;userData, ArnoldHitTest, ArnoldQueryFlags };</div>
<div class="line"></div>
<div class="line">        <a class="code" href="group___pz_detect_sample_api.html#gac6410e7ecfb3cf5a078a69240fc33ea8">PresenZ::DetectSample::PzProcessDetectSample</a>(&amp;probe, sample, sg-&gt;tid);</div>
<div class="line"></div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">if</span> (!(sg-&gt;Rt &amp; AI_RAY_CAMERA))</div>
<div class="line">            <span class="keywordflow">return</span>;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (PresenZ_data_struct::pass == <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#ae1c5184dc404edf057ed537bcfddef84a4fa71226841d5dc4359c2e48fa8a079e">PresenZ::Phase::Render_Reflection</a>)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">if</span>(sg-&gt;bounces == 1)</div>
<div class="line">            {</div>
<div class="line">                AiAOVSetVec(sg, rayDirAOVStr, sg-&gt;Rd);</div>
<div class="line">                AiAOVSetVec(sg, rayOrigAOVStr, sg-&gt;Ro);</div>
<div class="line">                AiAOVSetVec(sg, NCameraAtStr, sg-&gt;Ng);</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">        {</div>
<div class="line"></div>
<div class="line">            AiAOVSetVec(sg, rayDirAOVStr, sg-&gt;Rd);</div>
<div class="line">            AiAOVSetVec(sg, rayOrigAOVStr, sg-&gt;Ro);</div>
<div class="line">            <span class="keywordflow">if</span> (sg-&gt;Rl &gt;= data-&gt;maxDistance)</div>
<div class="line">                AiAOVSetVec(sg, NCameraAtStr, AiV3Normalize(-sg-&gt;Rd));</div>
<div class="line">            <span class="keywordflow">else</span></div>
<div class="line">                AiAOVSetVec(sg, NCameraAtStr, sg-&gt;Ng);</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (PresenZ_data_struct::motion_vector)</div>
<div class="line">        {</div>
<div class="line">           </div>
<div class="line">            <span class="keywordflow">if</span> (sg-&gt;sc == AI_CONTEXT_SURFACE)</div>
<div class="line">            {</div>
<div class="line">                AtVector P1, P2;</div>
<div class="line">                AiShaderGlobalsGetPositionAtTime(sg, 0.0f, P1, NULL, NULL, NULL);</div>
<div class="line">                AiShaderGlobalsGetPositionAtTime(sg, 1.0f, P2, NULL, NULL, NULL);</div>
<div class="line">                AiAOVSetVec(sg, velocityAtStr, AtVector(P2.x - P1.x, P2.y - P1.y, P2.z - P1.z));</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">node_initialize</div>
<div class="line">{</div>
<div class="line">    postShaderData *data = (postShaderData*)AiMalloc(<span class="keyword">sizeof</span>(postShaderData));</div>
<div class="line">    AiNodeSetLocalData(node, data);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">node_update</div>
<div class="line">{</div>
<div class="line"></div>
<div class="line">    postShaderData *data = (postShaderData*)AiNodeGetLocalData(node);</div>
<div class="line"><span class="preprocessor">#if AI_VERSION_ARCH_NUM &lt;= 6</span></div>
<div class="line"><span class="preprocessor"></span>AtNode* pzCamera = AiUniverseGetCamera();</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>    <span class="keyword">const</span> AtUniverse* universe = AiNodeGetUniverse(node);</div>
<div class="line">    <span class="keyword">const</span> AtNode* pzCamera = AiUniverseGetCamera(universe);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>    <span class="keywordflow">if</span> (AiNodeIs(pzCamera, PresenzCameraName))</div>
<div class="line">    {</div>
<div class="line">        data-&gt;renderIsolated = AiNodeGetBool(pzCamera, <span class="stringliteral">&quot;render_isolated&quot;</span>);</div>
<div class="line">        </div>
<div class="line">        <span class="keywordtype">float</span> far_clip = AiNodeGetFlt(pzCamera, <span class="stringliteral">&quot;far_clip&quot;</span>);</div>
<div class="line">        <span class="keywordtype">float</span> scene_scale = AiNodeGetFlt(pzCamera, <span class="stringliteral">&quot;presenz_scene_scale&quot;</span>);</div>
<div class="line">        data-&gt;maxDistance = far_clip - (0.1 * scene_scale);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">        <a class="code" href="group___pz_app_logger.html#gafd8b815a0f76d6b121f44f62d5730ee4">PZ_ERROR</a>(<span class="stringliteral">&quot;[PresenZ] Could not find the PresenZMainCamera.&quot;</span>);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">node_finish</div>
<div class="line">{</div>
<div class="line">}</div>
</div><!-- fragment --><h1>10.3 Intersection shader</h1>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;arnoldWrapper.h&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="_pz_detect_sample_api_8h.html">API/PzDetectSampleApi.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="_pz_app_logger_8h.html">API/PzAppLogger.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="_pz_shading_api_8h.html">API/PzShadingApi.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;presenz_global_parameters.h&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">namespace</span></div>
<div class="line">{</div>
<div class="line">    <span class="keyword">enum</span> PresenZAOVsParams</div>
<div class="line">    {</div>
<div class="line">        p_beauty,</div>
<div class="line">    };</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line">AI_SHADER_NODE_EXPORT_METHODS(PresenZAOVsMtd);</div>
<div class="line"></div>
<div class="line">node_parameters</div>
<div class="line">{</div>
<div class="line">    AiParameterClosure(<span class="stringliteral">&quot;beauty&quot;</span>);</div>
<div class="line">    AiMetaDataSetInt(nentry, <span class="stringliteral">&quot;beauty&quot;</span>, <span class="stringliteral">&quot;opacity_term&quot;</span>, 1);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span></div>
<div class="line">{</div>
<div class="line">    <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#a3104904c134a52357b85f763f6dfd48f">PresenZ::Phase::Eye</a> eye;</div>
<div class="line">    <span class="keywordtype">bool</span> renderIsolated;</div>
<div class="line">    uint8_t stereoRightEye;</div>
<div class="line"></div>
<div class="line">} ShaderData;</div>
<div class="line"></div>
<div class="line"><span class="keyword">inline</span> <span class="keywordtype">void</span> setOut(AtShaderGlobals* sg, <span class="keyword">const</span> AtNode* node, PresenZAOVsParams p_beauty) { sg-&gt;out.CLOSURE() = AiShaderEvalParamClosure(p_beauty); }</div>
<div class="line"><span class="keyword">inline</span> <span class="keywordtype">void</span> setOutBlack(AtShaderGlobals* sg) { sg-&gt;out.RGBA() = AI_RGBA_ZERO; }</div>
<div class="line"><span class="keyword">inline</span> <span class="keywordtype">void</span> setOutWhite(AtShaderGlobals* sg) { sg-&gt;out.RGBA() = AI_RGBA_WHITE; }</div>
<div class="line"><span class="keyword">inline</span> uint8_t getRecursionLevel(AtShaderGlobals* sg) { <span class="keywordflow">return</span> sg-&gt;bounces; }</div>
<div class="line"><span class="keyword">inline</span> uint8_t getReflectionLevel(AtShaderGlobals* sg) { <span class="keywordflow">return</span> sg-&gt;bounces_reflect; }</div>
<div class="line"><span class="keyword">inline</span> uint8_t getRefractionLevel(AtShaderGlobals* sg) { <span class="keywordflow">return</span> sg-&gt;bounces_transmit; }</div>
<div class="line"><span class="keyword">inline</span> uint8_t getDiffractionLevel(AtShaderGlobals* sg) { <span class="keywordflow">return</span> sg-&gt;bounces_diffuse; }</div>
<div class="line"><span class="keyword">inline</span> uint8_t getGlossyLevel(AtShaderGlobals* sg) { <span class="keywordflow">return</span> sg-&gt;bounces_specular; }</div>
<div class="line"><span class="keyword">inline</span> <span class="keywordtype">void</span> setVelocityVec(AtShaderGlobals* sg) { AtVector P1; AiShaderGlobalsGetPositionAtTime(sg, 1.0f, P1, NULL, NULL, NULL); AiAOVSetVec(sg, velocityAtStr, AtVector(P1.x - sg-&gt;P.x, P1.y - sg-&gt;P.y, P1.z - sg-&gt;P.z)); }</div>
<div class="line"><span class="keyword">inline</span> <span class="keywordtype">void</span> setShaderGlobals(AtShaderGlobals* sg, uint8_t Rr, uint8_t Rr_refl, uint8_t Rr_refr, uint8_t Rr_diff, uint8_t Rr_gloss) { sg-&gt;bounces = Rr; sg-&gt;bounces_reflect = Rr_refl; sg-&gt;bounces_transmit = Rr_refr; sg-&gt;bounces_diffuse = Rr_diff; sg-&gt;bounces_specular = Rr_gloss; }</div>
<div class="line"><span class="keyword">inline</span> <span class="keywordtype">void</span> setGlassMaterialAOV(AtShaderGlobals* sg) { AiAOVSetBool(sg, przGlassAtStr, <span class="keyword">true</span>); }</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">bool</span> SolveLinearSystem2x2(<span class="keyword">const</span> <span class="keywordtype">float</span> A[2][2], <span class="keyword">const</span> <span class="keywordtype">float</span> B[2], <span class="keywordtype">float</span> *x0, <span class="keywordtype">float</span> *x1)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">float</span> det = A[0][0] * A[1][1] - A[0][1] * A[1][0];</div>
<div class="line">    <span class="keywordflow">if</span> (fabsf(det) &lt; 1e-10f)</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">    *x0 = (A[1][1] * B[0] - A[0][1] * B[1]) / det;</div>
<div class="line">    *x1 = (A[0][0] * B[1] - A[1][0] * B[0]) / det;</div>
<div class="line">    <span class="keywordflow">if</span> (isnan(*x0) || isnan(*x1))</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> computeUVDifferentials(<span class="keyword">const</span> AtVector&amp; nn,  <span class="keyword">const</span> AtVector &amp;dPdx, <span class="keyword">const</span> AtVector &amp;dPdy, <span class="keyword">const</span> AtVector &amp;dPdu, <span class="keyword">const</span> AtVector &amp;dPdv,</div>
<div class="line">    <span class="keywordtype">float</span> &amp;dudx,<span class="keywordtype">float</span> &amp;dudy, <span class="keywordtype">float</span> &amp;dvdx, <span class="keywordtype">float</span> &amp;dvdy  ) {</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">float</span> A[2][2], Bx[2], By[2];</div>
<div class="line">    <span class="keywordtype">int</span> axes[2];</div>
<div class="line">    <span class="keywordflow">if</span> (fabsf(nn.x) &gt; fabsf(nn.y) &amp;&amp; fabsf(nn.x) &gt; fabsf(nn.z)) {</div>
<div class="line">        axes[0] = 1; axes[1] = 2;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fabsf(nn.y) &gt; fabsf(nn.z)) {</div>
<div class="line">        axes[0] = 0; axes[1] = 2;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> {</div>
<div class="line">        axes[0] = 0; axes[1] = 1;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    A[0][0] = dPdu[axes[0]];</div>
<div class="line">    A[0][1] = dPdv[axes[0]];</div>
<div class="line">    A[1][0] = dPdu[axes[1]];</div>
<div class="line">    A[1][1] = dPdv[axes[1]];</div>
<div class="line">    Bx[0] = dPdx[axes[0]];</div>
<div class="line">    Bx[1] = dPdx[axes[1]];</div>
<div class="line">    By[0] = dPdy[axes[0]];</div>
<div class="line">    By[1] = dPdy[axes[1]];</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (!SolveLinearSystem2x2(A, Bx, &amp;dudx, &amp;dvdx)) {</div>
<div class="line">        dudx = 0.; dvdx = 0.;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (!SolveLinearSystem2x2(A, By, &amp;dudy, &amp;dvdy)) {</div>
<div class="line">        dudy = 0.; dvdy = 0.;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line">AtVector GetPlaneIntersect(<span class="keyword">const</span> AtVector&amp; planePoint, <span class="keyword">const</span> AtVector&amp; planeNormal, <span class="keyword">const</span> AtVector&amp; linePoint, <span class="keyword">const</span> AtVector&amp; lineDir)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> denom = AiV3Dot(planeNormal, lineDir);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (fabs(denom) &gt; FLT_EPSILON) {</div>
<div class="line"></div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> p0l0x = <span class="keyword">static_cast&lt;</span><span class="keywordtype">double</span><span class="keyword">&gt;</span>(planePoint.x) - static_cast&lt;double&gt;(linePoint.x);</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> p0l0y = <span class="keyword">static_cast&lt;</span><span class="keywordtype">double</span><span class="keyword">&gt;</span>(planePoint.y) - static_cast&lt;double&gt;(linePoint.y);</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> p0l0z = <span class="keyword">static_cast&lt;</span><span class="keywordtype">double</span><span class="keyword">&gt;</span>(planePoint.z) - static_cast&lt;double&gt;(linePoint.z);</div>
<div class="line"></div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> num = p0l0x * planeNormal.x + p0l0y * planeNormal.y + p0l0z * planeNormal.z;</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> t = num / denom;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">return</span> linePoint + t * lineDir;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> planePoint;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">bool</span> isStereoRightEye(uint8_t stereoRightEye, <span class="keywordtype">bool</span> stereoTag) {</div>
<div class="line">    <span class="keywordflow">if</span> (stereoRightEye == 0) <span class="keywordflow">return</span> <span class="keyword">true</span>; <span class="comment">// render all surfaces, ignore stereo tag</span></div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (stereoRightEye == 1 &amp;&amp; stereoTag ) <span class="keywordflow">return</span> <span class="keyword">true</span>; <span class="comment">// render tagged surface in stereo</span></div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (stereoRightEye == 2 &amp;&amp; !stereoTag) <span class="keywordflow">return</span> <span class="keyword">true</span>; <span class="comment">// render tagged surface in stereo</span></div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">shader_evaluate</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (PresenZ_data_struct::pass == <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#ae1c5184dc404edf057ed537bcfddef84ac677a954de25220db675695edacb4f71">PresenZ::Phase::Render</a> || PresenZ_data_struct::pass == <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#ae1c5184dc404edf057ed537bcfddef84a4fa71226841d5dc4359c2e48fa8a079e">PresenZ::Phase::Render_Reflection</a>)</div>
<div class="line">    {</div>
<div class="line">        ShaderData *data = (ShaderData*)AiNodeGetLocalData(node);</div>
<div class="line"></div>
<div class="line">        AiAOVSetVec(sg, NCameraAtStr, sg-&gt;Ng);</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">        </div>
<div class="line"></div>
<div class="line">        <span class="comment">// for left eye you should always evaluate shader, for right eye we need to check that hitpoint is not too far</span></div>
<div class="line"></div>
<div class="line"></div>
<div class="line">        <span class="comment">// If it&#39;s not a camera ray, we are just evaluating the shader</span></div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (!(sg-&gt;Rt &amp; AI_RAY_CAMERA))</div>
<div class="line">        {</div>
<div class="line">            <span class="comment">// Transmission case.</span></div>
<div class="line">            <span class="comment">/*if (sg-&gt;Rt &amp; AI_RAY_ALL_TRANSMIT)</span></div>
<div class="line"><span class="comment">            {</span></div>
<div class="line"><span class="comment">                bool fromGlass = false;</span></div>
<div class="line"><span class="comment">                bool found = AiStateGetMsgBool(przGlassAtStr, &amp;fromGlass);</span></div>
<div class="line"><span class="comment"></span></div>
<div class="line"><span class="comment">                if (found)</span></div>
<div class="line"><span class="comment">                {</span></div>
<div class="line"><span class="comment">                // If  we are coming from a glass, and we are not, we don&#39;t want the refraction, so we return nothing.</span></div>
<div class="line"><span class="comment">                if (IsTaggedAsGlass(sg-&gt;Op) == false)</span></div>
<div class="line"><span class="comment">                    return;</span></div>
<div class="line"><span class="comment">                else</span></div>
<div class="line"><span class="comment">                    sg-&gt;out.CLOSURE() = closureList;</span></div>
<div class="line"><span class="comment">                }</span></div>
<div class="line"><span class="comment">                else</span></div>
<div class="line"><span class="comment">                    sg-&gt;out.CLOSURE() = closureList;</span></div>
<div class="line"><span class="comment">                    return;</span></div>
<div class="line"><span class="comment">            }</span></div>
<div class="line"><span class="comment">            else*/</span></div>
<div class="line">                sg-&gt;out.CLOSURE() = AiShaderEvalParamClosure(p_beauty);</div>
<div class="line"></div>
<div class="line">        }</div>
<div class="line">        <span class="comment">// Camera ray...</span></div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">        {</div>
<div class="line"></div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">bool</span> notisolated = (data-&gt;renderIsolated) &amp;&amp; (!IsTaggedAsRenderIsolated(sg));</div>
<div class="line">            <span class="keywordflow">if</span> (notisolated) {</div>
<div class="line">                sg-&gt;out.CLOSURE() = AiClosureMatte(sg);</div>
<div class="line">                <span class="keywordflow">return</span>;</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> (<a class="code" href="group___pz_shading_api.html#ga92c23c7b028873c784d8fd74bef4292f">PresenZ::Shading::PzIsValidEvaluation</a>(sg-&gt;x, sg-&gt;y, sg-&gt;Rl, IsTaggedAsChaotic(sg)) == <span class="keyword">false</span>)</div>
<div class="line">            {</div>
<div class="line">                sg-&gt;out.CLOSURE() = AiClosureMatte(sg);</div>
<div class="line">                <span class="keywordflow">return</span>;</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="keyword">const</span> AtVector originalRd = sg-&gt;Rd;</div>
<div class="line">            <a class="code" href="struct_noz_point.html">NozPoint</a> bestCamWS = <a class="code" href="group___pz_shading_api.html#ga7b1e9d6ef33e499eca978c3dba837d98">PresenZ::Shading::PzGetBestCameraWSPosition</a>(sg-&gt;x, sg-&gt;y);</div>
<div class="line">            <a class="code" href="struct_noz_point.html">NozVector</a> bestCamWsDir = <a class="code" href="group___n_o_z__vector.html#ga19bf5d776ee066f688d5432fe9ce257f">NozVecNormalize</a>( NozPointFromAiPoint(sg-&gt;P) - bestCamWS );</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">            <a class="code" href="struct_presen_z_1_1_shading_1_1v3__0_1_1_pz_bend_ray.html">PresenZ::Shading::PzBendRay</a> bendRay = <a class="code" href="group___pz_shading_api.html#gab494b6706b2ce7119c4736a70bd6f594">PresenZ::Shading::PzGetBendRayRenderPhase</a>(</div>
<div class="line">                data-&gt;eye, </div>
<div class="line">                NozPointFromAiPoint(sg-&gt;Ng),</div>
<div class="line">                NozPointFromAiPoint(sg-&gt;Ns), </div>
<div class="line">                NozPointFromAiPoint(originalRd),</div>
<div class="line">                NozPointFromAiPoint(sg-&gt;P), </div>
<div class="line">                sg-&gt;Rl,</div>
<div class="line">                bestCamWS); <span class="comment">// eye, normal, worldcameradir, worldpoint, hitdistance</span></div>
<div class="line"></div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">bool</span> stereoRightEye = isStereoRightEye(data-&gt;stereoRightEye, IsTaggedAsStereoRightEye(sg) );</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> (data-&gt;eye == <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#a3104904c134a52357b85f763f6dfd48fa4280d82f18d6dbafdeb68c811112455e">PresenZ::Phase::Eye::RC_Left</a> || (data-&gt;eye == <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#a3104904c134a52357b85f763f6dfd48fac2b22af1f16cebd2cc909767c763a713">PresenZ::Phase::Eye::RC_Right</a> &amp;&amp; stereoRightEye &amp;&amp; bendRay.<a class="code" href="struct_presen_z_1_1_shading_1_1v3__0_1_1_pz_bend_ray.html#a25d24f3fc254ac9d7f43b9be22fadd34">isStereoScopic</a>))</div>
<div class="line">            {</div>
<div class="line">                </div>
<div class="line">                sg-&gt;Rd = AtVectorFromNozPoint(bendRay.<a class="code" href="struct_presen_z_1_1_shading_1_1v3__0_1_1_pz_bend_ray.html#a7d4ae5b50b35b0b0e860ffe3192b05da">dir</a>);</div>
<div class="line">                sg-&gt;Rl = bendRay.<a class="code" href="struct_presen_z_1_1_shading_1_1v3__0_1_1_pz_bend_ray.html#ab44f0a3b38724b93889067c8dc6e9469">wHitDistance</a>;</div>
<div class="line">                sg-&gt;Ro = sg-&gt;P - AtVectorFromNozPoint(bendRay.<a class="code" href="struct_presen_z_1_1_shading_1_1v3__0_1_1_pz_bend_ray.html#a7d4ae5b50b35b0b0e860ffe3192b05da">dir</a>) * bendRay.<a class="code" href="struct_presen_z_1_1_shading_1_1v3__0_1_1_pz_bend_ray.html#ab44f0a3b38724b93889067c8dc6e9469">wHitDistance</a>;</div>
<div class="line">                <span class="keywordtype">double</span> resX = 0.;</div>
<div class="line">                <span class="keywordtype">double</span> resY = 0.;</div>
<div class="line">                <a class="code" href="group___pz_shading_api.html#gaa7cccc460f977f6ed485158716e17157">PresenZ::Shading::PzGetRenderingResolution</a>(resX, resY);</div>
<div class="line"></div>
<div class="line">                <span class="comment">// Previously we took the arnold cube map camera derivative into reference </span></div>
<div class="line">                <span class="comment">// but we found out they were a bit too long, this was making arnold using too high mipmap level</span></div>
<div class="line">                </div>
<div class="line">                <span class="comment">// const float dsx = 2.0 / (resX * 1.5);    // matching camera screenspace derivatives </span></div>
<div class="line">                <span class="comment">// const float dsy = ( 2.0 / (resY * 1.5 * 1.5) ) * 1.5 ;</span></div>
<div class="line">                <span class="comment">// equaling this</span></div>
<div class="line">                <span class="comment">// const float dsx = 4.0 / (resX * 3.);</span></div>
<div class="line">                <span class="comment">// const float dsy = 4.0 / (resY * 3 );</span></div>
<div class="line">                </div>
<div class="line">                <span class="comment">// now we are using a 90deg perspective camera derivative as a refenrece </span></div>
<div class="line">                <span class="comment">// to set the derivative for each face of our cube map projection. </span></div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">float</span> dsx = 2.0 / (resX * 3.) ;  <span class="comment">// or (2/Ry)/3   </span></div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">float</span> dsy = 1.0 /  resY;         <span class="comment">// or (2/Ry)/2</span></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line">                sg-&gt;dDdx = AtVectorFromNozVector( bendRay.<a class="code" href="struct_presen_z_1_1_shading_1_1v3__0_1_1_pz_bend_ray.html#a736153c8076e6040f9703e238e5b987c">dDdx</a> ) *  dsx;</div>
<div class="line">                sg-&gt;dDdy = AtVectorFromNozVector( bendRay.<a class="code" href="struct_presen_z_1_1_shading_1_1v3__0_1_1_pz_bend_ray.html#aeb84bfd699fd4a7c535d38f19449e6b4">dDdy</a> ) *  dsy;</div>
<div class="line">                </div>
<div class="line">                AtVector sgrd = AtVectorFromNozPoint(bestCamWsDir);</div>
<div class="line">                AtVector sgro = AtVectorFromNozPoint(bestCamWS);</div>
<div class="line"></div>
<div class="line">                sg-&gt;dPdx = GetPlaneIntersect(sg-&gt;P, sg-&gt;Ng, sgro, sgrd + sg-&gt;dDdx) - sg-&gt;P;</div>
<div class="line">                sg-&gt;dPdy = GetPlaneIntersect(sg-&gt;P, sg-&gt;Ng, sgro, sgrd + sg-&gt;dDdy) - sg-&gt;P;</div>
<div class="line">                </div>
<div class="line"></div>
<div class="line">                computeUVDifferentials(sg-&gt;Ng, sg-&gt;dPdx, sg-&gt;dPdy, sg-&gt;dPdu, sg-&gt;dPdv, sg-&gt;dudx, sg-&gt;dudy, sg-&gt;dvdx, sg-&gt;dvdy);</div>
<div class="line"></div>
<div class="line">                AtClosureList closureList = AiShaderEvalParamClosure(p_beauty);</div>
<div class="line"></div>
<div class="line">                <span class="keywordflow">if</span> (IsTaggedAsGlass(sg) == <span class="keyword">true</span>)</div>
<div class="line">                {</div>
<div class="line">                    <span class="keywordflow">if</span> (PresenZ_data_struct::pass == <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#ae1c5184dc404edf057ed537bcfddef84a4fa71226841d5dc4359c2e48fa8a079e">PresenZ::Phase::Render_Reflection</a>)</div>
<div class="line">                    {</div>
<div class="line">                        AtScrSample sample;</div>
<div class="line">                        AtVector reflectionRay = AiReflect(originalRd, sg-&gt;Nf);</div>
<div class="line">                        AtRay ray = AiMakeRay(AI_RAY_CAMERA, sg-&gt;P, &amp;reflectionRay, AI_INFINITE, sg);</div>
<div class="line">                        AiTrace(ray, AI_RGB_WHITE, sample);</div>
<div class="line"></div>
<div class="line">                        AiAOVSetFlt(sg, Z_Refl_AtStr, sample.z);</div>
<div class="line">                        AtRGBA rgba = sample.color;</div>
<div class="line">                        rgba.a = sample.alpha;</div>
<div class="line">                        AiAOVSetRGBA(sg, RGBA_Refl_AtStr, rgba);</div>
<div class="line">                        AiAOVSetVec(sg, NHitPoint_Refl_AtStr, sample.point);</div>
<div class="line">                        sg-&gt;out.CLOSURE() = AiClosureMatte(sg);</div>
<div class="line">                        <span class="keywordflow">return</span>;</div>
<div class="line"></div>
<div class="line">                    }</div>
<div class="line">                    <span class="comment">// If we are tagged as glass, we are making the object transparent so our ray continue.</span></div>
<div class="line">                    <span class="comment">// We also tag the ray for further depth != camera.</span></div>
<div class="line">                    setGlassMaterialAOV(sg);</div>
<div class="line">                    AiStateSetMsgBool(przGlassAtStr, <span class="keyword">true</span>);</div>
<div class="line"></div>
<div class="line">                    <span class="keywordtype">bool</span> goThrough = <span class="keyword">false</span>;</div>
<div class="line">                    <span class="keyword">const</span> <span class="keywordtype">bool</span> shadeCurrentPoint = <a class="code" href="group___pz_shading_api.html#gae26a93bf43d6cb1f25a79823ab2fe2eb">PresenZ::Shading::PzShouldShade</a>(NozPointFromAiPoint(sg-&gt;P), NozPointFromAiPoint(sg-&gt;Ns), sg-&gt;x, sg-&gt;y, goThrough);</div>
<div class="line">                    <span class="keywordflow">if</span> (!shadeCurrentPoint) {</div>
<div class="line">                        <span class="keywordflow">if</span> (goThrough)</div>
<div class="line">                            sg-&gt;out.CLOSURE() = AiClosureTransparent(sg);</div>
<div class="line">                        <span class="keywordflow">else</span></div>
<div class="line">                            sg-&gt;out.CLOSURE() = AiClosureMatte(sg);</div>
<div class="line">                        <span class="keywordflow">return</span>;</div>
<div class="line">                    }</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">                    AtClosureList closureList = AiShaderEvalParamClosure(p_beauty);</div>
<div class="line">                    </div>
<div class="line">                    </div>
<div class="line">                    <span class="keywordflow">if</span> (goThrough){</div>
<div class="line">                        closureList.add(AiClosureTransparent(sg));</div>
<div class="line">                    }</div>
<div class="line">                    sg-&gt;out.CLOSURE() = closureList;</div>
<div class="line">                    <span class="keywordflow">return</span>;</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">else</span></div>
<div class="line">                {</div>
<div class="line">                    <span class="comment">// Normal evaluation</span></div>
<div class="line">                    sg-&gt;out.CLOSURE() = AiShaderEvalParamClosure(p_beauty);</div>
<div class="line">                    <span class="keywordflow">return</span>;</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (IsTaggedAsGlass(sg) == <span class="keyword">true</span>)</div>
<div class="line">            {</div>
<div class="line">                sg-&gt;out.CLOSURE() = AiClosureTransparent(sg);</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span></div>
<div class="line">                sg-&gt;out.CLOSURE() = AiClosureMatte(sg);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// Early out if it&#39;s not a camera ray.</span></div>
<div class="line">        <span class="keywordflow">if</span> (!(sg-&gt;Rt &amp; AI_RAY_CAMERA))</div>
<div class="line">            <span class="keywordflow">return</span>;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (IsTaggedAsGlass(sg) == <span class="keyword">true</span>)</div>
<div class="line">        {</div>
<div class="line">            sg-&gt;out.CLOSURE() = AiClosureTransparent(sg, AI_RGB_50GREY);</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">            sg-&gt;out.CLOSURE();</div>
<div class="line">    }</div>
<div class="line"><span class="keywordflow">return</span>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">node_initialize</div>
<div class="line">{</div>
<div class="line">    ShaderData *data = (ShaderData*)AiMalloc(<span class="keyword">sizeof</span>(ShaderData));</div>
<div class="line">    AiNodeSetLocalData(node, data);</div>
<div class="line">    <a class="code" href="group___pz_app_logger.html#gad79dc53c351eeff13f901542c29f6e57">PZ_DEBUG</a>(<span class="stringliteral">&quot;node initialized&quot;</span>);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">node_update</div>
<div class="line">{</div>
<div class="line">    ShaderData *data = (ShaderData*)AiNodeGetLocalData(node);</div>
<div class="line"><span class="preprocessor">#if AI_VERSION_ARCH_NUM &lt;= 6    </span></div>
<div class="line"><span class="preprocessor"></span>    AtNode* pzCamera = AiUniverseGetCamera();</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>    AtNode* pzCamera = AiUniverseGetCamera(AiNodeGetUniverse(node));</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">    <span class="keywordflow">if</span> (AiNodeIs(pzCamera, PresenzCameraName))</div>
<div class="line">    {</div>
<div class="line">        data-&gt;eye = AiNodeGetInt(pzCamera, <span class="stringliteral">&quot;rendering_eye&quot;</span>) ? <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#a3104904c134a52357b85f763f6dfd48fac2b22af1f16cebd2cc909767c763a713">PresenZ::Phase::Eye::RC_Right</a> : <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#a3104904c134a52357b85f763f6dfd48fa4280d82f18d6dbafdeb68c811112455e">PresenZ::Phase::Eye::RC_Left</a>;</div>
<div class="line">        data-&gt;renderIsolated = AiNodeGetBool(pzCamera, <span class="stringliteral">&quot;render_isolated&quot;</span>);</div>
<div class="line">        data-&gt;stereoRightEye = AiNodeGetInt(pzCamera, <span class="stringliteral">&quot;stereo_right_eye&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">        <a class="code" href="group___pz_app_logger.html#gafd8b815a0f76d6b121f44f62d5730ee4">PZ_ERROR</a>(<span class="stringliteral">&quot;[PresenZ] Could not find the PresenZMainCamera.&quot;</span>);</div>
<div class="line">    </div>
<div class="line">    <a class="code" href="group___pz_app_logger.html#gad79dc53c351eeff13f901542c29f6e57">PZ_DEBUG</a>(<span class="stringliteral">&quot;node updated&quot;</span>);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">node_finish</div>
<div class="line">{</div>
<div class="line">    ShaderData *data = (ShaderData*)AiNodeGetLocalData(node);</div>
<div class="line">    AiFree(data);</div>
<div class="line">}</div>
</div><!-- fragment --><h1>10.4 Filter</h1>
<div class="fragment"><div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;ai.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &quot;arnoldWrapper.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;presenz_global_parameters.h&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="_pz_bucket_api_8h.html">API/PzBucketApi.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="_pz_render_sample_api_8h.html">API/PzRenderSampleApi.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="_pz_phase_api_8h.html">API/PzPhaseApi.h</a>&quot;</span></div>
<div class="line"></div>
<div class="line">AI_FILTER_NODE_EXPORT_METHODS(PresenZFilterMethods);</div>
<div class="line"></div>
<div class="line"><span class="keyword">using namespace </span><a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#ae1c5184dc404edf057ed537bcfddef84">PresenZ::Phase</a>;</div>
<div class="line"><span class="keyword">using namespace </span>PresenZ::BinIO;</div>
<div class="line"><span class="keyword">using namespace </span>PresenZ::RenderSample;</div>
<div class="line"></div>
<div class="line">node_parameters</div>
<div class="line">{</div>
<div class="line">    AiParameterFlt(<span class="stringliteral">&quot;width&quot;</span>, 1.0);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">node_initialize</div>
<div class="line">{</div>
<div class="line"></div>
<div class="line">    <span class="comment">//static const char* necessary_aovs[] = { &quot;FLOAT Z&quot;, &quot;VECTOR P&quot;, &quot;VECTOR prz_geometricnormal&quot;, nullptr };</span></div>
<div class="line">    AiFilterInitialize(node, <span class="keyword">true</span>, NULL);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">node_finish</div>
<div class="line">{</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">node_update</div>
<div class="line">{</div>
<div class="line">    <span class="comment">//AiFilterUpdate(node, AiNodeGetFlt(node, &quot;width&quot;));</span></div>
<div class="line">    AiFilterUpdate(node, 1.0);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">filter_output_type</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span> AI_TYPE_POINTER;</div>
<div class="line"></div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">filter_pixel</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (PresenZ_data_struct::pass == <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#ae1c5184dc404edf057ed537bcfddef84a48a95ceab76284afa466622424eba555">PresenZ::Phase::Detect</a> || PresenZ_data_struct::pass == <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#ae1c5184dc404edf057ed537bcfddef84a9e72290cbba5243f4449f84168a3c99c">PresenZ::Phase::Detect_Reflection</a>)</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line"></div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">float</span> width = 0.5f; <span class="comment">//AiNodeGetFlt(node, &quot;width&quot;);</span></div>
<div class="line">    </div>
<div class="line">    FilterData *out_data = <span class="keyword">new</span> FilterData();</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">while</span> (AiAOVSampleIteratorGetNext(iterator))</div>
<div class="line">    {</div>
<div class="line">        AtVector2 offset = AiAOVSampleIteratorGetOffset(iterator);</div>
<div class="line">        <span class="keywordflow">while</span> (AiAOVSampleIteratorGetNextDepth(iterator))</div>
<div class="line">        {</div>
<div class="line">            AOVData data;</div>
<div class="line">            <span class="keywordflow">switch</span> (data_type)</div>
<div class="line">            {</div>
<div class="line">            <span class="keywordflow">case</span> AI_TYPE_RGB:</div>
<div class="line">            {</div>
<div class="line">                AtRGB <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#add16db84a471b163119fa85bfa9df0fda30447e9f6efa4afdd251f9afc1d5fb44">RGB</a> = AiAOVSampleIteratorGetRGB(iterator);</div>
<div class="line">                data.v3.x = RGB.r;</div>
<div class="line">                data.v3.y = RGB.g;</div>
<div class="line">                data.v3.z = RGB.b;</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">case</span> AI_TYPE_RGBA:</div>
<div class="line">            {</div>
<div class="line">                AtRGBA <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#add16db84a471b163119fa85bfa9df0fdae75845ff0980839032f4a78a0d42753c">RGBA</a> = AiAOVSampleIteratorGetRGBA(iterator);</div>
<div class="line">                data.v4.x = RGBA.r;</div>
<div class="line">                data.v4.y = RGBA.g;</div>
<div class="line">                data.v4.z = RGBA.b;</div>
<div class="line">                data.v4.a = RGBA.a;</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">case</span> AI_TYPE_VECTOR:</div>
<div class="line">            {</div>
<div class="line">                AtVector vector = AiAOVSampleIteratorGetVec(iterator);</div>
<div class="line">                data.v3.x = vector.x;</div>
<div class="line">                data.v3.y = vector.y;</div>
<div class="line">                data.v3.z = vector.z;</div>
<div class="line">                 <span class="keywordflow">break</span>;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">case</span> AI_TYPE_VECTOR2:</div>
<div class="line">            {</div>
<div class="line">                AtVector2 vector2 = AiAOVSampleIteratorGetVec2(iterator);</div>
<div class="line">                data.v2.x = vector2.x;</div>
<div class="line">                data.v2.y = vector2.y;</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">case</span> AI_TYPE_FLOAT:</div>
<div class="line">                data.f = AiAOVSampleIteratorGetFlt(iterator);</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">            <span class="keywordflow">case</span> AI_TYPE_INT:</div>
<div class="line">                data.d = AiAOVSampleIteratorGetInt(iterator);</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">            <span class="keywordflow">case</span> AI_TYPE_UINT:</div>
<div class="line">                data.d = AiAOVSampleIteratorGetUInt(iterator);</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">            <span class="keywordflow">case</span> AI_TYPE_BOOLEAN:</div>
<div class="line">                data.b = AiAOVSampleIteratorGetBool(iterator);</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">            <span class="keywordflow">default</span>:</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">            }</div>
<div class="line">           </div>
<div class="line">            out_data-&gt;offset.push_back(<a class="code" href="group___n_o_z__vector.html#ga5457e8d9c7c92cda60f3114ea781f618">nozVector2</a>(offset.x, offset.y));</div>
<div class="line">            out_data-&gt;data.push_back(data);</div>
<div class="line">            out_data-&gt;depth.push_back(AiAOVSampleIteratorGetDepth(iterator));</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">   </div>
<div class="line">    *((<span class="keywordtype">void</span>**)data_out) = (<span class="keywordtype">void</span>*)out_data;</div>
<div class="line"></div>
<div class="line">}</div>
</div><!-- fragment --><h1>10.5 Driver</h1>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;ai.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &quot;arnoldWrapper.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;presenz_global_parameters.h&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="_pz_bucket_api_8h.html">API/PzBucketApi.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="_pz_render_sample_api_8h.html">API/PzRenderSampleApi.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="_pz_phase_api_8h.html">API/PzPhaseApi.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="_pz_camera_api_8h.html">API/PzCameraApi.h</a>&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;algorithm&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;map&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define MAX_ITERATIONS 3</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define ARNOLD_MAXDISTANCE 10e16f</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="keyword">using namespace </span><a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#ae1c5184dc404edf057ed537bcfddef84">PresenZ::Phase</a>;</div>
<div class="line"><span class="keyword">using namespace </span>PresenZ::BinIO;</div>
<div class="line"><span class="keyword">using namespace </span>PresenZ::RenderSample;</div>
<div class="line"><span class="keyword">using namespace </span><a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#ab11a1dda34491acff014ddfc9e6bafb8a72159b99f162eb7444ea0810dcce4442">PresenZ::Camera</a>;</div>
<div class="line"></div>
<div class="line"><span class="keyword">struct </span>ArnoldAOVData</div>
<div class="line">{</div>
<div class="line">    std::string name;</div>
<div class="line">    FilterData ** bucket_data;</div>
<div class="line"></div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keyword">struct </span>DriverData</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">bool</span> m_idValid;</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keyword">typedef</span> std::map&lt;AtString, ArnoldAOVData&gt; ArnoldBucketData;</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keyword">inline</span> <span class="keywordtype">size_t</span> getNumShaders(AtArray *shaders) { <span class="keywordflow">return</span> AiArrayGetNumElements(shaders);}</div>
<div class="line"><span class="keyword">inline</span> <span class="keywordtype">void</span> initializeDriver(AtNode* node) {AiDriverInitialize(node, <span class="keyword">true</span>);}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">// Register to Arnold what are the extra datas per pixel that we need (for deep_reflection or motion vectors).</span></div>
<div class="line"><span class="keywordtype">void</span> registerAOVs(AtNode *node, <span class="keywordtype">bool</span> compute_motion_vector)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// No need of AOV for detection phase.</span></div>
<div class="line">    <span class="keywordflow">if</span> (!(AiNodeGetInt(node, <span class="stringliteral">&quot;pass&quot;</span>) == <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#ae1c5184dc404edf057ed537bcfddef84ac677a954de25220db675695edacb4f71">Render</a> || AiNodeGetInt(node, <span class="stringliteral">&quot;pass&quot;</span>) == <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#ae1c5184dc404edf057ed537bcfddef84a4fa71226841d5dc4359c2e48fa8a079e">Render_Reflection</a>))</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line"></div>
<div class="line">    std::vector &lt;std::string&gt; aovDeclaration;</div>
<div class="line"></div>
<div class="line">    {</div>
<div class="line">        AtNode* filter;</div>
<div class="line">        AtUniverse* universe = AiNodeGetUniverse(node);</div>
<div class="line">        AtNodeIterator* iterFilter = AiUniverseGetNodeIterator(universe, AI_NODE_FILTER);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">while</span> (!AiNodeIteratorFinished(iterFilter))</div>
<div class="line">        {</div>
<div class="line">            AtNode *filterNode = AiNodeIteratorGetNext(iterFilter);</div>
<div class="line">            <span class="keywordflow">if</span> (AiNodeIs(filterNode, PresenZFilter))</div>
<div class="line">            {</div>
<div class="line">                filter = filterNode;</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">        AiNodeIteratorDestroy(iterFilter);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (filter == NULL)</div>
<div class="line">            filter = AiNode(universe, PresenZFilter, PresenZFilter, NULL);           </div>
<div class="line"></div>
<div class="line">        <span class="comment">// Default AOV</span></div>
<div class="line">        {</div>
<div class="line">            std::string RGBA_aov_str(<span class="stringliteral">&quot;RGBA RGBA&quot;</span>);</div>
<div class="line">            std::string Z_aov_str(<span class="stringliteral">&quot;Z FLOAT&quot;</span>);</div>
<div class="line">            std::string P_aov_str(<span class="stringliteral">&quot;P VECTOR&quot;</span>);</div>
<div class="line">            std::string N_aov_str(<span class="stringliteral">&quot;prz_geometricnormal VECTOR&quot;</span>);</div>
<div class="line">            std::string prz_transp_aov_str(<span class="stringliteral">&quot;prz_transp BOOL&quot;</span>);</div>
<div class="line">            std::string transmission_albedo_aov_str(<span class="stringliteral">&quot;transmission_albedo RGB&quot;</span>);</div>
<div class="line">            std::string glass_aov_aov_str(<span class="stringliteral">&quot;glass_aov RGB&quot;</span>);</div>
<div class="line">            std::string ray_dir_aov_str(<span class="stringliteral">&quot;ray_dir VECTOR&quot;</span>);</div>
<div class="line">            std::string ray_orig_aov_str(<span class="stringliteral">&quot;ray_orig VECTOR&quot;</span>);</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> (PresenZ_data_struct::pass == <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#ae1c5184dc404edf057ed537bcfddef84a4fa71226841d5dc4359c2e48fa8a079e">PresenZ::Phase::Render_Reflection</a>)</div>
<div class="line">            {</div>
<div class="line">                Z_aov_str = <span class="stringliteral">&quot;Z_Refl FLOAT&quot;</span>;</div>
<div class="line">                P_aov_str = <span class="stringliteral">&quot;P_Refl VECTOR&quot;</span>;</div>
<div class="line">                RGBA_aov_str = <span class="stringliteral">&quot;RGBA_Refl RGBA&quot;</span>;</div>
<div class="line"></div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            RGBA_aov_str = RGBA_aov_str + <span class="stringliteral">&quot; &quot;</span> + AiNodeGetName(filter) + <span class="stringliteral">&quot; &quot;</span> + AiNodeGetName(node);</div>
<div class="line">            Z_aov_str = Z_aov_str + <span class="stringliteral">&quot; &quot;</span> + AiNodeGetName(filter) + <span class="stringliteral">&quot; &quot;</span> + AiNodeGetName(node);</div>
<div class="line">            P_aov_str = P_aov_str + <span class="stringliteral">&quot; &quot;</span> + AiNodeGetName(filter) + <span class="stringliteral">&quot; &quot;</span> + AiNodeGetName(node);</div>
<div class="line">            N_aov_str = N_aov_str + <span class="stringliteral">&quot; &quot;</span> + AiNodeGetName(filter) + <span class="stringliteral">&quot; &quot;</span> + AiNodeGetName(node);</div>
<div class="line">            prz_transp_aov_str = prz_transp_aov_str + <span class="stringliteral">&quot; &quot;</span> + AiNodeGetName(filter) + <span class="stringliteral">&quot; &quot;</span> + AiNodeGetName(node);</div>
<div class="line">            transmission_albedo_aov_str = transmission_albedo_aov_str + <span class="stringliteral">&quot; &quot;</span> + AiNodeGetName(filter) + <span class="stringliteral">&quot; &quot;</span> + AiNodeGetName(node);</div>
<div class="line">            glass_aov_aov_str = glass_aov_aov_str + <span class="stringliteral">&quot; &quot;</span> + AiNodeGetName(filter) + <span class="stringliteral">&quot; &quot;</span> + AiNodeGetName(node);</div>
<div class="line">            ray_dir_aov_str = ray_dir_aov_str + <span class="stringliteral">&quot; &quot;</span> + AiNodeGetName(filter) + <span class="stringliteral">&quot; &quot;</span> + AiNodeGetName(node);</div>
<div class="line">            ray_orig_aov_str = ray_orig_aov_str + <span class="stringliteral">&quot; &quot;</span> + AiNodeGetName(filter) + <span class="stringliteral">&quot; &quot;</span> + AiNodeGetName(node);</div>
<div class="line"></div>
<div class="line">            aovDeclaration.push_back(RGBA_aov_str);</div>
<div class="line">            aovDeclaration.push_back(Z_aov_str);</div>
<div class="line">            aovDeclaration.push_back(P_aov_str);</div>
<div class="line">            aovDeclaration.push_back(N_aov_str);</div>
<div class="line">            aovDeclaration.push_back(prz_transp_aov_str);</div>
<div class="line">            aovDeclaration.push_back(transmission_albedo_aov_str);</div>
<div class="line">            aovDeclaration.push_back(glass_aov_aov_str);</div>
<div class="line">            aovDeclaration.push_back(ray_dir_aov_str);</div>
<div class="line">            aovDeclaration.push_back(ray_orig_aov_str);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (compute_motion_vector)</div>
<div class="line">        {</div>
<div class="line">            std::string mvAov = std::string(velocityAtStr.c_str()) + <span class="stringliteral">&quot; VECTOR &quot;</span> + AiNodeGetName(filter) + <span class="stringliteral">&quot; &quot;</span> + AiNodeGetName(node);</div>
<div class="line">            aovDeclaration.push_back(mvAov);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        AtArray *current_outputs = AiNodeGetArray(AiUniverseGetOptions(universe), <span class="stringliteral">&quot;outputs&quot;</span>);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; AiArrayGetNumElements(current_outputs); i++)</div>
<div class="line">        {</div>
<div class="line">            AtString output = AiArrayGetStr(current_outputs, i);</div>
<div class="line">            <span class="keywordflow">if</span> (std::find(aovDeclaration.begin(), aovDeclaration.end(), std::string(output.c_str())) == aovDeclaration.end())</div>
<div class="line">                aovDeclaration.push_back(output.c_str());</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">        AtArray* outputs = AiArrayAllocate(aovDeclaration.size(), 1, AI_TYPE_STRING);</div>
<div class="line">        <span class="keywordtype">int</span> aliasIdx = 0;</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; aovDeclaration.size(); i++)</div>
<div class="line">        {</div>
<div class="line">            AiArraySetStr(outputs, i, aovDeclaration[i].c_str());</div>
<div class="line"></div>
<div class="line">            std::istringstream iss(aovDeclaration[i]);</div>
<div class="line">            std::string first, second;</div>
<div class="line">            iss &gt;&gt; first &gt;&gt; second;</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> (std::find(standard_AOVs.begin(), standard_AOVs.end(), AtString(first.c_str())) == standard_AOVs.end())</div>
<div class="line">            {</div>
<div class="line">                uint8_t type = convertNameTypeToType(second);</div>
<div class="line">                <span class="keywordflow">switch</span> (type)</div>
<div class="line">                {</div>
<div class="line">                <span class="keywordflow">case</span> AI_TYPE_INT:</div>
<div class="line">                <span class="keywordflow">case</span> AI_TYPE_USHORT:</div>
<div class="line">                <span class="keywordflow">case</span> AI_TYPE_UINT: <a class="code" href="group___pz_phase_api.html#ga8c5931c64510f045134fb6a6fc206273">PzRenderPhaseRegisterAov</a>(aliasIdx, first.c_str(), <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#add16db84a471b163119fa85bfa9df0fdafd5a5f51ce25953f3db2c7e93eb7864a">PresenZ::Phase::AOVType::INT</a>); <span class="keywordflow">break</span>;</div>
<div class="line">                <span class="keywordflow">case</span> AI_TYPE_BYTE:</div>
<div class="line">                <span class="keywordflow">case</span> AI_TYPE_BOOLEAN: <a class="code" href="group___pz_phase_api.html#ga8c5931c64510f045134fb6a6fc206273">PzRenderPhaseRegisterAov</a>(aliasIdx, first.c_str(), <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#add16db84a471b163119fa85bfa9df0fdae663dbb8f8244e122acb5bd6b2c216e1">PresenZ::Phase::AOVType::BOOL</a>); <span class="keywordflow">break</span>;</div>
<div class="line">                <span class="keywordflow">case</span> AI_TYPE_FLOAT:</div>
<div class="line">                <span class="keywordflow">case</span> AI_TYPE_HALF: <a class="code" href="group___pz_phase_api.html#ga8c5931c64510f045134fb6a6fc206273">PzRenderPhaseRegisterAov</a>(aliasIdx, first.c_str(), <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#add16db84a471b163119fa85bfa9df0fda9cf4a0866224b0bb4a7a895da27c9c4c">PresenZ::Phase::AOVType::FLOAT</a>); <span class="keywordflow">break</span>;</div>
<div class="line">                <span class="keywordflow">case</span> AI_TYPE_RGB: <a class="code" href="group___pz_phase_api.html#ga8c5931c64510f045134fb6a6fc206273">PzRenderPhaseRegisterAov</a>(aliasIdx, first.c_str(), <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#add16db84a471b163119fa85bfa9df0fda30447e9f6efa4afdd251f9afc1d5fb44">PresenZ::Phase::AOVType::RGB</a>); <span class="keywordflow">break</span>;</div>
<div class="line">                <span class="keywordflow">case</span> AI_TYPE_RGBA: <a class="code" href="group___pz_phase_api.html#ga8c5931c64510f045134fb6a6fc206273">PzRenderPhaseRegisterAov</a>(aliasIdx, first.c_str(), <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#add16db84a471b163119fa85bfa9df0fdae75845ff0980839032f4a78a0d42753c">PresenZ::Phase::AOVType::RGBA</a>); <span class="keywordflow">break</span>;</div>
<div class="line">                <span class="keywordflow">case</span> AI_TYPE_VECTOR2: <a class="code" href="group___pz_phase_api.html#ga8c5931c64510f045134fb6a6fc206273">PzRenderPhaseRegisterAov</a>(aliasIdx, first.c_str(), <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#add16db84a471b163119fa85bfa9df0fdab77decd1c62766213f0df1b81b3e9647">PresenZ::Phase::AOVType::VEC2</a>); <span class="keywordflow">break</span>;</div>
<div class="line">                <span class="keywordflow">case</span> AI_TYPE_VECTOR: <a class="code" href="group___pz_phase_api.html#ga8c5931c64510f045134fb6a6fc206273">PzRenderPhaseRegisterAov</a>(aliasIdx, first.c_str(), <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#add16db84a471b163119fa85bfa9df0fdacff9b70db3f47a019c78e266909da55c">PresenZ::Phase::AOVType::VEC</a>); <span class="keywordflow">break</span>;</div>
<div class="line">                }</div>
<div class="line">                ++aliasIdx;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">        <a class="code" href="group___pz_app_logger.html#gad79dc53c351eeff13f901542c29f6e57">PZ_DEBUG</a>(<span class="stringliteral">&quot;Registered %i additionnal AOVs&quot;</span>, aliasIdx);</div>
<div class="line">        </div>
<div class="line"></div>
<div class="line">        AiNodeSetArray(AiUniverseGetOptions(universe), <span class="stringliteral">&quot;outputs&quot;</span>, outputs);</div>
<div class="line"></div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Invoke all the PresenZ parameters that are related to the Camera</span></div>
<div class="line"><span class="keywordtype">void</span> initPresenZCameraParameters(<span class="keyword">const</span> AtNode* pzCamera, <span class="keyword">const</span> <span class="keywordtype">int</span> renderTargetResX, <span class="keyword">const</span> <span class="keywordtype">int</span> renderTargetResY, <span class="keyword">const</span> <span class="keywordtype">float</span> ipd)</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="group___pz_phase_api.html#gaf350495ba3e909dda96ff5710044261b">PzSetOutputResolution</a>(renderTargetResX, renderTargetResY);</div>
<div class="line"></div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">int</span> renderEye = AiNodeGetInt(pzCamera, <span class="stringliteral">&quot;rendering_eye&quot;</span>);</div>
<div class="line">    <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#a3104904c134a52357b85f763f6dfd48f">PresenZ::Phase::Eye</a> eye = <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#a3104904c134a52357b85f763f6dfd48faa1703c467e4e95c2a7194aabb4db866f">PresenZ::Phase::Eye::RC_LeftAndRight</a>;</div>
<div class="line">    <span class="keywordflow">if</span> (renderEye == 0) { eye = <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#a3104904c134a52357b85f763f6dfd48fa4280d82f18d6dbafdeb68c811112455e">PresenZ::Phase::Eye::RC_Left</a>; }</div>
<div class="line">    <span class="keywordflow">if</span> (renderEye == 1) { eye = <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#a3104904c134a52357b85f763f6dfd48fac2b22af1f16cebd2cc909767c763a713">PresenZ::Phase::Eye::RC_Right</a>; }</div>
<div class="line"></div>
<div class="line">    <a class="code" href="group___pz_phase_api.html#gac3afc2f459b347c438662de65c198a50">PzSetDeepReflection</a>(eye, ipd);</div>
<div class="line"></div>
<div class="line">    <a class="code" href="group___pz_phase_api.html#gac2c8fc98e4fea4d4d4204a394aa16458">PzSetDistanceToGround</a>(AiNodeGetFlt(pzCamera, <span class="stringliteral">&quot;distance_to_ground&quot;</span>));</div>
<div class="line">    <a class="code" href="group___pz_phase_api.html#ga91c7a89a477bae0bba92a42399cc87f7">PzSetSpecularPointOffset</a>(NozPointFromAiPoint(AiNodeGetVec(pzCamera, <span class="stringliteral">&quot;specular_point_offset&quot;</span>)));</div>
<div class="line"></div>
<div class="line">    <span class="keyword">const</span> AtVector viewscale = AiNodeGetVec(pzCamera, <span class="stringliteral">&quot;view_scale&quot;</span>);</div>
<div class="line">    <a class="code" href="group___pz_phase_api.html#gac178cf8d5ca681880d185675bad1eb83">PzSetZovScaling</a>(viewscale.x, viewscale.y, viewscale.z);</div>
<div class="line"></div>
<div class="line">    <a class="code" href="group___pz_phase_api.html#ga4e1183c45e876b63397f76eef22bfa8a">PzSetZovOffset</a>(AiNodeGetInt(pzCamera, <span class="stringliteral">&quot;multibox_offset_right&quot;</span>), AiNodeGetInt(pzCamera, <span class="stringliteral">&quot;multibox_offset_top&quot;</span>), AiNodeGetInt(pzCamera, <span class="stringliteral">&quot;multibox_offset_back&quot;</span>));</div>
<div class="line"></div>
<div class="line">    AtMatrix AtCamToWorldMat4;</div>
<div class="line">    AiCameraToWorldMatrix(pzCamera, 0.5, AtCamToWorldMat4);</div>
<div class="line"></div>
<div class="line">    <a class="code" href="matrix_8h.html#a15eb5c4da255c65c60623dc95ca45bc1">NozMatrix</a> worldToCam;</div>
<div class="line">    AtMatrixToNozMatrix(AtCamToWorldMat4, worldToCam);</div>
<div class="line">    <a class="code" href="group___pz_phase_api.html#ga42397edff2e26f59763a914f4fcdb907">PzSetCameraToWorldMatrix</a>(worldToCam);</div>
<div class="line"></div>
<div class="line">    <a class="code" href="group___pz_phase_api.html#gac11c71bce1628268767b411ce31051d8">PzSetClippingSphere</a>(AiNodeGetBool(pzCamera, <span class="stringliteral">&quot;clipping_enable&quot;</span>),</div>
<div class="line">        <a class="code" href="group___n_o_z__vector.html#ga347d85f3e636cf273a47949aa0613a8f">NozVector</a>(AiNodeGetVec(pzCamera, <span class="stringliteral">&quot;clipping_position&quot;</span>).x, AiNodeGetVec(pzCamera, <span class="stringliteral">&quot;clipping_position&quot;</span>).y, AiNodeGetVec(pzCamera, <span class="stringliteral">&quot;clipping_position&quot;</span>).z),</div>
<div class="line">        AiNodeGetFlt(pzCamera, <span class="stringliteral">&quot;clipping_radius&quot;</span>), !AiNodeGetBool(pzCamera, <span class="stringliteral">&quot;clipping_outside&quot;</span>));</div>
<div class="line"></div>
<div class="line">    <a class="code" href="group___pz_phase_api.html#ga6da4a461e66a4916bcadf9d0d17ea33f">PzSetRenderInsideBox</a>(AiNodeGetInt(pzCamera, <span class="stringliteral">&quot;render_inside_zov&quot;</span>));</div>
<div class="line"></div>
<div class="line">    <a class="code" href="group___pz_phase_api.html#gad62d04d2a684ad105ddb52a268f73ffd">PzSetFroxtrum</a>(AiNodeGetBool(pzCamera, <span class="stringliteral">&quot;enable_froxtrum&quot;</span>));</div>
<div class="line">    <a class="code" href="group___pz_phase_api.html#gac1ad4f221e5f62638eea8387d7d68e03">PzSetFroxtrumDepth</a>(AiNodeGetInt(pzCamera, <span class="stringliteral">&quot;froxtrum_depth&quot;</span>)+5);</div>
<div class="line"></div>
<div class="line">    <span class="keyword">const</span> AtString windowShapesFile = AiNodeGetStr(pzCamera, <span class="stringliteral">&quot;window_shapes_file&quot;</span>);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">int</span> windowShapeIndex = AiNodeGetInt(pzCamera, <span class="stringliteral">&quot;window_shape_index&quot;</span>);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">float</span> minDistToScreen = AiNodeGetFlt(pzCamera, <span class="stringliteral">&quot;min_dist_to_screen&quot;</span>);</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">if</span> (windowShapesFile.length() != 0 ){</div>
<div class="line">        <a class="code" href="group___pz_phase_api.html#gaf70ef3857d3b92ff1ce6b9017c089ee5">PzSetWindowShapesFile</a>(windowShapesFile.c_str(), windowShapeIndex);</div>
<div class="line">        <a class="code" href="group___pz_phase_api.html#ga7884f4f91a7070c91f059085553317f3">PzSetDetectionMinimumDistance</a>(minDistToScreen);</div>
<div class="line">        <a class="code" href="group___pz_app_logger.html#gaf8ab3f1606906a93b3081de7f0cb7be1">PZ_INFO</a>(<span class="stringliteral">&quot;[PresenZ] Set the minimum distance of detection to %f cm for window shape rendering\n&quot;</span>, minDistToScreen);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Forward all the parameters from Arnold to PresenZ.</span></div>
<div class="line"><span class="keywordtype">bool</span> initPresenZ(AtNode *node)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">const</span> AtUniverse* universe = AiNodeGetUniverse(node);</div>
<div class="line">    <span class="keyword">const</span> AtNode* pzCamera = AiUniverseGetCamera(universe);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (AiNodeIs(pzCamera, PresenzCameraName) == <span class="keyword">false</span>)</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="group___pz_app_logger.html#ga57e4c432a80f1ffc8de1a41a42ac07d0">PZ_WARNING</a>(<span class="stringliteral">&quot;[PresenZ] Could not find the PresenZMainCamera.&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">    }</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">int</span> pass = AiNodeGetInt(node, <span class="stringliteral">&quot;pass&quot;</span>);</div>
<div class="line">    PresenZ_data_struct::pass = pass;</div>
<div class="line"></div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">int</span> renderEye = AiNodeGetInt(pzCamera, <span class="stringliteral">&quot;rendering_eye&quot;</span>);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">bool</span> motionVector = AiNodeGetBool(pzCamera, <span class="stringliteral">&quot;compute_motion_vector&quot;</span>);</div>
<div class="line">    PresenZ_data_struct::motion_vector = ( motionVector == <span class="keyword">true</span> &amp;&amp; renderEye == 0 &amp;&amp; pass == <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#ae1c5184dc404edf057ed537bcfddef84ac677a954de25220db675695edacb4f71">Render</a>);</div>
<div class="line"></div>
<div class="line">    <span class="keyword">const</span> AtNode *universeOptions = AiRenderSessionGetOptions(AiUniverseGetRenderSession(universe));</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (pass == <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#ae1c5184dc404edf057ed537bcfddef84a48a95ceab76284afa466622424eba555">Detect</a> || pass == <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#ae1c5184dc404edf057ed537bcfddef84a9e72290cbba5243f4449f84168a3c99c">Detect_Reflection</a>)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">if</span> (AiNodeGetInt(universeOptions, <span class="stringliteral">&quot;AA_samples&quot;</span>) != 16)</div>
<div class="line">            <a class="code" href="group___pz_app_logger.html#gafd8b815a0f76d6b121f44f62d5730ee4">PZ_ERROR</a>(<span class="stringliteral">&quot;Detection phase requires 16 AA_Samples&quot;</span>);</div>
<div class="line">        <span class="keywordflow">if</span> (AiNodeGetBool(universeOptions, <span class="stringliteral">&quot;enable_adaptive_sampling&quot;</span>) == <span class="keyword">true</span>)</div>
<div class="line">            <a class="code" href="group___pz_app_logger.html#gafd8b815a0f76d6b121f44f62d5730ee4">PZ_ERROR</a>(<span class="stringliteral">&quot;Detection phase requires adaptative sampling disabled.&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (AiNodeGetFlt(universeOptions, <span class="stringliteral">&quot;pixel_aspect_ratio&quot;</span>) != 1.0f)</div>
<div class="line">        <a class="code" href="group___pz_app_logger.html#gafd8b815a0f76d6b121f44f62d5730ee4">PZ_ERROR</a>(<span class="stringliteral">&quot;Device aspect ratio is not 1.0&quot;</span>);</div>
<div class="line"></div>
<div class="line">    <a class="code" href="group___pz_phase_api.html#ga36a62a0e95484104ce9507b58f2cda67">PzInitPhase</a>((<a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#ae1c5184dc404edf057ed537bcfddef84">Phase</a>)pass, PresenZ::Util::RenderingEngineId::ARNOLD);</div>
<div class="line"></div>
<div class="line">    <a class="code" href="group___pz_phase_api.html#ga84883989935b783a1e30f2fe012cc8b6">PzSetRenderTransparencyMode</a>(<a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#a36a74ae11377f0edba8dcb5070390a4d">PresenZ::Phase::TransparencyRenderingType</a>(<a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#a36a74ae11377f0edba8dcb5070390a4daf1fb663f950f6e485ca1a18bf9d3f2ee">PresenZ::Phase::TransparencyRenderingType::PRZ_BOTH</a>));</div>
<div class="line">    PresenZ_data_struct::glass_pass_mode = <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#a36a74ae11377f0edba8dcb5070390a4daf1fb663f950f6e485ca1a18bf9d3f2ee">PresenZ::Phase::TransparencyRenderingType::PRZ_BOTH</a>;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span>(pass == <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#ae1c5184dc404edf057ed537bcfddef84ac677a954de25220db675695edacb4f71">Render</a> || pass == <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#ae1c5184dc404edf057ed537bcfddef84a4fa71226841d5dc4359c2e48fa8a079e">Render_Reflection</a>)</div>
<div class="line">        registerAOVs(node, motionVector);</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">    <a class="code" href="group___pz_phase_api.html#ga8b1b4c6f8a8629d079bc628920373987">PzSetDetectionSaveguard</a>(8.0, <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#ad9f2e08d4f565bc8e1d21ceb48f50a72ae31eaee77988d5953bff8791498e4cbd">DSG_disabled</a>);</div>
<div class="line"></div>
<div class="line">    <a class="code" href="group___pz_phase_api.html#ga872021ff344d7ad06ed99044cade33dd">PzSetCameraUpVector</a>(<a class="code" href="group___n_o_z__vector.html#ga347d85f3e636cf273a47949aa0613a8f">NozVector</a>(0.0, 1.0, 0.0));</div>
<div class="line">    <a class="code" href="group___pz_phase_api.html#gae150318848ccb17713d4c1f396b66d2c">PzSetDetectFilePath</a>(GetOutputDirectoryDetectFilePath(node).c_str());</div>
<div class="line">    <a class="code" href="group___pz_phase_api.html#gaeba0942d7312761ff1085f724def48bc">PzSetOutFilePath</a>(GetOutputDirectoryFilePath(node).c_str());</div>
<div class="line">    <span class="comment">//PzSetMaxDistance(ARNOLD_MAXDISTANCE - 5000);</span></div>
<div class="line">    <a class="code" href="group___pz_phase_api.html#ga7972a71067de708d80c76c9c8bedcdf1">PzSetCurrentFrame</a>(AiNodeGetFlt(universeOptions, <span class="stringliteral">&quot;frame&quot;</span>));</div>
<div class="line">    <a class="code" href="group___pz_phase_api.html#ga2272389ac083bba044c74c10f1d7e520">PzSetDraft</a>(AiNodeGetBool(pzCamera, <span class="stringliteral">&quot;draft_mode&quot;</span>));</div>
<div class="line">    <a class="code" href="group___pz_phase_api.html#gac3afc2f459b347c438662de65c198a50">PzSetDeepReflection</a>(<a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#a3104904c134a52357b85f763f6dfd48faa1703c467e4e95c2a7194aabb4db866f">Eye::RC_LeftAndRight</a>, AiNodeGetFlt(pzCamera, <span class="stringliteral">&quot;ipd&quot;</span>));</div>
<div class="line">    </div>
<div class="line">    <a class="code" href="group___pz_phase_api.html#ga5f81ac7c777176967e5395adc895c281">PzSetIdealPointSizeTarget</a>(AiNodeGetFlt(pzCamera, <span class="stringliteral">&quot;ideal_point_size&quot;</span>)); </div>
<div class="line">    <a class="code" href="group___pz_phase_api.html#gafdd2169c7578a963e98dd10e4c2ed896">PzSetRenderScale</a>(AiNodeGetFlt(pzCamera, <span class="stringliteral">&quot;presenz_scene_scale&quot;</span>));</div>
<div class="line">    </div>
<div class="line">    <a class="code" href="group___pz_phase_api.html#gad3be8013a2063cf2fe240c2a0ca285a3">PzSetThreadNumber</a>(AiNodeGetInt(universeOptions, <span class="stringliteral">&quot;threads&quot;</span>));</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">int</span> renderTargetResX = AiNodeGetInt(universeOptions, <span class="stringliteral">&quot;xres&quot;</span>);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">int</span> renderTargetResY = AiNodeGetInt(universeOptions, <span class="stringliteral">&quot;yres&quot;</span>);</div>
<div class="line"></div>
<div class="line">    initPresenZCameraParameters(pzCamera, renderTargetResX, renderTargetResY, AiNodeGetFlt(pzCamera, <span class="stringliteral">&quot;ipd&quot;</span>));</div>
<div class="line"></div>
<div class="line">    <a class="code" href="group___pz_phase_api.html#ga9a095444afc1af0f1c678be87b80033b">PzSetMotionVector</a>(motionVector);</div>
<div class="line"></div>
<div class="line">    <a class="code" href="group___pz_phase_api.html#gab67750648f02eb67d0ef93c813e36a7c">PzSetRenderingResolutionParameters</a>(<a class="code" href="group___pz_phase_api.html#gab1862ca3334977c6899dd4cd823310b5">PzComputeRenderingResolutionParameters</a>(renderTargetResX, renderTargetResY));</div>
<div class="line">    <span class="comment">//PzSetRenderingResolutionParameters(PzGetRenderingResolutionParameters());</span></div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">AI_DRIVER_NODE_EXPORT_METHODS(nozPresenZDriverMethods);</div>
<div class="line"></div>
<div class="line">node_parameters</div>
<div class="line">{</div>
<div class="line">    AiParameterStr(<span class="stringliteral">&quot;filename&quot;</span>, <span class="stringliteral">&quot;presenz.prz&quot;</span>);</div>
<div class="line">    AiParameterStr(<span class="stringliteral">&quot;detect_file&quot;</span>, <span class="stringliteral">&quot;presenz.przDetect&quot;</span>);</div>
<div class="line">    AiMetaDataSetBool(nentry, <span class="stringliteral">&quot;detect_file&quot;</span>, <span class="stringliteral">&quot;maya.hide&quot;</span>, <span class="keyword">true</span>);</div>
<div class="line">    AiParameterStr(<span class="stringliteral">&quot;color_space&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);          <span class="comment">// No idea what to do with that, but otherwise MtoA barf about it.</span></div>
<div class="line">    AiParameterInt(<span class="stringliteral">&quot;pass&quot;</span>, 0);</div>
<div class="line">    AiMetaDataSetBool(nentry, <span class="stringliteral">&quot;pass&quot;</span>, <span class="stringliteral">&quot;maya.hide&quot;</span>, <span class="keyword">true</span>);</div>
<div class="line">    </div>
<div class="line">    AiParameterInt(<span class="stringliteral">&quot;current_Block&quot;</span>, 0);         <span class="comment">// &quot;Current block to render&quot;</span></div>
<div class="line">    AiMetaDataSetBool(nentry, <span class="stringliteral">&quot;current_Block&quot;</span>, <span class="stringliteral">&quot;maya.hide&quot;</span>, <span class="keyword">true</span>);</div>
<div class="line"></div>
<div class="line">    </div>
<div class="line"></div>
<div class="line">    AiMetaDataSetBool(nentry, <span class="stringliteral">&quot;filename&quot;</span>, <span class="stringliteral">&quot;maya.hide&quot;</span>, <span class="keyword">true</span>);</div>
<div class="line">    AiMetaDataSetStr(nentry, NULL, <span class="stringliteral">&quot;maya.attr_prefix&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);</div>
<div class="line">    AiMetaDataSetStr(nentry, NULL, <span class="stringliteral">&quot;maya.translator&quot;</span>, <span class="stringliteral">&quot;prz&quot;</span>);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">driver_extension</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *extensions[] = { <span class="stringliteral">&quot;prz&quot;</span>, <span class="stringliteral">&quot;przDetect&quot;</span>, <span class="stringliteral">&quot;przRender&quot;</span>, NULL };</div>
<div class="line">    <span class="keywordflow">return</span> extensions;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">driver_supports_pixel_type</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span> pixel_type == AI_TYPE_POINTER || pixel_type == AI_TYPE_NODE;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">node_initialize</div>
<div class="line">{</div>
<div class="line">    AiDriverInitialize(node, <span class="keyword">true</span>);</div>
<div class="line">    DriverData *data = (DriverData*)AiMalloc(<span class="keyword">sizeof</span>(DriverData));</div>
<div class="line">    AiNodeSetLocalData(node, data);</div>
<div class="line">    <a class="code" href="group___pz_app_logger.html#ga796c8996450a6a133bd714fd8df838e6">PresenZ::Logger::PzSetDateHeader</a>(<span class="keyword">false</span>);</div>
<div class="line">    <a class="code" href="group___pz_app_logger.html#gaae38cb81f16f5bfd662890985d2590c5">PresenZ::Logger::PzSetLogLevelHeader</a>(<span class="keyword">false</span>);</div>
<div class="line">    <a class="code" href="group___pz_app_logger.html#ga9ceb7f158e3d956cbc18022ec5f3521e">PresenZ::Logger::PzSetConsole</a>(<span class="keyword">false</span>);</div>
<div class="line">    <a class="code" href="group___pz_app_logger.html#ga80a53b7d361b1f14fc3434aa8025dd4d">PresenZ::Logger::PzSetProgressBarType</a>(<a class="code" href="namespace_presen_z_1_1_logger_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#a797e8f0ee9ab4aad21b8a9ea23c5f457acf64a7a93c17e0fb483f1256a33e13f9">PresenZ::Logger::PT_vertical</a>);</div>
<div class="line">    <a class="code" href="group___pz_app_logger.html#gad553edc68869caef27062377dbd1fa3e">PresenZ::Logger::PzSetCallBackLogLevel</a>(<a class="code" href="namespace_presen_z_1_1_logger_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#aca1fd1d8935433e6ba2e3918214e07f9a1ef17fe4022551db4da98ddd8838a626">PresenZ::Logger::LL_Trace</a>, arnoldLogger, static_cast&lt;void *&gt;(NULL));</div>
<div class="line">    <a class="code" href="group___pz_app_logger.html#gad737a4583be20f23371c49033ab3ce0c">PresenZ::Logger::PzSetCallbackCarriageReturnMode</a>(<a class="code" href="namespace_presen_z_1_1_logger_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#a09c183db9d6f5f4e369cab8b6a566a92a4794744b59a0b9c9ee7267cd770f03fb">PresenZ::Logger::CR_NoCarriageReturn</a>);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">node_update </div>
<div class="line">{</div>
<div class="line">    DriverData *data = (DriverData*)AiNodeGetLocalData(node);</div>
<div class="line">    data-&gt;m_idValid = initPresenZ(node);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span>(data-&gt;m_idValid == <span class="keyword">true</span>)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordtype">size_t</span> currentBlock = AiNodeGetInt(node, <span class="stringliteral">&quot;current_Block&quot;</span>);</div>
<div class="line">        <a class="code" href="group___pz_phase_api.html#ga88b63a5dd2bf80e290d8a84d4617dfa0">PzSetCurrentBlockIndex</a>(currentBlock);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">    <a class="code" href="group___pz_app_logger.html#gaf8ab3f1606906a93b3081de7f0cb7be1">PZ_INFO</a>(<span class="stringliteral">&quot;[PresenZ] Driver disabled.&quot;</span>)</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">node_finish</div>
<div class="line">{</div>
<div class="line">    DriverData *data = (DriverData*)AiNodeGetLocalData(node);</div>
<div class="line">    AiFree(data);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Callback invoked by Arnold when it is ready to start rendering an image</span></div>
<div class="line">driver_open</div>
<div class="line">{</div>
<div class="line">    DriverData *data = (DriverData*)AiNodeGetLocalData(node);</div>
<div class="line">    <span class="keywordflow">if</span> (data-&gt;m_idValid == <span class="keyword">false</span>)</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">        </div>
<div class="line">    <a class="code" href="group___pz_phase_api.html#ga34a210923ecc5389e6c4e566cbec5cf3">PzSetBucketSize</a>(bucket_size, bucket_size);</div>
<div class="line">    <a class="code" href="group___pz_phase_api.html#ga6a43f2e8043105f9ddf44442d99e1ada">PzPhaseBegin</a>();</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Callback invoked an image is finished.</span></div>
<div class="line">driver_close</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="group__bucket_a_p_i.html#ga9bd61516f6335535ffb1c17090c9180a">PzProcessAllBucketsToFile</a>();</div>
<div class="line">    <a class="code" href="group___pz_phase_api.html#ga782555fb073b4677f9eb7c8beba4299e">PzPhaseTerminate</a>();</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">driver_needs_bucket</div>
<div class="line">{</div>
<div class="line">    DriverData *data = (DriverData*)AiNodeGetLocalData(node);</div>
<div class="line">    <span class="keywordflow">if</span> (data-&gt;m_idValid == <span class="keyword">false</span>)</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Callback invoked by Arnold when bucket (image sub zone) is going to be rendered.</span></div>
<div class="line">driver_prepare_bucket</div>
<div class="line">{</div>
<div class="line">    DriverData *data = (DriverData*)AiNodeGetLocalData(node);</div>
<div class="line">    <span class="keywordflow">if</span> (data-&gt;m_idValid == <span class="keyword">false</span>)</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line"></div>
<div class="line">    <a class="code" href="group__bucket_a_p_i.html#ga560ec0137742aa12a1dc91ac6a378461">PzInitBucket</a>(tid, bucket_xo, bucket_yo, bucket_xo + bucket_size_x, bucket_yo + bucket_size_y);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Callback invoked by Arnold when a bucket (image sub-zone) is finished, all shaded pixels are forwarded </span></div>
<div class="line"><span class="comment">// to PresenZ for further processing. </span></div>
<div class="line">driver_process_bucket</div>
<div class="line">{</div>
<div class="line">    DriverData *data = (DriverData*)AiNodeGetLocalData(node);</div>
<div class="line">    <span class="keywordflow">if</span> (data-&gt;m_idValid == <span class="keyword">false</span>)</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (AiNodeGetInt(node, <span class="stringliteral">&quot;pass&quot;</span>) == <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#ae1c5184dc404edf057ed537bcfddef84a48a95ceab76284afa466622424eba555">Detect</a> || AiNodeGetInt(node, <span class="stringliteral">&quot;pass&quot;</span>) == <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#ae1c5184dc404edf057ed537bcfddef84a9e72290cbba5243f4449f84168a3c99c">Detect_Reflection</a>)</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line"></div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">void</span> *bucket_data;</div>
<div class="line"></div>
<div class="line">    AtString name;</div>
<div class="line">    <span class="keywordtype">int</span> type = AI_TYPE_UNDEFINED;</div>
<div class="line"></div>
<div class="line">    ArnoldBucketData pixel_data;</div>
<div class="line">    <span class="keywordflow">while</span> (AiOutputIteratorGetNext(iterator, &amp;name, &amp;type, &amp;bucket_data))</div>
<div class="line">    {</div>
<div class="line">        AtString atName = AtString(name);</div>
<div class="line">        pixel_data[atName].bucket_data = (FilterData **)bucket_data;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keyword">const</span> AtUniverse* universe = AiNodeGetUniverse(node);</div>
<div class="line">    <span class="keyword">const</span> AtNode* pzCamera = AiUniverseGetCamera(universe);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">float</span> far_clip = AiNodeGetFlt(pzCamera, <span class="stringliteral">&quot;far_clip&quot;</span>);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">float</span> scene_scale = AiNodeGetFlt(pzCamera, <span class="stringliteral">&quot;presenz_scene_scale&quot;</span>);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">float</span> max_distance = far_clip - (0.1 * scene_scale);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j &lt; bucket_size_y; ++j)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; bucket_size_x; ++i)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> in_idx = j * bucket_size_x + i;</div>
<div class="line"></div>
<div class="line">            <span class="keywordtype">int</span> dataSize = -1;</div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keyword">auto</span> it = pixel_data.begin(); it != pixel_data.end(); ++it)</div>
<div class="line">            {</div>
<div class="line">                <span class="keywordflow">if</span> (dataSize == -1)</div>
<div class="line">                    dataSize = it-&gt;second.bucket_data[in_idx]-&gt;data.size();</div>
<div class="line"></div>
<div class="line">                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dataSize != it-&gt;second.bucket_data[in_idx]-&gt;data.size())</div>
<div class="line">                    <a class="code" href="group___pz_app_logger.html#gafd8b815a0f76d6b121f44f62d5730ee4">PZ_ERROR</a>(<span class="stringliteral">&quot;[PresenZ] We have a different number of samples in AOV %s (%i vs %i)&quot;</span>, it-&gt;first.c_str(), dataSize, it-&gt;second.bucket_data[in_idx]-&gt;data.size());</div>
<div class="line">            }</div>
<div class="line">            </div>
<div class="line">            <span class="keywordtype">float</span> lastTransmission = 1.0f;</div>
<div class="line">            <span class="keywordtype">int</span> lastDepth = -1;</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">int</span> sample = 0; sample &lt; dataSize; sample++)</div>
<div class="line">            {</div>
<div class="line">                <span class="keywordtype">int</span> curDepth = pixel_data[RGBAAtStr].bucket_data[in_idx]-&gt;depth[sample];</div>
<div class="line">                <span class="keywordtype">float</span> distance = pixel_data[ZAtStr].bucket_data[in_idx]-&gt;data[sample].f;</div>
<div class="line">                <a class="code" href="struct_presen_z_1_1_render_sample_1_1v3__0_1_1_pz_render_sample.html">PzRenderSample</a> winSample;</div>
<div class="line"></div>
<div class="line">                <span class="comment">// Depth 0, we reset the transmission.</span></div>
<div class="line">                <span class="keywordflow">if</span> (curDepth == 0)</div>
<div class="line">                {</div>
<div class="line">                    lastTransmission = 1.0f;</div>
<div class="line">                    lastDepth = -1;</div>
<div class="line">                }</div>
<div class="line"></div>
<div class="line">                <span class="keywordflow">if</span> (PresenZ_data_struct::pass == <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#ae1c5184dc404edf057ed537bcfddef84ac677a954de25220db675695edacb4f71">PresenZ::Phase::Render</a>)</div>
<div class="line">                {</div>
<div class="line">                    AtRGBA leftEyeColor = AtRGBA(pixel_data[RGBAAtStr].bucket_data[in_idx]-&gt;data[sample].v4.x, pixel_data[RGBAAtStr].bucket_data[in_idx]-&gt;data[sample].v4.y, pixel_data[RGBAAtStr].bucket_data[in_idx]-&gt;data[sample].v4.z, pixel_data[RGBAAtStr].bucket_data[in_idx]-&gt;data[sample].v4.a);</div>
<div class="line">                    <span class="keywordflow">if</span> (leftEyeColor.a &lt;= AI_EPSILON)</div>
<div class="line">                        <span class="keywordflow">continue</span>;</div>
<div class="line"></div>
<div class="line">                    <a class="code" href="group___render_sample.html#ga5f9917e3482d27304c8a2b5da8f0d428">PzSetSamplePosition</a>(winSample, <a class="code" href="group___n_o_z__vector.html#ga67d23b8a9bee957caefe96759f6b012c">nozVector</a>(pixel_data[NHitPointAtStr].bucket_data[in_idx]-&gt;data[sample].v3.x, pixel_data[NHitPointAtStr].bucket_data[in_idx]-&gt;data[sample].v3.y, pixel_data[NHitPointAtStr].bucket_data[in_idx]-&gt;data[sample].v3.z));</div>
<div class="line">                    <a class="code" href="group___render_sample.html#gaff7747e2d5786e8a2dfe81424c871f96">PzSetSampleNormal</a>(winSample, <a class="code" href="group___n_o_z__vector.html#ga67d23b8a9bee957caefe96759f6b012c">nozVector</a>(pixel_data[NCameraAtStr].bucket_data[in_idx]-&gt;data[sample].v3.x, pixel_data[NCameraAtStr].bucket_data[in_idx]-&gt;data[sample].v3.y, pixel_data[NCameraAtStr].bucket_data[in_idx]-&gt;data[sample].v3.z));</div>
<div class="line">                    <a class="code" href="group___render_sample.html#gafbfb1ad8b22bf10b7680e956b1a49edc">PzSetSampleZ</a>(winSample, distance);</div>
<div class="line">                    <a class="code" href="group___render_sample.html#gab740a5b964a594890226fdd087c958a7">PzSetSamplePosXY</a>(winSample, pixel_data[NHitPointAtStr].bucket_data[in_idx]-&gt;offset[sample].x + 0.5f, pixel_data[NHitPointAtStr].bucket_data[in_idx]-&gt;offset[sample].y + 0.5f);</div>
<div class="line"></div>
<div class="line">                    <span class="comment">// In the future we will need to give the samples a weight (inv_density) when using adaptive sampling, atm it causes a problem in the merger where all the clusters are seen as transparent.</span></div>
<div class="line">                    <span class="comment">//const float inv_density = AiAOVSampleIteratorGetInvDensity(sample_iterator);</span></div>
<div class="line"></div>
<div class="line">                    <span class="keywordflow">if</span> (pixel_data[przGlassAtStr].bucket_data[in_idx]-&gt;data[sample].b)</div>
<div class="line">                    {</div>
<div class="line">                        AtRGB transmission = AtRGB(pixel_data[transmissionAOV].bucket_data[in_idx]-&gt;data[sample].v4.x, pixel_data[transmissionAOV].bucket_data[in_idx]-&gt;data[sample].v4.y, pixel_data[transmissionAOV].bucket_data[in_idx]-&gt;data[sample].v4.z);</div>
<div class="line">                        <span class="keywordtype">float</span> transmissionAlbedo = (transmission.r + transmission.g + transmission.b) / 3.0f;</div>
<div class="line">                        <span class="keywordflow">if</span> (transmissionAlbedo != 0.0f)</div>
<div class="line">                        {</div>
<div class="line">                            leftEyeColor = AtRGB(pixel_data[glassRGBOVStr].bucket_data[in_idx]-&gt;data[sample].v4.x, pixel_data[glassRGBOVStr].bucket_data[in_idx]-&gt;data[sample].v4.y, pixel_data[glassRGBOVStr].bucket_data[in_idx]-&gt;data[sample].v4.z);</div>
<div class="line">                            <span class="keywordtype">float</span> curTransmission = 1.0f - transmissionAlbedo;</div>
<div class="line"></div>
<div class="line">                        </div>
<div class="line"></div>
<div class="line">                            <span class="keywordflow">if</span> (curDepth &gt; lastDepth)</div>
<div class="line">                            {</div>
<div class="line">                                curTransmission *= lastTransmission;</div>
<div class="line">                                lastDepth = curDepth;</div>
<div class="line">                                lastTransmission = curTransmission;</div>
<div class="line">                            }</div>
<div class="line"></div>
<div class="line">                            leftEyeColor.a = curTransmission;</div>
<div class="line"></div>
<div class="line">                            <a class="code" href="group___render_sample.html#gac3a665a9da089d686c2ae13258d004c5">PzAddGlassSampleAov</a>(winSample, 1);</div>
<div class="line">                        }</div>
<div class="line">                        <span class="keywordflow">else</span></div>
<div class="line">                            <a class="code" href="group___render_sample.html#gac3a665a9da089d686c2ae13258d004c5">PzAddGlassSampleAov</a>(winSample, 0);</div>
<div class="line">                    }</div>
<div class="line">                    <span class="keywordflow">else</span></div>
<div class="line">                        <a class="code" href="group___render_sample.html#gac3a665a9da089d686c2ae13258d004c5">PzAddGlassSampleAov</a>(winSample, 0);</div>
<div class="line"></div>
<div class="line">                    <a class="code" href="group___render_sample.html#gacbfc89ad3b514c3fd64fb027ed36ebae">PzSetSampleColor</a>(winSample, <a class="code" href="struct_noz_r_g_b_a.html">NozRGBA</a>(leftEyeColor.r, leftEyeColor.g, leftEyeColor.b, leftEyeColor.a));</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (PresenZ_data_struct::pass == <a class="code" href="namespace_presen_z_1_1_phase_1_1_p_r_e_s_e_n_z___v_e_r_s_i_o_n___n_s.html#ae1c5184dc404edf057ed537bcfddef84a4fa71226841d5dc4359c2e48fa8a079e">PresenZ::Phase::Render_Reflection</a>)</div>
<div class="line">                {</div>
<div class="line">                    <a class="code" href="group___render_sample.html#ga5f9917e3482d27304c8a2b5da8f0d428">PzSetSamplePosition</a>(winSample, <a class="code" href="group___n_o_z__vector.html#ga67d23b8a9bee957caefe96759f6b012c">nozVector</a>(pixel_data[NHitPoint_Refl_AtStr].bucket_data[in_idx]-&gt;data[sample].v3.x, pixel_data[NHitPoint_Refl_AtStr].bucket_data[in_idx]-&gt;data[sample].v3.y, pixel_data[NHitPoint_Refl_AtStr].bucket_data[in_idx]-&gt;data[sample].v3.z));</div>
<div class="line">                    <a class="code" href="group___render_sample.html#gaff7747e2d5786e8a2dfe81424c871f96">PzSetSampleNormal</a>(winSample, <a class="code" href="group___n_o_z__vector.html#ga67d23b8a9bee957caefe96759f6b012c">nozVector</a>(pixel_data[NCameraAtStr].bucket_data[in_idx]-&gt;data[sample].v3.x, pixel_data[NCameraAtStr].bucket_data[in_idx]-&gt;data[sample].v3.y, pixel_data[NCameraAtStr].bucket_data[in_idx]-&gt;data[sample].v3.z));</div>
<div class="line">                    <a class="code" href="group___render_sample.html#gafbfb1ad8b22bf10b7680e956b1a49edc">PzSetSampleZ</a>(winSample, pixel_data[Z_Refl_AtStr].bucket_data[in_idx]-&gt;data[sample].f);</div>
<div class="line">                    <a class="code" href="group___render_sample.html#gab740a5b964a594890226fdd087c958a7">PzSetSamplePosXY</a>(winSample, pixel_data[NHitPoint_Refl_AtStr].bucket_data[in_idx]-&gt;offset[sample].x + 0.5f, pixel_data[NHitPoint_Refl_AtStr].bucket_data[in_idx]-&gt;offset[sample].y + 0.5f);</div>
<div class="line">                    </div>
<div class="line">                    AtRGBA leftEyeColor = AtRGBA(pixel_data[RGBA_Refl_AtStr].bucket_data[in_idx]-&gt;data[sample].v4.x, pixel_data[RGBA_Refl_AtStr].bucket_data[in_idx]-&gt;data[sample].v4.y, pixel_data[RGBA_Refl_AtStr].bucket_data[in_idx]-&gt;data[sample].v4.z, pixel_data[RGBA_Refl_AtStr].bucket_data[in_idx]-&gt;data[sample].v4.a);</div>
<div class="line">                    <a class="code" href="group___render_sample.html#gacbfc89ad3b514c3fd64fb027ed36ebae">PzSetSampleColor</a>(winSample, <a class="code" href="struct_noz_r_g_b_a.html">NozRGBA</a>(leftEyeColor.r, leftEyeColor.g, leftEyeColor.b, leftEyeColor.a));</div>
<div class="line">                }</div>
<div class="line"></div>
<div class="line">                <span class="keywordflow">if</span> (PresenZ_data_struct::motion_vector)</div>
<div class="line">                    <a class="code" href="group___render_sample.html#gae086107e0d3a7d2e8236c112691302f5">PzAddVelocitySampleAov</a>(winSample, <a class="code" href="group___n_o_z__vector.html#ga67d23b8a9bee957caefe96759f6b012c">nozVector</a>(pixel_data[velocityAtStr].bucket_data[in_idx]-&gt;data[sample].v3.x, pixel_data[velocityAtStr].bucket_data[in_idx]-&gt;data[sample].v3.y, pixel_data[velocityAtStr].bucket_data[in_idx]-&gt;data[sample].v3.z));</div>
<div class="line"></div>
<div class="line">                <span class="keywordflow">if</span> (distance &gt;= max_distance) { <span class="comment">//Hit the skydome sphere, need to recompute hitpoint and normal with virtual sphere around ZOV</span></div>
<div class="line">                    <a class="code" href="struct_noz_point.html">NozPoint</a> camPos = <a class="code" href="group___pz_phase_api.html#ga14ef4db9fbaa07463fb8c6eeb68f4a1e">PresenZ::Phase::PzGetZOVWorldPosition</a>();</div>
<div class="line">                    <a class="code" href="struct_noz_point.html">NozVector</a> rayDir(pixel_data[rayDirAOVStr].bucket_data[in_idx]-&gt;data[sample].v3.x, pixel_data[rayDirAOVStr].bucket_data[in_idx]-&gt;data[sample].v3.y, pixel_data[rayDirAOVStr].bucket_data[in_idx]-&gt;data[sample].v3.z);</div>
<div class="line">                    <a class="code" href="struct_noz_point.html">NozVector</a> rayOrigin(pixel_data[rayOrigAOVStr].bucket_data[in_idx]-&gt;data[sample].v3.x, pixel_data[rayOrigAOVStr].bucket_data[in_idx]-&gt;data[sample].v3.y, pixel_data[rayOrigAOVStr].bucket_data[in_idx]-&gt;data[sample].v3.z);</div>
<div class="line">                    std::vector&lt;float&gt; distances = hit_sphere(camPos, max_distance, rayDir, rayOrigin);                    </div>
<div class="line">                    <a class="code" href="group___render_sample.html#ga5f9917e3482d27304c8a2b5da8f0d428">PzSetSamplePosition</a>(winSample, rayOrigin + (rayDir * distances[0]));</div>
<div class="line">                    <a class="code" href="group___render_sample.html#gaff7747e2d5786e8a2dfe81424c871f96">PzSetSampleNormal</a>(winSample, -rayDir);                    </div>
<div class="line">                    <a class="code" href="group___render_sample.html#gafbfb1ad8b22bf10b7680e956b1a49edc">PzSetSampleZ</a>(winSample, distances[0]);</div>
<div class="line"></div>
<div class="line">                }</div>
<div class="line">                </div>
<div class="line">                <span class="keywordflow">for</span> (<span class="keyword">auto</span> it = pixel_data.begin(); it != pixel_data.end(); ++it) {</div>
<div class="line">                    <span class="keywordflow">if</span> (std::find(standard_AOVs.begin(), standard_AOVs.end(), it-&gt;first) == standard_AOVs.end()) {</div>
<div class="line">                        <span class="keyword">const</span> <span class="keywordtype">void</span>* aovData = &amp;it-&gt;second.bucket_data[in_idx]-&gt;data[sample];</div>
<div class="line">                        <a class="code" href="group___render_sample.html#ga4ed240d714fdab571e1e8c73933fe63f">PzAddSampleAov</a>(winSample, aovData, std::string(it-&gt;first.c_str()));</div>
<div class="line">                    }</div>
<div class="line">                }</div>
<div class="line">                </div>
<div class="line">                <a class="code" href="group___render_sample.html#gaf31d2a3ae08ac5994f5cf02766108d75">PzProcessRenderSample</a>(tid, bucket_xo + i, bucket_yo + j, 0, winSample);</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="comment">// Cleaning up</span></div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keyword">auto</span> it = pixel_data.begin(); it != pixel_data.end(); ++it)</div>
<div class="line">            {</div>
<div class="line">                it-&gt;second.bucket_data[in_idx]-&gt;data.clear();</div>
<div class="line">                it-&gt;second.bucket_data[in_idx]-&gt;offset.clear();</div>
<div class="line">                it-&gt;second.bucket_data[in_idx]-&gt;depth.clear();</div>
<div class="line">                <span class="keyword">delete</span> it-&gt;second.bucket_data[in_idx];</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Callback invoked by Arnold when bucket (image sub-zone) is finished and can be dismissed.</span></div>
<div class="line">driver_write_bucket</div>
<div class="line">{</div>
<div class="line">    DriverData *data = (DriverData*)AiNodeGetLocalData(node);</div>
<div class="line">    <span class="keywordflow">if</span> (data-&gt;m_idValid == <span class="keyword">false</span>)</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line"></div>
<div class="line">    <a class="code" href="group__bucket_a_p_i.html#gadd76ffab50ad3f6597a0b7d7190c80ea">PzProcessBucketFlushToFile</a>(bucket_xo, bucket_yo, bucket_xo + bucket_size_x, bucket_yo + bucket_size_y);</div>
<div class="line">}</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.5 </li>
  </ul>
</div>
</body>
</html>
